<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Incremental Civ Builder - From Stone Age to Future</title>
  <style>
/* Incremental Civ Builder - Styles */

/* Dark Theme (Default) */
:root {
  --bg-primary: #1a1a2e;
  --bg-secondary: #16213e;
  --bg-tertiary: #0f3460;
  --text-primary: #eee;
  --text-secondary: #aaa;
  --accent-primary: #e94560;
  --accent-secondary: #4ecdc4;
  --accent-gold: #ffd93d;
  --success: #6bcb77;
  --warning: #ff8c00;
  --danger: #ff4444;
  --tooltip-bg: rgba(0, 0, 0, 0.9);
  --tooltip-border: var(--accent-secondary);
}

/* Light Theme */
[data-theme="light"] {
  --bg-primary: #f5f5f5;
  --bg-secondary: #e8e8e8;
  --bg-tertiary: #d0d0d0;
  --text-primary: #1a1a2e;
  --text-secondary: #555;
  --accent-primary: #e94560;
  --accent-secondary: #2a9d8f;
  --accent-gold: #e9c46a;
  --success: #2d6a4f;
  --warning: #e76f51;
  --danger: #d62828;
  --tooltip-bg: rgba(30, 30, 50, 0.95);
  --tooltip-border: var(--accent-secondary);
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
  min-height: 100vh;
  color: var(--text-primary);
}

.game-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
}

/* Header */
.game-header {
  text-align: center;
  padding: 20px;
  background: var(--bg-secondary);
  border-radius: 15px;
  margin-bottom: 20px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
}

.game-header h1 {
  font-size: 2.5rem;
  margin-bottom: 10px;
  color: var(--accent-gold);
}

.era-info h2 {
  color: var(--accent-secondary);
  font-size: 1.8rem;
  margin-bottom: 5px;
}

.era-info p {
  color: var(--text-secondary);
}

#era-progress {
  font-size: 0.9rem;
  margin-top: 5px;
  color: var(--accent-primary);
}

/* Resources Bar */
.resources-bar {
  display: flex;
  justify-content: space-around;
  flex-wrap: wrap;
  gap: 15px;
  padding: 20px;
  background: var(--bg-secondary);
  border-radius: 15px;
  margin-bottom: 20px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
}

.resource {
  display: flex;
  flex-direction: column;
  align-items: center;
  min-width: 100px;
  padding: 10px;
  background: var(--bg-tertiary);
  border-radius: 10px;
}

.resource-icon {
  font-size: 1.8rem;
  margin-bottom: 5px;
}

.resource-name {
  font-size: 0.9rem;
  color: var(--text-secondary);
}

.resource-amount {
  font-size: 1.5rem;
  font-weight: bold;
  color: var(--accent-gold);
}

.resource-rate {
  font-size: 0.8rem;
  color: var(--success);
}

/* Tab Navigation */
.tab-nav {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.tab-btn {
  flex: 1;
  min-width: 120px;
  padding: 12px 20px;
  background: var(--bg-secondary);
  border: 2px solid var(--bg-tertiary);
  border-radius: 10px;
  color: var(--text-primary);
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.3s ease;
}

.tab-btn:hover {
  background: var(--bg-tertiary);
  border-color: var(--accent-secondary);
}

.tab-btn.active {
  background: var(--accent-primary);
  border-color: var(--accent-primary);
}

/* Tab Content */
.tab-container {
  background: var(--bg-secondary);
  border-radius: 15px;
  padding: 25px;
  min-height: 400px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}

.tab-content h2 {
  color: var(--accent-gold);
  margin-bottom: 10px;
}

.tab-content > p {
  color: var(--text-secondary);
  margin-bottom: 20px;
}

/* Gather Buttons */
.gather-buttons {
  display: flex;
  gap: 15px;
  flex-wrap: wrap;
}

.gather-btn {
  padding: 20px 30px;
  font-size: 1.1rem;
  background: var(--bg-tertiary);
  border: 2px solid var(--accent-secondary);
  border-radius: 10px;
  color: var(--text-primary);
  cursor: pointer;
  transition: all 0.2s ease;
}

.gather-btn:hover {
  background: var(--accent-secondary);
  color: var(--bg-primary);
  transform: scale(1.05);
}

.gather-btn:active {
  transform: scale(0.95);
}

/* Research Tree */
.research-tree {
  max-height: 600px;
  overflow-y: auto;
}

.era-section {
  margin-bottom: 30px;
}

.era-section h3 {
  color: var(--accent-secondary);
  padding-bottom: 10px;
  border-bottom: 2px solid var(--bg-tertiary);
  margin-bottom: 15px;
}

.tech-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  gap: 15px;
}

.tech-card {
  padding: 15px;
  border-radius: 10px;
  background: var(--bg-tertiary);
  border: 2px solid transparent;
  transition: all 0.3s ease;
}

.tech-card.locked {
  opacity: 0.5;
  border-color: #444;
}

.tech-card.available {
  border-color: var(--success);
  box-shadow: 0 0 10px rgba(107, 203, 119, 0.3);
}

.tech-card.researched {
  border-color: var(--accent-gold);
  background: linear-gradient(135deg, var(--bg-tertiary) 0%, rgba(255, 217, 61, 0.1) 100%);
}

.tech-card.current {
  border-color: var(--accent-primary);
  box-shadow: 0 0 10px rgba(233, 69, 96, 0.6);
}

.tech-card h4 {
  color: var(--text-primary);
  margin-bottom: 8px;
}

.tech-desc {
  font-size: 0.85rem;
  color: var(--text-secondary);
  margin-bottom: 10px;
}

.tech-cost {
  font-size: 0.9rem;
  color: var(--accent-gold);
  margin-bottom: 10px;
}

.badge {
  display: inline-block;
  padding: 4px 10px;
  background: var(--success);
  color: var(--bg-primary);
  border-radius: 15px;
  font-size: 0.8rem;
  font-weight: bold;
}

.research-btn {
  width: 100%;
  padding: 10px;
  background: var(--success);
  border: none;
  border-radius: 8px;
  color: var(--bg-primary);
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;
}

.research-btn:hover {
  background: #5ab868;
  transform: scale(1.02);
}

/* Current Research */
.current-research {
  background: var(--bg-tertiary);
  padding: 20px;
  border-radius: 10px;
  margin-bottom: 25px;
  border: 2px solid var(--accent-primary);
}

.current-research h3 {
  color: var(--accent-primary);
  margin-bottom: 15px;
}

/* Progress Bar */
.progress-bar {
  height: 25px;
  background: var(--bg-primary);
  border-radius: 12px;
  overflow: hidden;
  margin-bottom: 10px;
}

.progress-bar.small {
  height: 12px;
  margin-bottom: 0;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
  border-radius: 12px;
  transition: width 0.3s ease;
}

/* Barracks */
.barracks-content h3 {
  color: var(--accent-secondary);
  margin-bottom: 15px;
  padding-bottom: 10px;
  border-bottom: 2px solid var(--bg-tertiary);
}

.training-queue {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-bottom: 25px;
}

.training-item {
  display: flex;
  align-items: center;
  gap: 15px;
  padding: 12px;
  background: var(--bg-tertiary);
  border-radius: 8px;
}

.training-item span:first-child {
  min-width: 120px;
  color: var(--accent-gold);
}

.training-item .progress-bar {
  flex: 1;
}

.troop-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  gap: 15px;
}

.troop-card {
  padding: 15px;
  background: var(--bg-tertiary);
  border-radius: 10px;
  border: 2px solid transparent;
}

.troop-card.available {
  border-color: var(--success);
}

.troop-card.unavailable {
  opacity: 0.7;
  border-color: var(--danger);
}

.troop-card h4 {
  color: var(--accent-gold);
  margin-bottom: 8px;
}

.troop-desc {
  font-size: 0.85rem;
  color: var(--text-secondary);
  margin-bottom: 10px;
}

.troop-stats {
  display: flex;
  gap: 15px;
  margin-bottom: 10px;
  font-size: 0.9rem;
}

.troop-cost {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  margin-bottom: 10px;
  font-size: 0.85rem;
  color: var(--accent-gold);
}

.train-time {
  font-size: 0.8rem;
  color: var(--text-secondary);
  margin-bottom: 10px;
}

.train-btn {
  width: 100%;
  padding: 10px;
  background: var(--accent-primary);
  border: none;
  border-radius: 8px;
  color: white;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;
}

.train-btn:hover:not(:disabled) {
  background: #d63850;
  transform: scale(1.02);
}

.train-btn:disabled {
  background: #555;
  cursor: not-allowed;
}

/* Army */
.army-overview {
  background: var(--bg-tertiary);
  padding: 20px;
  border-radius: 10px;
  margin-bottom: 25px;
  text-align: center;
}

.army-overview h3 {
  color: var(--accent-gold);
  margin-bottom: 20px;
}

.power-stats {
  display: flex;
  justify-content: center;
  gap: 40px;
  flex-wrap: wrap;
}

.power-stat {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.power-icon {
  font-size: 2rem;
  margin-bottom: 5px;
}

.power-value {
  font-size: 1.8rem;
  font-weight: bold;
  color: var(--accent-secondary);
}

.power-label {
  font-size: 0.9rem;
  color: var(--text-secondary);
}

.army-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 15px;
}

.army-unit {
  padding: 15px;
  background: var(--bg-tertiary);
  border-radius: 10px;
  border: 2px solid var(--accent-secondary);
  text-align: center;
}

.army-unit h4 {
  color: var(--accent-gold);
  margin-bottom: 5px;
}

.unit-count {
  font-size: 1.5rem;
  font-weight: bold;
  color: var(--accent-primary);
}

.unit-stats {
  display: flex;
  justify-content: center;
  gap: 15px;
  margin-top: 10px;
  font-size: 0.9rem;
}

/* Empty Messages */
.empty-message {
  text-align: center;
  color: var(--text-secondary);
  padding: 30px;
  font-style: italic;
}

/* Footer */
.game-footer {
  display: flex;
  justify-content: center;
  gap: 15px;
  margin-top: 20px;
  padding: 20px;
  background: var(--bg-secondary);
  border-radius: 15px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
}

.footer-btn {
  padding: 12px 25px;
  background: var(--bg-tertiary);
  border: 2px solid var(--accent-secondary);
  border-radius: 8px;
  color: var(--text-primary);
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.3s ease;
}

.footer-btn:hover {
  background: var(--accent-secondary);
  color: var(--bg-primary);
}

.footer-btn.danger {
  border-color: var(--danger);
}

.footer-btn.danger:hover {
  background: var(--danger);
}

/* Notification */
.notification {
  position: fixed;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%);
  padding: 15px 30px;
  background: var(--accent-secondary);
  color: var(--bg-primary);
  border-radius: 10px;
  font-weight: bold;
  animation: slideUp 0.3s ease;
  z-index: 1000;
}

.notification.fade-out {
  opacity: 0;
  transition: opacity 0.5s ease;
}

@keyframes slideUp {
  from {
    transform: translateX(-50%) translateY(50px);
    opacity: 0;
  }
  to {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
  }
}

/* Scrollbar Styling */
::-webkit-scrollbar {
  width: 10px;
}

::-webkit-scrollbar-track {
  background: var(--bg-primary);
  border-radius: 5px;
}

::-webkit-scrollbar-thumb {
  background: var(--bg-tertiary);
  border-radius: 5px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--accent-secondary);
}

/* Combat System Styles */
.combat-content {
  padding: 10px 0;
}

.combat-intro {
  margin-bottom: 15px;
  color: var(--text-secondary);
}

.army-power-summary {
  background: var(--bg-tertiary);
  padding: 12px 20px;
  border-radius: 8px;
  margin-bottom: 20px;
  font-weight: bold;
  color: var(--accent-gold);
}

.warning-message {
  background: rgba(255, 68, 68, 0.2);
  border: 2px solid var(--danger);
  padding: 15px;
  border-radius: 8px;
  margin-bottom: 20px;
  color: var(--danger);
  text-align: center;
}

.mission-era-section {
  margin-bottom: 30px;
}

.mission-era-section.locked {
  opacity: 0.6;
}

.mission-era-title {
  color: var(--accent-secondary);
  padding-bottom: 10px;
  border-bottom: 2px solid var(--bg-tertiary);
  margin-bottom: 15px;
}

.mission-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 15px;
}

.mission-card {
  padding: 18px;
  background: var(--bg-tertiary);
  border-radius: 10px;
  border: 2px solid transparent;
  transition: all 0.3s ease;
}

.mission-card:hover {
  border-color: var(--accent-secondary);
}

.mission-card.completed {
  border-color: var(--success);
  background: linear-gradient(135deg, var(--bg-tertiary) 0%, rgba(107, 203, 119, 0.1) 100%);
}

.mission-card.locked {
  opacity: 0.5;
  border-color: #444;
}

.mission-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.mission-header h5 {
  color: var(--accent-gold);
  font-size: 1.1rem;
  margin: 0;
}

.completed-badge {
  background: var(--success);
  color: var(--bg-primary);
  padding: 3px 8px;
  border-radius: 10px;
  font-size: 0.75rem;
  font-weight: bold;
}

.mission-desc {
  font-size: 0.85rem;
  color: var(--text-secondary);
  margin-bottom: 12px;
}

.enemy-stats {
  background: rgba(0, 0, 0, 0.2);
  padding: 10px;
  border-radius: 6px;
  margin-bottom: 10px;
}

.enemy-label {
  display: block;
  font-size: 0.85rem;
  color: var(--danger);
  margin-bottom: 5px;
}

.enemy-power {
  display: flex;
  gap: 15px;
  font-size: 0.9rem;
}

.difficulty-indicator {
  padding: 6px 12px;
  border-radius: 6px;
  font-size: 0.85rem;
  font-weight: bold;
  text-align: center;
  margin-bottom: 10px;
}

.difficulty-very-easy {
  background: rgba(107, 203, 119, 0.3);
  color: var(--success);
}

.difficulty-easy {
  background: rgba(78, 205, 196, 0.3);
  color: var(--accent-secondary);
}

.difficulty-medium {
  background: rgba(255, 217, 61, 0.3);
  color: var(--accent-gold);
}

.difficulty-hard {
  background: rgba(255, 140, 0, 0.3);
  color: var(--warning);
}

.difficulty-very-hard {
  background: rgba(255, 68, 68, 0.3);
  color: var(--danger);
}

.difficulty-extreme, .difficulty-impossible {
  background: rgba(139, 0, 0, 0.3);
  color: #ff6666;
}

.mission-rewards {
  margin-bottom: 12px;
}

.rewards-label {
  font-size: 0.85rem;
  color: var(--text-secondary);
  display: block;
  margin-bottom: 5px;
}

.rewards-list {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  font-size: 0.85rem;
  color: var(--accent-gold);
}

.mission-btn {
  width: 100%;
  padding: 12px;
  background: var(--accent-primary);
  border: none;
  border-radius: 8px;
  color: white;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;
}

.mission-btn:hover:not(:disabled) {
  background: #d63850;
  transform: scale(1.02);
}

.mission-btn:disabled, .mission-btn.disabled {
  background: #555;
  cursor: not-allowed;
}

/* Battle Arena Styles */
.battle-arena {
  background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-primary) 100%);
  border-radius: 15px;
  padding: 25px;
  border: 2px solid var(--accent-primary);
}

.battle-title {
  text-align: center;
  color: var(--accent-gold);
  font-size: 1.5rem;
  margin-bottom: 5px;
}

.battle-vs {
  text-align: center;
  color: var(--text-secondary);
  margin-bottom: 25px;
}

.battle-field {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 25px;
  gap: 20px;
}

.battle-side {
  flex: 1;
  text-align: center;
  padding: 20px;
  background: var(--bg-secondary);
  border-radius: 12px;
}

.player-side {
  border: 2px solid var(--accent-secondary);
}

.enemy-side {
  border: 2px solid var(--danger);
}

.army-icon {
  font-size: 4rem;
  margin-bottom: 10px;
  transition: all 0.3s ease;
}

.army-icon.victorious {
  transform: scale(1.1);
}

.army-icon.defeated {
  opacity: 0.5;
  filter: grayscale(100%);
}

.battle-side h4 {
  color: var(--text-primary);
  margin-bottom: 10px;
}

.health-bar-container {
  margin-top: 10px;
}

.health-bar {
  height: 20px;
  background: var(--bg-primary);
  border-radius: 10px;
  overflow: hidden;
  margin-bottom: 5px;
}

.health-fill {
  height: 100%;
  border-radius: 10px;
  transition: width 0.5s ease;
}

.player-health {
  background: linear-gradient(90deg, var(--accent-secondary) 0%, var(--success) 100%);
}

.enemy-health {
  background: linear-gradient(90deg, var(--danger) 0%, #ff8c00 100%);
}

.health-text {
  font-size: 0.85rem;
  color: var(--text-secondary);
}

.battle-center {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
}

.battle-clash {
  font-size: 3rem;
}

.battle-clash.animating {
  transform: scale(1.1);
}

.round-counter {
  font-weight: bold;
  color: var(--accent-gold);
}

/* Battle Log */
.battle-log-container {
  background: var(--bg-secondary);
  border-radius: 10px;
  padding: 15px;
  margin-bottom: 20px;
}

.battle-log-container h4 {
  color: var(--accent-secondary);
  margin-bottom: 10px;
}

.battle-log {
  max-height: 200px;
  overflow-y: auto;
  padding: 10px;
  background: var(--bg-primary);
  border-radius: 8px;
}

.log-entry {
  padding: 8px;
  margin-bottom: 5px;
  background: var(--bg-tertiary);
  border-radius: 5px;
  font-size: 0.9rem;
  display: flex;
  align-items: center;
  gap: 10px;
  opacity: 0.8;
  transition: all 0.3s ease;
}

.log-entry.latest {
  opacity: 1;
  border-left: 3px solid var(--accent-primary);
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

.log-round {
  color: var(--accent-gold);
  font-weight: bold;
  min-width: 70px;
}

.log-damage {
  flex: 1;
}

.player-damage {
  color: var(--success);
}

.enemy-damage {
  color: var(--danger);
}

.log-separator {
  color: var(--text-secondary);
}

/* Battle Result */
.battle-result {
  padding: 25px;
  border-radius: 12px;
  text-align: center;
  margin-bottom: 20px;
  animation: resultPopup 0.5s ease;
}

@keyframes resultPopup {
  from { transform: scale(0.8); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}

.battle-result.victory {
  background: linear-gradient(135deg, rgba(107, 203, 119, 0.2) 0%, rgba(78, 205, 196, 0.2) 100%);
  border: 2px solid var(--success);
}

.battle-result.defeat {
  background: linear-gradient(135deg, rgba(255, 68, 68, 0.2) 0%, rgba(139, 0, 0, 0.2) 100%);
  border: 2px solid var(--danger);
}

.battle-result h3 {
  font-size: 2rem;
  margin-bottom: 10px;
}

.battle-result.victory h3 {
  color: var(--success);
}

.battle-result.defeat h3 {
  color: var(--danger);
}

.casualty-report {
  color: var(--warning);
  margin-bottom: 15px;
}

.battle-rewards {
  background: rgba(0, 0, 0, 0.2);
  padding: 15px;
  border-radius: 8px;
  margin-bottom: 15px;
}

.battle-rewards h4 {
  color: var(--accent-gold);
  margin-bottom: 10px;
}

.battle-rewards .rewards-list {
  justify-content: center;
  font-size: 1rem;
}

.dismiss-battle-btn {
  padding: 12px 30px;
  background: var(--accent-secondary);
  border: none;
  border-radius: 8px;
  color: var(--bg-primary);
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;
}

.dismiss-battle-btn:hover {
  background: #3dbdb5;
  transform: scale(1.02);
}

/* Battle Controls */
.battle-controls {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 15px;
  padding: 15px;
  background: var(--bg-secondary);
  border-radius: 8px;
}

.battle-controls label {
  color: var(--text-secondary);
}

.battle-controls input[type="range"] {
  width: 150px;
  accent-color: var(--accent-primary);
}

#speed-display {
  color: var(--accent-gold);
  min-width: 60px;
}

/* Responsive */
@media (max-width: 768px) {
  .game-header h1 {
    font-size: 1.8rem;
  }
  
  .resources-bar {
    justify-content: center;
  }
  
  .resource {
    min-width: 80px;
  }
  
  .tab-btn {
    min-width: 80px;
    padding: 10px 15px;
    font-size: 0.9rem;
  }
  
  .tech-grid,
  .troop-grid,
  .army-grid,
  .mission-grid {
    grid-template-columns: 1fr;
  }
  
  .power-stats {
    gap: 20px;
  }
  
  .battle-field {
    flex-direction: column;
  }
  
  .battle-side {
    width: 100%;
  }
  
  .army-icon {
    font-size: 3rem;
  }
}

/* ===== Achievements & Statistics Styles ===== */

/* Statistics Section */
.statistics-section {
  background: var(--bg-tertiary);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 25px;
}

.statistics-section h3 {
  color: var(--accent-gold);
  margin-bottom: 15px;
  padding-bottom: 10px;
  border-bottom: 2px solid var(--bg-secondary);
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  gap: 12px;
}

.stat-card {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 15px 10px;
  background: var(--bg-secondary);
  border-radius: 10px;
  transition: transform 0.2s ease;
}

.stat-card:hover {
  transform: translateY(-2px);
}

.stat-icon {
  font-size: 1.8rem;
  margin-bottom: 5px;
}

.stat-value {
  font-size: 1.3rem;
  font-weight: bold;
  color: var(--accent-secondary);
}

.stat-label {
  font-size: 0.8rem;
  color: var(--text-secondary);
  text-align: center;
}

/* Achievement Progress Bar */
.achievement-progress-bar {
  position: relative;
  height: 30px;
  background: var(--bg-tertiary);
  border-radius: 15px;
  overflow: hidden;
  margin-bottom: 25px;
}

.achievement-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent-primary) 0%, var(--accent-gold) 100%);
  border-radius: 15px;
  transition: width 0.5s ease;
}

.achievement-progress-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: white;
  font-weight: bold;
  text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
}

/* Achievement Categories */
.achievement-category {
  margin-bottom: 25px;
}

.achievement-category h4 {
  color: var(--accent-secondary);
  margin-bottom: 15px;
  padding-bottom: 8px;
  border-bottom: 2px solid var(--bg-tertiary);
}

.achievement-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 12px;
}

.achievement-card {
  display: flex;
  align-items: center;
  padding: 15px;
  background: var(--bg-tertiary);
  border-radius: 10px;
  border: 2px solid transparent;
  position: relative;
  transition: all 0.3s ease;
}

.achievement-card.unlocked {
  border-color: var(--accent-gold);
  background: linear-gradient(135deg, var(--bg-tertiary) 0%, rgba(255, 217, 61, 0.1) 100%);
}

.achievement-card.locked {
  opacity: 0.6;
}

.achievement-card:hover {
  transform: translateY(-2px);
}

.achievement-icon {
  font-size: 2.5rem;
  margin-right: 15px;
  min-width: 50px;
  text-align: center;
}

.achievement-info {
  flex: 1;
}

.achievement-info h5 {
  color: var(--text-primary);
  margin-bottom: 4px;
  font-size: 1rem;
}

.achievement-info p {
  color: var(--text-secondary);
  font-size: 0.85rem;
  margin-bottom: 5px;
}

.achievement-reward {
  display: inline-block;
  background: rgba(255, 217, 61, 0.2);
  color: var(--accent-gold);
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 0.75rem;
}

.achievement-badge {
  position: absolute;
  top: 10px;
  right: 10px;
  background: var(--success);
  color: var(--bg-primary);
  width: 24px;
  height: 24px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 0.8rem;
}

/* Achievement Popup */
.achievement-popup {
  position: fixed;
  top: 20px;
  right: -400px;
  width: 350px;
  background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
  border: 2px solid var(--accent-gold);
  border-radius: 15px;
  padding: 20px;
  z-index: 2000;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
  transition: right 0.5s ease;
}

.achievement-popup.show {
  right: 20px;
}

.achievement-popup-content {
  display: flex;
  align-items: center;
}

.achievement-popup-icon {
  font-size: 3rem;
  margin-right: 15px;
  animation: achievementBounce 0.5s ease;
}

@keyframes achievementBounce {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.2); }
}

.achievement-popup-info h4 {
  color: var(--accent-gold);
  font-size: 0.85rem;
  margin-bottom: 5px;
}

.achievement-popup-info h5 {
  color: var(--text-primary);
  font-size: 1.1rem;
  margin-bottom: 5px;
}

.achievement-popup-info p {
  color: var(--text-secondary);
  font-size: 0.85rem;
}

/* Offline Progress Popup */
.offline-popup-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 3000;
  animation: fadeIn 0.3s ease;
}

.offline-popup-overlay.fade-out {
  animation: fadeOut 0.3s ease forwards;
}

@keyframes fadeOut {
  from { opacity: 1; }
  to { opacity: 0; }
}

.offline-popup {
  background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
  border: 2px solid var(--accent-secondary);
  border-radius: 20px;
  padding: 30px 40px;
  max-width: 450px;
  text-align: center;
  animation: popupBounce 0.3s ease;
}

@keyframes popupBounce {
  0% { transform: scale(0.8); opacity: 0; }
  100% { transform: scale(1); opacity: 1; }
}

.offline-popup h3 {
  color: var(--accent-gold);
  font-size: 1.8rem;
  margin-bottom: 10px;
}

.offline-popup p {
  color: var(--text-secondary);
  margin-bottom: 10px;
}

.offline-subtitle {
  color: var(--text-primary) !important;
  font-weight: bold;
}

.offline-rewards {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 15px;
  margin: 20px 0;
  padding: 15px;
  background: var(--bg-primary);
  border-radius: 10px;
}

.offline-rewards span {
  color: var(--accent-gold);
  font-size: 1.1rem;
  font-weight: bold;
}

.offline-note {
  font-size: 0.8rem !important;
  color: var(--text-secondary) !important;
  font-style: italic;
  margin-bottom: 20px !important;
}

.offline-dismiss-btn {
  padding: 12px 30px;
  background: var(--accent-secondary);
  border: none;
  border-radius: 10px;
  color: var(--bg-primary);
  font-size: 1rem;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;
}

.offline-dismiss-btn:hover {
  background: #3dbdb5;
  transform: scale(1.05);
}

/* Responsive adjustments for new features */
@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
  }
  
  .achievement-grid {
    grid-template-columns: 1fr;
  }
  
  .achievement-popup {
    width: calc(100% - 40px);
    right: -100%;
  }
  
  .achievement-popup.show {
    right: 20px;
  }
  
  .offline-popup {
    margin: 20px;
    padding: 20px;
  }
}

/* ===== Buildings System Styles ===== */

/* Construction Queue */
.construction-queue {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-bottom: 25px;
}

.construction-item {
  display: flex;
  align-items: center;
  gap: 15px;
  padding: 12px;
  background: var(--bg-tertiary);
  border-radius: 8px;
}

.construction-item span:first-child {
  min-width: 150px;
  color: var(--accent-gold);
}

.construction-item .progress-bar {
  flex: 1;
}

/* Building Overview */
.building-overview {
  background: var(--bg-tertiary);
  padding: 20px;
  border-radius: 12px;
  margin-bottom: 25px;
}

.building-overview h3 {
  color: var(--accent-gold);
  margin-bottom: 15px;
}

.production-stats {
  display: flex;
  flex-wrap: wrap;
  gap: 15px;
}

.production-stat {
  padding: 8px 15px;
  background: var(--bg-secondary);
  border-radius: 8px;
  color: var(--success);
  font-weight: bold;
}

/* Building Grid */
.building-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
}

.building-card {
  padding: 15px;
  background: var(--bg-tertiary);
  border-radius: 10px;
  border: 2px solid transparent;
  transition: all 0.3s ease;
}

.building-card.available {
  border-color: var(--success);
  box-shadow: 0 0 10px rgba(107, 203, 119, 0.3);
}

.building-card.maxed {
  border-color: var(--accent-gold);
  background: linear-gradient(135deg, var(--bg-tertiary) 0%, rgba(255, 217, 61, 0.1) 100%);
}

.building-card.locked {
  opacity: 0.7;
  border-color: var(--danger);
}

.building-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.building-header h5 {
  color: var(--accent-gold);
  margin: 0;
  font-size: 1.1rem;
}

.building-count {
  background: var(--bg-secondary);
  padding: 4px 10px;
  border-radius: 15px;
  font-size: 0.85rem;
  color: var(--accent-secondary);
}

.building-desc {
  font-size: 0.85rem;
  color: var(--text-secondary);
  margin-bottom: 12px;
}

.building-production {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 10px;
  font-size: 0.85rem;
}

.building-production .label {
  color: var(--text-secondary);
  width: 100%;
  margin-bottom: 2px;
}

.building-production span:not(.label) {
  color: var(--success);
}

.building-cost {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 10px;
  font-size: 0.85rem;
}

.building-cost .label {
  color: var(--text-secondary);
  width: 100%;
  margin-bottom: 2px;
}

.building-cost span:not(.label) {
  color: var(--accent-gold);
}

.build-time {
  font-size: 0.8rem;
  color: var(--text-secondary);
  margin-bottom: 10px;
}

.build-btn {
  width: 100%;
  padding: 10px;
  background: var(--accent-secondary);
  border: none;
  border-radius: 8px;
  color: var(--bg-primary);
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;
}

.build-btn:hover:not(:disabled) {
  background: #3dbdb5;
  transform: scale(1.02);
}

.build-btn:disabled {
  background: #555;
  cursor: not-allowed;
}

/* Buildings Tab Era Section */
.buildings-content .era-section {
  margin-bottom: 25px;
}

.buildings-content .era-section h4 {
  color: var(--accent-secondary);
  padding-bottom: 10px;
  border-bottom: 2px solid var(--bg-tertiary);
  margin-bottom: 15px;
}

/* Responsive adjustments for buildings */
@media (max-width: 768px) {
  .building-grid {
    grid-template-columns: 1fr;
  }
  
  .production-stats {
    flex-direction: column;
    gap: 8px;
  }
}

/* ===== Conquest Mode Styles ===== */

/* Mode Toggle */
.combat-mode-toggle {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
  justify-content: center;
}

.mode-toggle-btn {
  padding: 12px 25px;
  background: var(--bg-tertiary);
  border: 2px solid var(--bg-tertiary);
  border-radius: 8px;
  color: var(--text-primary);
  font-size: 1rem;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;
}

.mode-toggle-btn:hover {
  background: var(--bg-secondary);
  border-color: var(--accent-secondary);
}

.mode-toggle-btn.active {
  background: var(--accent-primary);
  border-color: var(--accent-primary);
}

/* Conquest Overview */
.conquest-overview {
  background: var(--bg-tertiary);
  padding: 20px;
  border-radius: 12px;
  margin-bottom: 25px;
}

.conquest-progress {
  margin-bottom: 15px;
}

.conquest-progress span {
  display: block;
  color: var(--accent-gold);
  font-weight: bold;
  margin-bottom: 8px;
}

.conquest-bonuses h4 {
  color: var(--accent-secondary);
  margin-bottom: 10px;
}

.bonuses-list {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
}

.bonus-item {
  padding: 6px 12px;
  background: var(--bg-secondary);
  border-radius: 8px;
  color: var(--success);
  font-weight: bold;
}

.bonus-item.multiplier {
  color: var(--accent-gold);
  background: rgba(255, 217, 61, 0.15);
}

.no-bonuses {
  color: var(--text-secondary);
  font-style: italic;
}

/* Territory Cards */
.territory-era-section {
  margin-bottom: 30px;
}

.territory-era-section.locked {
  opacity: 0.6;
}

.territory-era-title {
  color: var(--accent-secondary);
  padding-bottom: 10px;
  border-bottom: 2px solid var(--bg-tertiary);
  margin-bottom: 15px;
}

.territory-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 15px;
}

.territory-card {
  padding: 18px;
  background: var(--bg-tertiary);
  border-radius: 10px;
  border: 2px solid transparent;
  transition: all 0.3s ease;
}

.territory-card:hover {
  border-color: var(--accent-secondary);
}

.territory-card.conquered {
  border-color: var(--success);
  background: linear-gradient(135deg, var(--bg-tertiary) 0%, rgba(107, 203, 119, 0.15) 100%);
}

.territory-card.locked {
  opacity: 0.5;
  border-color: #444;
}

.territory-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.territory-header h5 {
  color: var(--accent-gold);
  font-size: 1.1rem;
  margin: 0;
}

.conquered-badge {
  background: var(--success);
  color: var(--bg-primary);
  padding: 3px 8px;
  border-radius: 10px;
  font-size: 0.75rem;
  font-weight: bold;
}

.territory-desc {
  font-size: 0.85rem;
  color: var(--text-secondary);
  margin-bottom: 12px;
}

.territory-bonus {
  background: rgba(255, 217, 61, 0.1);
  border: 1px solid rgba(255, 217, 61, 0.3);
  padding: 10px;
  border-radius: 6px;
  margin-bottom: 12px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.territory-bonus .bonus-label {
  font-size: 0.8rem;
  color: var(--text-secondary);
}

.territory-bonus .bonus-value {
  color: var(--accent-gold);
  font-weight: bold;
}

.territory-rewards {
  margin-bottom: 12px;
}

.territory-btn {
  width: 100%;
  padding: 12px;
  background: var(--accent-secondary);
  border: none;
  border-radius: 8px;
  color: var(--bg-primary);
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;
}

.territory-btn:hover:not(:disabled) {
  background: #3dbdb5;
  transform: scale(1.02);
}

.territory-btn:disabled, .territory-btn.disabled {
  background: #555;
  cursor: not-allowed;
}

/* Conquest Battle Specific */
.conquest-battle {
  border-color: var(--accent-secondary);
}

.conquest-reward {
  background: rgba(255, 217, 61, 0.15);
  border: 2px solid var(--accent-gold);
  padding: 15px;
  border-radius: 10px;
  margin-bottom: 15px;
  text-align: center;
}

.conquest-reward h4 {
  color: var(--accent-gold);
  margin-bottom: 8px;
}

.bonus-unlocked {
  font-size: 1.3rem;
  color: var(--success);
  font-weight: bold;
}

/* Responsive adjustments for conquest mode */
@media (max-width: 768px) {
  .territory-grid {
    grid-template-columns: 1fr;
  }
  
  .combat-mode-toggle {
    flex-direction: column;
  }
  
  .mode-toggle-btn {
    width: 100%;
  }
  
  .bonuses-list {
    flex-direction: column;
    gap: 8px;
  }
}

/* ===== Skill Tree Styles ===== */

/* Skill Overview */
.skill-overview {
  background: var(--bg-tertiary);
  padding: 20px;
  border-radius: 12px;
  margin-bottom: 25px;
  text-align: center;
}

.legacy-points-display {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 15px;
  margin-bottom: 10px;
}

.legacy-icon {
  font-size: 2.5rem;
}

.legacy-label {
  font-size: 1.2rem;
  color: var(--text-secondary);
}

.legacy-value {
  font-size: 2rem;
  font-weight: bold;
  color: var(--accent-gold);
}

.legacy-stats {
  display: flex;
  justify-content: center;
  gap: 30px;
  color: var(--text-secondary);
  font-size: 0.9rem;
}

/* Skill Bonuses Summary */
.skill-bonuses-summary {
  background: var(--bg-tertiary);
  padding: 20px;
  border-radius: 12px;
  margin-bottom: 25px;
}

.skill-bonuses-summary h4 {
  color: var(--accent-secondary);
  margin-bottom: 15px;
}

.skill-bonuses-summary .no-bonuses {
  color: var(--text-secondary);
  font-style: italic;
}

.bonuses-grid {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.bonus-group {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 10px;
}

.bonus-group-label {
  color: var(--text-secondary);
  font-size: 0.9rem;
  min-width: 140px;
}

.bonus-value {
  background: var(--bg-secondary);
  padding: 4px 10px;
  border-radius: 6px;
  color: var(--success);
  font-weight: bold;
  font-size: 0.85rem;
}

/* Skill Categories */
.skill-category {
  margin-bottom: 30px;
}

.skill-category h4 {
  color: var(--accent-secondary);
  padding-bottom: 10px;
  border-bottom: 2px solid var(--bg-tertiary);
  margin-bottom: 15px;
}

.skill-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
  gap: 15px;
}

/* Skill Cards */
.skill-card {
  padding: 18px;
  background: var(--bg-tertiary);
  border-radius: 10px;
  border: 2px solid transparent;
  transition: all 0.3s ease;
}

.skill-card:hover {
  transform: translateY(-2px);
}

.skill-card.locked {
  opacity: 0.6;
  border-color: #444;
}

.skill-card.affordable {
  opacity: 0.8;
  border-color: var(--warning);
}

.skill-card.available {
  border-color: var(--success);
  box-shadow: 0 0 10px rgba(107, 203, 119, 0.3);
}

.skill-card.maxed {
  border-color: var(--accent-gold);
  background: linear-gradient(135deg, var(--bg-tertiary) 0%, rgba(255, 217, 61, 0.1) 100%);
}

.skill-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
}

.skill-icon {
  font-size: 1.8rem;
}

.skill-header h5 {
  flex: 1;
  color: var(--accent-gold);
  font-size: 1rem;
  margin: 0;
}

.skill-level {
  background: var(--bg-secondary);
  padding: 4px 10px;
  border-radius: 10px;
  font-size: 0.85rem;
  color: var(--accent-secondary);
  font-weight: bold;
}

.skill-desc {
  font-size: 0.85rem;
  color: var(--text-secondary);
  margin-bottom: 12px;
  line-height: 1.4;
}

.skill-effect {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: rgba(0, 0, 0, 0.2);
  padding: 8px 12px;
  border-radius: 6px;
  margin-bottom: 10px;
}

.effect-label {
  color: var(--text-secondary);
  font-size: 0.85rem;
}

.effect-value {
  color: var(--success);
  font-weight: bold;
  font-size: 0.9rem;
}

.skill-prereq {
  display: block;
  font-size: 0.8rem;
  color: var(--warning);
  margin-bottom: 10px;
  font-style: italic;
}

.skill-cost {
  font-size: 0.9rem;
  color: var(--accent-gold);
  margin-bottom: 10px;
  text-align: center;
}

.skill-btn {
  width: 100%;
  padding: 10px;
  background: var(--accent-secondary);
  border: none;
  border-radius: 8px;
  color: var(--bg-primary);
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;
}

.skill-btn:hover:not(:disabled) {
  background: #3dbdb5;
  transform: scale(1.02);
}

.skill-btn:disabled {
  background: #555;
  cursor: not-allowed;
}

.skill-maxed {
  text-align: center;
  padding: 10px;
  background: rgba(255, 217, 61, 0.2);
  border-radius: 8px;
  color: var(--accent-gold);
  font-weight: bold;
}

/* Legacy Milestones */
.legacy-milestones {
  margin-top: 30px;
}

.legacy-milestones h3 {
  color: var(--accent-gold);
  margin-bottom: 10px;
}

.legacy-milestones > p {
  color: var(--text-secondary);
  margin-bottom: 20px;
}

.milestone-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 15px;
}

.milestone-card {
  padding: 15px;
  background: var(--bg-tertiary);
  border-radius: 10px;
  border: 2px solid transparent;
  transition: all 0.3s ease;
}

.milestone-card:hover {
  transform: translateY(-2px);
}

.milestone-card.completed {
  border-color: var(--success);
  background: linear-gradient(135deg, var(--bg-tertiary) 0%, rgba(107, 203, 119, 0.1) 100%);
}

.milestone-card.available {
  border-color: var(--accent-gold);
  box-shadow: 0 0 10px rgba(255, 217, 61, 0.3);
}

.milestone-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 8px;
}

.milestone-icon {
  font-size: 1.5rem;
}

.milestone-header h5 {
  color: var(--text-primary);
  font-size: 1rem;
  margin: 0;
}

.milestone-desc {
  font-size: 0.85rem;
  color: var(--text-secondary);
  margin-bottom: 10px;
}

.milestone-reward {
  font-size: 0.9rem;
  color: var(--accent-gold);
  margin-bottom: 8px;
}

.milestone-repeatable {
  display: block;
  font-size: 0.8rem;
  color: var(--accent-secondary);
  font-style: italic;
}

.milestone-complete-badge {
  display: inline-block;
  background: var(--success);
  color: var(--bg-primary);
  padding: 4px 10px;
  border-radius: 10px;
  font-size: 0.8rem;
  font-weight: bold;
}

/* Responsive adjustments for skill tree */
@media (max-width: 768px) {
  .skill-grid,
  .milestone-grid {
    grid-template-columns: 1fr;
  }
  
  .legacy-stats {
    flex-direction: column;
    gap: 5px;
  }
  
  .bonus-group {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .bonus-group-label {
    min-width: auto;
  }
}

/* ===== Military Tab Styles ===== */
.military-content {
  padding: 10px 0;
}

.military-section {
  background: var(--bg-tertiary);
  border-radius: 10px;
  padding: 20px;
  margin-bottom: 20px;
}

.military-section h3 {
  color: var(--accent-gold);
  margin-bottom: 15px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.military-section h4 {
  color: var(--accent-secondary);
  margin: 15px 0 10px 0;
}

/* Military Overview Panel */
.military-overview {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
}

.military-stat {
  background: var(--bg-secondary);
  padding: 15px;
  border-radius: 8px;
  text-align: center;
}

.military-stat-icon {
  font-size: 2rem;
  display: block;
  margin-bottom: 5px;
}

.military-stat-value {
  font-size: 1.5rem;
  font-weight: bold;
  color: var(--accent-gold);
}

.military-stat-label {
  font-size: 0.85rem;
  color: var(--text-secondary);
}

/* Formation Grid */
.formation-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 15px;
}

.formation-card {
  background: var(--bg-secondary);
  border: 2px solid var(--bg-tertiary);
  border-radius: 10px;
  padding: 15px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.formation-card:hover {
  border-color: var(--accent-secondary);
}

.formation-card.active {
  border-color: var(--accent-gold);
  background: rgba(255, 217, 61, 0.1);
}

.formation-card.locked {
  opacity: 0.5;
  cursor: not-allowed;
}

.formation-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
}

.formation-icon {
  font-size: 1.5rem;
}

.formation-name {
  font-weight: bold;
}

.formation-desc {
  font-size: 0.9rem;
  color: var(--text-secondary);
  margin-bottom: 10px;
}

.formation-stats {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  font-size: 0.85rem;
}

.formation-stat {
  padding: 3px 8px;
  border-radius: 4px;
  background: var(--bg-tertiary);
}

.formation-stat.positive {
  color: var(--success);
}

.formation-stat.negative {
  color: var(--danger);
}

.formation-special {
  margin-top: 10px;
  font-size: 0.85rem;
  color: var(--accent-secondary);
}

/* Hero Grid */
.hero-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 15px;
}

.hero-card {
  background: var(--bg-secondary);
  border: 2px solid var(--bg-tertiary);
  border-radius: 10px;
  padding: 15px;
  transition: all 0.3s ease;
}

.hero-card.available {
  border-color: var(--accent-secondary);
}

.hero-card.recruited {
  border-color: var(--success);
  background: rgba(107, 203, 119, 0.1);
}

.hero-card.active {
  border-color: var(--accent-gold);
  background: rgba(255, 217, 61, 0.15);
}

.hero-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 10px;
}

.hero-icon {
  font-size: 2rem;
}

.hero-info h5 {
  margin: 0;
  color: var(--accent-gold);
}

.hero-title {
  font-size: 0.8rem;
  color: var(--text-secondary);
}

.hero-desc {
  font-size: 0.9rem;
  color: var(--text-secondary);
  margin-bottom: 10px;
}

.hero-bonuses {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  font-size: 0.85rem;
  margin-bottom: 10px;
}

.hero-bonus {
  padding: 3px 8px;
  border-radius: 4px;
  background: var(--bg-tertiary);
  color: var(--success);
}

.hero-ability {
  font-size: 0.85rem;
  color: var(--accent-secondary);
  margin-bottom: 10px;
}

.hero-cost {
  display: flex;
  gap: 15px;
  font-size: 0.85rem;
  margin-bottom: 10px;
}

.hero-btn {
  width: 100%;
  padding: 10px;
  background: var(--accent-secondary);
  border: none;
  border-radius: 6px;
  color: var(--bg-primary);
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;
}

.hero-btn:hover:not(:disabled) {
  background: var(--success);
}

.hero-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.hero-btn.set-active {
  background: var(--accent-gold);
}

/* Defense Grid */
.defense-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 15px;
}

.defense-card {
  background: var(--bg-secondary);
  border: 2px solid var(--bg-tertiary);
  border-radius: 10px;
  padding: 15px;
  transition: all 0.3s ease;
}

.defense-card.available {
  border-color: var(--accent-secondary);
}

.defense-card.maxed {
  border-color: var(--success);
  opacity: 0.7;
}

.defense-card.locked {
  opacity: 0.5;
}

.defense-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 10px;
}

.defense-header h5 {
  display: flex;
  align-items: center;
  gap: 8px;
}

.defense-count {
  font-size: 0.9rem;
  color: var(--accent-gold);
}

.defense-desc {
  font-size: 0.9rem;
  color: var(--text-secondary);
  margin-bottom: 10px;
}

.defense-bonuses {
  display: flex;
  gap: 15px;
  font-size: 0.85rem;
  margin-bottom: 10px;
}

.defense-cost {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  font-size: 0.85rem;
  margin-bottom: 10px;
}

.build-defense-btn {
  width: 100%;
  padding: 8px;
  background: var(--accent-primary);
  border: none;
  border-radius: 6px;
  color: white;
  cursor: pointer;
  transition: all 0.3s ease;
}

.build-defense-btn:hover:not(:disabled) {
  opacity: 0.9;
  transform: scale(1.02);
}

.build-defense-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Naval and Siege Grid */
.naval-grid, .siege-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 15px;
}

.naval-card, .siege-card {
  background: var(--bg-secondary);
  border: 2px solid var(--bg-tertiary);
  border-radius: 10px;
  padding: 15px;
  transition: all 0.3s ease;
}

.naval-card.available, .siege-card.available {
  border-color: var(--accent-secondary);
}

.naval-header, .siege-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 8px;
}

.naval-icon, .siege-icon {
  font-size: 1.5rem;
}

.naval-desc, .siege-desc {
  font-size: 0.85rem;
  color: var(--text-secondary);
  margin-bottom: 10px;
}

.naval-stats, .siege-stats {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  font-size: 0.85rem;
  margin-bottom: 10px;
}

.naval-cost, .siege-cost {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  font-size: 0.85rem;
  margin-bottom: 10px;
}

.train-naval-btn, .train-siege-btn {
  width: 100%;
  padding: 8px;
  background: var(--accent-secondary);
  border: none;
  border-radius: 6px;
  color: var(--bg-primary);
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;
}

.train-naval-btn:hover:not(:disabled), .train-siege-btn:hover:not(:disabled) {
  background: var(--success);
}

.train-naval-btn:disabled, .train-siege-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Unit Upgrade Grid */
.upgrade-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 15px;
}

.upgrade-card {
  background: var(--bg-secondary);
  border: 2px solid var(--bg-tertiary);
  border-radius: 10px;
  padding: 15px;
  transition: all 0.3s ease;
}

.upgrade-card.available {
  border-color: var(--accent-secondary);
}

.upgrade-arrow {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 15px;
  margin-bottom: 10px;
}

.upgrade-from, .upgrade-to {
  padding: 8px 15px;
  background: var(--bg-tertiary);
  border-radius: 6px;
  text-align: center;
}

.upgrade-cost {
  display: flex;
  gap: 10px;
  justify-content: center;
  font-size: 0.85rem;
  margin-bottom: 10px;
}

.upgrade-btn {
  width: 100%;
  padding: 10px;
  background: var(--accent-gold);
  border: none;
  border-radius: 6px;
  color: var(--bg-primary);
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;
}

.upgrade-btn:hover:not(:disabled) {
  opacity: 0.9;
}

.upgrade-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Traditions Grid */
.traditions-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 15px;
}

.tradition-card {
  background: var(--bg-secondary);
  border: 2px solid var(--bg-tertiary);
  border-radius: 10px;
  padding: 15px;
  transition: all 0.3s ease;
}

.tradition-card.unlocked {
  border-color: var(--accent-gold);
  background: rgba(255, 217, 61, 0.1);
}

.tradition-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
}

.tradition-icon {
  font-size: 1.5rem;
}

.tradition-desc {
  font-size: 0.9rem;
  color: var(--text-secondary);
  margin-bottom: 10px;
}

.tradition-bonus {
  font-size: 0.85rem;
  color: var(--success);
  margin-bottom: 10px;
}

.tradition-requirement {
  font-size: 0.8rem;
  color: var(--text-secondary);
}

.tradition-requirement.met {
  color: var(--success);
}

/* Espionage Styles */
.spy-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
}

.spy-card {
  background: var(--bg-secondary);
  border: 2px solid var(--bg-tertiary);
  border-radius: 10px;
  padding: 15px;
}

.spy-card.busy {
  border-color: var(--warning);
}

.spy-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.spy-name {
  font-weight: bold;
}

.spy-level {
  font-size: 0.85rem;
  color: var(--accent-secondary);
}

.spy-status {
  font-size: 0.85rem;
  color: var(--text-secondary);
}

.spy-status.on-mission {
  color: var(--warning);
}

.spy-mission-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 15px;
}

.spy-mission-card {
  background: var(--bg-secondary);
  border: 2px solid var(--bg-tertiary);
  border-radius: 10px;
  padding: 15px;
}

.spy-mission-card.available {
  border-color: var(--accent-secondary);
}

.mission-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 8px;
}

.mission-icon {
  font-size: 1.5rem;
}

.mission-desc {
  font-size: 0.85rem;
  color: var(--text-secondary);
  margin-bottom: 10px;
}

.mission-stats {
  display: flex;
  justify-content: space-between;
  font-size: 0.85rem;
  margin-bottom: 10px;
}

.spy-mission-btn {
  width: 100%;
  padding: 8px;
  background: var(--accent-primary);
  border: none;
  border-radius: 6px;
  color: white;
  cursor: pointer;
  transition: all 0.3s ease;
}

.spy-mission-btn:hover:not(:disabled) {
  opacity: 0.9;
}

.spy-mission-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.recruit-spy-btn {
  padding: 12px 24px;
  background: var(--accent-secondary);
  border: none;
  border-radius: 6px;
  color: var(--bg-primary);
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;
}

.recruit-spy-btn:hover:not(:disabled) {
  background: var(--success);
}

.recruit-spy-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Training Queue Styles for Military */
.military-queue {
  background: var(--bg-secondary);
  padding: 15px;
  border-radius: 8px;
  margin-bottom: 15px;
}

.military-queue-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px;
  background: var(--bg-tertiary);
  border-radius: 6px;
  margin-bottom: 8px;
}

.military-queue-item:last-child {
  margin-bottom: 0;
}

/* Military Tab Responsive */
@media (max-width: 768px) {
  .military-overview {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .formation-grid,
  .hero-grid,
  .defense-grid,
  .naval-grid,
  .siege-grid,
  .upgrade-grid,
  .traditions-grid,
  .spy-grid,
  .spy-mission-grid {
    grid-template-columns: 1fr;
  }
  
  .formation-stats,
  .hero-bonuses,
  .defense-bonuses {
    justify-content: center;
  }
}

/* ===== Animated Battlefield Styles ===== */

.battlefield-container {
  position: relative;
  width: 100%;
  height: 350px;
  background: linear-gradient(180deg, 
    #2a4a3d 0%,
    #3a5a4d 30%,
    #4a6a5d 50%,
    #5a7a6d 70%,
    #6a8a7d 100%
  );
  border-radius: 15px;
  overflow: hidden;
  margin-bottom: 20px;
  border: 3px solid var(--bg-tertiary);
  box-shadow: inset 0 0 50px rgba(0,0,0,0.3);
}

/* Ground texture effect */
.battlefield-container::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-image: 
    radial-gradient(circle at 20% 80%, rgba(0,0,0,0.1) 0%, transparent 50%),
    radial-gradient(circle at 80% 20%, rgba(255,255,255,0.05) 0%, transparent 50%);
  pointer-events: none;
}

/* Battle lines */
.battlefield-center-line {
  position: absolute;
  left: 50%;
  top: 0;
  bottom: 0;
  width: 4px;
  background: rgba(255,255,255,0.1);
  transform: translateX(-50%);
}

/* Troop positions */
.battlefield-troops {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
}

.troop-unit {
  position: absolute;
  display: flex;
  flex-direction: column;
  align-items: center;
  font-size: 2rem;
  transition: all 0.4s ease-out;
  z-index: 10;
}

.troop-unit.player-troop {
  filter: drop-shadow(0 2px 4px rgba(78, 205, 196, 0.5));
}

.troop-unit.enemy-troop {
  filter: drop-shadow(0 2px 4px rgba(255, 68, 68, 0.5));
}

/* Troop count badge */
.troop-count {
  font-size: 0.7rem;
  background: rgba(0,0,0,0.7);
  color: white;
  padding: 1px 5px;
  border-radius: 8px;
  margin-top: -5px;
  font-weight: bold;
}

.player-troop .troop-count {
  background: var(--accent-secondary);
  color: var(--bg-primary);
}

.enemy-troop .troop-count {
  background: var(--danger);
  color: white;
}

/* Attack animation */
.troop-unit.attacking {
  animation: troopAttack 0.3s ease-in-out;
}

.player-troop.attacking {
  animation: playerAttack 0.4s ease-in-out;
}

.enemy-troop.attacking {
  animation: enemyAttack 0.4s ease-in-out;
}

@keyframes playerAttack {
  0% { transform: translateX(0); }
  50% { transform: translateX(40px) scale(1.2); }
  100% { transform: translateX(0); }
}

@keyframes enemyAttack {
  0% { transform: translateX(0); }
  50% { transform: translateX(-40px) scale(1.2); }
  100% { transform: translateX(0); }
}

/* Damage effect */
.troop-unit.hit {
  animation: hitEffect 0.3s ease-out;
}

@keyframes hitEffect {
  0% { filter: brightness(1); }
  50% { filter: brightness(2) sepia(1); }
  100% { filter: brightness(1); }
}

/* Death animation */
.troop-unit.dying {
  animation: deathEffect 0.5s ease-out forwards;
}

@keyframes deathEffect {
  0% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.5; transform: scale(1.2) rotate(15deg); }
  100% { opacity: 0; transform: scale(0) rotate(45deg); }
}

/* Damage numbers floating up */
.damage-popup {
  position: absolute;
  font-size: 1.2rem;
  font-weight: bold;
  color: #ff4444;
  text-shadow: 2px 2px 2px rgba(0,0,0,0.5);
  animation: damageFloat 1s ease-out forwards;
  pointer-events: none;
  z-index: 100;
}

.damage-popup.player-damage {
  color: var(--accent-secondary);
}

.damage-popup.enemy-damage {
  color: var(--danger);
}

@keyframes damageFloat {
  0% { 
    opacity: 1; 
    transform: translateY(0) scale(1);
  }
  100% { 
    opacity: 0; 
    transform: translateY(-50px) scale(1.5);
  }
}

/* Battle effects */
.battle-effect {
  position: absolute;
  pointer-events: none;
  z-index: 50;
}

.clash-effect {
  font-size: 3rem;
  animation: clashPulse 0.5s ease-out forwards;
}

@keyframes clashPulse {
  0% { opacity: 1; transform: scale(0.5); }
  50% { opacity: 1; transform: scale(1.5); }
  100% { opacity: 0; transform: scale(2); }
}

/* Side labels */
.battlefield-label {
  position: absolute;
  top: 10px;
  padding: 5px 15px;
  border-radius: 15px;
  font-weight: bold;
  font-size: 0.9rem;
  z-index: 20;
}

.battlefield-label.player-label {
  left: 15px;
  background: var(--accent-secondary);
  color: var(--bg-primary);
}

.battlefield-label.enemy-label {
  right: 15px;
  background: var(--danger);
  color: white;
}

/* Health bars on battlefield */
.battlefield-health {
  position: absolute;
  bottom: 15px;
  width: 40%;
  height: 25px;
  background: var(--bg-primary);
  border-radius: 12px;
  overflow: hidden;
  border: 2px solid rgba(255,255,255,0.2);
}

.battlefield-health.player-health-bar {
  left: 5%;
}

.battlefield-health.enemy-health-bar {
  right: 5%;
}

.battlefield-health-fill {
  height: 100%;
  transition: width 0.5s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}

.battlefield-health-fill.player {
  background: linear-gradient(90deg, var(--success) 0%, var(--accent-secondary) 100%);
}

.battlefield-health-fill.enemy {
  background: linear-gradient(90deg, var(--danger) 0%, #ff8c00 100%);
}

.battlefield-health-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: white;
  font-size: 0.75rem;
  font-weight: bold;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
}

/* Round indicator on battlefield */
.battlefield-round {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(0,0,0,0.7);
  padding: 8px 20px;
  border-radius: 20px;
  color: var(--accent-gold);
  font-weight: bold;
  font-size: 1.1rem;
  z-index: 30;
  border: 2px solid var(--accent-gold);
}

/* Victory/Defeat overlay */
.battlefield-result-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 100;
  animation: resultFadeIn 0.5s ease-out;
}

.battlefield-result-overlay.victory {
  background: radial-gradient(circle, rgba(107, 203, 119, 0.4) 0%, rgba(0,0,0,0.6) 100%);
}

.battlefield-result-overlay.defeat {
  background: radial-gradient(circle, rgba(255, 68, 68, 0.4) 0%, rgba(0,0,0,0.6) 100%);
}

.battlefield-result-text {
  font-size: 3rem;
  font-weight: bold;
  text-shadow: 3px 3px 6px rgba(0,0,0,0.8);
  animation: resultPulse 0.5s ease-out;
}

.victory .battlefield-result-text {
  color: var(--success);
}

.defeat .battlefield-result-text {
  color: var(--danger);
}

@keyframes resultFadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes resultPulse {
  0% { transform: scale(0.5); }
  50% { transform: scale(1.2); }
  100% { transform: scale(1); }
}

/* Troop class icons - different animations */
.troop-unit.cavalry .troop-icon {
  animation: cavalryBounce 0.5s ease-in-out infinite;
}

@keyframes cavalryBounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-3px); }
}

.troop-unit.air .troop-icon {
  animation: airFloat 2s ease-in-out infinite;
}

@keyframes airFloat {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-8px); }
}

.troop-unit.siege .troop-icon {
  animation: siegeRumble 0.3s ease-in-out infinite;
}

@keyframes siegeRumble {
  0%, 100% { transform: rotate(-1deg); }
  50% { transform: rotate(1deg); }
}

/* Battle log improvements */
.battle-log-compact {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  max-height: 120px;
  overflow-y: auto;
  padding: 10px;
  background: var(--bg-tertiary);
  border-radius: 8px;
}

.log-chip {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  padding: 4px 10px;
  border-radius: 15px;
  font-size: 0.8rem;
  background: var(--bg-secondary);
}

.log-chip.player-attack {
  border-left: 3px solid var(--accent-secondary);
}

.log-chip.enemy-attack {
  border-left: 3px solid var(--danger);
}

/* Responsive battlefield */
@media (max-width: 768px) {
  .battlefield-container {
    height: 280px;
  }
  
  .troop-unit {
    font-size: 1.5rem;
  }
  
  .battlefield-label {
    font-size: 0.75rem;
    padding: 4px 10px;
  }
  
  .battlefield-round {
    font-size: 0.9rem;
    padding: 6px 15px;
  }
  
  .battlefield-health {
    height: 20px;
    width: 35%;
  }
}

/* ===== Theme Toggle Styles ===== */

.theme-toggle-container {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 1000;
}

.theme-toggle-btn {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  border: 2px solid var(--accent-secondary);
  background: var(--bg-secondary);
  color: var(--accent-gold);
  font-size: 1.5rem;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
}

.theme-toggle-btn:hover {
  transform: scale(1.1);
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
}

.theme-toggle-btn:active {
  transform: scale(0.95);
}

/* Theme transition */
body {
  transition: background 0.3s ease, color 0.3s ease;
}

.game-header,
.resources-bar,
.tab-container,
.game-footer,
.resource,
.tab-btn,
.tech-card,
.building-card,
.troop-card,
.mission-card,
.achievement-card,
.skill-card {
  transition: background 0.3s ease, border-color 0.3s ease, color 0.3s ease;
}

/* ===== Enhanced Tooltips ===== */

.tooltip-container {
  position: relative;
}

.tooltip {
  position: absolute;
  bottom: calc(100% + 10px);
  left: 50%;
  transform: translateX(-50%);
  background: var(--tooltip-bg);
  color: var(--text-primary);
  padding: 12px 16px;
  border-radius: 8px;
  font-size: 0.85rem;
  z-index: 2000;
  pointer-events: none;
  opacity: 0;
  visibility: hidden;
  transition: all 0.2s ease;
  border: 1px solid var(--tooltip-border);
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
  max-width: 300px;
  white-space: normal;
  text-align: center;
}

.tooltip::after {
  content: '';
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%);
  border: 8px solid transparent;
  border-top-color: var(--tooltip-bg);
}

.tooltip-container:hover .tooltip,
[data-tooltip]:hover::before,
[data-tooltip]:hover::after {
  opacity: 1;
  visibility: visible;
}

/* Alternative tooltip using data attribute */
[data-tooltip] {
  position: relative;
  cursor: help;
}

[data-tooltip]::before {
  content: attr(data-tooltip);
  position: absolute;
  bottom: calc(100% + 10px);
  left: 50%;
  transform: translateX(-50%);
  background: var(--tooltip-bg);
  color: var(--text-primary);
  padding: 10px 14px;
  border-radius: 8px;
  font-size: 0.85rem;
  z-index: 2000;
  pointer-events: none;
  opacity: 0;
  visibility: hidden;
  transition: all 0.2s ease;
  border: 1px solid var(--tooltip-border);
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
  max-width: 280px;
  white-space: normal;
  text-align: center;
}

[data-tooltip]::after {
  content: '';
  position: absolute;
  bottom: calc(100% + 2px);
  left: 50%;
  transform: translateX(-50%);
  border: 8px solid transparent;
  border-top-color: var(--tooltip-bg);
  opacity: 0;
  visibility: hidden;
  transition: all 0.2s ease;
  z-index: 2001;
}

[data-tooltip]:hover::before,
[data-tooltip]:hover::after {
  opacity: 1;
  visibility: visible;
}

/* Tooltip for resources with detailed info */
.resource[data-tooltip]::before {
  max-width: 200px;
}

/* ===== Resource Gain Animation Effects ===== */

@keyframes resourceGainPulse {
  0% {
    transform: scale(1);
    box-shadow: 0 0 0 0 rgba(78, 205, 196, 0.4);
  }
  50% {
    transform: scale(1.05);
    box-shadow: 0 0 20px 5px rgba(78, 205, 196, 0.3);
  }
  100% {
    transform: scale(1);
    box-shadow: 0 0 0 0 rgba(78, 205, 196, 0);
  }
}

@keyframes resourceGainFloat {
  0% {
    opacity: 1;
    transform: translateY(0);
  }
  100% {
    opacity: 0;
    transform: translateY(-30px);
  }
}

@keyframes resourceGainGlow {
  0% {
    text-shadow: 0 0 0 var(--accent-gold);
  }
  50% {
    text-shadow: 0 0 10px var(--accent-gold), 0 0 20px var(--accent-gold);
  }
  100% {
    text-shadow: 0 0 0 var(--accent-gold);
  }
}

.resource.gain-animation {
  animation: resourceGainPulse 0.5s ease-out;
}

.resource-amount.gain-animation {
  animation: resourceGainGlow 0.5s ease-out;
}

/* Floating resource gain indicator */
.resource-gain-popup {
  position: absolute;
  top: -10px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 0.9rem;
  font-weight: bold;
  color: var(--success);
  pointer-events: none;
  animation: resourceGainFloat 1s ease-out forwards;
  z-index: 100;
}

/* Research progress animation */
@keyframes progressPulse {
  0%, 100% {
    box-shadow: 0 0 0 0 rgba(233, 69, 96, 0.4);
  }
  50% {
    box-shadow: 0 0 10px 3px rgba(233, 69, 96, 0.3);
  }
}

.current-research .progress-bar {
  animation: progressPulse 2s infinite;
}

/* Button click feedback */
@keyframes buttonClick {
  0% {
    transform: scale(1);
  }
  50% {
    transform: scale(0.95);
  }
  100% {
    transform: scale(1);
  }
}

.gather-btn:active,
.build-btn:active,
.train-btn:active,
.research-btn:active {
  animation: buttonClick 0.15s ease;
}

/* Success animation for completing actions */
@keyframes successFlash {
  0% {
    background: inherit;
  }
  50% {
    background: rgba(107, 203, 119, 0.3);
  }
  100% {
    background: inherit;
  }
}

.action-success {
  animation: successFlash 0.5s ease;
}

/* Era advancement celebration effect */
@keyframes eraAdvance {
  0% {
    transform: scale(1);
    filter: brightness(1);
  }
  25% {
    transform: scale(1.02);
    filter: brightness(1.2);
  }
  50% {
    transform: scale(1);
    filter: brightness(1);
  }
  75% {
    transform: scale(1.02);
    filter: brightness(1.2);
  }
  100% {
    transform: scale(1);
    filter: brightness(1);
  }
}

.era-advance-animation {
  animation: eraAdvance 1s ease;
}

/* Training/Construction queue progress animation */
@keyframes queueProgress {
  0% {
    background-position: 0% 50%;
  }
  100% {
    background-position: 100% 50%;
  }
}

.training-item .progress-fill,
.construction-item .progress-fill {
  background: linear-gradient(
    90deg, 
    var(--accent-primary) 0%, 
    var(--accent-secondary) 50%, 
    var(--accent-primary) 100%
  );
  background-size: 200% 100%;
  animation: queueProgress 2s linear infinite;
}

/* Tab switch animation */
.tab-content {
  opacity: 0;
  transform: translateY(10px);
  transition: opacity 0.2s ease, transform 0.2s ease;
}

.tab-content.active {
  opacity: 1;
  transform: translateY(0);
}

/* Responsive adjustments for theme toggle */
@media (max-width: 768px) {
  .theme-toggle-container {
    top: 10px;
    right: 10px;
  }
  
  .theme-toggle-btn {
    width: 40px;
    height: 40px;
    font-size: 1.2rem;
  }
  
  [data-tooltip]::before {
    max-width: 200px;
    font-size: 0.8rem;
  }
}

</style>
</head>
<body>
  <div class="game-container">
    <!-- Header with Era Info -->
    <header class="game-header">
      <h1> Civilization Builder</h1>
      <div class="era-info">
        <h2 id="current-era">Stone Age</h2>
        <p id="era-description">The dawn of civilization. Gather basic resources to survive.</p>
        <p id="era-progress">Era 1 of 11</p>
      </div>
    </header>

    <!-- Resources Bar -->
    <div class="resources-bar">
      <div class="resource">
        <span class="resource-icon"></span>
        <span class="resource-name">Food</span>
        <span class="resource-amount" id="food-amount">0</span>
        <span class="resource-rate" id="food-rate">+1/s</span>
      </div>
      <div class="resource">
        <span class="resource-icon"></span>
        <span class="resource-name">Wood</span>
        <span class="resource-amount" id="wood-amount">0</span>
        <span class="resource-rate" id="wood-rate">+1/s</span>
      </div>
      <div class="resource">
        <span class="resource-icon"></span>
        <span class="resource-name">Stone</span>
        <span class="resource-amount" id="stone-amount">0</span>
        <span class="resource-rate" id="stone-rate">+0.5/s</span>
      </div>
      <div class="resource">
        <span class="resource-icon"></span>
        <span class="resource-name">Gold</span>
        <span class="resource-amount" id="gold-amount">0</span>
        <span class="resource-rate" id="gold-rate">+0/s</span>
      </div>
      <div class="resource">
        <span class="resource-icon"></span>
        <span class="resource-name">Science</span>
        <span class="resource-amount" id="science-amount">0</span>
        <span class="resource-rate" id="science-rate">+0.1/s</span>
      </div>
    </div>

    <!-- Tab Navigation -->
    <nav class="tab-nav">
      <button class="tab-btn active" data-tab="resources"> Resources</button>
      <button class="tab-btn" data-tab="buildings"> Buildings</button>
      <button class="tab-btn" data-tab="research"> Research</button>
      <button class="tab-btn" data-tab="barracks"> Barracks</button>
      <button class="tab-btn" data-tab="army"> Army</button>
      <button class="tab-btn" data-tab="combat"> Combat</button>
      <button class="tab-btn" data-tab="world"> World</button>
      <button class="tab-btn" data-tab="skills"> Skills</button>
      <button class="tab-btn" data-tab="military"> Military</button>
      <button class="tab-btn" data-tab="achievements"> Achievements</button>
    </nav>

    <!-- Tab Content -->
    <main class="tab-container">
      <!-- Resources Tab -->
      <div id="resources-tab" class="tab-content active">
        <h2>Gather Resources</h2>
        <p>Click to manually gather resources. Research technologies to increase your rates!</p>
        <div id="gather-buttons" class="gather-buttons">
          <button id="gather-food" class="gather-btn"> Gather Food (+1)</button>
          <button id="gather-wood" class="gather-btn"> Gather Wood (+1)</button>
          <button id="gather-stone" class="gather-btn"> Gather Stone (+1)</button>
        </div>
      </div>

      <!-- Buildings Tab -->
      <div id="buildings-tab" class="tab-content">
        <h2> Buildings & Infrastructure</h2>
        <p>Construct buildings to boost your resource production. Research technologies to unlock more buildings!</p>
        <div id="buildings-content" class="buildings-content">
          <!-- Filled dynamically -->
        </div>
      </div>

      <!-- Research Tab -->
      <div id="research-tab" class="tab-content">
        <h2>Research Tree</h2>
        <p>Research new technologies to advance your civilization through the ages!</p>
        <div id="research-tree" class="research-tree">
          <!-- Filled dynamically -->
        </div>
      </div>

      <!-- Barracks Tab -->
      <div id="barracks-tab" class="tab-content">
        <h2>Barracks</h2>
        <p>Train troops to build your army. Unlock new units through research!</p>
        <div id="barracks-content" class="barracks-content">
          <!-- Filled dynamically -->
        </div>
      </div>

      <!-- Army Tab -->
      <div id="army-tab" class="tab-content">
        <h2>Your Army</h2>
        <p>View your current military forces and their combined power.</p>
        <div id="army-content" class="army-content">
          <!-- Filled dynamically -->
        </div>
      </div>

      <!-- Combat Tab -->
      <div id="combat-tab" class="tab-content">
        <h2>Combat Missions</h2>
        <p>Send your army on missions to battle enemy forces and earn rewards!</p>
        <div id="combat-content" class="combat-content">
          <!-- Filled dynamically -->
        </div>
      </div>

      <!-- Achievements Tab -->
      <div id="achievements-tab" class="tab-content">
        <h2> Achievements & Statistics</h2>
        <p>Track your milestones and view your civilization's statistics!</p>
        <div id="achievements-content" class="achievements-content">
          <!-- Filled dynamically -->
        </div>
      </div>

      <!-- Skills Tab -->
      <!-- Military Tab -->
      <div id="military-tab" class="tab-content">
        <h2> Military Command</h2>
        <p>Manage your military forces - formations, defenses, heroes, naval forces, siege weapons, espionage, and more!</p>
        <div id="military-content" class="military-content">
          <!-- Filled dynamically -->
        </div>
      </div>

      <div id="skills-tab" class="tab-content">
        <h2> Skill Tree</h2>
        <p>Spend legacy points to unlock permanent upgrades that persist across prestiges!</p>
        <div id="skills-content" class="skills-content">
          <!-- Filled dynamically -->
        </div>
      </div>

      <!-- World & Lore Tab -->
      <div id="world-tab" class="tab-content">
        <h2> World & Lore</h2>
        <p>Shape your civilization's identity through choices of culture, religion, and leaders!</p>
        <div id="world-content" class="world-content">
          <!-- Filled dynamically -->
        </div>
      </div>
    </main>

    <!-- Footer with Save/Load -->
    <footer class="game-footer">
      <button id="save-game" class="footer-btn"> Save</button>
      <button id="load-game" class="footer-btn"> Load</button>
      <button id="reset-game" class="footer-btn danger"> Reset</button>
    </footer>
  </div>

  <script>
"use strict";
(() => {
  // dist/eras.js
  var ERAS = [
    {
      id: "stone_age",
      name: "Stone Age",
      description: "The dawn of civilization. Gather basic resources to survive.",
      requiredResearch: null,
      resources: {
        food: { baseRate: 1 },
        wood: { baseRate: 1 },
        stone: { baseRate: 0.5 },
        gold: { baseRate: 0 },
        science: { baseRate: 0.1 }
      }
    },
    {
      id: "bronze_age",
      name: "Bronze Age",
      description: "Metal tools revolutionize your civilization.",
      requiredResearch: "bronze_working",
      resources: {
        food: { baseRate: 2 },
        wood: { baseRate: 2 },
        stone: { baseRate: 1 },
        gold: { baseRate: 0.5 },
        science: { baseRate: 0.5 }
      }
    },
    {
      id: "iron_age",
      name: "Iron Age",
      description: "Iron strengthens your tools and weapons.",
      requiredResearch: "iron_working",
      resources: {
        food: { baseRate: 3 },
        wood: { baseRate: 3 },
        stone: { baseRate: 2 },
        gold: { baseRate: 1 },
        science: { baseRate: 1 }
      }
    },
    {
      id: "classical_age",
      name: "Classical Age",
      description: "Philosophy and culture flourish.",
      requiredResearch: "philosophy",
      resources: {
        food: { baseRate: 4 },
        wood: { baseRate: 4 },
        stone: { baseRate: 3 },
        gold: { baseRate: 2 },
        science: { baseRate: 2 }
      }
    },
    {
      id: "medieval_age",
      name: "Medieval Age",
      description: "Castles and knights dominate the land.",
      requiredResearch: "feudalism",
      resources: {
        food: { baseRate: 5 },
        wood: { baseRate: 5 },
        stone: { baseRate: 4 },
        gold: { baseRate: 3 },
        science: { baseRate: 3 }
      }
    },
    {
      id: "renaissance",
      name: "Renaissance",
      description: "Art, science, and exploration reach new heights.",
      requiredResearch: "printing_press",
      resources: {
        food: { baseRate: 7 },
        wood: { baseRate: 6 },
        stone: { baseRate: 5 },
        gold: { baseRate: 5 },
        science: { baseRate: 5 }
      }
    },
    {
      id: "industrial_age",
      name: "Industrial Age",
      description: "Machines transform production.",
      requiredResearch: "steam_power",
      resources: {
        food: { baseRate: 10 },
        wood: { baseRate: 8 },
        stone: { baseRate: 8 },
        gold: { baseRate: 8 },
        science: { baseRate: 8 }
      }
    },
    {
      id: "modern_age",
      name: "Modern Age",
      description: "Electricity and automobiles change everything.",
      requiredResearch: "electricity",
      resources: {
        food: { baseRate: 15 },
        wood: { baseRate: 12 },
        stone: { baseRate: 12 },
        gold: { baseRate: 15 },
        science: { baseRate: 15 }
      }
    },
    {
      id: "atomic_age",
      name: "Atomic Age",
      description: "Nuclear power and the space race.",
      requiredResearch: "nuclear_fission",
      resources: {
        food: { baseRate: 20 },
        wood: { baseRate: 15 },
        stone: { baseRate: 15 },
        gold: { baseRate: 25 },
        science: { baseRate: 25 }
      }
    },
    {
      id: "information_age",
      name: "Information Age",
      description: "Computers and the internet connect the world.",
      requiredResearch: "computing",
      resources: {
        food: { baseRate: 25 },
        wood: { baseRate: 18 },
        stone: { baseRate: 18 },
        gold: { baseRate: 40 },
        science: { baseRate: 50 }
      }
    },
    {
      id: "future_age",
      name: "Future Age",
      description: "Advanced AI and space colonization await.",
      requiredResearch: "artificial_intelligence",
      resources: {
        food: { baseRate: 50 },
        wood: { baseRate: 30 },
        stone: { baseRate: 30 },
        gold: { baseRate: 100 },
        science: { baseRate: 100 }
      }
    }
  ];
  function getEraById(id) {
    return ERAS.find((era) => era.id === id);
  }
  function getNextEra(currentEraId) {
    const currentIndex = ERAS.findIndex((era) => era.id === currentEraId);
    if (currentIndex === -1 || currentIndex === ERAS.length - 1) {
      return void 0;
    }
    return ERAS[currentIndex + 1];
  }

  // dist/research.js
  var SPECIAL_UNLOCKS = {
    OFFLINE_PROGRESS: "offline_progress"
  };
  var TECH_IDS = {
    CLOUD_COMPUTING: "cloud_computing"
  };
  var TECHNOLOGIES = [
    // Stone Age
    {
      id: "hunting",
      name: "Hunting",
      description: "Learn to hunt animals for food.",
      era: "stone_age",
      cost: { science: 10 },
      prerequisites: [],
      effects: { resourceBonus: { resource: "food", multiplier: 1.5 }, unitUnlock: "hunter" }
    },
    {
      id: "stone_tools",
      name: "Stone Tools",
      description: "Craft basic tools from stone.",
      era: "stone_age",
      cost: { science: 15 },
      prerequisites: [],
      effects: { resourceBonus: { resource: "stone", multiplier: 1.5 } }
    },
    {
      id: "fire",
      name: "Fire Making",
      description: "Master the art of creating fire.",
      era: "stone_age",
      cost: { science: 20 },
      prerequisites: ["hunting"],
      effects: { resourceBonus: { resource: "food", multiplier: 1.3 } }
    },
    {
      id: "agriculture",
      name: "Agriculture",
      description: "Cultivate crops for sustainable food.",
      era: "stone_age",
      cost: { science: 30 },
      prerequisites: ["fire", "stone_tools"],
      effects: { resourceBonus: { resource: "food", multiplier: 2 } }
    },
    {
      id: "bronze_working",
      name: "Bronze Working",
      description: "Unlock the Bronze Age with metal tools.",
      era: "stone_age",
      cost: { science: 50 },
      prerequisites: ["agriculture"],
      effects: { unlocks: ["bronze_age"], unitUnlock: "warrior" }
    },
    // Bronze Age
    {
      id: "writing",
      name: "Writing",
      description: "Record knowledge for future generations.",
      era: "bronze_age",
      cost: { science: 80 },
      prerequisites: ["bronze_working"],
      effects: { resourceBonus: { resource: "science", multiplier: 1.5 } }
    },
    {
      id: "wheel",
      name: "The Wheel",
      description: "Revolutionary transportation technology.",
      era: "bronze_age",
      cost: { science: 100 },
      prerequisites: ["bronze_working"],
      effects: { resourceBonus: { resource: "gold", multiplier: 1.5 }, unitUnlock: "chariot" }
    },
    {
      id: "pottery",
      name: "Pottery",
      description: "Store goods and food more efficiently.",
      era: "bronze_age",
      cost: { science: 70 },
      prerequisites: ["bronze_working"],
      effects: { resourceBonus: { resource: "food", multiplier: 1.3 } }
    },
    {
      id: "iron_working",
      name: "Iron Working",
      description: "Unlock the Iron Age with stronger metals.",
      era: "bronze_age",
      cost: { science: 150 },
      prerequisites: ["writing", "wheel"],
      effects: { unlocks: ["iron_age"], unitUnlock: "swordsman" }
    },
    // Iron Age
    {
      id: "mathematics",
      name: "Mathematics",
      description: "Advanced calculations boost science.",
      era: "iron_age",
      cost: { science: 200 },
      prerequisites: ["iron_working"],
      effects: { resourceBonus: { resource: "science", multiplier: 1.5 } }
    },
    {
      id: "currency",
      name: "Currency",
      description: "Standardized money improves trade.",
      era: "iron_age",
      cost: { science: 180 },
      prerequisites: ["iron_working"],
      effects: { resourceBonus: { resource: "gold", multiplier: 2 } }
    },
    {
      id: "construction",
      name: "Construction",
      description: "Build larger structures.",
      era: "iron_age",
      cost: { science: 220 },
      prerequisites: ["mathematics"],
      effects: { resourceBonus: { resource: "stone", multiplier: 1.5 } }
    },
    {
      id: "philosophy",
      name: "Philosophy",
      description: "Unlock the Classical Age with deep thinking.",
      era: "iron_age",
      cost: { science: 300 },
      prerequisites: ["mathematics", "currency"],
      effects: { unlocks: ["classical_age"], resourceBonus: { resource: "science", multiplier: 1.3 } }
    },
    // Classical Age
    {
      id: "engineering",
      name: "Engineering",
      description: "Advanced construction techniques.",
      era: "classical_age",
      cost: { science: 400 },
      prerequisites: ["philosophy", "construction"],
      effects: { resourceBonus: { resource: "stone", multiplier: 2 } }
    },
    {
      id: "horseback_riding",
      name: "Horseback Riding",
      description: "Mount horses for faster movement.",
      era: "classical_age",
      cost: { science: 350 },
      prerequisites: ["philosophy"],
      effects: { unitUnlock: "horseman" }
    },
    {
      id: "iron_casting",
      name: "Iron Casting",
      description: "Improved metalworking techniques.",
      era: "classical_age",
      cost: { science: 380 },
      prerequisites: ["engineering"],
      effects: { unitUnlock: "legionary" }
    },
    {
      id: "feudalism",
      name: "Feudalism",
      description: "Unlock the Medieval Age.",
      era: "classical_age",
      cost: { science: 500 },
      prerequisites: ["engineering", "horseback_riding"],
      effects: { unlocks: ["medieval_age"], unitUnlock: "knight" }
    },
    // Medieval Age
    {
      id: "metal_casting",
      name: "Metal Casting",
      description: "Mass produce metal goods.",
      era: "medieval_age",
      cost: { science: 600 },
      prerequisites: ["feudalism"],
      effects: { resourceBonus: { resource: "gold", multiplier: 1.5 } }
    },
    {
      id: "machinery",
      name: "Machinery",
      description: "Mechanical devices improve production.",
      era: "medieval_age",
      cost: { science: 650 },
      prerequisites: ["metal_casting"],
      effects: { resourceBonus: { resource: "wood", multiplier: 2 } }
    },
    {
      id: "gunpowder",
      name: "Gunpowder",
      description: "Explosive new military technology.",
      era: "medieval_age",
      cost: { science: 700 },
      prerequisites: ["metal_casting"],
      effects: { unitUnlock: "musketeer" }
    },
    {
      id: "printing_press",
      name: "Printing Press",
      description: "Unlock the Renaissance with mass communication.",
      era: "medieval_age",
      cost: { science: 800 },
      prerequisites: ["machinery", "gunpowder"],
      effects: { unlocks: ["renaissance"], resourceBonus: { resource: "science", multiplier: 2 } }
    },
    // Renaissance
    {
      id: "astronomy",
      name: "Astronomy",
      description: "Study the stars and navigation.",
      era: "renaissance",
      cost: { science: 1e3 },
      prerequisites: ["printing_press"],
      effects: { resourceBonus: { resource: "science", multiplier: 1.5 } }
    },
    {
      id: "banking",
      name: "Banking",
      description: "Advanced financial systems.",
      era: "renaissance",
      cost: { science: 1100 },
      prerequisites: ["printing_press"],
      effects: { resourceBonus: { resource: "gold", multiplier: 2 } }
    },
    {
      id: "military_science",
      name: "Military Science",
      description: "Organized military tactics.",
      era: "renaissance",
      cost: { science: 1200 },
      prerequisites: ["astronomy"],
      effects: { unitUnlock: "rifleman" }
    },
    {
      id: "steam_power",
      name: "Steam Power",
      description: "Unlock the Industrial Age.",
      era: "renaissance",
      cost: { science: 1500 },
      prerequisites: ["banking", "military_science"],
      effects: { unlocks: ["industrial_age"] }
    },
    // Industrial Age
    {
      id: "industrialization",
      name: "Industrialization",
      description: "Factory production methods.",
      era: "industrial_age",
      cost: { science: 2e3 },
      prerequisites: ["steam_power"],
      effects: { resourceBonus: { resource: "gold", multiplier: 2 } }
    },
    {
      id: "railroad",
      name: "Railroad",
      description: "Efficient transportation networks.",
      era: "industrial_age",
      cost: { science: 2200 },
      prerequisites: ["steam_power"],
      effects: { resourceBonus: { resource: "food", multiplier: 1.5 } }
    },
    {
      id: "dynamite",
      name: "Dynamite",
      description: "Powerful explosives for mining and warfare.",
      era: "industrial_age",
      cost: { science: 2400 },
      prerequisites: ["industrialization"],
      effects: { unitUnlock: "artillery" }
    },
    {
      id: "electricity",
      name: "Electricity",
      description: "Unlock the Modern Age.",
      era: "industrial_age",
      cost: { science: 3e3 },
      prerequisites: ["railroad", "dynamite"],
      effects: { unlocks: ["modern_age"] }
    },
    // Modern Age
    {
      id: "radio",
      name: "Radio",
      description: "Wireless communication.",
      era: "modern_age",
      cost: { science: 4e3 },
      prerequisites: ["electricity"],
      effects: { resourceBonus: { resource: "science", multiplier: 1.5 } }
    },
    {
      id: "combustion",
      name: "Combustion Engine",
      description: "Vehicles revolutionize transport.",
      era: "modern_age",
      cost: { science: 4500 },
      prerequisites: ["electricity"],
      effects: { unitUnlock: "tank" }
    },
    {
      id: "flight",
      name: "Flight",
      description: "Take to the skies.",
      era: "modern_age",
      cost: { science: 5e3 },
      prerequisites: ["combustion"],
      effects: { unitUnlock: "fighter" }
    },
    {
      id: "nuclear_fission",
      name: "Nuclear Fission",
      description: "Unlock the Atomic Age.",
      era: "modern_age",
      cost: { science: 6e3 },
      prerequisites: ["radio", "flight"],
      effects: { unlocks: ["atomic_age"] }
    },
    // Atomic Age
    {
      id: "rocketry",
      name: "Rocketry",
      description: "Launch into space.",
      era: "atomic_age",
      cost: { science: 8e3 },
      prerequisites: ["nuclear_fission"],
      effects: { unitUnlock: "rocket_artillery" }
    },
    {
      id: "nuclear_power",
      name: "Nuclear Power",
      description: "Clean energy from atoms.",
      era: "atomic_age",
      cost: { science: 9e3 },
      prerequisites: ["nuclear_fission"],
      effects: { resourceBonus: { resource: "gold", multiplier: 2 } }
    },
    {
      id: "satellites",
      name: "Satellites",
      description: "Eyes in the sky.",
      era: "atomic_age",
      cost: { science: 1e4 },
      prerequisites: ["rocketry"],
      effects: { resourceBonus: { resource: "science", multiplier: 2 } }
    },
    {
      id: "computing",
      name: "Computing",
      description: "Unlock the Information Age.",
      era: "atomic_age",
      cost: { science: 12e3 },
      prerequisites: ["satellites", "nuclear_power"],
      effects: { unlocks: ["information_age"] }
    },
    // Information Age
    {
      id: "internet",
      name: "Internet",
      description: "Global network of information.",
      era: "information_age",
      cost: { science: 15e3 },
      prerequisites: ["computing"],
      effects: { resourceBonus: { resource: "science", multiplier: 2 } }
    },
    {
      id: "robotics",
      name: "Robotics",
      description: "Automated machines.",
      era: "information_age",
      cost: { science: 18e3 },
      prerequisites: ["computing"],
      effects: { unitUnlock: "mech_infantry" }
    },
    {
      id: TECH_IDS.CLOUD_COMPUTING,
      name: "Cloud Computing",
      description: "Earn resources even while offline. Your civilization continues to grow while you are away!",
      era: "information_age",
      cost: { science: 16e3 },
      prerequisites: ["internet"],
      effects: { specialUnlock: SPECIAL_UNLOCKS.OFFLINE_PROGRESS }
    },
    {
      id: "nanotechnology",
      name: "Nanotechnology",
      description: "Microscopic engineering.",
      era: "information_age",
      cost: { science: 2e4 },
      prerequisites: ["internet", "robotics"],
      effects: { resourceBonus: { resource: "gold", multiplier: 2 } }
    },
    {
      id: "artificial_intelligence",
      name: "Artificial Intelligence",
      description: "Unlock the Future Age.",
      era: "information_age",
      cost: { science: 25e3 },
      prerequisites: ["nanotechnology"],
      effects: { unlocks: ["future_age"] }
    },
    // Future Age
    {
      id: "quantum_computing",
      name: "Quantum Computing",
      description: "Computing at the quantum level.",
      era: "future_age",
      cost: { science: 35e3 },
      prerequisites: ["artificial_intelligence"],
      effects: { resourceBonus: { resource: "science", multiplier: 3 } }
    },
    {
      id: "fusion_power",
      name: "Fusion Power",
      description: "Unlimited clean energy.",
      era: "future_age",
      cost: { science: 4e4 },
      prerequisites: ["artificial_intelligence"],
      effects: { resourceBonus: { resource: "gold", multiplier: 3 } }
    },
    {
      id: "space_colonization",
      name: "Space Colonization",
      description: "Expand to the stars.",
      era: "future_age",
      cost: { science: 5e4 },
      prerequisites: ["quantum_computing", "fusion_power"],
      effects: { unitUnlock: "space_marine" }
    },
    {
      id: "singularity",
      name: "Technological Singularity",
      description: "The ultimate achievement of civilization.",
      era: "future_age",
      cost: { science: 1e5 },
      prerequisites: ["space_colonization"],
      effects: { resourceBonus: { resource: "science", multiplier: 10 } }
    }
  ];
  function getTechById(id) {
    return TECHNOLOGIES.find((tech) => tech.id === id);
  }
  function canResearch(techId, researchedTechs, science) {
    const tech = getTechById(techId);
    if (!tech)
      return false;
    if (researchedTechs.has(techId))
      return false;
    for (const prereq of tech.prerequisites) {
      if (!researchedTechs.has(prereq))
        return false;
    }
    return science >= tech.cost.science;
  }

  // dist/barracks.js
  var TROOP_TYPES = [
    // Stone Age
    {
      id: "hunter",
      name: "Hunter",
      description: "Basic ranged unit with primitive weapons.",
      era: "stone_age",
      unlockTech: "hunting",
      cost: { food: 30, gold: 0 },
      trainTime: 5,
      stats: { attack: 3, defense: 1, health: 20 },
      icon: "\u{1F3F9}",
      troopClass: "ranged"
    },
    {
      id: "gatherer",
      name: "Gatherer Warrior",
      description: "Versatile fighter who can forage and fight.",
      era: "stone_age",
      unlockTech: "hunting",
      cost: { food: 25, gold: 0 },
      trainTime: 4,
      stats: { attack: 2, defense: 2, health: 25 },
      icon: "\u{1FA93}",
      troopClass: "infantry"
    },
    {
      id: "clubman",
      name: "Clubman",
      description: "Basic melee unit with a wooden club.",
      era: "stone_age",
      unlockTech: "stone_tools",
      cost: { food: 20, gold: 0, wood: 10 },
      trainTime: 3,
      stats: { attack: 4, defense: 1, health: 15 },
      icon: "\u{1F3CF}",
      troopClass: "infantry"
    },
    // Bronze Age
    {
      id: "warrior",
      name: "Warrior",
      description: "Melee fighter with bronze weapons.",
      era: "bronze_age",
      unlockTech: "bronze_working",
      cost: { food: 50, gold: 10 },
      trainTime: 8,
      stats: { attack: 6, defense: 4, health: 40 },
      icon: "\u2694\uFE0F",
      troopClass: "infantry"
    },
    {
      id: "chariot",
      name: "War Chariot",
      description: "Fast mobile unit.",
      era: "bronze_age",
      unlockTech: "wheel",
      cost: { food: 40, gold: 30, wood: 50 },
      trainTime: 12,
      stats: { attack: 8, defense: 2, health: 30 },
      icon: "\u{1F3CE}\uFE0F",
      troopClass: "cavalry"
    },
    {
      id: "spearman",
      name: "Spearman",
      description: "Defensive unit effective against cavalry.",
      era: "bronze_age",
      unlockTech: "bronze_working",
      cost: { food: 45, gold: 15 },
      trainTime: 7,
      stats: { attack: 5, defense: 6, health: 35 },
      icon: "\u{1F531}",
      troopClass: "infantry"
    },
    {
      id: "slinger",
      name: "Slinger",
      description: "Cheap ranged unit with a sling.",
      era: "bronze_age",
      unlockTech: "writing",
      cost: { food: 35, gold: 5 },
      trainTime: 5,
      stats: { attack: 7, defense: 2, health: 25 },
      icon: "\u{1F3AF}",
      troopClass: "ranged"
    },
    // Iron Age
    {
      id: "swordsman",
      name: "Swordsman",
      description: "Skilled fighter with iron sword.",
      era: "iron_age",
      unlockTech: "iron_working",
      cost: { food: 60, gold: 25 },
      trainTime: 10,
      stats: { attack: 10, defense: 6, health: 50 },
      icon: "\u{1F5E1}\uFE0F",
      troopClass: "infantry"
    },
    {
      id: "archer",
      name: "Archer",
      description: "Trained bowman with improved range.",
      era: "iron_age",
      unlockTech: "iron_working",
      cost: { food: 55, gold: 20 },
      trainTime: 8,
      stats: { attack: 12, defense: 3, health: 35 },
      icon: "\u{1F3F9}",
      troopClass: "ranged"
    },
    {
      id: "phalanx",
      name: "Phalanx",
      description: "Heavy defensive infantry with long spears.",
      era: "iron_age",
      unlockTech: "construction",
      cost: { food: 70, gold: 30 },
      trainTime: 12,
      stats: { attack: 8, defense: 12, health: 55 },
      icon: "\u{1F6E1}\uFE0F",
      troopClass: "infantry"
    },
    // Classical Age
    {
      id: "horseman",
      name: "Horseman",
      description: "Mounted cavalry unit.",
      era: "classical_age",
      unlockTech: "horseback_riding",
      cost: { food: 80, gold: 40 },
      trainTime: 15,
      stats: { attack: 12, defense: 4, health: 45 },
      icon: "\u{1F40E}",
      troopClass: "cavalry"
    },
    {
      id: "legionary",
      name: "Legionary",
      description: "Elite heavy infantry.",
      era: "classical_age",
      unlockTech: "iron_casting",
      cost: { food: 70, gold: 35 },
      trainTime: 12,
      stats: { attack: 11, defense: 10, health: 60 },
      icon: "\u{1F3DB}\uFE0F",
      troopClass: "infantry"
    },
    {
      id: "catapult",
      name: "Catapult",
      description: "Siege weapon that hurls stones at enemies.",
      era: "classical_age",
      unlockTech: "engineering",
      cost: { food: 60, gold: 60, stone: 80 },
      trainTime: 18,
      stats: { attack: 20, defense: 2, health: 30 },
      icon: "\u{1FAA8}",
      troopClass: "siege"
    },
    {
      id: "war_elephant",
      name: "War Elephant",
      description: "Massive beast that tramples enemies.",
      era: "classical_age",
      unlockTech: "horseback_riding",
      cost: { food: 120, gold: 80 },
      trainTime: 25,
      stats: { attack: 16, defense: 8, health: 90 },
      icon: "\u{1F418}",
      troopClass: "cavalry"
    },
    // Medieval Age
    {
      id: "knight",
      name: "Knight",
      description: "Heavily armored mounted warrior.",
      era: "medieval_age",
      unlockTech: "feudalism",
      cost: { food: 100, gold: 80 },
      trainTime: 20,
      stats: { attack: 18, defense: 14, health: 80 },
      icon: "\u{1F3C7}",
      troopClass: "cavalry"
    },
    {
      id: "musketeer",
      name: "Musketeer",
      description: "Soldier armed with a musket.",
      era: "medieval_age",
      unlockTech: "gunpowder",
      cost: { food: 90, gold: 60 },
      trainTime: 15,
      stats: { attack: 22, defense: 8, health: 55 },
      icon: "\u{1F52B}",
      troopClass: "ranged"
    },
    {
      id: "crossbowman",
      name: "Crossbowman",
      description: "Powerful ranged unit with a crossbow.",
      era: "medieval_age",
      unlockTech: "machinery",
      cost: { food: 85, gold: 50 },
      trainTime: 14,
      stats: { attack: 19, defense: 6, health: 50 },
      icon: "\u{1F3AF}",
      troopClass: "ranged"
    },
    {
      id: "trebuchet",
      name: "Trebuchet",
      description: "Advanced siege weapon for destroying fortifications.",
      era: "medieval_age",
      unlockTech: "machinery",
      cost: { food: 80, gold: 100, wood: 120 },
      trainTime: 22,
      stats: { attack: 35, defense: 3, health: 40 },
      icon: "\u2699\uFE0F",
      troopClass: "siege"
    },
    {
      id: "pikeman",
      name: "Pikeman",
      description: "Long pike infantry effective against cavalry.",
      era: "medieval_age",
      unlockTech: "metal_casting",
      cost: { food: 75, gold: 45 },
      trainTime: 12,
      stats: { attack: 14, defense: 16, health: 65 },
      icon: "\u{1F531}",
      troopClass: "infantry"
    },
    // Renaissance
    {
      id: "rifleman",
      name: "Rifleman",
      description: "Soldier with advanced rifle.",
      era: "renaissance",
      unlockTech: "military_science",
      cost: { food: 100, gold: 70 },
      trainTime: 12,
      stats: { attack: 28, defense: 10, health: 60 },
      icon: "\u{1F396}\uFE0F",
      troopClass: "ranged"
    },
    {
      id: "cavalry",
      name: "Light Cavalry",
      description: "Fast scout and raider unit.",
      era: "renaissance",
      unlockTech: "military_science",
      cost: { food: 90, gold: 65 },
      trainTime: 14,
      stats: { attack: 24, defense: 8, health: 55 },
      icon: "\u{1F434}",
      troopClass: "cavalry"
    },
    {
      id: "cannon",
      name: "Cannon",
      description: "Early artillery piece with devastating power.",
      era: "renaissance",
      unlockTech: "banking",
      cost: { food: 70, gold: 120, stone: 80 },
      trainTime: 20,
      stats: { attack: 38, defense: 4, health: 45 },
      icon: "\u{1F4A5}",
      troopClass: "siege"
    },
    {
      id: "lancer",
      name: "Lancer",
      description: "Elite cavalry with lance charge.",
      era: "renaissance",
      unlockTech: "astronomy",
      cost: { food: 110, gold: 90 },
      trainTime: 18,
      stats: { attack: 30, defense: 12, health: 70 },
      icon: "\u{1F3C7}",
      troopClass: "cavalry"
    },
    // Industrial Age
    {
      id: "artillery",
      name: "Artillery",
      description: "Powerful ranged siege weapon.",
      era: "industrial_age",
      unlockTech: "dynamite",
      cost: { food: 80, gold: 150, stone: 100 },
      trainTime: 25,
      stats: { attack: 45, defense: 5, health: 50 },
      icon: "\u{1F4A3}",
      troopClass: "siege"
    },
    {
      id: "infantry",
      name: "Line Infantry",
      description: "Standard modern infantry with rifles.",
      era: "industrial_age",
      unlockTech: "industrialization",
      cost: { food: 90, gold: 60 },
      trainTime: 10,
      stats: { attack: 32, defense: 14, health: 65 },
      icon: "\u{1FA96}",
      troopClass: "infantry"
    },
    {
      id: "gatling_gun",
      name: "Gatling Gun",
      description: "Early machine gun with rapid fire.",
      era: "industrial_age",
      unlockTech: "industrialization",
      cost: { food: 100, gold: 180 },
      trainTime: 22,
      stats: { attack: 50, defense: 8, health: 55 },
      icon: "\u{1F52B}",
      troopClass: "ranged"
    },
    {
      id: "ironclad",
      name: "Armored Train",
      description: "Mobile armored platform on rails.",
      era: "industrial_age",
      unlockTech: "railroad",
      cost: { food: 120, gold: 200, stone: 150 },
      trainTime: 30,
      stats: { attack: 40, defense: 25, health: 100 },
      icon: "\u{1F682}",
      troopClass: "special"
    },
    // Modern Age
    {
      id: "tank",
      name: "Tank",
      description: "Armored fighting vehicle.",
      era: "modern_age",
      unlockTech: "combustion",
      cost: { food: 100, gold: 250 },
      trainTime: 30,
      stats: { attack: 55, defense: 35, health: 120 },
      icon: "\u{1F6E1}\uFE0F",
      troopClass: "cavalry"
    },
    {
      id: "fighter",
      name: "Fighter",
      description: "Military aircraft.",
      era: "modern_age",
      unlockTech: "flight",
      cost: { food: 80, gold: 300 },
      trainTime: 25,
      stats: { attack: 65, defense: 20, health: 80 },
      icon: "\u2708\uFE0F",
      troopClass: "air"
    },
    {
      id: "marine",
      name: "Marine",
      description: "Elite amphibious assault infantry.",
      era: "modern_age",
      unlockTech: "radio",
      cost: { food: 110, gold: 140 },
      trainTime: 16,
      stats: { attack: 42, defense: 22, health: 75 },
      icon: "\u{1F396}\uFE0F",
      troopClass: "infantry"
    },
    {
      id: "bomber",
      name: "Bomber",
      description: "Heavy aircraft for strategic bombing.",
      era: "modern_age",
      unlockTech: "flight",
      cost: { food: 100, gold: 350 },
      trainTime: 28,
      stats: { attack: 80, defense: 15, health: 90 },
      icon: "\u{1F6E9}\uFE0F",
      troopClass: "air"
    },
    {
      id: "anti_tank",
      name: "Anti-Tank Gun",
      description: "Specialized unit for destroying armor.",
      era: "modern_age",
      unlockTech: "combustion",
      cost: { food: 90, gold: 200 },
      trainTime: 20,
      stats: { attack: 60, defense: 10, health: 60 },
      icon: "\u{1F3AF}",
      troopClass: "ranged"
    },
    // Atomic Age
    {
      id: "rocket_artillery",
      name: "Rocket Artillery",
      description: "Long-range rocket launcher.",
      era: "atomic_age",
      unlockTech: "rocketry",
      cost: { food: 100, gold: 400 },
      trainTime: 30,
      stats: { attack: 80, defense: 10, health: 70 },
      icon: "\u{1F680}",
      troopClass: "siege"
    },
    {
      id: "paratrooper",
      name: "Paratrooper",
      description: "Elite airborne infantry.",
      era: "atomic_age",
      unlockTech: "rocketry",
      cost: { food: 120, gold: 280 },
      trainTime: 18,
      stats: { attack: 55, defense: 25, health: 85 },
      icon: "\u{1FA82}",
      troopClass: "infantry"
    },
    {
      id: "jet_fighter",
      name: "Jet Fighter",
      description: "Advanced supersonic aircraft.",
      era: "atomic_age",
      unlockTech: "satellites",
      cost: { food: 100, gold: 450 },
      trainTime: 26,
      stats: { attack: 90, defense: 30, health: 95 },
      icon: "\u{1F6EB}",
      troopClass: "air"
    },
    {
      id: "nuclear_sub",
      name: "Nuclear Submarine",
      description: "Stealthy underwater nuclear platform.",
      era: "atomic_age",
      unlockTech: "nuclear_power",
      cost: { food: 150, gold: 600 },
      trainTime: 35,
      stats: { attack: 100, defense: 40, health: 110 },
      icon: "\u{1F6A2}",
      troopClass: "special"
    },
    // Information Age
    {
      id: "mech_infantry",
      name: "Mechanized Infantry",
      description: "Soldiers with powered exoskeletons.",
      era: "information_age",
      unlockTech: "robotics",
      cost: { food: 120, gold: 500 },
      trainTime: 20,
      stats: { attack: 70, defense: 50, health: 150 },
      icon: "\u{1F916}",
      troopClass: "infantry"
    },
    {
      id: "drone_swarm",
      name: "Drone Swarm",
      description: "Autonomous attack drones.",
      era: "information_age",
      unlockTech: "robotics",
      cost: { food: 80, gold: 550 },
      trainTime: 18,
      stats: { attack: 85, defense: 15, health: 60 },
      icon: "\u{1F6F8}",
      troopClass: "air"
    },
    {
      id: "cyber_warrior",
      name: "Cyber Warrior",
      description: "Electronic warfare specialist.",
      era: "information_age",
      unlockTech: "internet",
      cost: { food: 100, gold: 480 },
      trainTime: 16,
      stats: { attack: 60, defense: 40, health: 100 },
      icon: "\u{1F4BB}",
      troopClass: "special"
    },
    {
      id: "stealth_bomber",
      name: "Stealth Bomber",
      description: "Undetectable strategic bomber.",
      era: "information_age",
      unlockTech: "nanotechnology",
      cost: { food: 120, gold: 700 },
      trainTime: 30,
      stats: { attack: 110, defense: 35, health: 100 },
      icon: "\u{1F985}",
      troopClass: "air"
    },
    {
      id: "battle_mech",
      name: "Battle Mech",
      description: "Piloted combat robot.",
      era: "information_age",
      unlockTech: "nanotechnology",
      cost: { food: 150, gold: 650 },
      trainTime: 28,
      stats: { attack: 95, defense: 60, health: 180 },
      icon: "\u{1F9BE}",
      troopClass: "special"
    },
    // Future Age
    {
      id: "space_marine",
      name: "Space Marine",
      description: "Elite soldier for space combat.",
      era: "future_age",
      unlockTech: "space_colonization",
      cost: { food: 150, gold: 800 },
      trainTime: 25,
      stats: { attack: 100, defense: 80, health: 200 },
      icon: "\u{1F468}\u200D\u{1F680}",
      troopClass: "infantry"
    },
    {
      id: "plasma_tank",
      name: "Plasma Tank",
      description: "Hover tank with plasma weapons.",
      era: "future_age",
      unlockTech: "fusion_power",
      cost: { food: 180, gold: 900 },
      trainTime: 32,
      stats: { attack: 120, defense: 70, health: 220 },
      icon: "\u{1F52E}",
      troopClass: "cavalry"
    },
    {
      id: "nanite_swarm",
      name: "Nanite Swarm",
      description: "Self-replicating microscopic robots.",
      era: "future_age",
      unlockTech: "quantum_computing",
      cost: { food: 100, gold: 1e3 },
      trainTime: 22,
      stats: { attack: 90, defense: 30, health: 150 },
      icon: "\u2728",
      troopClass: "special"
    },
    {
      id: "antimatter_bomber",
      name: "Antimatter Bomber",
      description: "Aircraft with antimatter warheads.",
      era: "future_age",
      unlockTech: "fusion_power",
      cost: { food: 200, gold: 1200 },
      trainTime: 35,
      stats: { attack: 150, defense: 40, health: 130 },
      icon: "\u{1F4AB}",
      troopClass: "air"
    },
    {
      id: "titan",
      name: "Titan",
      description: "Massive war machine of destruction.",
      era: "future_age",
      unlockTech: "singularity",
      cost: { food: 300, gold: 1500 },
      trainTime: 45,
      stats: { attack: 200, defense: 150, health: 500 },
      icon: "\u{1F5FF}",
      troopClass: "special"
    }
  ];
  function getTroopTypeById(id) {
    return TROOP_TYPES.find((troop) => troop.id === id);
  }
  function canTrainTroop(troopId, unlockedTroops, resources) {
    const troopType = getTroopTypeById(troopId);
    if (!troopType)
      return false;
    if (!unlockedTroops.has(troopId))
      return false;
    if (resources.food < troopType.cost.food)
      return false;
    if (resources.gold < troopType.cost.gold)
      return false;
    if (troopType.cost.wood && resources.wood < troopType.cost.wood)
      return false;
    if (troopType.cost.stone && resources.stone < troopType.cost.stone)
      return false;
    return true;
  }
  function calculateArmyPower(troops) {
    let totalAttack = 0;
    let totalDefense = 0;
    let totalHealth = 0;
    for (const troop of troops) {
      const troopType = getTroopTypeById(troop.typeId);
      if (troopType) {
        totalAttack += troopType.stats.attack * troop.count;
        totalDefense += troopType.stats.defense * troop.count;
        totalHealth += troopType.stats.health * troop.count;
      }
    }
    return { attack: totalAttack, defense: totalDefense, health: totalHealth };
  }

  // dist/combat.js
  var DEFENSE_MITIGATION_FACTOR = 0.3;
  var MAX_BATTLE_ROUNDS = 50;
  var DAMAGE_RANDOM_MIN = 0.8;
  var DAMAGE_RANDOM_RANGE = 0.4;
  function generateMissions() {
    const missions = [];
    missions.push({
      id: "stone_wolves",
      name: "Wolf Pack",
      description: "A small pack of wolves threatens your village. Defend your people!",
      era: "stone_age",
      enemyArmy: {
        name: "Wolf Pack",
        troops: [],
        attack: 5,
        defense: 2,
        health: 30,
        size: "small"
      },
      rewards: { food: 50, wood: 20, stone: 10, gold: 0, science: 5 },
      unlocked: true
    });
    missions.push({
      id: "stone_raiders",
      name: "Rival Tribe Raiders",
      description: "A rival tribe is raiding your supplies. Fight them off!",
      era: "stone_age",
      enemyArmy: {
        name: "Tribal Raiders",
        troops: [],
        attack: 10,
        defense: 5,
        health: 60,
        size: "medium"
      },
      rewards: { food: 100, wood: 50, stone: 30, gold: 0, science: 10 },
      unlocked: true
    });
    missions.push({
      id: "stone_mammoth_hunters",
      name: "Mammoth Hunter Clan",
      description: "A large clan of mammoth hunters wants your territory.",
      era: "stone_age",
      enemyArmy: {
        name: "Mammoth Hunter Clan",
        troops: [],
        attack: 15,
        defense: 8,
        health: 100,
        size: "large"
      },
      rewards: { food: 180, wood: 90, stone: 60, gold: 0, science: 20 },
      unlocked: true
    });
    missions.push({
      id: "stone_cave_beast",
      name: "Cave Beast",
      description: "A legendary beast terrorizes the land. Only the bravest dare face it!",
      era: "stone_age",
      enemyArmy: {
        name: "Ancient Cave Beast",
        troops: [],
        attack: 25,
        defense: 15,
        health: 150,
        size: "boss"
      },
      rewards: { food: 300, wood: 150, stone: 100, gold: 20, science: 40 },
      unlocked: true
    });
    missions.push({
      id: "bronze_scouts",
      name: "Enemy Scouts",
      description: "Enemy scouts probe your defenses. Eliminate them!",
      era: "bronze_age",
      enemyArmy: {
        name: "Scout Party",
        troops: [],
        attack: 15,
        defense: 8,
        health: 80,
        size: "small"
      },
      rewards: { food: 100, wood: 70, stone: 50, gold: 30, science: 20 },
      unlocked: true
    });
    missions.push({
      id: "bronze_bandits",
      name: "Bronze Bandits",
      description: "Bandits with bronze weapons attack your trade routes.",
      era: "bronze_age",
      enemyArmy: {
        name: "Bronze Bandits",
        troops: [],
        attack: 25,
        defense: 15,
        health: 120,
        size: "medium"
      },
      rewards: { food: 150, wood: 100, stone: 80, gold: 50, science: 30 },
      unlocked: true
    });
    missions.push({
      id: "bronze_chariot_army",
      name: "Chariot Army",
      description: "A massive chariot army approaches your borders!",
      era: "bronze_age",
      enemyArmy: {
        name: "Chariot Legion",
        troops: [],
        attack: 35,
        defense: 18,
        health: 160,
        size: "large"
      },
      rewards: { food: 200, wood: 130, stone: 100, gold: 80, science: 45 },
      unlocked: true
    });
    missions.push({
      id: "bronze_warlord",
      name: "Warlord's Army",
      description: "The Bronze Warlord seeks to conquer your lands with his elite army.",
      era: "bronze_age",
      enemyArmy: {
        name: "Warlord's Forces",
        troops: [],
        attack: 50,
        defense: 25,
        health: 220,
        size: "boss"
      },
      rewards: { food: 350, wood: 200, stone: 160, gold: 150, science: 70 },
      unlocked: true
    });
    missions.push({
      id: "iron_raiders",
      name: "Iron Raiders",
      description: "Small raiding parties with iron weapons test your defenses.",
      era: "iron_age",
      enemyArmy: {
        name: "Iron Raiders",
        troops: [],
        attack: 40,
        defense: 25,
        health: 200,
        size: "small"
      },
      rewards: { food: 280, wood: 180, stone: 140, gold: 120, science: 70 },
      unlocked: true
    });
    missions.push({
      id: "iron_invaders",
      name: "Iron Invaders",
      description: "An invading army with iron weapons threatens your borders.",
      era: "iron_age",
      enemyArmy: {
        name: "Iron Invaders",
        troops: [],
        attack: 60,
        defense: 40,
        health: 300,
        size: "medium"
      },
      rewards: { food: 400, wood: 250, stone: 200, gold: 200, science: 100 },
      unlocked: true
    });
    missions.push({
      id: "iron_phalanx",
      name: "Iron Phalanx",
      description: "A disciplined phalanx of iron-clad warriors marches against you.",
      era: "iron_age",
      enemyArmy: {
        name: "Iron Phalanx",
        troops: [],
        attack: 80,
        defense: 55,
        health: 400,
        size: "large"
      },
      rewards: { food: 550, wood: 350, stone: 280, gold: 300, science: 140 },
      unlocked: true
    });
    missions.push({
      id: "iron_empire",
      name: "Empire Strike",
      description: "The neighboring empire sends its elite legions against you.",
      era: "iron_age",
      enemyArmy: {
        name: "Imperial Legion",
        troops: [],
        attack: 100,
        defense: 70,
        health: 550,
        size: "boss"
      },
      rewards: { food: 700, wood: 450, stone: 350, gold: 400, science: 180 },
      unlocked: true
    });
    missions.push({
      id: "classical_mercenaries",
      name: "Mercenary Band",
      description: "A small band of mercenaries threatens your borders.",
      era: "classical_age",
      enemyArmy: {
        name: "Mercenary Band",
        troops: [],
        attack: 90,
        defense: 50,
        health: 450,
        size: "small"
      },
      rewards: { food: 600, wood: 380, stone: 300, gold: 350, science: 150 },
      unlocked: true
    });
    missions.push({
      id: "classical_horde",
      name: "Barbarian Horde",
      description: "A barbarian horde approaches your civilization.",
      era: "classical_age",
      enemyArmy: {
        name: "Barbarian Horde",
        troops: [],
        attack: 120,
        defense: 70,
        health: 600,
        size: "medium"
      },
      rewards: { food: 800, wood: 500, stone: 400, gold: 500, science: 200 },
      unlocked: true
    });
    missions.push({
      id: "classical_legion",
      name: "Enemy Legion",
      description: "A massive legion of enemy soldiers marches toward your lands.",
      era: "classical_age",
      enemyArmy: {
        name: "Enemy Legion",
        troops: [],
        attack: 145,
        defense: 90,
        health: 750,
        size: "large"
      },
      rewards: { food: 950, wood: 620, stone: 470, gold: 620, science: 270 },
      unlocked: true
    });
    missions.push({
      id: "classical_rivals",
      name: "Rival Kingdom",
      description: "The rival kingdom declares war. Defend your honor against their elite forces!",
      era: "classical_age",
      enemyArmy: {
        name: "Royal Army",
        troops: [],
        attack: 180,
        defense: 110,
        health: 900,
        size: "boss"
      },
      rewards: { food: 1200, wood: 800, stone: 600, gold: 800, science: 350 },
      unlocked: true
    });
    missions.push({
      id: "medieval_raiders",
      name: "Viking Raiders",
      description: "Viking raiders land on your shores seeking plunder.",
      era: "medieval_age",
      enemyArmy: {
        name: "Viking Raiders",
        troops: [],
        attack: 150,
        defense: 100,
        health: 750,
        size: "small"
      },
      rewards: { food: 1100, wood: 750, stone: 600, gold: 750, science: 300 },
      unlocked: true
    });
    missions.push({
      id: "medieval_siege",
      name: "Castle Siege",
      description: "Enemy forces besiege your castle. Hold the walls!",
      era: "medieval_age",
      enemyArmy: {
        name: "Siege Army",
        troops: [],
        attack: 200,
        defense: 150,
        health: 1e3,
        size: "medium"
      },
      rewards: { food: 1500, wood: 1e3, stone: 800, gold: 1e3, science: 400 },
      unlocked: true
    });
    missions.push({
      id: "medieval_mongol_horde",
      name: "Mongol Horde",
      description: "The great Mongol horde sweeps across your land.",
      era: "medieval_age",
      enemyArmy: {
        name: "Mongol Horde",
        troops: [],
        attack: 250,
        defense: 170,
        health: 1250,
        size: "large"
      },
      rewards: { food: 1800, wood: 1250, stone: 1e3, gold: 1250, science: 520 },
      unlocked: true
    });
    missions.push({
      id: "medieval_crusade",
      name: "Holy Crusade",
      description: "A massive crusading army marches against your lands with divine fury.",
      era: "medieval_age",
      enemyArmy: {
        name: "Crusader Army",
        troops: [],
        attack: 320,
        defense: 220,
        health: 1600,
        size: "boss"
      },
      rewards: { food: 2400, wood: 1700, stone: 1400, gold: 1800, science: 700 },
      unlocked: true
    });
    missions.push({
      id: "renaissance_privateers",
      name: "Privateers",
      description: "Enemy privateers raid your shipping lanes.",
      era: "renaissance",
      enemyArmy: {
        name: "Privateer Fleet",
        troops: [],
        attack: 280,
        defense: 160,
        health: 1400,
        size: "small"
      },
      rewards: { food: 2200, wood: 1500, stone: 1100, gold: 1800, science: 600 },
      unlocked: true
    });
    missions.push({
      id: "renaissance_pirates",
      name: "Pirate Invasion",
      description: "Pirates raid your coastal cities with advanced weaponry.",
      era: "renaissance",
      enemyArmy: {
        name: "Pirate Fleet",
        troops: [],
        attack: 350,
        defense: 200,
        health: 1800,
        size: "medium"
      },
      rewards: { food: 3e3, wood: 2e3, stone: 1500, gold: 2500, science: 800 },
      unlocked: true
    });
    missions.push({
      id: "renaissance_conquistadors",
      name: "Conquistadors",
      description: "A large force of conquistadors seeks to claim your lands.",
      era: "renaissance",
      enemyArmy: {
        name: "Conquistador Army",
        troops: [],
        attack: 400,
        defense: 250,
        health: 2200,
        size: "large"
      },
      rewards: { food: 3600, wood: 2600, stone: 1800, gold: 3100, science: 1e3 },
      unlocked: true
    });
    missions.push({
      id: "renaissance_empire",
      name: "Colonial War",
      description: "A powerful colonial empire threatens your independence with their full might.",
      era: "renaissance",
      enemyArmy: {
        name: "Colonial Army",
        troops: [],
        attack: 500,
        defense: 310,
        health: 2800,
        size: "boss"
      },
      rewards: { food: 4800, wood: 3500, stone: 2400, gold: 4200, science: 1400 },
      unlocked: true
    });
    missions.push({
      id: "industrial_militia",
      name: "Rebel Militia",
      description: "Armed militia rebels challenge your authority.",
      era: "industrial_age",
      enemyArmy: {
        name: "Rebel Militia",
        troops: [],
        attack: 450,
        defense: 260,
        health: 2200,
        size: "small"
      },
      rewards: { food: 4500, wood: 3e3, stone: 2200, gold: 3800, science: 1500 },
      unlocked: true
    });
    missions.push({
      id: "industrial_revolution",
      name: "Revolution Forces",
      description: "Revolutionary forces threaten to overthrow your government.",
      era: "industrial_age",
      enemyArmy: {
        name: "Revolutionary Army",
        troops: [],
        attack: 600,
        defense: 350,
        health: 3e3,
        size: "medium"
      },
      rewards: { food: 6e3, wood: 4e3, stone: 3e3, gold: 5e3, science: 2e3 },
      unlocked: true
    });
    missions.push({
      id: "industrial_coalition",
      name: "Enemy Coalition",
      description: "Multiple nations form a coalition against you.",
      era: "industrial_age",
      enemyArmy: {
        name: "Coalition Forces",
        troops: [],
        attack: 720,
        defense: 440,
        health: 3600,
        size: "large"
      },
      rewards: { food: 7200, wood: 5200, stone: 3700, gold: 6200, science: 2600 },
      unlocked: true
    });
    missions.push({
      id: "industrial_invasion",
      name: "Great War",
      description: "A great power declares total war against your nation. This is an existential threat!",
      era: "industrial_age",
      enemyArmy: {
        name: "War Machine",
        troops: [],
        attack: 900,
        defense: 560,
        health: 4500,
        size: "boss"
      },
      rewards: { food: 9600, wood: 7200, stone: 4800, gold: 8400, science: 3600 },
      unlocked: true
    });
    missions.push({
      id: "modern_insurgents",
      name: "Insurgent Forces",
      description: "Well-equipped insurgent forces operate in your territory.",
      era: "modern_age",
      enemyArmy: {
        name: "Insurgent Army",
        troops: [],
        attack: 750,
        defense: 450,
        health: 3800,
        size: "small"
      },
      rewards: { food: 7500, wood: 5200, stone: 3800, gold: 7500, science: 3800 },
      unlocked: true
    });
    missions.push({
      id: "modern_conflict",
      name: "Regional Conflict",
      description: "A regional power challenges your military supremacy.",
      era: "modern_age",
      enemyArmy: {
        name: "Modern Army",
        troops: [],
        attack: 1e3,
        defense: 600,
        health: 5e3,
        size: "medium"
      },
      rewards: { food: 1e4, wood: 7e3, stone: 5e3, gold: 1e4, science: 5e3 },
      unlocked: true
    });
    missions.push({
      id: "modern_alliance",
      name: "Enemy Alliance",
      description: "A military alliance mobilizes against your nation.",
      era: "modern_age",
      enemyArmy: {
        name: "Allied Forces",
        troops: [],
        attack: 1250,
        defense: 780,
        health: 6200,
        size: "large"
      },
      rewards: { food: 13e3, wood: 9e3, stone: 6800, gold: 13e3, science: 6800 },
      unlocked: true
    });
    missions.push({
      id: "modern_superpower",
      name: "Superpower Clash",
      description: "Face the full military might of a global superpower.",
      era: "modern_age",
      enemyArmy: {
        name: "Superpower Forces",
        troops: [],
        attack: 1600,
        defense: 1e3,
        health: 8e3,
        size: "boss"
      },
      rewards: { food: 18e3, wood: 12e3, stone: 9600, gold: 18e3, science: 9600 },
      unlocked: true
    });
    missions.push({
      id: "atomic_rogue_state",
      name: "Rogue State",
      description: "A rogue state threatens nuclear confrontation.",
      era: "atomic_age",
      enemyArmy: {
        name: "Rogue Forces",
        troops: [],
        attack: 1500,
        defense: 900,
        health: 7500,
        size: "small"
      },
      rewards: { food: 15e3, wood: 11e3, stone: 9e3, gold: 19e3, science: 9e3 },
      unlocked: true
    });
    missions.push({
      id: "atomic_crisis",
      name: "Nuclear Crisis",
      description: "A nuclear-armed enemy threatens global destruction.",
      era: "atomic_age",
      enemyArmy: {
        name: "Nuclear Forces",
        troops: [],
        attack: 2e3,
        defense: 1200,
        health: 1e4,
        size: "medium"
      },
      rewards: { food: 2e4, wood: 15e3, stone: 12e3, gold: 25e3, science: 12e3 },
      unlocked: true
    });
    missions.push({
      id: "atomic_bloc",
      name: "Enemy Bloc",
      description: "An entire bloc of nuclear powers aligns against you.",
      era: "atomic_age",
      enemyArmy: {
        name: "Nuclear Bloc",
        troops: [],
        attack: 2600,
        defense: 1560,
        health: 13e3,
        size: "large"
      },
      rewards: { food: 26e3, wood: 21e3, stone: 17e3, gold: 34e3, science: 17e3 },
      unlocked: true
    });
    missions.push({
      id: "atomic_world_war",
      name: "World War III",
      description: "The final conflict. Win or face extinction.",
      era: "atomic_age",
      enemyArmy: {
        name: "World Coalition",
        troops: [],
        attack: 3400,
        defense: 2e3,
        health: 17e3,
        size: "boss"
      },
      rewards: { food: 36e3, wood: 3e4, stone: 24e3, gold: 48e3, science: 24e3 },
      unlocked: true
    });
    missions.push({
      id: "info_hackers",
      name: "Cyber Terrorists",
      description: "Cyber terrorists with military backing launch attacks.",
      era: "information_age",
      enemyArmy: {
        name: "Cyber Terrorists",
        troops: [],
        attack: 3e3,
        defense: 1900,
        health: 15e3,
        size: "small"
      },
      rewards: { food: 3e4, wood: 22e3, stone: 18e3, gold: 45e3, science: 26e3 },
      unlocked: true
    });
    missions.push({
      id: "info_cyber",
      name: "Cyber Warfare",
      description: "A cyber-enhanced army attacks your infrastructure.",
      era: "information_age",
      enemyArmy: {
        name: "Cyber Army",
        troops: [],
        attack: 4e3,
        defense: 2500,
        health: 2e4,
        size: "medium"
      },
      rewards: { food: 4e4, wood: 3e4, stone: 25e3, gold: 6e4, science: 35e3 },
      unlocked: true
    });
    missions.push({
      id: "info_drone_swarm",
      name: "Drone Swarm",
      description: "Autonomous drone swarms overwhelm conventional defenses.",
      era: "information_age",
      enemyArmy: {
        name: "Drone Swarm",
        troops: [],
        attack: 5e3,
        defense: 3100,
        health: 25e3,
        size: "large"
      },
      rewards: { food: 52e3, wood: 39e3, stone: 31e3, gold: 72e3, science: 44e3 },
      unlocked: true
    });
    missions.push({
      id: "info_ai_uprising",
      name: "AI Uprising",
      description: "Rogue AI systems control an army of machines. The singularity is here!",
      era: "information_age",
      enemyArmy: {
        name: "Machine Army",
        troops: [],
        attack: 6200,
        defense: 4e3,
        health: 32e3,
        size: "boss"
      },
      rewards: { food: 72e3, wood: 54e3, stone: 42e3, gold: 96e3, science: 6e4 },
      unlocked: true
    });
    missions.push({
      id: "future_rebels",
      name: "Space Rebels",
      description: "Rebel forces with advanced tech challenge your authority.",
      era: "future_age",
      enemyArmy: {
        name: "Space Rebels",
        troops: [],
        attack: 6e3,
        defense: 3800,
        health: 3e4,
        size: "small"
      },
      rewards: { food: 75e3, wood: 52e3, stone: 38e3, gold: 112e3, science: 75e3 },
      unlocked: true
    });
    missions.push({
      id: "future_alien",
      name: "Alien Invasion",
      description: "Extraterrestrial forces invade Earth. Humanity's last stand!",
      era: "future_age",
      enemyArmy: {
        name: "Alien Fleet",
        troops: [],
        attack: 8e3,
        defense: 5e3,
        health: 4e4,
        size: "medium"
      },
      rewards: { food: 1e5, wood: 7e4, stone: 5e4, gold: 15e4, science: 1e5 },
      unlocked: true
    });
    missions.push({
      id: "future_galactic_empire",
      name: "Galactic Empire",
      description: "A galactic empire sends its armada to conquer Earth.",
      era: "future_age",
      enemyArmy: {
        name: "Imperial Armada",
        troops: [],
        attack: 10500,
        defense: 6500,
        health: 52e3,
        size: "large"
      },
      rewards: { food: 13e4, wood: 91e3, stone: 65e3, gold: 195e3, science: 13e4 },
      unlocked: true
    });
    missions.push({
      id: "future_singularity",
      name: "Singularity War",
      description: "Battle the transcended intelligence for the fate of the universe.",
      era: "future_age",
      enemyArmy: {
        name: "Singularity Entity",
        troops: [],
        attack: 14e3,
        defense: 9e3,
        health: 7e4,
        size: "boss"
      },
      rewards: { food: 24e4, wood: 18e4, stone: 12e4, gold: 36e4, science: 24e4 },
      unlocked: true
    });
    return missions;
  }
  function getMissionsByEra(missions, era) {
    return missions.filter((m) => m.era === era);
  }
  function getMissionById(missions, id) {
    return missions.find((m) => m.id === id);
  }
  function calculateDamage(attack, defense) {
    const baseDamage = Math.max(1, attack - defense * DEFENSE_MITIGATION_FACTOR);
    const randomFactor = DAMAGE_RANDOM_MIN + Math.random() * DAMAGE_RANDOM_RANGE;
    return Math.floor(baseDamage * randomFactor);
  }
  function simulateBattleRound(playerHealth, enemyHealth, playerAttack, playerDefense, enemyAttack, enemyDefense, round) {
    const playerDamage = calculateDamage(playerAttack, enemyDefense);
    const enemyDamage = calculateDamage(enemyAttack, playerDefense);
    const newPlayerHealth = Math.max(0, playerHealth - enemyDamage);
    const newEnemyHealth = Math.max(0, enemyHealth - playerDamage);
    const messages = [
      `Your army deals ${playerDamage} damage!`,
      `Enemy army deals ${enemyDamage} damage!`
    ];
    return {
      round,
      playerDamage,
      enemyDamage,
      playerHealth: newPlayerHealth,
      enemyHealth: newEnemyHealth,
      message: messages.join(" ")
    };
  }
  function generateBattleLogs(playerArmy, enemyArmy) {
    const logs = [];
    let playerHealth = playerArmy.health;
    let enemyHealth = enemyArmy.health;
    let round = 1;
    while (playerHealth > 0 && enemyHealth > 0 && round <= MAX_BATTLE_ROUNDS) {
      const log = simulateBattleRound(playerHealth, enemyHealth, playerArmy.attack, playerArmy.defense, enemyArmy.attack, enemyArmy.defense, round);
      playerHealth = log.playerHealth;
      enemyHealth = log.enemyHealth;
      logs.push(log);
      round++;
    }
    return logs;
  }
  function determineBattleResult(logs, playerStartHealth, enemyStartHealth, mission) {
    const lastLog = logs[logs.length - 1];
    const victory = lastLog.enemyHealth <= 0;
    const playerEndHealth = lastLog.playerHealth;
    const enemyEndHealth = lastLog.enemyHealth;
    const casualtyPercent = Math.round((playerStartHealth - playerEndHealth) / playerStartHealth * 100);
    return {
      victory,
      logs,
      playerStartHealth,
      enemyStartHealth,
      playerEndHealth,
      enemyEndHealth,
      rewards: victory ? mission.rewards : void 0,
      casualtyPercent
    };
  }
  function simulateCombat(playerArmy, mission) {
    const playerPower = calculateArmyPower(playerArmy);
    if (playerPower.health <= 0) {
      return {
        victory: false,
        logs: [{
          round: 1,
          playerDamage: 0,
          enemyDamage: mission.enemyArmy.health,
          playerHealth: 0,
          enemyHealth: mission.enemyArmy.health,
          message: "You have no army to fight! The enemy claims victory."
        }],
        playerStartHealth: 0,
        enemyStartHealth: mission.enemyArmy.health,
        playerEndHealth: 0,
        enemyEndHealth: mission.enemyArmy.health,
        casualtyPercent: 100
      };
    }
    const logs = generateBattleLogs(playerPower, mission.enemyArmy);
    return determineBattleResult(logs, playerPower.health, mission.enemyArmy.health, mission);
  }
  function canStartMission(playerArmy) {
    const power = calculateArmyPower(playerArmy);
    return power.health > 0;
  }
  function getEraIndex(eraId) {
    return ERAS.findIndex((e) => e.id === eraId);
  }
  function isMissionAvailable(mission, currentEra) {
    const missionEraIndex = getEraIndex(mission.era);
    const currentEraIndex = getEraIndex(currentEra);
    return missionEraIndex <= currentEraIndex;
  }
  function generateTerritories() {
    const territories = [];
    territories.push({
      id: "territory_river_valley",
      name: "River Valley",
      description: "A fertile valley with abundant food sources.",
      era: "stone_age",
      conquered: false,
      enemyArmy: {
        name: "River Tribe",
        troops: [],
        attack: 8,
        defense: 4,
        health: 50,
        size: "small"
      },
      bonuses: { flatBonus: { resource: "food", amount: 1 } },
      rewards: { food: 80, wood: 40, stone: 20, gold: 0, science: 10 }
    });
    territories.push({
      id: "territory_forest_encampment",
      name: "Forest Encampment",
      description: "Dense woodland rich with timber.",
      era: "stone_age",
      conquered: false,
      enemyArmy: {
        name: "Forest Dwellers",
        troops: [],
        attack: 12,
        defense: 6,
        health: 70,
        size: "medium"
      },
      bonuses: { flatBonus: { resource: "wood", amount: 1 } },
      rewards: { food: 60, wood: 100, stone: 30, gold: 0, science: 15 }
    });
    territories.push({
      id: "territory_copper_mines",
      name: "Copper Mines",
      description: "Rich copper deposits for bronze production.",
      era: "bronze_age",
      conquered: false,
      enemyArmy: {
        name: "Mine Guards",
        troops: [],
        attack: 30,
        defense: 20,
        health: 150,
        size: "medium"
      },
      bonuses: { flatBonus: { resource: "gold", amount: 2 } },
      rewards: { food: 200, wood: 150, stone: 200, gold: 150, science: 50 }
    });
    territories.push({
      id: "territory_trade_crossroads",
      name: "Trade Crossroads",
      description: "A strategic trading hub.",
      era: "bronze_age",
      conquered: false,
      enemyArmy: {
        name: "Merchant Guards",
        troops: [],
        attack: 45,
        defense: 25,
        health: 200,
        size: "large"
      },
      bonuses: { resourceMultiplier: { resource: "gold", multiplier: 1.1 } },
      rewards: { food: 300, wood: 200, stone: 180, gold: 250, science: 80 }
    });
    territories.push({
      id: "territory_iron_hills",
      name: "Iron Hills",
      description: "Mountains rich with iron ore.",
      era: "iron_age",
      conquered: false,
      enemyArmy: {
        name: "Hill Clan",
        troops: [],
        attack: 70,
        defense: 50,
        health: 350,
        size: "medium"
      },
      bonuses: { flatBonus: { resource: "stone", amount: 3 } },
      rewards: { food: 500, wood: 350, stone: 400, gold: 300, science: 150 }
    });
    territories.push({
      id: "territory_coastal_fortress",
      name: "Coastal Fortress",
      description: "A strategic naval position.",
      era: "iron_age",
      conquered: false,
      enemyArmy: {
        name: "Coastal Garrison",
        troops: [],
        attack: 95,
        defense: 70,
        health: 500,
        size: "large"
      },
      bonuses: { resourceMultiplier: { resource: "food", multiplier: 1.15 } },
      rewards: { food: 700, wood: 500, stone: 400, gold: 450, science: 200 }
    });
    territories.push({
      id: "territory_ancient_library",
      name: "Ancient Library",
      description: "A repository of ancient knowledge.",
      era: "classical_age",
      conquered: false,
      enemyArmy: {
        name: "Library Guards",
        troops: [],
        attack: 140,
        defense: 90,
        health: 700,
        size: "medium"
      },
      bonuses: { flatBonus: { resource: "science", amount: 5 } },
      rewards: { food: 900, wood: 600, stone: 500, gold: 700, science: 500 }
    });
    territories.push({
      id: "territory_golden_city",
      name: "Golden City",
      description: "A wealthy city of gold and culture.",
      era: "classical_age",
      conquered: false,
      enemyArmy: {
        name: "City Guard",
        troops: [],
        attack: 175,
        defense: 120,
        health: 900,
        size: "large"
      },
      bonuses: { resourceMultiplier: { resource: "gold", multiplier: 1.2 } },
      rewards: { food: 1100, wood: 750, stone: 600, gold: 1200, science: 400 }
    });
    territories.push({
      id: "territory_castle_keep",
      name: "Castle Keep",
      description: "An impenetrable fortress.",
      era: "medieval_age",
      conquered: false,
      enemyArmy: {
        name: "Castle Defenders",
        troops: [],
        attack: 240,
        defense: 180,
        health: 1200,
        size: "large"
      },
      bonuses: { flatBonus: { resource: "stone", amount: 5 } },
      rewards: { food: 1800, wood: 1200, stone: 1500, gold: 1400, science: 700 }
    });
    territories.push({
      id: "territory_holy_land",
      name: "Holy Land",
      description: "A sacred territory with immense spiritual value.",
      era: "medieval_age",
      conquered: false,
      enemyArmy: {
        name: "Zealot Army",
        troops: [],
        attack: 300,
        defense: 210,
        health: 1500,
        size: "boss"
      },
      bonuses: { resourceMultiplier: { resource: "science", multiplier: 1.2 } },
      rewards: { food: 2200, wood: 1600, stone: 1300, gold: 2e3, science: 1e3 }
    });
    territories.push({
      id: "territory_trading_port",
      name: "Trading Port",
      description: "A bustling international trading port.",
      era: "renaissance",
      conquered: false,
      enemyArmy: {
        name: "Port Militia",
        troops: [],
        attack: 400,
        defense: 250,
        health: 2e3,
        size: "medium"
      },
      bonuses: { flatBonus: { resource: "gold", amount: 10 } },
      rewards: { food: 3500, wood: 2500, stone: 2e3, gold: 4e3, science: 1500 }
    });
    territories.push({
      id: "territory_new_world_colony",
      name: "New World Colony",
      description: "A rich colony in the new world.",
      era: "renaissance",
      conquered: false,
      enemyArmy: {
        name: "Colonial Defense",
        troops: [],
        attack: 480,
        defense: 300,
        health: 2600,
        size: "large"
      },
      bonuses: { resourceMultiplier: { resource: "food", multiplier: 1.25 } },
      rewards: { food: 5e3, wood: 3500, stone: 2500, gold: 4500, science: 1800 }
    });
    territories.push({
      id: "territory_coal_basin",
      name: "Coal Basin",
      description: "Vast coal deposits to fuel your industries.",
      era: "industrial_age",
      conquered: false,
      enemyArmy: {
        name: "Mining Company",
        troops: [],
        attack: 650,
        defense: 400,
        health: 3200,
        size: "medium"
      },
      bonuses: { flatBonus: { resource: "stone", amount: 15 } },
      rewards: { food: 7e3, wood: 5e3, stone: 6e3, gold: 6e3, science: 3e3 }
    });
    territories.push({
      id: "territory_industrial_heartland",
      name: "Industrial Heartland",
      description: "The manufacturing hub of a nation.",
      era: "industrial_age",
      conquered: false,
      enemyArmy: {
        name: "Industrial Guard",
        troops: [],
        attack: 850,
        defense: 540,
        health: 4200,
        size: "large"
      },
      bonuses: { resourceMultiplier: { resource: "wood", multiplier: 1.3 } },
      rewards: { food: 9e3, wood: 7500, stone: 5500, gold: 8e3, science: 4e3 }
    });
    territories.push({
      id: "territory_oil_fields",
      name: "Oil Fields",
      description: "Strategic petroleum reserves.",
      era: "modern_age",
      conquered: false,
      enemyArmy: {
        name: "Oil Defense Force",
        troops: [],
        attack: 1100,
        defense: 700,
        health: 5500,
        size: "medium"
      },
      bonuses: { flatBonus: { resource: "gold", amount: 30 } },
      rewards: { food: 12e3, wood: 8500, stone: 6500, gold: 18e3, science: 7e3 }
    });
    territories.push({
      id: "territory_tech_hub",
      name: "Tech Hub",
      description: "A center of technological innovation.",
      era: "modern_age",
      conquered: false,
      enemyArmy: {
        name: "Tech Security",
        troops: [],
        attack: 1500,
        defense: 950,
        health: 7500,
        size: "large"
      },
      bonuses: { resourceMultiplier: { resource: "science", multiplier: 1.35 } },
      rewards: { food: 16e3, wood: 11e3, stone: 9e3, gold: 2e4, science: 15e3 }
    });
    territories.push({
      id: "territory_nuclear_facility",
      name: "Nuclear Facility",
      description: "A secured nuclear research center.",
      era: "atomic_age",
      conquered: false,
      enemyArmy: {
        name: "Nuclear Guard",
        troops: [],
        attack: 2200,
        defense: 1350,
        health: 11e3,
        size: "medium"
      },
      bonuses: { flatBonus: { resource: "science", amount: 50 } },
      rewards: { food: 24e3, wood: 18e3, stone: 15e3, gold: 35e3, science: 25e3 }
    });
    territories.push({
      id: "territory_space_launch_complex",
      name: "Space Launch Complex",
      description: "Gateway to the stars.",
      era: "atomic_age",
      conquered: false,
      enemyArmy: {
        name: "Space Command",
        troops: [],
        attack: 3200,
        defense: 1950,
        health: 16e3,
        size: "large"
      },
      bonuses: { resourceMultiplier: { resource: "science", multiplier: 1.4 } },
      rewards: { food: 34e3, wood: 28e3, stone: 22e3, gold: 46e3, science: 35e3 }
    });
    territories.push({
      id: "territory_data_center",
      name: "Global Data Center",
      description: "The nerve center of worldwide communications.",
      era: "information_age",
      conquered: false,
      enemyArmy: {
        name: "Cyber Defense",
        troops: [],
        attack: 4500,
        defense: 2800,
        health: 22e3,
        size: "medium"
      },
      bonuses: { flatBonus: { resource: "science", amount: 80 } },
      rewards: { food: 48e3, wood: 35e3, stone: 28e3, gold: 7e4, science: 55e3 }
    });
    territories.push({
      id: "territory_ai_nexus",
      name: "AI Nexus",
      description: "The central hub of artificial intelligence.",
      era: "information_age",
      conquered: false,
      enemyArmy: {
        name: "AI Defense Grid",
        troops: [],
        attack: 5800,
        defense: 3800,
        health: 3e4,
        size: "large"
      },
      bonuses: { resourceMultiplier: { resource: "science", multiplier: 1.5 } },
      rewards: { food: 68e3, wood: 5e4, stone: 4e4, gold: 9e4, science: 75e3 }
    });
    territories.push({
      id: "territory_space_station",
      name: "Orbital Space Station",
      description: "A strategic foothold in orbit.",
      era: "future_age",
      conquered: false,
      enemyArmy: {
        name: "Orbital Guard",
        troops: [],
        attack: 9e3,
        defense: 5500,
        health: 45e3,
        size: "medium"
      },
      bonuses: { flatBonus: { resource: "science", amount: 150 } },
      rewards: { food: 12e4, wood: 84e3, stone: 6e4, gold: 18e4, science: 15e4 }
    });
    territories.push({
      id: "territory_dyson_sphere",
      name: "Dyson Sphere",
      description: "Harness the power of a star!",
      era: "future_age",
      conquered: false,
      enemyArmy: {
        name: "Stellar Guardians",
        troops: [],
        attack: 13e3,
        defense: 8500,
        health: 65e3,
        size: "boss"
      },
      bonuses: { resourceMultiplier: { resource: "gold", multiplier: 2 } },
      rewards: { food: 2e5, wood: 15e4, stone: 1e5, gold: 35e4, science: 25e4 }
    });
    territories.push({
      id: "territory_hunting_grounds",
      name: "Hunting Grounds",
      description: "Vast plains teeming with wild game.",
      era: "stone_age",
      conquered: false,
      enemyArmy: {
        name: "Nomadic Hunters",
        troops: [],
        attack: 10,
        defense: 5,
        health: 60,
        size: "small"
      },
      bonuses: { flatBonus: { resource: "food", amount: 2 } },
      rewards: { food: 100, wood: 30, stone: 20, gold: 0, science: 10 }
    });
    territories.push({
      id: "territory_sacred_cave",
      name: "Sacred Cave",
      description: "An ancient cave with mysterious paintings and spiritual significance.",
      era: "stone_age",
      conquered: false,
      enemyArmy: {
        name: "Cave Shamans",
        troops: [],
        attack: 15,
        defense: 10,
        health: 90,
        size: "medium"
      },
      bonuses: { flatBonus: { resource: "science", amount: 1 } },
      rewards: { food: 70, wood: 50, stone: 80, gold: 0, science: 30 }
    });
    territories.push({
      id: "territory_fertile_delta",
      name: "Fertile Delta",
      description: "Rich farmland where a great river meets the sea.",
      era: "bronze_age",
      conquered: false,
      enemyArmy: {
        name: "Delta Farmers",
        troops: [],
        attack: 25,
        defense: 15,
        health: 130,
        size: "medium"
      },
      bonuses: { resourceMultiplier: { resource: "food", multiplier: 1.15 } },
      rewards: { food: 250, wood: 100, stone: 80, gold: 100, science: 40 }
    });
    territories.push({
      id: "territory_tin_deposits",
      name: "Tin Deposits",
      description: "Essential tin for bronze alloy production.",
      era: "bronze_age",
      conquered: false,
      enemyArmy: {
        name: "Tin Miners",
        troops: [],
        attack: 35,
        defense: 25,
        health: 180,
        size: "medium"
      },
      bonuses: { flatBonus: { resource: "stone", amount: 3 } },
      rewards: { food: 150, wood: 120, stone: 280, gold: 120, science: 60 }
    });
    territories.push({
      id: "territory_mountain_pass",
      name: "Mountain Pass",
      description: "A strategic mountain passage controlling trade routes.",
      era: "iron_age",
      conquered: false,
      enemyArmy: {
        name: "Pass Wardens",
        troops: [],
        attack: 80,
        defense: 60,
        health: 400,
        size: "medium"
      },
      bonuses: { flatBonus: { resource: "gold", amount: 5 } },
      rewards: { food: 400, wood: 300, stone: 350, gold: 400, science: 150 }
    });
    territories.push({
      id: "territory_salt_flats",
      name: "Salt Flats",
      description: "Valuable salt deposits worth their weight in gold.",
      era: "iron_age",
      conquered: false,
      enemyArmy: {
        name: "Salt Traders",
        troops: [],
        attack: 60,
        defense: 40,
        health: 320,
        size: "small"
      },
      bonuses: { resourceMultiplier: { resource: "gold", multiplier: 1.1 } },
      rewards: { food: 350, wood: 200, stone: 250, gold: 500, science: 120 }
    });
    territories.push({
      id: "territory_marble_quarry",
      name: "Marble Quarry",
      description: "Source of fine marble for monuments and temples.",
      era: "classical_age",
      conquered: false,
      enemyArmy: {
        name: "Quarry Masters",
        troops: [],
        attack: 130,
        defense: 100,
        health: 650,
        size: "medium"
      },
      bonuses: { flatBonus: { resource: "stone", amount: 8 } },
      rewards: { food: 800, wood: 500, stone: 900, gold: 600, science: 300 }
    });
    territories.push({
      id: "territory_wine_region",
      name: "Wine Region",
      description: "Famous vineyards producing the finest wines.",
      era: "classical_age",
      conquered: false,
      enemyArmy: {
        name: "Vineyard Defenders",
        troops: [],
        attack: 120,
        defense: 80,
        health: 600,
        size: "small"
      },
      bonuses: { flatBonus: { resource: "gold", amount: 8 } },
      rewards: { food: 700, wood: 400, stone: 300, gold: 800, science: 250 }
    });
    territories.push({
      id: "territory_philosophers_grove",
      name: "Philosophers' Grove",
      description: "A sacred grove where great minds gather to debate.",
      era: "classical_age",
      conquered: false,
      enemyArmy: {
        name: "Academic Guards",
        troops: [],
        attack: 100,
        defense: 70,
        health: 500,
        size: "small"
      },
      bonuses: { resourceMultiplier: { resource: "science", multiplier: 1.15 } },
      rewards: { food: 600, wood: 400, stone: 300, gold: 500, science: 600 }
    });
    territories.push({
      id: "territory_silver_mines",
      name: "Silver Mines",
      description: "Rich veins of silver hidden in the mountains.",
      era: "medieval_age",
      conquered: false,
      enemyArmy: {
        name: "Mining Guild",
        troops: [],
        attack: 220,
        defense: 160,
        health: 1100,
        size: "medium"
      },
      bonuses: { flatBonus: { resource: "gold", amount: 12 } },
      rewards: { food: 1500, wood: 1e3, stone: 1200, gold: 2e3, science: 600 }
    });
    territories.push({
      id: "territory_monastery",
      name: "Grand Monastery",
      description: "A center of learning and religious devotion.",
      era: "medieval_age",
      conquered: false,
      enemyArmy: {
        name: "Monk Warriors",
        troops: [],
        attack: 180,
        defense: 200,
        health: 1e3,
        size: "medium"
      },
      bonuses: { flatBonus: { resource: "science", amount: 8 } },
      rewards: { food: 1200, wood: 800, stone: 900, gold: 1200, science: 1e3 }
    });
    territories.push({
      id: "territory_wheat_fields",
      name: "Golden Wheat Fields",
      description: "Endless fields of golden wheat to feed empires.",
      era: "medieval_age",
      conquered: false,
      enemyArmy: {
        name: "Peasant Militia",
        troops: [],
        attack: 150,
        defense: 120,
        health: 800,
        size: "small"
      },
      bonuses: { resourceMultiplier: { resource: "food", multiplier: 1.2 } },
      rewards: { food: 2e3, wood: 700, stone: 500, gold: 800, science: 400 }
    });
    territories.push({
      id: "territory_spice_islands",
      name: "Spice Islands",
      description: "Exotic islands with rare and valuable spices.",
      era: "renaissance",
      conquered: false,
      enemyArmy: {
        name: "Island Defenders",
        troops: [],
        attack: 380,
        defense: 220,
        health: 1900,
        size: "medium"
      },
      bonuses: { flatBonus: { resource: "gold", amount: 15 } },
      rewards: { food: 3200, wood: 2200, stone: 1600, gold: 4500, science: 1200 }
    });
    territories.push({
      id: "territory_university_city",
      name: "University City",
      description: "A renowned center of Renaissance learning.",
      era: "renaissance",
      conquered: false,
      enemyArmy: {
        name: "Scholar Militia",
        troops: [],
        attack: 320,
        defense: 280,
        health: 1700,
        size: "medium"
      },
      bonuses: { resourceMultiplier: { resource: "science", multiplier: 1.2 } },
      rewards: { food: 2800, wood: 2e3, stone: 1800, gold: 3e3, science: 2500 }
    });
    territories.push({
      id: "territory_banking_center",
      name: "Banking Center",
      description: "The financial heart of the known world.",
      era: "renaissance",
      conquered: false,
      enemyArmy: {
        name: "Mercenary Guards",
        troops: [],
        attack: 450,
        defense: 300,
        health: 2400,
        size: "large"
      },
      bonuses: { resourceMultiplier: { resource: "gold", multiplier: 1.25 } },
      rewards: { food: 3500, wood: 2500, stone: 2e3, gold: 6e3, science: 1500 }
    });
    territories.push({
      id: "territory_steel_mills",
      name: "Steel Mills",
      description: "Massive industrial complexes producing steel.",
      era: "industrial_age",
      conquered: false,
      enemyArmy: {
        name: "Factory Workers",
        troops: [],
        attack: 600,
        defense: 400,
        health: 3e3,
        size: "medium"
      },
      bonuses: { flatBonus: { resource: "stone", amount: 20 } },
      rewards: { food: 6500, wood: 5e3, stone: 7e3, gold: 5500, science: 2800 }
    });
    territories.push({
      id: "territory_railroad_hub",
      name: "Railroad Hub",
      description: "A major junction connecting all rail lines.",
      era: "industrial_age",
      conquered: false,
      enemyArmy: {
        name: "Railway Guard",
        troops: [],
        attack: 700,
        defense: 450,
        health: 3500,
        size: "large"
      },
      bonuses: { resourceMultiplier: { resource: "wood", multiplier: 1.25 } },
      rewards: { food: 7500, wood: 8e3, stone: 5e3, gold: 7e3, science: 3500 }
    });
    territories.push({
      id: "territory_textile_district",
      name: "Textile District",
      description: "Factories producing cloth for the world.",
      era: "industrial_age",
      conquered: false,
      enemyArmy: {
        name: "Guild Masters",
        troops: [],
        attack: 550,
        defense: 350,
        health: 2800,
        size: "small"
      },
      bonuses: { flatBonus: { resource: "gold", amount: 25 } },
      rewards: { food: 5500, wood: 4e3, stone: 3e3, gold: 9e3, science: 2500 }
    });
    territories.push({
      id: "territory_silicon_valley",
      name: "Tech Valley",
      description: "The birthplace of modern computing.",
      era: "modern_age",
      conquered: false,
      enemyArmy: {
        name: "Tech Security",
        troops: [],
        attack: 1200,
        defense: 800,
        health: 6e3,
        size: "medium"
      },
      bonuses: { flatBonus: { resource: "science", amount: 40 } },
      rewards: { food: 14e3, wood: 1e4, stone: 8e3, gold: 18e3, science: 2e4 }
    });
    territories.push({
      id: "territory_financial_district",
      name: "Financial District",
      description: "The economic powerhouse of the modern world.",
      era: "modern_age",
      conquered: false,
      enemyArmy: {
        name: "Corporate Security",
        troops: [],
        attack: 1100,
        defense: 700,
        health: 5500,
        size: "medium"
      },
      bonuses: { resourceMultiplier: { resource: "gold", multiplier: 1.3 } },
      rewards: { food: 12e3, wood: 8e3, stone: 6e3, gold: 25e3, science: 1e4 }
    });
    territories.push({
      id: "territory_military_base",
      name: "Military Base",
      description: "A heavily fortified military installation.",
      era: "modern_age",
      conquered: false,
      enemyArmy: {
        name: "Base Garrison",
        troops: [],
        attack: 1400,
        defense: 1100,
        health: 7e3,
        size: "large"
      },
      bonuses: { flatBonus: { resource: "stone", amount: 25 } },
      rewards: { food: 15e3, wood: 12e3, stone: 15e3, gold: 15e3, science: 8e3 }
    });
    territories.push({
      id: "territory_uranium_mines",
      name: "Uranium Mines",
      description: "Strategic deposits of nuclear fuel.",
      era: "atomic_age",
      conquered: false,
      enemyArmy: {
        name: "Nuclear Security",
        troops: [],
        attack: 2400,
        defense: 1500,
        health: 12e3,
        size: "medium"
      },
      bonuses: { flatBonus: { resource: "science", amount: 60 } },
      rewards: { food: 28e3, wood: 2e4, stone: 25e3, gold: 4e4, science: 3e4 }
    });
    territories.push({
      id: "territory_missile_silo",
      name: "Missile Silo Complex",
      description: "Underground facilities housing nuclear missiles.",
      era: "atomic_age",
      conquered: false,
      enemyArmy: {
        name: "Silo Guards",
        troops: [],
        attack: 3e3,
        defense: 2200,
        health: 15e3,
        size: "large"
      },
      bonuses: { resourceMultiplier: { resource: "stone", multiplier: 1.35 } },
      rewards: { food: 32e3, wood: 25e3, stone: 35e3, gold: 45e3, science: 25e3 }
    });
    territories.push({
      id: "territory_research_campus",
      name: "Research Campus",
      description: "A sprawling complex dedicated to scientific advancement.",
      era: "atomic_age",
      conquered: false,
      enemyArmy: {
        name: "Research Security",
        troops: [],
        attack: 2e3,
        defense: 1200,
        health: 1e4,
        size: "small"
      },
      bonuses: { resourceMultiplier: { resource: "science", multiplier: 1.3 } },
      rewards: { food: 22e3, wood: 16e3, stone: 14e3, gold: 3e4, science: 4e4 }
    });
    territories.push({
      id: "territory_server_farm",
      name: "Global Server Farm",
      description: "Massive data centers powering the digital world.",
      era: "information_age",
      conquered: false,
      enemyArmy: {
        name: "Digital Defense",
        troops: [],
        attack: 4800,
        defense: 3e3,
        health: 24e3,
        size: "medium"
      },
      bonuses: { flatBonus: { resource: "science", amount: 100 } },
      rewards: { food: 55e3, wood: 4e4, stone: 35e3, gold: 8e4, science: 7e4 }
    });
    territories.push({
      id: "territory_smart_city",
      name: "Smart City",
      description: "A fully automated city of the future.",
      era: "information_age",
      conquered: false,
      enemyArmy: {
        name: "Automated Defense",
        troops: [],
        attack: 5500,
        defense: 3500,
        health: 28e3,
        size: "large"
      },
      bonuses: { resourceMultiplier: { resource: "food", multiplier: 1.4 } },
      rewards: { food: 8e4, wood: 55e3, stone: 45e3, gold: 1e5, science: 6e4 }
    });
    territories.push({
      id: "territory_quantum_lab",
      name: "Quantum Research Lab",
      description: "Where the boundaries of physics are pushed.",
      era: "information_age",
      conquered: false,
      enemyArmy: {
        name: "Lab Security",
        troops: [],
        attack: 4200,
        defense: 2600,
        health: 21e3,
        size: "small"
      },
      bonuses: { resourceMultiplier: { resource: "science", multiplier: 1.45 } },
      rewards: { food: 45e3, wood: 32e3, stone: 28e3, gold: 6e4, science: 9e4 }
    });
    territories.push({
      id: "territory_mars_colony",
      name: "Mars Colony",
      description: "Humanity's first permanent settlement on Mars.",
      era: "future_age",
      conquered: false,
      enemyArmy: {
        name: "Colonial Defense",
        troops: [],
        attack: 1e4,
        defense: 6500,
        health: 5e4,
        size: "large"
      },
      bonuses: { flatBonus: { resource: "science", amount: 200 } },
      rewards: { food: 15e4, wood: 1e5, stone: 8e4, gold: 22e4, science: 2e5 }
    });
    territories.push({
      id: "territory_asteroid_belt",
      name: "Asteroid Mining Belt",
      description: "Unlimited resources floating in space.",
      era: "future_age",
      conquered: false,
      enemyArmy: {
        name: "Mining Drones",
        troops: [],
        attack: 8500,
        defense: 5e3,
        health: 42e3,
        size: "medium"
      },
      bonuses: { flatBonus: { resource: "gold", amount: 200 } },
      rewards: { food: 1e5, wood: 8e4, stone: 15e4, gold: 3e5, science: 12e4 }
    });
    territories.push({
      id: "territory_antimatter_plant",
      name: "Antimatter Power Plant",
      description: "Harnessing the most powerful energy source known.",
      era: "future_age",
      conquered: false,
      enemyArmy: {
        name: "Energy Sentinels",
        troops: [],
        attack: 11e3,
        defense: 7500,
        health: 55e3,
        size: "large"
      },
      bonuses: { resourceMultiplier: { resource: "science", multiplier: 1.8 } },
      rewards: { food: 18e4, wood: 13e4, stone: 1e5, gold: 28e4, science: 3e5 }
    });
    territories.push({
      id: "territory_galactic_gateway",
      name: "Galactic Gateway",
      description: "A portal to the stars. The ultimate prize.",
      era: "future_age",
      conquered: false,
      enemyArmy: {
        name: "Dimensional Guardians",
        troops: [],
        attack: 15e3,
        defense: 1e4,
        health: 75e3,
        size: "boss"
      },
      bonuses: { resourceMultiplier: { resource: "gold", multiplier: 2.5 } },
      rewards: { food: 3e5, wood: 25e4, stone: 2e5, gold: 5e5, science: 4e5 }
    });
    return territories;
  }
  function getTerritoryById(territories, id) {
    return territories.find((t) => t.id === id);
  }
  function getTerritoriesByEra(territories, era) {
    return territories.filter((t) => t.era === era);
  }
  function isTerritoryAvailable(territory, currentEra) {
    const territoryEraIndex = getEraIndex(territory.era);
    const currentEraIndex = getEraIndex(currentEra);
    return territoryEraIndex <= currentEraIndex;
  }
  function calculateConquestBonuses(territories) {
    const bonuses = { food: 0, wood: 0, stone: 0, gold: 0, science: 0 };
    const validResources = ["food", "wood", "stone", "gold", "science"];
    for (const territory of territories) {
      if (territory.conquered && territory.bonuses.flatBonus) {
        const resource = territory.bonuses.flatBonus.resource;
        if (validResources.includes(resource)) {
          bonuses[resource] += territory.bonuses.flatBonus.amount;
        }
      }
    }
    return bonuses;
  }
  function calculateConquestMultipliers(territories) {
    const multipliers = { food: 1, wood: 1, stone: 1, gold: 1, science: 1 };
    const validResources = ["food", "wood", "stone", "gold", "science"];
    for (const territory of territories) {
      if (territory.conquered && territory.bonuses.resourceMultiplier) {
        const resource = territory.bonuses.resourceMultiplier.resource;
        if (validResources.includes(resource)) {
          multipliers[resource] *= territory.bonuses.resourceMultiplier.multiplier;
        }
      }
    }
    return multipliers;
  }
  function simulateTerritoryConquest(playerArmy, territory) {
    const playerPower = calculateArmyPower(playerArmy);
    if (playerPower.health <= 0) {
      return {
        victory: false,
        logs: [{
          round: 1,
          playerDamage: 0,
          enemyDamage: territory.enemyArmy.health,
          playerHealth: 0,
          enemyHealth: territory.enemyArmy.health,
          message: "You have no army to fight! The territory remains unconquered."
        }],
        playerStartHealth: 0,
        enemyStartHealth: territory.enemyArmy.health,
        playerEndHealth: 0,
        enemyEndHealth: territory.enemyArmy.health,
        casualtyPercent: 100
      };
    }
    const logs = generateBattleLogs(playerPower, territory.enemyArmy);
    const lastLog = logs[logs.length - 1];
    const victory = lastLog.enemyHealth <= 0;
    const playerEndHealth = lastLog.playerHealth;
    const enemyEndHealth = lastLog.enemyHealth;
    const casualtyPercent = Math.round((playerPower.health - playerEndHealth) / playerPower.health * 100);
    return {
      victory,
      logs,
      playerStartHealth: playerPower.health,
      enemyStartHealth: territory.enemyArmy.health,
      playerEndHealth,
      enemyEndHealth,
      rewards: victory ? territory.rewards : void 0,
      casualtyPercent
    };
  }

  // dist/achievements.js
  var ACHIEVEMENTS = [
    // Resource Achievements
    {
      id: "first_food",
      name: "First Meal",
      description: "Gather 100 total food",
      icon: "\u{1F356}",
      category: "resources",
      condition: { type: "resource_total", target: "food", amount: 100 }
    },
    {
      id: "food_stockpile",
      name: "Food Stockpile",
      description: "Gather 1,000 total food",
      icon: "\u{1F356}",
      category: "resources",
      condition: { type: "resource_total", target: "food", amount: 1e3 }
    },
    {
      id: "feast_master",
      name: "Feast Master",
      description: "Gather 10,000 total food",
      icon: "\u{1F356}",
      category: "resources",
      condition: { type: "resource_total", target: "food", amount: 1e4 },
      reward: { type: "multiplier", resource: "food", amount: 1.1 }
    },
    {
      id: "first_lumber",
      name: "Lumberjack",
      description: "Gather 100 total wood",
      icon: "\u{1FAB5}",
      category: "resources",
      condition: { type: "resource_total", target: "wood", amount: 100 }
    },
    {
      id: "wood_stockpile",
      name: "Timber Baron",
      description: "Gather 1,000 total wood",
      icon: "\u{1FAB5}",
      category: "resources",
      condition: { type: "resource_total", target: "wood", amount: 1e3 }
    },
    {
      id: "forest_cleared",
      name: "Forest Cleared",
      description: "Gather 10,000 total wood",
      icon: "\u{1FAB5}",
      category: "resources",
      condition: { type: "resource_total", target: "wood", amount: 1e4 },
      reward: { type: "multiplier", resource: "wood", amount: 1.1 }
    },
    {
      id: "first_stone",
      name: "Stone Collector",
      description: "Gather 50 total stone",
      icon: "\u{1FAA8}",
      category: "resources",
      condition: { type: "resource_total", target: "stone", amount: 50 }
    },
    {
      id: "quarry_master",
      name: "Quarry Master",
      description: "Gather 1,000 total stone",
      icon: "\u{1FAA8}",
      category: "resources",
      condition: { type: "resource_total", target: "stone", amount: 1e3 }
    },
    {
      id: "mountain_mover",
      name: "Mountain Mover",
      description: "Gather 10,000 total stone",
      icon: "\u{1FAA8}",
      category: "resources",
      condition: { type: "resource_total", target: "stone", amount: 1e4 },
      reward: { type: "multiplier", resource: "stone", amount: 1.1 }
    },
    {
      id: "first_gold",
      name: "Gold Rush",
      description: "Accumulate 100 total gold",
      icon: "\u{1F4B0}",
      category: "resources",
      condition: { type: "resource_total", target: "gold", amount: 100 }
    },
    {
      id: "wealthy",
      name: "Wealthy",
      description: "Accumulate 1,000 total gold",
      icon: "\u{1F4B0}",
      category: "resources",
      condition: { type: "resource_total", target: "gold", amount: 1e3 }
    },
    {
      id: "tycoon",
      name: "Tycoon",
      description: "Accumulate 10,000 total gold",
      icon: "\u{1F4B0}",
      category: "resources",
      condition: { type: "resource_total", target: "gold", amount: 1e4 },
      reward: { type: "multiplier", resource: "gold", amount: 1.1 }
    },
    {
      id: "first_science",
      name: "Curious Mind",
      description: "Generate 50 total science",
      icon: "\u{1F52C}",
      category: "resources",
      condition: { type: "resource_total", target: "science", amount: 50 }
    },
    {
      id: "scientist",
      name: "Scientist",
      description: "Generate 500 total science",
      icon: "\u{1F52C}",
      category: "resources",
      condition: { type: "resource_total", target: "science", amount: 500 }
    },
    {
      id: "genius",
      name: "Genius",
      description: "Generate 5,000 total science",
      icon: "\u{1F52C}",
      category: "resources",
      condition: { type: "resource_total", target: "science", amount: 5e3 },
      reward: { type: "multiplier", resource: "science", amount: 1.1 }
    },
    // Research Achievements
    {
      id: "first_tech",
      name: "First Discovery",
      description: "Research your first technology",
      icon: "\u{1F4DA}",
      category: "research",
      condition: { type: "tech_count", target: "any", amount: 1 }
    },
    {
      id: "tech_5",
      name: "Scholar",
      description: "Research 5 technologies",
      icon: "\u{1F4DA}",
      category: "research",
      condition: { type: "tech_count", target: "any", amount: 5 }
    },
    {
      id: "tech_10",
      name: "Researcher",
      description: "Research 10 technologies",
      icon: "\u{1F4DA}",
      category: "research",
      condition: { type: "tech_count", target: "any", amount: 10 }
    },
    {
      id: "tech_20",
      name: "Professor",
      description: "Research 20 technologies",
      icon: "\u{1F4DA}",
      category: "research",
      condition: { type: "tech_count", target: "any", amount: 20 },
      reward: { type: "multiplier", resource: "science", amount: 1.15 }
    },
    {
      id: "tech_all",
      name: "Omniscient",
      description: "Research all technologies",
      icon: "\u{1F9E0}",
      category: "research",
      condition: { type: "tech_count", target: "any", amount: 44 },
      reward: { type: "multiplier", resource: "science", amount: 1.5 }
    },
    // Military Achievements
    {
      id: "first_troop",
      name: "First Recruit",
      description: "Train your first troop",
      icon: "\u2694\uFE0F",
      category: "military",
      condition: { type: "troop_count", target: "any", amount: 1 }
    },
    {
      id: "small_army",
      name: "Small Army",
      description: "Have 10 troops in your army",
      icon: "\u2694\uFE0F",
      category: "military",
      condition: { type: "troop_count", target: "any", amount: 10 }
    },
    {
      id: "large_army",
      name: "Large Army",
      description: "Have 50 troops in your army",
      icon: "\u2694\uFE0F",
      category: "military",
      condition: { type: "troop_count", target: "any", amount: 50 }
    },
    {
      id: "massive_army",
      name: "Massive Army",
      description: "Have 100 troops in your army",
      icon: "\u{1F6E1}\uFE0F",
      category: "military",
      condition: { type: "troop_count", target: "any", amount: 100 }
    },
    // Progress Achievements
    {
      id: "bronze_age",
      name: "Bronze Age",
      description: "Reach the Bronze Age",
      icon: "\u{1F949}",
      category: "progress",
      condition: { type: "era_reached", target: "bronze_age", amount: 1 }
    },
    {
      id: "iron_age",
      name: "Iron Age",
      description: "Reach the Iron Age",
      icon: "\u2699\uFE0F",
      category: "progress",
      condition: { type: "era_reached", target: "iron_age", amount: 1 }
    },
    {
      id: "classical_age",
      name: "Classical Age",
      description: "Reach the Classical Age",
      icon: "\u{1F3DB}\uFE0F",
      category: "progress",
      condition: { type: "era_reached", target: "classical_age", amount: 1 }
    },
    {
      id: "medieval_age",
      name: "Medieval Age",
      description: "Reach the Medieval Age",
      icon: "\u{1F3F0}",
      category: "progress",
      condition: { type: "era_reached", target: "medieval_age", amount: 1 }
    },
    {
      id: "renaissance",
      name: "Renaissance",
      description: "Reach the Renaissance",
      icon: "\u{1F3A8}",
      category: "progress",
      condition: { type: "era_reached", target: "renaissance", amount: 1 }
    },
    {
      id: "industrial_age",
      name: "Industrial Age",
      description: "Reach the Industrial Age",
      icon: "\u{1F3ED}",
      category: "progress",
      condition: { type: "era_reached", target: "industrial_age", amount: 1 }
    },
    {
      id: "modern_age",
      name: "Modern Age",
      description: "Reach the Modern Age",
      icon: "\u{1F697}",
      category: "progress",
      condition: { type: "era_reached", target: "modern_age", amount: 1 }
    },
    {
      id: "atomic_age",
      name: "Atomic Age",
      description: "Reach the Atomic Age",
      icon: "\u2622\uFE0F",
      category: "progress",
      condition: { type: "era_reached", target: "atomic_age", amount: 1 }
    },
    {
      id: "information_age",
      name: "Information Age",
      description: "Reach the Information Age",
      icon: "\u{1F4BB}",
      category: "progress",
      condition: { type: "era_reached", target: "information_age", amount: 1 }
    },
    {
      id: "future_age",
      name: "Future Age",
      description: "Reach the Future Age",
      icon: "\u{1F680}",
      category: "progress",
      condition: { type: "era_reached", target: "future_age", amount: 1 },
      reward: { type: "multiplier", resource: "science", amount: 2 }
    },
    // Combat Achievements
    {
      id: "first_victory",
      name: "First Victory",
      description: "Win your first battle",
      icon: "\u{1F3C6}",
      category: "combat",
      condition: { type: "battles_won", target: "any", amount: 1 }
    },
    {
      id: "veteran",
      name: "Veteran",
      description: "Win 5 battles",
      icon: "\u{1F3C6}",
      category: "combat",
      condition: { type: "battles_won", target: "any", amount: 5 }
    },
    {
      id: "war_hero",
      name: "War Hero",
      description: "Win 10 battles",
      icon: "\u{1F396}\uFE0F",
      category: "combat",
      condition: { type: "battles_won", target: "any", amount: 10 }
    },
    {
      id: "legendary_commander",
      name: "Legendary Commander",
      description: "Win 25 battles",
      icon: "\u{1F451}",
      category: "combat",
      condition: { type: "battles_won", target: "any", amount: 25 }
    },
    {
      id: "mission_complete_1",
      name: "Mission Accomplished",
      description: "Complete your first mission",
      icon: "\u2705",
      category: "combat",
      condition: { type: "missions_completed", target: "any", amount: 1 }
    },
    {
      id: "mission_complete_5",
      name: "Mission Specialist",
      description: "Complete 5 unique missions",
      icon: "\u2705",
      category: "combat",
      condition: { type: "missions_completed", target: "any", amount: 5 }
    },
    {
      id: "mission_complete_10",
      name: "Mission Master",
      description: "Complete 10 unique missions",
      icon: "\u{1F31F}",
      category: "combat",
      condition: { type: "missions_completed", target: "any", amount: 10 }
    },
    {
      id: "all_missions",
      name: "Conqueror",
      description: "Complete all missions",
      icon: "\u{1F30D}",
      category: "combat",
      condition: { type: "missions_completed", target: "any", amount: 22 }
    },
    // Building Achievements
    {
      id: "first_building",
      name: "First Construction",
      description: "Construct your first building",
      icon: "\u{1F3E0}",
      category: "buildings",
      condition: { type: "building_count", target: "any", amount: 1 }
    },
    {
      id: "small_village",
      name: "Small Village",
      description: "Have 5 buildings in your civilization",
      icon: "\u{1F3D8}\uFE0F",
      category: "buildings",
      condition: { type: "building_count", target: "any", amount: 5 }
    },
    {
      id: "town",
      name: "Growing Town",
      description: "Have 15 buildings in your civilization",
      icon: "\u{1F3D9}\uFE0F",
      category: "buildings",
      condition: { type: "building_count", target: "any", amount: 15 }
    },
    {
      id: "city",
      name: "City Builder",
      description: "Have 30 buildings in your civilization",
      icon: "\u{1F306}",
      category: "buildings",
      condition: { type: "building_count", target: "any", amount: 30 },
      reward: { type: "multiplier", resource: "gold", amount: 1.15 }
    },
    {
      id: "metropolis",
      name: "Metropolis",
      description: "Have 50 buildings in your civilization",
      icon: "\u{1F303}",
      category: "buildings",
      condition: { type: "building_count", target: "any", amount: 50 },
      reward: { type: "multiplier", resource: "gold", amount: 1.25 }
    }
  ];
  function getAchievementById(id) {
    return ACHIEVEMENTS.find((a) => a.id === id);
  }
  function getAchievementsByCategory(category) {
    return ACHIEVEMENTS.filter((a) => a.category === category);
  }
  function createInitialStatistics() {
    return {
      totalFoodGathered: 0,
      totalWoodGathered: 0,
      totalStoneGathered: 0,
      totalGoldEarned: 0,
      totalScienceGenerated: 0,
      totalTroopsTrained: 0,
      battlesWon: 0,
      battlesLost: 0,
      clickCount: 0,
      offlineEarnings: 0,
      totalBuildingsConstructed: 0,
      territoriesConquered: 0,
      heroesRecruited: 0
    };
  }
  function createInitialAchievementProgress() {
    const progress = /* @__PURE__ */ new Map();
    for (const achievement of ACHIEVEMENTS) {
      progress.set(achievement.id, {
        id: achievement.id,
        unlocked: false,
        notified: false
      });
    }
    return progress;
  }

  // dist/buildings.js
  var BUILDING_TYPES = [
    // Stone Age Buildings
    {
      id: "hut",
      name: "Hut",
      description: "A simple shelter that increases food production.",
      era: "stone_age",
      unlockTech: null,
      // Available from start
      cost: { food: 10, wood: 10, stone: 5, gold: 0 },
      buildTime: 10,
      production: { food: 0.5 },
      maxCount: 10
    },
    {
      id: "campfire",
      name: "Campfire",
      description: "Provides warmth and allows better cooking. Increases food and science.",
      era: "stone_age",
      unlockTech: "fire",
      cost: { food: 5, wood: 20, stone: 10, gold: 0 },
      buildTime: 8,
      production: { food: 0.3, science: 0.1 },
      maxCount: 5
    },
    {
      id: "farm",
      name: "Farm",
      description: "Cultivate crops for a steady food supply.",
      era: "stone_age",
      unlockTech: "agriculture",
      cost: { food: 15, wood: 20, stone: 5, gold: 0 },
      buildTime: 15,
      production: { food: 1 },
      maxCount: 15
    },
    // Bronze Age Buildings
    {
      id: "granary",
      name: "Granary",
      description: "Store grain to prevent food spoilage. Greatly increases food production.",
      era: "bronze_age",
      unlockTech: "pottery",
      cost: { food: 50, wood: 80, stone: 60, gold: 20 },
      buildTime: 20,
      production: { food: 2 },
      maxCount: 10
    },
    {
      id: "workshop",
      name: "Workshop",
      description: "Craft tools and goods. Increases wood and stone production.",
      era: "bronze_age",
      unlockTech: "bronze_working",
      cost: { food: 40, wood: 100, stone: 80, gold: 30 },
      buildTime: 25,
      production: { wood: 1, stone: 0.5 },
      maxCount: 8
    },
    {
      id: "library",
      name: "Library",
      description: "A place of learning. Increases science production.",
      era: "bronze_age",
      unlockTech: "writing",
      cost: { food: 30, wood: 60, stone: 40, gold: 50 },
      buildTime: 30,
      production: { science: 0.5 },
      maxCount: 5
    },
    // Iron Age Buildings
    {
      id: "mine",
      name: "Mine",
      description: "Extract ore and stone from the earth.",
      era: "iron_age",
      unlockTech: "iron_working",
      cost: { food: 60, wood: 100, stone: 150, gold: 80 },
      buildTime: 40,
      production: { stone: 2, gold: 0.5 },
      maxCount: 10
    },
    {
      id: "market",
      name: "Market",
      description: "Trade goods for gold. Increases gold production.",
      era: "iron_age",
      unlockTech: "currency",
      cost: { food: 50, wood: 80, stone: 60, gold: 100 },
      buildTime: 35,
      production: { gold: 1.5 },
      maxCount: 8
    },
    {
      id: "academy",
      name: "Academy",
      description: "Train scholars and philosophers. Greatly increases science.",
      era: "iron_age",
      unlockTech: "philosophy",
      cost: { food: 40, wood: 70, stone: 80, gold: 150 },
      buildTime: 45,
      production: { science: 1.5 },
      maxCount: 5
    },
    // Classical Age Buildings
    {
      id: "aqueduct",
      name: "Aqueduct",
      description: "Bring water to your cities. Boosts food and stone production.",
      era: "classical_age",
      unlockTech: "engineering",
      cost: { food: 80, wood: 100, stone: 200, gold: 150 },
      buildTime: 60,
      production: { food: 2.5, stone: 1.5 },
      maxCount: 5
    },
    {
      id: "colosseum",
      name: "Colosseum",
      description: "Entertainment venue. Attracts trade and boosts gold.",
      era: "classical_age",
      unlockTech: "construction",
      cost: { food: 100, wood: 150, stone: 300, gold: 200 },
      buildTime: 80,
      production: { gold: 3 },
      maxCount: 3
    },
    // Medieval Age Buildings
    {
      id: "blacksmith",
      name: "Blacksmith",
      description: "Forge weapons and tools. Increases gold and stone production.",
      era: "medieval_age",
      unlockTech: "metal_casting",
      cost: { food: 100, wood: 150, stone: 200, gold: 250 },
      buildTime: 50,
      production: { gold: 2, stone: 1 },
      maxCount: 8
    },
    {
      id: "cathedral",
      name: "Cathedral",
      description: "A grand place of worship. Boosts science and gold.",
      era: "medieval_age",
      unlockTech: "feudalism",
      cost: { food: 150, wood: 200, stone: 400, gold: 500 },
      buildTime: 100,
      production: { science: 2.5, gold: 2 },
      maxCount: 3
    },
    {
      id: "windmill",
      name: "Windmill",
      description: "Harness wind power for grinding grain. Increases food production.",
      era: "medieval_age",
      unlockTech: "machinery",
      cost: { food: 80, wood: 200, stone: 100, gold: 150 },
      buildTime: 45,
      production: { food: 3.5 },
      maxCount: 10
    },
    // Renaissance Buildings
    {
      id: "bank",
      name: "Bank",
      description: "Financial institution. Greatly increases gold production.",
      era: "renaissance",
      unlockTech: "banking",
      cost: { food: 100, wood: 150, stone: 200, gold: 800 },
      buildTime: 60,
      production: { gold: 5 },
      maxCount: 5
    },
    {
      id: "observatory",
      name: "Observatory",
      description: "Study the stars. Greatly increases science production.",
      era: "renaissance",
      unlockTech: "astronomy",
      cost: { food: 80, wood: 100, stone: 300, gold: 600 },
      buildTime: 70,
      production: { science: 4 },
      maxCount: 3
    },
    {
      id: "shipyard",
      name: "Shipyard",
      description: "Build ships for trade. Increases gold and wood production.",
      era: "renaissance",
      unlockTech: "printing_press",
      cost: { food: 150, wood: 400, stone: 200, gold: 500 },
      buildTime: 80,
      production: { gold: 3.5, wood: 2 },
      maxCount: 5
    },
    // Industrial Age Buildings
    {
      id: "factory",
      name: "Factory",
      description: "Mass produce goods. Increases all resource production.",
      era: "industrial_age",
      unlockTech: "industrialization",
      cost: { food: 200, wood: 300, stone: 400, gold: 1e3 },
      buildTime: 90,
      production: { food: 3, wood: 3, stone: 2, gold: 4 },
      maxCount: 8
    },
    {
      id: "railroad_station",
      name: "Railroad Station",
      description: "Connect cities via rail. Boosts all production.",
      era: "industrial_age",
      unlockTech: "railroad",
      cost: { food: 150, wood: 250, stone: 350, gold: 800 },
      buildTime: 70,
      production: { food: 2, wood: 2, stone: 2, gold: 3 },
      maxCount: 5
    },
    {
      id: "power_plant",
      name: "Power Plant",
      description: "Generate electricity. Greatly boosts production.",
      era: "industrial_age",
      unlockTech: "electricity",
      cost: { food: 100, wood: 200, stone: 500, gold: 1500 },
      buildTime: 100,
      production: { gold: 8, science: 3 },
      maxCount: 5
    },
    // Modern Age Buildings
    {
      id: "research_lab",
      name: "Research Lab",
      description: "Advanced scientific research. Greatly increases science.",
      era: "modern_age",
      unlockTech: "radio",
      cost: { food: 200, wood: 150, stone: 300, gold: 2e3 },
      buildTime: 80,
      production: { science: 8 },
      maxCount: 8
    },
    {
      id: "oil_refinery",
      name: "Oil Refinery",
      description: "Process petroleum. Increases gold production significantly.",
      era: "modern_age",
      unlockTech: "combustion",
      cost: { food: 150, wood: 200, stone: 400, gold: 2500 },
      buildTime: 100,
      production: { gold: 10 },
      maxCount: 5
    },
    {
      id: "airport",
      name: "Airport",
      description: "Enable air travel and trade. Boosts gold and science.",
      era: "modern_age",
      unlockTech: "flight",
      cost: { food: 200, wood: 300, stone: 500, gold: 3e3 },
      buildTime: 120,
      production: { gold: 8, science: 5 },
      maxCount: 3
    },
    // Atomic Age Buildings
    {
      id: "nuclear_plant",
      name: "Nuclear Plant",
      description: "Clean nuclear energy. Massive production boost.",
      era: "atomic_age",
      unlockTech: "nuclear_power",
      cost: { food: 300, wood: 200, stone: 800, gold: 5e3 },
      buildTime: 150,
      production: { gold: 15, science: 10 },
      maxCount: 5
    },
    {
      id: "space_center",
      name: "Space Center",
      description: "Launch rockets and satellites. Greatly increases science.",
      era: "atomic_age",
      unlockTech: "rocketry",
      cost: { food: 400, wood: 300, stone: 1e3, gold: 8e3 },
      buildTime: 180,
      production: { science: 20 },
      maxCount: 3
    },
    // Information Age Buildings
    {
      id: "data_center",
      name: "Data Center",
      description: "Store and process information. Massive science boost.",
      era: "information_age",
      unlockTech: "internet",
      cost: { food: 300, wood: 200, stone: 500, gold: 1e4 },
      buildTime: 100,
      production: { science: 30, gold: 10 },
      maxCount: 8
    },
    {
      id: "robotics_facility",
      name: "Robotics Facility",
      description: "Automate production with robots. Boosts all resources.",
      era: "information_age",
      unlockTech: "robotics",
      cost: { food: 400, wood: 300, stone: 600, gold: 15e3 },
      buildTime: 120,
      production: { food: 10, wood: 8, stone: 6, gold: 12 },
      maxCount: 5
    },
    // Future Age Buildings
    {
      id: "fusion_reactor",
      name: "Fusion Reactor",
      description: "Unlimited clean energy. Massive production boost.",
      era: "future_age",
      unlockTech: "fusion_power",
      cost: { food: 500, wood: 400, stone: 800, gold: 25e3 },
      buildTime: 200,
      production: { gold: 50, science: 30 },
      maxCount: 5
    },
    {
      id: "quantum_lab",
      name: "Quantum Lab",
      description: "Quantum computing research. Extreme science production.",
      era: "future_age",
      unlockTech: "quantum_computing",
      cost: { food: 400, wood: 300, stone: 600, gold: 3e4 },
      buildTime: 150,
      production: { science: 80 },
      maxCount: 5
    },
    {
      id: "space_colony",
      name: "Space Colony",
      description: "Expand to the stars. Produces all resources.",
      era: "future_age",
      unlockTech: "space_colonization",
      cost: { food: 1e3, wood: 800, stone: 1200, gold: 5e4 },
      buildTime: 300,
      production: { food: 30, wood: 25, stone: 20, gold: 40, science: 50 },
      maxCount: 3
    }
  ];
  function getBuildingTypeById(id) {
    return BUILDING_TYPES.find((b) => b.id === id);
  }
  function canBuildBuilding(buildingId, unlockedBuildings, builtBuildings, resources) {
    const buildingType = getBuildingTypeById(buildingId);
    if (!buildingType)
      return false;
    if (buildingType.unlockTech && !unlockedBuildings.has(buildingType.id))
      return false;
    const existing = builtBuildings.find((b) => b.typeId === buildingId);
    if (existing && existing.count >= buildingType.maxCount)
      return false;
    if (resources.food < buildingType.cost.food)
      return false;
    if (resources.wood < buildingType.cost.wood)
      return false;
    if (resources.stone < buildingType.cost.stone)
      return false;
    if (resources.gold < buildingType.cost.gold)
      return false;
    return true;
  }
  function calculateBuildingProduction(buildings) {
    let totalFood = 0;
    let totalWood = 0;
    let totalStone = 0;
    let totalGold = 0;
    let totalScience = 0;
    for (const building of buildings) {
      const buildingType = getBuildingTypeById(building.typeId);
      if (buildingType) {
        const count = building.count;
        totalFood += (buildingType.production.food || 0) * count;
        totalWood += (buildingType.production.wood || 0) * count;
        totalStone += (buildingType.production.stone || 0) * count;
        totalGold += (buildingType.production.gold || 0) * count;
        totalScience += (buildingType.production.science || 0) * count;
      }
    }
    return {
      food: totalFood,
      wood: totalWood,
      stone: totalStone,
      gold: totalGold,
      science: totalScience
    };
  }
  function getTotalBuildingCount(buildings) {
    return buildings.reduce((sum, b) => sum + b.count, 0);
  }

  // dist/skills.js
  var SKILLS = [
    // Production Skills
    {
      id: "efficient_gathering",
      name: "Efficient Gathering",
      description: "Increase all resource gathering by 10% per level.",
      icon: "\u{1F9FA}",
      category: "production",
      maxLevel: 10,
      costPerLevel: 1,
      prerequisites: [],
      effects: { type: "multiplier", target: "all_resources", valuePerLevel: 0.1 }
    },
    {
      id: "master_farmer",
      name: "Master Farmer",
      description: "Increase food production by 15% per level.",
      icon: "\u{1F33E}",
      category: "production",
      maxLevel: 10,
      costPerLevel: 1,
      prerequisites: ["efficient_gathering"],
      effects: { type: "multiplier", target: "food", valuePerLevel: 0.15 }
    },
    {
      id: "master_lumberjack",
      name: "Master Lumberjack",
      description: "Increase wood production by 15% per level.",
      icon: "\u{1FA93}",
      category: "production",
      maxLevel: 10,
      costPerLevel: 1,
      prerequisites: ["efficient_gathering"],
      effects: { type: "multiplier", target: "wood", valuePerLevel: 0.15 }
    },
    {
      id: "master_miner",
      name: "Master Miner",
      description: "Increase stone production by 15% per level.",
      icon: "\u26CF\uFE0F",
      category: "production",
      maxLevel: 10,
      costPerLevel: 1,
      prerequisites: ["efficient_gathering"],
      effects: { type: "multiplier", target: "stone", valuePerLevel: 0.15 }
    },
    {
      id: "resource_mastery",
      name: "Resource Mastery",
      description: "All resource production increased by 25% per level.",
      icon: "\u{1F4AB}",
      category: "production",
      maxLevel: 5,
      costPerLevel: 5,
      prerequisites: ["master_farmer", "master_lumberjack", "master_miner"],
      effects: { type: "multiplier", target: "all_resources", valuePerLevel: 0.25 }
    },
    // Military Skills
    {
      id: "warrior_training",
      name: "Warrior Training",
      description: "Increase army attack by 10% per level.",
      icon: "\u2694\uFE0F",
      category: "military",
      maxLevel: 10,
      costPerLevel: 1,
      prerequisites: [],
      effects: { type: "multiplier", target: "army_attack", valuePerLevel: 0.1 }
    },
    {
      id: "fortification",
      name: "Fortification",
      description: "Increase army defense by 10% per level.",
      icon: "\u{1F6E1}\uFE0F",
      category: "military",
      maxLevel: 10,
      costPerLevel: 1,
      prerequisites: [],
      effects: { type: "multiplier", target: "army_defense", valuePerLevel: 0.1 }
    },
    {
      id: "vitality",
      name: "Vitality",
      description: "Increase army health by 10% per level.",
      icon: "\u2764\uFE0F",
      category: "military",
      maxLevel: 10,
      costPerLevel: 1,
      prerequisites: [],
      effects: { type: "multiplier", target: "army_health", valuePerLevel: 0.1 }
    },
    {
      id: "battle_hardened",
      name: "Battle Hardened",
      description: "Reduce casualties in battle by 5% per level.",
      icon: "\u{1F396}\uFE0F",
      category: "military",
      maxLevel: 10,
      costPerLevel: 2,
      prerequisites: ["warrior_training", "fortification", "vitality"],
      effects: { type: "multiplier", target: "casualty_reduction", valuePerLevel: 0.05 }
    },
    {
      id: "warlord",
      name: "Warlord",
      description: "All military stats increased by 20% per level.",
      icon: "\u{1F451}",
      category: "military",
      maxLevel: 5,
      costPerLevel: 5,
      prerequisites: ["battle_hardened"],
      effects: { type: "multiplier", target: "all_military", valuePerLevel: 0.2 }
    },
    // Research Skills
    {
      id: "quick_learner",
      name: "Quick Learner",
      description: "Increase science production by 10% per level.",
      icon: "\u{1F4DA}",
      category: "research",
      maxLevel: 10,
      costPerLevel: 1,
      prerequisites: [],
      effects: { type: "multiplier", target: "science", valuePerLevel: 0.1 }
    },
    {
      id: "research_efficiency",
      name: "Research Efficiency",
      description: "Reduce research time by 5% per level.",
      icon: "\u23F1\uFE0F",
      category: "research",
      maxLevel: 10,
      costPerLevel: 2,
      prerequisites: ["quick_learner"],
      effects: { type: "multiplier", target: "research_speed", valuePerLevel: 0.05 }
    },
    {
      id: "genius",
      name: "Genius",
      description: "Science production increased by 30% per level.",
      icon: "\u{1F9E0}",
      category: "research",
      maxLevel: 5,
      costPerLevel: 5,
      prerequisites: ["research_efficiency"],
      effects: { type: "multiplier", target: "science", valuePerLevel: 0.3 }
    },
    // Economy Skills
    {
      id: "merchant",
      name: "Merchant",
      description: "Increase gold production by 15% per level.",
      icon: "\u{1F4B0}",
      category: "economy",
      maxLevel: 10,
      costPerLevel: 1,
      prerequisites: [],
      effects: { type: "multiplier", target: "gold", valuePerLevel: 0.15 }
    },
    {
      id: "trade_routes",
      name: "Trade Routes",
      description: "Flat +1 gold per second per level.",
      icon: "\u{1F6E4}\uFE0F",
      category: "economy",
      maxLevel: 10,
      costPerLevel: 2,
      prerequisites: ["merchant"],
      effects: { type: "flat", target: "gold", valuePerLevel: 1 }
    },
    {
      id: "economic_empire",
      name: "Economic Empire",
      description: "Gold production increased by 50% per level.",
      icon: "\u{1F3DB}\uFE0F",
      category: "economy",
      maxLevel: 5,
      costPerLevel: 5,
      prerequisites: ["trade_routes"],
      effects: { type: "multiplier", target: "gold", valuePerLevel: 0.5 }
    },
    // Special Skills
    {
      id: "starting_resources",
      name: "Starting Resources",
      description: "Start each game with +100 of each resource per level.",
      icon: "\u{1F4E6}",
      category: "special",
      maxLevel: 10,
      costPerLevel: 2,
      prerequisites: [],
      effects: { type: "flat", target: "starting_resources", valuePerLevel: 100 }
    },
    {
      id: "era_memory",
      name: "Era Memory",
      description: "Keep 10% of researched technologies per level after prestige.",
      icon: "\u{1F9EC}",
      category: "special",
      maxLevel: 5,
      costPerLevel: 5,
      prerequisites: ["starting_resources"],
      effects: { type: "multiplier", target: "tech_retention", valuePerLevel: 0.1 }
    },
    {
      id: "legacy_amplifier",
      name: "Legacy Amplifier",
      description: "Increase legacy points earned by 10% per level.",
      icon: "\u2728",
      category: "special",
      maxLevel: 10,
      costPerLevel: 3,
      prerequisites: [],
      effects: { type: "multiplier", target: "legacy_points", valuePerLevel: 0.1 }
    },
    {
      id: "eternal_wisdom",
      name: "Eternal Wisdom",
      description: "All skill effects are 10% stronger per level.",
      icon: "\u{1F31F}",
      category: "special",
      maxLevel: 5,
      costPerLevel: 10,
      prerequisites: ["era_memory", "legacy_amplifier"],
      effects: { type: "multiplier", target: "skill_effectiveness", valuePerLevel: 0.1 }
    }
  ];
  var LEGACY_MILESTONES = [
    // Era Progression Milestones
    {
      id: "reach_bronze_age",
      name: "Bronze Pioneer",
      description: "Reach the Bronze Age",
      icon: "\u{1F949}",
      condition: { type: "era_reached", target: "bronze_age", amount: 1 },
      legacyPoints: 1,
      repeatable: true
    },
    {
      id: "reach_iron_age",
      name: "Iron Forger",
      description: "Reach the Iron Age",
      icon: "\u2699\uFE0F",
      condition: { type: "era_reached", target: "iron_age", amount: 1 },
      legacyPoints: 2,
      repeatable: true
    },
    {
      id: "reach_classical_age",
      name: "Classical Scholar",
      description: "Reach the Classical Age",
      icon: "\u{1F3DB}\uFE0F",
      condition: { type: "era_reached", target: "classical_age", amount: 1 },
      legacyPoints: 3,
      repeatable: true
    },
    {
      id: "reach_medieval_age",
      name: "Medieval Lord",
      description: "Reach the Medieval Age",
      icon: "\u{1F3F0}",
      condition: { type: "era_reached", target: "medieval_age", amount: 1 },
      legacyPoints: 5,
      repeatable: true
    },
    {
      id: "reach_renaissance",
      name: "Renaissance Master",
      description: "Reach the Renaissance",
      icon: "\u{1F3A8}",
      condition: { type: "era_reached", target: "renaissance", amount: 1 },
      legacyPoints: 8,
      repeatable: true
    },
    {
      id: "reach_industrial_age",
      name: "Industrial Tycoon",
      description: "Reach the Industrial Age",
      icon: "\u{1F3ED}",
      condition: { type: "era_reached", target: "industrial_age", amount: 1 },
      legacyPoints: 12,
      repeatable: true
    },
    {
      id: "reach_modern_age",
      name: "Modern Leader",
      description: "Reach the Modern Age",
      icon: "\u{1F306}",
      condition: { type: "era_reached", target: "modern_age", amount: 1 },
      legacyPoints: 18,
      repeatable: true
    },
    {
      id: "reach_atomic_age",
      name: "Atomic Pioneer",
      description: "Reach the Atomic Age",
      icon: "\u2622\uFE0F",
      condition: { type: "era_reached", target: "atomic_age", amount: 1 },
      legacyPoints: 25,
      repeatable: true
    },
    {
      id: "reach_information_age",
      name: "Digital Visionary",
      description: "Reach the Information Age",
      icon: "\u{1F4BB}",
      condition: { type: "era_reached", target: "information_age", amount: 1 },
      legacyPoints: 35,
      repeatable: true
    },
    {
      id: "reach_future_age",
      name: "Future Architect",
      description: "Reach the Future Age",
      icon: "\u{1F680}",
      condition: { type: "era_reached", target: "future_age", amount: 1 },
      legacyPoints: 50,
      repeatable: true
    },
    // Combat Milestones
    {
      id: "battle_novice",
      name: "Battle Novice",
      description: "Win 10 battles",
      icon: "\u2694\uFE0F",
      condition: { type: "battles_won", target: "any", amount: 10 },
      legacyPoints: 2,
      repeatable: false
    },
    {
      id: "battle_veteran",
      name: "Battle Veteran",
      description: "Win 50 battles",
      icon: "\u{1F5E1}\uFE0F",
      condition: { type: "battles_won", target: "any", amount: 50 },
      legacyPoints: 5,
      repeatable: false
    },
    {
      id: "battle_legend",
      name: "Battle Legend",
      description: "Win 100 battles",
      icon: "\u2694\uFE0F",
      condition: { type: "battles_won", target: "any", amount: 100 },
      legacyPoints: 10,
      repeatable: false
    },
    // Territory Milestones
    {
      id: "first_conquest",
      name: "First Conquest",
      description: "Conquer your first territory",
      icon: "\u{1F3F4}",
      condition: { type: "territories_conquered", target: "any", amount: 1 },
      legacyPoints: 2,
      repeatable: false
    },
    {
      id: "regional_power",
      name: "Regional Power",
      description: "Conquer 5 territories",
      icon: "\u{1F5FA}\uFE0F",
      condition: { type: "territories_conquered", target: "any", amount: 5 },
      legacyPoints: 5,
      repeatable: false
    },
    {
      id: "empire_builder",
      name: "Empire Builder",
      description: "Conquer 10 territories",
      icon: "\u{1F451}",
      condition: { type: "territories_conquered", target: "any", amount: 10 },
      legacyPoints: 10,
      repeatable: false
    },
    {
      id: "world_conqueror",
      name: "World Conqueror",
      description: "Conquer all territories",
      icon: "\u{1F30D}",
      condition: { type: "territories_conquered", target: "any", amount: 22 },
      legacyPoints: 25,
      repeatable: false
    },
    // Research Milestones
    {
      id: "knowledge_seeker",
      name: "Knowledge Seeker",
      description: "Research 10 technologies",
      icon: "\u{1F4D6}",
      condition: { type: "techs_researched", target: "any", amount: 10 },
      legacyPoints: 3,
      repeatable: false
    },
    {
      id: "scholar",
      name: "Scholar",
      description: "Research 25 technologies",
      icon: "\u{1F393}",
      condition: { type: "techs_researched", target: "any", amount: 25 },
      legacyPoints: 8,
      repeatable: false
    },
    {
      id: "tech_master",
      name: "Tech Master",
      description: "Research all technologies",
      icon: "\u{1F9EA}",
      condition: { type: "techs_researched", target: "any", amount: 44 },
      legacyPoints: 20,
      repeatable: false
    },
    // Building Milestones
    {
      id: "builder",
      name: "Builder",
      description: "Construct 10 buildings",
      icon: "\u{1F3D7}\uFE0F",
      condition: { type: "buildings_built", target: "any", amount: 10 },
      legacyPoints: 2,
      repeatable: false
    },
    {
      id: "architect",
      name: "Architect",
      description: "Construct 50 buildings",
      icon: "\u{1F3D8}\uFE0F",
      condition: { type: "buildings_built", target: "any", amount: 50 },
      legacyPoints: 5,
      repeatable: false
    },
    {
      id: "city_planner",
      name: "City Planner",
      description: "Construct 100 buildings",
      icon: "\u{1F306}",
      condition: { type: "buildings_built", target: "any", amount: 100 },
      legacyPoints: 10,
      repeatable: false
    }
  ];
  function getSkillById(id) {
    return SKILLS.find((s) => s.id === id);
  }
  function getSkillsByCategory(category) {
    return SKILLS.filter((s) => s.category === category);
  }
  function canUnlockSkill(skill, skillLevels) {
    for (const prereqId of skill.prerequisites) {
      const level = skillLevels.get(prereqId) || 0;
      if (level < 1) {
        return false;
      }
    }
    return true;
  }
  function getSkillLevel(skillId, skillLevels) {
    return skillLevels.get(skillId) || 0;
  }
  function getSkillCost(skill, currentLevel) {
    return skill.costPerLevel * (currentLevel + 1);
  }
  function getSkillEffect(skill, level, skillEffectivenessBonus = 0) {
    if (level <= 0)
      return skill.effects.type === "multiplier" ? 1 : 0;
    const baseValue = skill.effects.valuePerLevel * level;
    const effectivenessMultiplier = 1 + skillEffectivenessBonus;
    if (skill.effects.type === "multiplier") {
      return 1 + baseValue * effectivenessMultiplier;
    }
    return baseValue * effectivenessMultiplier;
  }
  function createInitialSkillTreeState() {
    return {
      legacyPoints: 0,
      totalLegacyPointsEarned: 0,
      skillLevels: /* @__PURE__ */ new Map(),
      completedMilestones: /* @__PURE__ */ new Set(),
      milestoneCompletionCounts: /* @__PURE__ */ new Map(),
      prestigeCount: 0
    };
  }
  function calculateSkillBonuses(skillLevels) {
    const eternalWisdomLevel = skillLevels.get("eternal_wisdom") || 0;
    const skillEffectiveness = eternalWisdomLevel > 0 ? getSkillEffect(getSkillById("eternal_wisdom"), eternalWisdomLevel) - 1 : 0;
    const resourceMultipliers = { food: 1, wood: 1, stone: 1, gold: 1, science: 1 };
    const flatBonuses = { food: 0, wood: 0, stone: 0, gold: 0, science: 0 };
    const militaryMultipliers = { attack: 1, defense: 1, health: 1, casualtyReduction: 0 };
    let researchSpeedMultiplier = 1;
    let startingResources = 0;
    let techRetention = 0;
    let legacyPointsMultiplier = 1;
    for (const skill of SKILLS) {
      const level = skillLevels.get(skill.id) || 0;
      if (level <= 0)
        continue;
      const effectValue = getSkillEffect(skill, level, skillEffectiveness);
      const target = skill.effects.target;
      switch (target) {
        case "all_resources":
          if (skill.effects.type === "multiplier") {
            resourceMultipliers.food *= effectValue;
            resourceMultipliers.wood *= effectValue;
            resourceMultipliers.stone *= effectValue;
            resourceMultipliers.gold *= effectValue;
            resourceMultipliers.science *= effectValue;
          }
          break;
        case "food":
          if (skill.effects.type === "multiplier")
            resourceMultipliers.food *= effectValue;
          else
            flatBonuses.food += effectValue;
          break;
        case "wood":
          if (skill.effects.type === "multiplier")
            resourceMultipliers.wood *= effectValue;
          else
            flatBonuses.wood += effectValue;
          break;
        case "stone":
          if (skill.effects.type === "multiplier")
            resourceMultipliers.stone *= effectValue;
          else
            flatBonuses.stone += effectValue;
          break;
        case "gold":
          if (skill.effects.type === "multiplier")
            resourceMultipliers.gold *= effectValue;
          else
            flatBonuses.gold += effectValue;
          break;
        case "science":
          if (skill.effects.type === "multiplier")
            resourceMultipliers.science *= effectValue;
          else
            flatBonuses.science += effectValue;
          break;
        case "army_attack":
          militaryMultipliers.attack *= effectValue;
          break;
        case "army_defense":
          militaryMultipliers.defense *= effectValue;
          break;
        case "army_health":
          militaryMultipliers.health *= effectValue;
          break;
        case "casualty_reduction":
          militaryMultipliers.casualtyReduction += skill.effects.valuePerLevel * level * (1 + skillEffectiveness);
          break;
        case "all_military":
          militaryMultipliers.attack *= effectValue;
          militaryMultipliers.defense *= effectValue;
          militaryMultipliers.health *= effectValue;
          break;
        case "research_speed":
          researchSpeedMultiplier *= effectValue;
          break;
        case "starting_resources":
          startingResources += effectValue;
          break;
        case "tech_retention":
          techRetention += skill.effects.valuePerLevel * level * (1 + skillEffectiveness);
          break;
        case "legacy_points":
          legacyPointsMultiplier *= effectValue;
          break;
      }
    }
    militaryMultipliers.casualtyReduction = Math.min(0.9, militaryMultipliers.casualtyReduction);
    techRetention = Math.min(1, techRetention);
    return {
      resourceMultipliers,
      flatBonuses,
      militaryMultipliers,
      researchSpeedMultiplier,
      startingResources,
      techRetention,
      legacyPointsMultiplier,
      skillEffectiveness
    };
  }

  // dist/lore.js
  var CIVILIZATIONS = [
    {
      id: "default",
      name: "Settlers",
      description: "A balanced civilization with no special bonuses. Perfect for learning the game.",
      icon: "\u{1F3E0}",
      bonuses: {},
      startingResources: { food: 0, wood: 0, stone: 0, gold: 0, science: 0 }
    },
    {
      id: "roman",
      name: "Roman Empire",
      description: "Master builders and soldiers. Bonus to stone and military defense.",
      icon: "\u{1F3DB}\uFE0F",
      bonuses: {
        resourceMultipliers: { stone: 1.25 },
        militaryBonuses: { defense: 1.15 },
        specialAbility: "Roads: Buildings complete 20% faster"
      },
      startingResources: { food: 50, wood: 30, stone: 100, gold: 50, science: 20 },
      uniqueUnit: "legionary"
    },
    {
      id: "egyptian",
      name: "Egyptian Kingdom",
      description: "Ancient wisdom and monumental builders. Bonus to science and gold.",
      icon: "\u{1F53A}",
      bonuses: {
        resourceMultipliers: { gold: 1.2, science: 1.15 },
        specialAbility: "Nile Flooding: +50% food from conquered territories"
      },
      startingResources: { food: 80, wood: 20, stone: 50, gold: 100, science: 50 }
    },
    {
      id: "chinese",
      name: "Chinese Dynasty",
      description: "Ancient and wise civilization. Bonus to science and food production.",
      icon: "\u{1F409}",
      bonuses: {
        resourceMultipliers: { food: 1.2, science: 1.2 },
        specialAbility: "Paper Money: Research costs reduced by 10%"
      },
      startingResources: { food: 100, wood: 40, stone: 30, gold: 60, science: 100 }
    },
    {
      id: "viking",
      name: "Viking Clans",
      description: "Fierce warriors and explorers. Bonus to military attack and wood.",
      icon: "\u2694\uFE0F",
      bonuses: {
        resourceMultipliers: { wood: 1.3 },
        militaryBonuses: { attack: 1.2 },
        specialAbility: "Berserker: +25% damage when health below 50%"
      },
      startingResources: { food: 60, wood: 150, stone: 30, gold: 30, science: 20 }
    },
    {
      id: "greek",
      name: "Greek City-States",
      description: "Birthplace of democracy and philosophy. Major bonus to science.",
      icon: "\u{1F3FA}",
      bonuses: {
        resourceMultipliers: { science: 1.35 },
        specialAbility: "Philosophy: +1 free technology at game start"
      },
      startingResources: { food: 40, wood: 30, stone: 60, gold: 80, science: 150 }
    },
    {
      id: "persian",
      name: "Persian Empire",
      description: "Vast empire of wealth and trade. Bonus to gold and all resources.",
      icon: "\u{1F451}",
      bonuses: {
        resourceMultipliers: { food: 1.1, wood: 1.1, stone: 1.1, gold: 1.3, science: 1.1 },
        specialAbility: "Satrapies: Conquered territories give 50% more bonuses"
      },
      startingResources: { food: 70, wood: 70, stone: 70, gold: 200, science: 70 }
    },
    {
      id: "japanese",
      name: "Japanese Shogunate",
      description: "Honor-bound warriors with refined culture. Balanced military bonuses.",
      icon: "\u{1F5FE}",
      bonuses: {
        militaryBonuses: { attack: 1.1, defense: 1.1, health: 1.1 },
        specialAbility: "Bushido: Troops deal 30% more damage on first combat round"
      },
      startingResources: { food: 60, wood: 80, stone: 40, gold: 70, science: 50 }
    }
  ];
  var LEADERS = [
    // Universal Leaders (any civilization)
    {
      id: "tribal_chief",
      name: "Tribal Chief",
      title: "Chieftain",
      description: "A wise leader who guides their people through the earliest times.",
      icon: "\u{1F464}",
      civilizationId: "any",
      era: "stone_age",
      bonuses: {
        resourceMultipliers: { food: 1.1 },
        specialAbility: "Unity: +10% to all resource gathering"
      }
    },
    {
      id: "julius_caesar",
      name: "Julius Caesar",
      title: "Dictator",
      description: "The legendary Roman leader who conquered Gaul and transformed the Republic.",
      icon: "\u{1F985}",
      civilizationId: "roman",
      era: "iron_age",
      bonuses: {
        militaryBonuses: { attack: 1.25, defense: 1.15 },
        specialAbility: "Veni Vidi Vici: Conquests grant 50% more rewards"
      }
    },
    {
      id: "cleopatra",
      name: "Cleopatra VII",
      title: "Pharaoh",
      description: "The last active ruler of the Ptolemaic Kingdom of Egypt.",
      icon: "\u{1F40D}",
      civilizationId: "egyptian",
      era: "classical_age",
      bonuses: {
        resourceMultipliers: { gold: 1.3, science: 1.2 },
        specialAbility: "Diplomatic Charm: Trade routes generate 30% more gold"
      }
    },
    {
      id: "qin_shi_huang",
      name: "Qin Shi Huang",
      title: "First Emperor",
      description: "The founder of the Qin dynasty and first emperor of unified China.",
      icon: "\u{1F3EF}",
      civilizationId: "chinese",
      era: "iron_age",
      bonuses: {
        resourceMultipliers: { stone: 1.3, science: 1.15 },
        specialAbility: "Great Wall: Defensive buildings cost 25% less"
      }
    },
    {
      id: "ragnar_lothbrok",
      name: "Ragnar Lothbrok",
      title: "King",
      description: "Legendary Norse hero and Viking king.",
      icon: "\u{1FA93}",
      civilizationId: "viking",
      era: "medieval_age",
      bonuses: {
        militaryBonuses: { attack: 1.35, health: 1.1 },
        specialAbility: "Raid: Combat victories grant bonus resources"
      }
    },
    {
      id: "alexander",
      name: "Alexander the Great",
      title: "King of Macedon",
      description: "One of history's greatest military commanders who created one of the largest empires.",
      icon: "\u{1F434}",
      civilizationId: "greek",
      era: "classical_age",
      bonuses: {
        militaryBonuses: { attack: 1.3, defense: 1.1 },
        resourceMultipliers: { science: 1.15 },
        specialAbility: "Conquest: Conquered territories provide double bonuses for 5 minutes"
      }
    },
    {
      id: "cyrus",
      name: "Cyrus the Great",
      title: "King of Kings",
      description: "Founder of the Achaemenid Empire, the first Persian Empire.",
      icon: "\u{1F981}",
      civilizationId: "persian",
      era: "iron_age",
      bonuses: {
        resourceMultipliers: { gold: 1.25, food: 1.15 },
        specialAbility: "Tolerance: Conquered territories take 50% less time to pacify"
      }
    },
    {
      id: "oda_nobunaga",
      name: "Oda Nobunaga",
      title: "Daimyo",
      description: "The great unifier who initiated the unification of Japan.",
      icon: "\u2694\uFE0F",
      civilizationId: "japanese",
      era: "medieval_age",
      bonuses: {
        militaryBonuses: { attack: 1.2, defense: 1.15 },
        resourceMultipliers: { gold: 1.15 },
        specialAbility: "Innovation: Gunpowder units cost 20% less"
      }
    },
    // More universal leaders for later eras
    {
      id: "industrial_tycoon",
      name: "Industrial Tycoon",
      title: "Magnate",
      description: "A captain of industry who revolutionizes production.",
      icon: "\u{1F3ED}",
      civilizationId: "any",
      era: "industrial_age",
      bonuses: {
        resourceMultipliers: { gold: 1.4, wood: 1.2, stone: 1.2 },
        specialAbility: "Mass Production: Buildings produce 25% more resources"
      }
    },
    {
      id: "tech_visionary",
      name: "Tech Visionary",
      title: "CEO",
      description: "A forward-thinking leader who embraces technological advancement.",
      icon: "\u{1F4A1}",
      civilizationId: "any",
      era: "information_age",
      bonuses: {
        resourceMultipliers: { science: 1.5 },
        specialAbility: "Innovation: Research completes 20% faster"
      }
    }
  ];
  var NATURAL_WONDERS = [
    {
      id: "grand_canyon",
      name: "Grand Canyon",
      description: "A steep-sided canyon carved by the Colorado River. Its grandeur inspires your people.",
      icon: "\u{1F3DC}\uFE0F",
      era: "stone_age",
      discoveryChance: 0.15,
      discovered: false,
      bonuses: {
        flatBonuses: [{ resource: "science", amount: 2 }],
        specialEffect: "Inspires exploration and discovery"
      }
    },
    {
      id: "mount_everest",
      name: "Mount Everest",
      description: "The highest mountain in the world. Its presence strengthens your people's resolve.",
      icon: "\u{1F3D4}\uFE0F",
      era: "stone_age",
      discoveryChance: 0.1,
      discovered: false,
      bonuses: {
        resourceMultiplier: { resource: "stone", multiplier: 1.2 },
        specialEffect: "Military units gain +10% health"
      }
    },
    {
      id: "great_barrier_reef",
      name: "Great Barrier Reef",
      description: "The world's largest coral reef system. Its bounty feeds your people.",
      icon: "\u{1F420}",
      era: "bronze_age",
      discoveryChance: 0.12,
      discovered: false,
      bonuses: {
        flatBonuses: [{ resource: "food", amount: 5 }],
        specialEffect: "Coastal buildings produce 20% more"
      }
    },
    {
      id: "amazon_rainforest",
      name: "Amazon Rainforest",
      description: "The largest tropical rainforest. An endless source of wood and discovery.",
      icon: "\u{1F333}",
      era: "bronze_age",
      discoveryChance: 0.15,
      discovered: false,
      bonuses: {
        flatBonuses: [{ resource: "wood", amount: 5 }],
        resourceMultiplier: { resource: "science", multiplier: 1.1 }
      }
    },
    {
      id: "sahara_oasis",
      name: "Sahara Oasis",
      description: "A hidden paradise in the desert. Trading caravans gather here.",
      icon: "\u{1F3DD}\uFE0F",
      era: "iron_age",
      discoveryChance: 0.1,
      discovered: false,
      bonuses: {
        flatBonuses: [{ resource: "gold", amount: 8 }],
        specialEffect: "Trade income increased by 15%"
      }
    },
    {
      id: "victoria_falls",
      name: "Victoria Falls",
      description: "One of the largest waterfalls in the world. Its power is awe-inspiring.",
      icon: "\u{1F4A7}",
      era: "classical_age",
      discoveryChance: 0.12,
      discovered: false,
      bonuses: {
        flatBonuses: [
          { resource: "food", amount: 8 },
          { resource: "science", amount: 3 }
        ]
      }
    },
    {
      id: "northern_lights",
      name: "Northern Lights",
      description: "The spectacular aurora borealis. Its mystery drives scientific inquiry.",
      icon: "\u{1F30C}",
      era: "medieval_age",
      discoveryChance: 0.08,
      discovered: false,
      bonuses: {
        resourceMultiplier: { resource: "science", multiplier: 1.25 },
        specialEffect: "Happiness increased by 10%"
      }
    },
    {
      id: "dead_sea",
      name: "Dead Sea",
      description: "The saltiest body of water on Earth. Rich in minerals and trade goods.",
      icon: "\u{1F30A}",
      era: "classical_age",
      discoveryChance: 0.12,
      discovered: false,
      bonuses: {
        flatBonuses: [
          { resource: "gold", amount: 10 },
          { resource: "stone", amount: 5 }
        ]
      }
    },
    {
      id: "krakatoa",
      name: "Krakatoa",
      description: "A volcanic island between Java and Sumatra. Dangerous but fertile.",
      icon: "\u{1F30B}",
      era: "renaissance",
      discoveryChance: 0.08,
      discovered: false,
      bonuses: {
        flatBonuses: [
          { resource: "food", amount: 15 },
          { resource: "stone", amount: 10 }
        ],
        specialEffect: "Chance to cause disasters but also windfalls"
      }
    },
    {
      id: "el_dorado",
      name: "El Dorado",
      description: "The legendary city of gold! Its treasures are beyond imagination.",
      icon: "\u{1F3F0}",
      era: "renaissance",
      discoveryChance: 0.05,
      discovered: false,
      bonuses: {
        flatBonuses: [{ resource: "gold", amount: 50 }],
        specialEffect: "One-time bonus of 5000 gold upon discovery"
      }
    }
  ];
  var RELIGION_TEMPLATES = [
    {
      id: "ancestor_worship",
      name: "Ancestor Worship",
      description: "Honor the spirits of ancestors who guide and protect.",
      icon: "\u{1F47B}",
      bonuses: {
        resourceMultipliers: { food: 1.15 },
        militaryBonuses: { morale: 1.2 },
        specialAbility: "Ancestral Guidance: +15% to all production during peaceful times"
      }
    },
    {
      id: "sun_worship",
      name: "Solar Faith",
      description: "Worship of the life-giving sun.",
      icon: "\u2600\uFE0F",
      bonuses: {
        resourceMultipliers: { food: 1.2, gold: 1.1 },
        specialAbility: "Solar Blessing: Farms and gold production boosted during day"
      }
    },
    {
      id: "earth_mother",
      name: "Earth Mother Cult",
      description: "Veneration of the earth and its bounty.",
      icon: "\u{1F30D}",
      bonuses: {
        resourceMultipliers: { food: 1.15, stone: 1.15, wood: 1.15 },
        specialAbility: "Nature's Bounty: Natural resources regenerate faster"
      }
    },
    {
      id: "war_god",
      name: "War God Devotion",
      description: "Worship of a deity of battle and victory.",
      icon: "\u2694\uFE0F",
      bonuses: {
        militaryBonuses: { attack: 1.25, morale: 1.15 },
        specialAbility: "Battle Fury: +25% attack power in combat"
      }
    },
    {
      id: "wisdom_path",
      name: "Path of Wisdom",
      description: "A philosophical tradition emphasizing knowledge and enlightenment.",
      icon: "\u{1F4DC}",
      bonuses: {
        resourceMultipliers: { science: 1.3 },
        specialAbility: "Enlightenment: Research costs reduced by 15%"
      }
    },
    {
      id: "prosperity_creed",
      name: "Creed of Prosperity",
      description: "A belief system centered on wealth and commerce.",
      icon: "\u{1F48E}",
      bonuses: {
        resourceMultipliers: { gold: 1.3 },
        specialAbility: "Divine Commerce: +30% gold from all sources"
      }
    },
    {
      id: "harmony_faith",
      name: "Faith of Harmony",
      description: "A peaceful religion promoting balance and unity.",
      icon: "\u262F\uFE0F",
      bonuses: {
        resourceMultipliers: { food: 1.1, wood: 1.1, stone: 1.1, gold: 1.1, science: 1.1 },
        militaryBonuses: { defense: 1.2 },
        specialAbility: "Inner Peace: All bonuses apply even during war"
      }
    },
    {
      id: "techno_faith",
      name: "Techno-Religion",
      description: "Worship of technology and progress.",
      icon: "\u{1F916}",
      bonuses: {
        resourceMultipliers: { science: 1.4, gold: 1.1 },
        specialAbility: "Digital Transcendence: +40% science production"
      }
    }
  ];
  var CULTURAL_POLICIES = [
    {
      id: "tradition",
      name: "Tradition",
      description: "Embrace the old ways for stability.",
      icon: "\u{1F3DB}\uFE0F",
      adopted: false,
      cost: 100,
      effects: {
        resourceBonus: { resource: "food", amount: 2 },
        special: "Capital city produces 25% more resources"
      }
    },
    {
      id: "liberty",
      name: "Liberty",
      description: "Freedom drives innovation.",
      icon: "\u{1F5FD}",
      adopted: false,
      cost: 150,
      effects: {
        resourceBonus: { resource: "science", amount: 3 },
        special: "Free settler and worker at adoption"
      }
    },
    {
      id: "honor",
      name: "Honor",
      description: "Military might is the path to glory.",
      icon: "\u2694\uFE0F",
      adopted: false,
      cost: 200,
      effects: {
        militaryBonus: { stat: "attack", amount: 10 },
        special: "Combat experience gained 50% faster"
      }
    },
    {
      id: "piety",
      name: "Piety",
      description: "Faith guides our people.",
      icon: "\u{1F64F}",
      adopted: false,
      cost: 175,
      effects: {
        resourceBonus: { resource: "gold", amount: 3 },
        special: "Religion spreads 50% faster"
      }
    },
    {
      id: "patronage",
      name: "Patronage",
      description: "Support the arts and sciences.",
      icon: "\u{1F3AD}",
      adopted: false,
      cost: 250,
      effects: {
        resourceBonus: { resource: "science", amount: 5 },
        special: "Great people born 25% more often"
      }
    },
    {
      id: "commerce",
      name: "Commerce",
      description: "Trade is the lifeblood of empire.",
      icon: "\u{1F4B0}",
      adopted: false,
      cost: 225,
      effects: {
        resourceBonus: { resource: "gold", amount: 5 },
        special: "Trade routes generate 50% more income"
      }
    },
    {
      id: "rationalism",
      name: "Rationalism",
      description: "Reason and logic above all.",
      icon: "\u{1F52C}",
      adopted: false,
      cost: 300,
      effects: {
        resourceBonus: { resource: "science", amount: 8 },
        special: "Scientific buildings 25% more effective"
      }
    },
    {
      id: "aesthetics",
      name: "Aesthetics",
      description: "Beauty and culture define civilization.",
      icon: "\u{1F3A8}",
      adopted: false,
      cost: 200,
      effects: {
        special: "Cultural influence spreads 100% faster"
      }
    }
  ];
  function getCivilizationById(id) {
    return CIVILIZATIONS.find((civ) => civ.id === id);
  }
  function getLeaderById(id) {
    return LEADERS.find((leader) => leader.id === id);
  }
  function getAvailableLeaders(civilizationId, currentEra, eras) {
    const currentEraIndex = eras.findIndex((e) => e.id === currentEra);
    return LEADERS.filter((leader) => {
      const leaderEraIndex = eras.findIndex((e) => e.id === leader.era);
      const eraAvailable = leaderEraIndex <= currentEraIndex;
      const civMatch = leader.civilizationId === "any" || leader.civilizationId === civilizationId;
      return eraAvailable && civMatch;
    });
  }
  function getNaturalWonderById(id) {
    return NATURAL_WONDERS.find((wonder) => wonder.id === id);
  }
  function getAvailableWonders(currentEra, eras) {
    const currentEraIndex = eras.findIndex((e) => e.id === currentEra);
    return NATURAL_WONDERS.filter((wonder) => {
      const wonderEraIndex = eras.findIndex((e) => e.id === wonder.era);
      return wonderEraIndex <= currentEraIndex && !wonder.discovered;
    });
  }
  function getReligionTemplateById(id) {
    return RELIGION_TEMPLATES.find((rel) => rel.id === id);
  }
  function getPolicyById(id) {
    return CULTURAL_POLICIES.find((policy) => policy.id === id);
  }
  function calculateCivilizationBonuses(civilization, leader) {
    const resourceMultipliers = {
      food: 1,
      wood: 1,
      stone: 1,
      gold: 1,
      science: 1
    };
    const militaryBonuses = {
      attack: 1,
      defense: 1,
      health: 1
    };
    if (civilization.bonuses.resourceMultipliers) {
      if (civilization.bonuses.resourceMultipliers.food) {
        resourceMultipliers.food *= civilization.bonuses.resourceMultipliers.food;
      }
      if (civilization.bonuses.resourceMultipliers.wood) {
        resourceMultipliers.wood *= civilization.bonuses.resourceMultipliers.wood;
      }
      if (civilization.bonuses.resourceMultipliers.stone) {
        resourceMultipliers.stone *= civilization.bonuses.resourceMultipliers.stone;
      }
      if (civilization.bonuses.resourceMultipliers.gold) {
        resourceMultipliers.gold *= civilization.bonuses.resourceMultipliers.gold;
      }
      if (civilization.bonuses.resourceMultipliers.science) {
        resourceMultipliers.science *= civilization.bonuses.resourceMultipliers.science;
      }
    }
    if (civilization.bonuses.militaryBonuses) {
      if (civilization.bonuses.militaryBonuses.attack) {
        militaryBonuses.attack *= civilization.bonuses.militaryBonuses.attack;
      }
      if (civilization.bonuses.militaryBonuses.defense) {
        militaryBonuses.defense *= civilization.bonuses.militaryBonuses.defense;
      }
      if (civilization.bonuses.militaryBonuses.health) {
        militaryBonuses.health *= civilization.bonuses.militaryBonuses.health;
      }
    }
    if (leader) {
      if (leader.bonuses.resourceMultipliers) {
        if (leader.bonuses.resourceMultipliers.food) {
          resourceMultipliers.food *= leader.bonuses.resourceMultipliers.food;
        }
        if (leader.bonuses.resourceMultipliers.wood) {
          resourceMultipliers.wood *= leader.bonuses.resourceMultipliers.wood;
        }
        if (leader.bonuses.resourceMultipliers.stone) {
          resourceMultipliers.stone *= leader.bonuses.resourceMultipliers.stone;
        }
        if (leader.bonuses.resourceMultipliers.gold) {
          resourceMultipliers.gold *= leader.bonuses.resourceMultipliers.gold;
        }
        if (leader.bonuses.resourceMultipliers.science) {
          resourceMultipliers.science *= leader.bonuses.resourceMultipliers.science;
        }
      }
      if (leader.bonuses.militaryBonuses) {
        if (leader.bonuses.militaryBonuses.attack) {
          militaryBonuses.attack *= leader.bonuses.militaryBonuses.attack;
        }
        if (leader.bonuses.militaryBonuses.defense) {
          militaryBonuses.defense *= leader.bonuses.militaryBonuses.defense;
        }
        if (leader.bonuses.militaryBonuses.health) {
          militaryBonuses.health *= leader.bonuses.militaryBonuses.health;
        }
      }
    }
    return { resourceMultipliers, militaryBonuses };
  }
  function calculateReligionBonuses(religion) {
    const resourceMultipliers = {
      food: 1,
      wood: 1,
      stone: 1,
      gold: 1,
      science: 1
    };
    const militaryBonuses = {
      attack: 1,
      defense: 1,
      morale: 1
    };
    if (!religion) {
      return { resourceMultipliers, militaryBonuses };
    }
    if (religion.bonuses.resourceMultipliers) {
      if (religion.bonuses.resourceMultipliers.food) {
        resourceMultipliers.food *= religion.bonuses.resourceMultipliers.food;
      }
      if (religion.bonuses.resourceMultipliers.wood) {
        resourceMultipliers.wood *= religion.bonuses.resourceMultipliers.wood;
      }
      if (religion.bonuses.resourceMultipliers.stone) {
        resourceMultipliers.stone *= religion.bonuses.resourceMultipliers.stone;
      }
      if (religion.bonuses.resourceMultipliers.gold) {
        resourceMultipliers.gold *= religion.bonuses.resourceMultipliers.gold;
      }
      if (religion.bonuses.resourceMultipliers.science) {
        resourceMultipliers.science *= religion.bonuses.resourceMultipliers.science;
      }
    }
    if (religion.bonuses.militaryBonuses) {
      if (religion.bonuses.militaryBonuses.attack) {
        militaryBonuses.attack *= religion.bonuses.militaryBonuses.attack;
      }
      if (religion.bonuses.militaryBonuses.defense) {
        militaryBonuses.defense *= religion.bonuses.militaryBonuses.defense;
      }
      if (religion.bonuses.militaryBonuses.morale) {
        militaryBonuses.morale *= religion.bonuses.militaryBonuses.morale;
      }
    }
    return { resourceMultipliers, militaryBonuses };
  }
  function calculateNaturalWonderBonuses(discoveredWonders) {
    const flatBonuses = { food: 0, wood: 0, stone: 0, gold: 0, science: 0 };
    const multipliers = { food: 1, wood: 1, stone: 1, gold: 1, science: 1 };
    const validResources = ["food", "wood", "stone", "gold", "science"];
    for (const wonderId of discoveredWonders) {
      const wonder = getNaturalWonderById(wonderId);
      if (wonder) {
        if (wonder.bonuses.flatBonuses) {
          for (const bonus of wonder.bonuses.flatBonuses) {
            const resource = bonus.resource;
            if (validResources.includes(resource)) {
              flatBonuses[resource] += bonus.amount;
            }
          }
        }
        if (wonder.bonuses.resourceMultiplier) {
          const resource = wonder.bonuses.resourceMultiplier.resource;
          if (validResources.includes(resource)) {
            multipliers[resource] *= wonder.bonuses.resourceMultiplier.multiplier;
          }
        }
      }
    }
    return { flatBonuses, multipliers };
  }
  function calculatePolicyBonuses(adoptedPolicies) {
    const flatBonuses = { food: 0, wood: 0, stone: 0, gold: 0, science: 0 };
    const militaryBonuses = { attack: 0, defense: 0 };
    const validResources = ["food", "wood", "stone", "gold", "science"];
    const validStats = ["attack", "defense"];
    for (const policyId of adoptedPolicies) {
      const policy = getPolicyById(policyId);
      if (policy) {
        if (policy.effects.resourceBonus) {
          const resource = policy.effects.resourceBonus.resource;
          if (validResources.includes(resource)) {
            flatBonuses[resource] += policy.effects.resourceBonus.amount;
          }
        }
        if (policy.effects.militaryBonus) {
          const stat = policy.effects.militaryBonus.stat;
          if (validStats.includes(stat)) {
            militaryBonuses[stat] += policy.effects.militaryBonus.amount;
          }
        }
      }
    }
    return { flatBonuses, militaryBonuses };
  }
  function createInitialLoreState() {
    return {
      selectedCivilization: "default",
      selectedLeader: null,
      discoveredWonders: /* @__PURE__ */ new Set(),
      foundedReligion: null,
      culturePoints: 0,
      cultureLevel: 0,
      adoptedPolicies: /* @__PURE__ */ new Set()
    };
  }
  function tryDiscoverWonder(currentEra, discoveredWonders, eras) {
    const availableWonders = getAvailableWonders(currentEra, eras).filter((wonder) => !discoveredWonders.has(wonder.id));
    if (availableWonders.length === 0)
      return null;
    for (const wonder of availableWonders) {
      if (Math.random() < wonder.discoveryChance) {
        return wonder;
      }
    }
    return null;
  }
  function foundReligion(templateId) {
    const template = getReligionTemplateById(templateId);
    if (!template)
      return null;
    return {
      ...template,
      founded: true,
      followers: 1
    };
  }
  function calculateCultureGain(baseAmount, adoptedPolicies, discoveredWonders) {
    let gain = baseAmount;
    if (adoptedPolicies.has("aesthetics")) {
      gain *= 2;
    }
    gain += discoveredWonders * 0.5;
    return Math.floor(gain);
  }
  function canAdoptPolicy(policyId, culturePoints, adoptedPolicies) {
    const policy = getPolicyById(policyId);
    if (!policy)
      return false;
    if (adoptedPolicies.has(policyId))
      return false;
    return culturePoints >= policy.cost;
  }

  // dist/military.js
  var UNIT_UPGRADES = [
    // Stone Age -> Bronze Age
    {
      id: "upgrade_hunter_warrior",
      name: "Upgrade Hunters",
      description: "Upgrade your Hunters to Warriors with bronze weapons.",
      fromUnit: "hunter",
      toUnit: "warrior",
      cost: { food: 30, gold: 20, science: 20 },
      requiredTech: "bronze_working"
    },
    // Bronze Age -> Iron Age
    {
      id: "upgrade_warrior_swordsman",
      name: "Upgrade Warriors",
      description: "Upgrade your Warriors to Swordsmen with iron weapons.",
      fromUnit: "warrior",
      toUnit: "swordsman",
      cost: { food: 50, gold: 40, science: 50 },
      requiredTech: "iron_working"
    },
    {
      id: "upgrade_chariot_horseman",
      name: "Upgrade Chariots",
      description: "Upgrade your War Chariots to Horsemen.",
      fromUnit: "chariot",
      toUnit: "horseman",
      cost: { food: 60, gold: 50, science: 60 },
      requiredTech: "horseback_riding"
    },
    // Classical -> Medieval
    {
      id: "upgrade_horseman_knight",
      name: "Upgrade Horsemen",
      description: "Upgrade your Horsemen to Knights.",
      fromUnit: "horseman",
      toUnit: "knight",
      cost: { food: 80, gold: 100, science: 100 },
      requiredTech: "feudalism"
    },
    {
      id: "upgrade_legionary_knight",
      name: "Upgrade Legionaries",
      description: "Upgrade your Legionaries to Knights.",
      fromUnit: "legionary",
      toUnit: "knight",
      cost: { food: 70, gold: 90, science: 90 },
      requiredTech: "feudalism"
    },
    // Medieval -> Renaissance
    {
      id: "upgrade_musketeer_rifleman",
      name: "Upgrade Musketeers",
      description: "Upgrade your Musketeers to Riflemen.",
      fromUnit: "musketeer",
      toUnit: "rifleman",
      cost: { food: 100, gold: 150, science: 200 },
      requiredTech: "military_science"
    },
    // Industrial -> Modern
    {
      id: "upgrade_artillery_rocket_artillery",
      name: "Upgrade Artillery",
      description: "Upgrade your Artillery to Rocket Artillery.",
      fromUnit: "artillery",
      toUnit: "rocket_artillery",
      cost: { food: 200, gold: 500, science: 600 },
      requiredTech: "rocketry"
    },
    // Modern -> Information
    {
      id: "upgrade_tank_mech_infantry",
      name: "Mechanize Infantry",
      description: "Upgrade your Tanks to Mechanized Infantry.",
      fromUnit: "tank",
      toUnit: "mech_infantry",
      cost: { food: 300, gold: 800, science: 1e3 },
      requiredTech: "robotics"
    },
    // Information -> Future
    {
      id: "upgrade_mech_space_marine",
      name: "Space Marine Program",
      description: "Upgrade your Mechanized Infantry to Space Marines.",
      fromUnit: "mech_infantry",
      toUnit: "space_marine",
      cost: { food: 500, gold: 1500, science: 2e3 },
      requiredTech: "space_colonization"
    }
  ];
  function getUpgradeById(id) {
    return UNIT_UPGRADES.find((u) => u.id === id);
  }
  function canUpgradeUnit(upgrade, army, resources, researchedTechs) {
    const troopEntry = army.find((t) => t.typeId === upgrade.fromUnit);
    if (!troopEntry || troopEntry.count <= 0)
      return false;
    if (!researchedTechs.has(upgrade.requiredTech))
      return false;
    if (resources.food < upgrade.cost.food)
      return false;
    if (resources.gold < upgrade.cost.gold)
      return false;
    if (resources.science < upgrade.cost.science)
      return false;
    return true;
  }
  var FORMATIONS = [
    {
      id: "standard",
      name: "Standard Formation",
      description: "Balanced formation with no special bonuses.",
      icon: "\u2694\uFE0F",
      attackModifier: 1,
      defenseModifier: 1,
      healthModifier: 1
    },
    {
      id: "aggressive",
      name: "Aggressive Stance",
      description: "All-out attack sacrificing defense. +30% Attack, -20% Defense.",
      icon: "\u{1F525}",
      attackModifier: 1.3,
      defenseModifier: 0.8,
      healthModifier: 1,
      specialEffect: "First strike bonus"
    },
    {
      id: "defensive",
      name: "Defensive Stance",
      description: "Hunker down and hold the line. +40% Defense, -15% Attack.",
      icon: "\u{1F6E1}\uFE0F",
      attackModifier: 0.85,
      defenseModifier: 1.4,
      healthModifier: 1,
      specialEffect: "Reduced casualties"
    },
    {
      id: "phalanx",
      name: "Phalanx Formation",
      description: "Ancient formation focusing on collective defense. +50% Defense.",
      icon: "\u{1F5E1}\uFE0F",
      attackModifier: 0.9,
      defenseModifier: 1.5,
      healthModifier: 1.1,
      requiredTech: "iron_working",
      specialEffect: "Shield wall"
    },
    {
      id: "cavalry_charge",
      name: "Cavalry Charge",
      description: "Swift mounted attack. +50% Attack but lower defense.",
      icon: "\u{1F434}",
      attackModifier: 1.5,
      defenseModifier: 0.7,
      healthModifier: 1,
      requiredTech: "horseback_riding",
      specialEffect: "Breakthrough damage"
    },
    {
      id: "guerrilla",
      name: "Guerrilla Tactics",
      description: "Hit and run tactics. +20% Attack, +20% Defense, -10% Health.",
      icon: "\u{1F33F}",
      attackModifier: 1.2,
      defenseModifier: 1.2,
      healthModifier: 0.9,
      requiredTech: "military_science",
      specialEffect: "Evasion bonus"
    },
    {
      id: "blitzkrieg",
      name: "Blitzkrieg",
      description: "Lightning warfare. +60% Attack, -30% Defense.",
      icon: "\u26A1",
      attackModifier: 1.6,
      defenseModifier: 0.7,
      healthModifier: 1,
      requiredTech: "combustion",
      specialEffect: "Shock and awe"
    },
    {
      id: "combined_arms",
      name: "Combined Arms",
      description: "Modern integrated warfare. +25% to all stats.",
      icon: "\u{1F3AF}",
      attackModifier: 1.25,
      defenseModifier: 1.25,
      healthModifier: 1.25,
      requiredTech: "internet",
      specialEffect: "Force multiplier"
    }
  ];
  function getFormationById(id) {
    return FORMATIONS.find((f) => f.id === id);
  }
  function getAvailableFormations(researchedTechs) {
    return FORMATIONS.filter((f) => !f.requiredTech || researchedTechs.has(f.requiredTech));
  }
  var DEFENSE_STRUCTURES = [
    {
      id: "wooden_palisade",
      name: "Wooden Palisade",
      description: "Basic wooden defensive wall.",
      icon: "\u{1FAB5}",
      era: "stone_age",
      defenseBonus: 10,
      healthBonus: 50,
      cost: { food: 0, wood: 100, stone: 0, gold: 0 },
      buildTime: 30,
      maxCount: 3,
      requiredTech: "stone_tools"
    },
    {
      id: "stone_wall",
      name: "Stone Wall",
      description: "Sturdy stone defensive wall.",
      icon: "\u{1F9F1}",
      era: "bronze_age",
      defenseBonus: 25,
      healthBonus: 150,
      cost: { food: 0, wood: 50, stone: 200, gold: 50 },
      buildTime: 60,
      maxCount: 3,
      requiredTech: "bronze_working"
    },
    {
      id: "watchtower",
      name: "Watchtower",
      description: "Provides early warning and ranged defense.",
      icon: "\u{1F5FC}",
      era: "iron_age",
      defenseBonus: 15,
      healthBonus: 75,
      cost: { food: 0, wood: 100, stone: 150, gold: 50 },
      buildTime: 45,
      maxCount: 4,
      requiredTech: "construction"
    },
    {
      id: "fortified_wall",
      name: "Fortified Wall",
      description: "Reinforced wall with battlements.",
      icon: "\u{1F3F0}",
      era: "classical_age",
      defenseBonus: 50,
      healthBonus: 300,
      cost: { food: 0, wood: 100, stone: 400, gold: 100 },
      buildTime: 90,
      maxCount: 3,
      requiredTech: "engineering"
    },
    {
      id: "castle",
      name: "Castle",
      description: "Massive fortification providing ultimate defense.",
      icon: "\u{1F3EF}",
      era: "medieval_age",
      defenseBonus: 100,
      healthBonus: 500,
      cost: { food: 100, wood: 200, stone: 800, gold: 300 },
      buildTime: 180,
      maxCount: 2,
      requiredTech: "feudalism"
    },
    {
      id: "star_fort",
      name: "Star Fort",
      description: "Angular fortress designed to resist cannon fire.",
      icon: "\u2B50",
      era: "renaissance",
      defenseBonus: 150,
      healthBonus: 750,
      cost: { food: 200, wood: 300, stone: 1200, gold: 500 },
      buildTime: 240,
      maxCount: 2,
      requiredTech: "military_science"
    },
    {
      id: "bunker",
      name: "Bunker",
      description: "Reinforced concrete bunker for modern warfare.",
      icon: "\u{1F3D7}\uFE0F",
      era: "modern_age",
      defenseBonus: 200,
      healthBonus: 1e3,
      cost: { food: 300, wood: 100, stone: 2e3, gold: 800 },
      buildTime: 300,
      maxCount: 3,
      requiredTech: "electricity"
    },
    {
      id: "missile_defense",
      name: "Missile Defense System",
      description: "Advanced anti-missile defense network.",
      icon: "\u{1F680}",
      era: "atomic_age",
      defenseBonus: 300,
      healthBonus: 1500,
      cost: { food: 500, wood: 200, stone: 3e3, gold: 2e3 },
      buildTime: 360,
      maxCount: 2,
      requiredTech: "rocketry"
    },
    {
      id: "energy_shield",
      name: "Energy Shield",
      description: "Force field protection against all attacks.",
      icon: "\u{1F4A0}",
      era: "future_age",
      defenseBonus: 500,
      healthBonus: 3e3,
      cost: { food: 1e3, wood: 500, stone: 5e3, gold: 5e3 },
      buildTime: 480,
      maxCount: 1,
      requiredTech: "fusion_power"
    }
  ];
  function getDefenseStructureById(id) {
    return DEFENSE_STRUCTURES.find((d) => d.id === id);
  }
  function calculateDefenseBonuses(defenseBuildings) {
    let totalDefense = 0;
    let totalHealth = 0;
    for (const building of defenseBuildings) {
      const structure = getDefenseStructureById(building.typeId);
      if (structure) {
        totalDefense += structure.defenseBonus * building.count;
        totalHealth += structure.healthBonus * building.count;
      }
    }
    return { defense: totalDefense, health: totalHealth };
  }
  var HEROES = [
    {
      id: "tribal_chief",
      name: "Grunk",
      title: "Tribal Chief",
      description: "A fierce tribal leader who inspires warriors.",
      icon: "\u{1F9B4}",
      era: "stone_age",
      bonuses: {
        attackBonus: 10,
        defenseBonus: 5,
        healthBonus: 50,
        specialAbility: "Rally Cry - +15% attack for all units"
      },
      cost: { gold: 50, science: 30 },
      requiredTech: "hunting"
    },
    {
      id: "bronze_commander",
      name: "Marduk",
      title: "Bronze Commander",
      description: "A legendary commander of bronze age armies.",
      icon: "\u2694\uFE0F",
      era: "bronze_age",
      bonuses: {
        attackBonus: 20,
        defenseBonus: 15,
        healthBonus: 100,
        specialAbility: "Bronze Wall - +25% defense when defending"
      },
      cost: { gold: 150, science: 100 },
      requiredTech: "bronze_working"
    },
    {
      id: "iron_general",
      name: "Leonidas",
      title: "Iron General",
      description: "A tactical genius of iron age warfare.",
      icon: "\u{1F6E1}\uFE0F",
      era: "iron_age",
      bonuses: {
        attackBonus: 35,
        defenseBonus: 40,
        healthBonus: 200,
        specialAbility: "Phalanx Master - Defense formations are 50% more effective"
      },
      cost: { gold: 400, science: 300 },
      requiredTech: "iron_working"
    },
    {
      id: "classical_strategos",
      name: "Alexander",
      title: "Strategos",
      description: "A conquering hero who never lost a battle.",
      icon: "\u{1F451}",
      era: "classical_age",
      bonuses: {
        attackBonus: 60,
        defenseBonus: 30,
        healthBonus: 250,
        specialAbility: "Conqueror - +50% rewards from victories"
      },
      cost: { gold: 800, science: 500 },
      requiredTech: "philosophy"
    },
    {
      id: "medieval_knight",
      name: "Richard",
      title: "Lionheart",
      description: "A crusading king renowned for his valor.",
      icon: "\u{1F981}",
      era: "medieval_age",
      bonuses: {
        attackBonus: 80,
        defenseBonus: 60,
        healthBonus: 400,
        specialAbility: "Chivalry - Knights deal double damage"
      },
      cost: { gold: 1500, science: 800 },
      requiredTech: "feudalism"
    },
    {
      id: "renaissance_admiral",
      name: "Drake",
      title: "Admiral",
      description: "A master of naval warfare and exploration.",
      icon: "\u2693",
      era: "renaissance",
      bonuses: {
        attackBonus: 100,
        defenseBonus: 50,
        healthBonus: 350,
        specialAbility: "Sea Wolf - Naval units +75% effectiveness"
      },
      cost: { gold: 2500, science: 1200 },
      requiredTech: "astronomy"
    },
    {
      id: "industrial_marshal",
      name: "Napoleon",
      title: "Marshal",
      description: "A military genius who conquered empires.",
      icon: "\u{1F396}\uFE0F",
      era: "industrial_age",
      bonuses: {
        attackBonus: 150,
        defenseBonus: 80,
        healthBonus: 600,
        specialAbility: "Grande Arm\xE9e - All units +20% stats"
      },
      cost: { gold: 5e3, science: 2500 },
      requiredTech: "steam_power"
    },
    {
      id: "modern_general",
      name: "Patton",
      title: "General",
      description: "A tank commander who led from the front.",
      icon: "\u{1F397}\uFE0F",
      era: "modern_age",
      bonuses: {
        attackBonus: 250,
        defenseBonus: 120,
        healthBonus: 800,
        specialAbility: "Armor Blitz - Tanks deal +100% damage"
      },
      cost: { gold: 1e4, science: 5e3 },
      requiredTech: "combustion"
    },
    {
      id: "atomic_commander",
      name: "Zhukov",
      title: "Supreme Commander",
      description: "Master of massive military operations.",
      icon: "\u2B50",
      era: "atomic_age",
      bonuses: {
        attackBonus: 400,
        defenseBonus: 200,
        healthBonus: 1200,
        specialAbility: "Deep Battle - +30% attack, -25% casualties"
      },
      cost: { gold: 2e4, science: 1e4 },
      requiredTech: "rocketry"
    },
    {
      id: "cyber_commander",
      name: "ARIA",
      title: "Cyber Commander",
      description: "An AI military strategist.",
      icon: "\u{1F916}",
      era: "information_age",
      bonuses: {
        attackBonus: 600,
        defenseBonus: 400,
        healthBonus: 2e3,
        specialAbility: "Network Warfare - Enemy defense reduced by 30%"
      },
      cost: { gold: 4e4, science: 25e3 },
      requiredTech: "artificial_intelligence"
    },
    {
      id: "stellar_admiral",
      name: "Nova",
      title: "Stellar Admiral",
      description: "Commander of the space fleet.",
      icon: "\u{1F31F}",
      era: "future_age",
      bonuses: {
        attackBonus: 1e3,
        defenseBonus: 600,
        healthBonus: 3e3,
        specialAbility: "Orbital Strike - First strike deals triple damage"
      },
      cost: { gold: 1e5, science: 5e4 },
      requiredTech: "space_colonization"
    }
  ];
  function getHeroById(id) {
    return HEROES.find((h) => h.id === id);
  }
  function getAvailableHeroes(researchedTechs, recruitedHeroes) {
    return HEROES.filter((h) => researchedTechs.has(h.requiredTech) && !recruitedHeroes.has(h.id));
  }
  var NAVAL_UNITS = [
    {
      id: "raft",
      name: "War Raft",
      description: "Simple wooden raft for river combat.",
      icon: "\u{1FAB5}",
      era: "stone_age",
      stats: { attack: 5, defense: 2, health: 30 },
      cost: { food: 20, wood: 50, gold: 0 },
      trainTime: 15,
      requiredTech: "hunting"
    },
    {
      id: "galley",
      name: "Galley",
      description: "Oar-powered warship with bronze ram.",
      icon: "\u26F5",
      era: "bronze_age",
      stats: { attack: 15, defense: 8, health: 60 },
      cost: { food: 40, wood: 100, gold: 30 },
      trainTime: 25,
      requiredTech: "bronze_working"
    },
    {
      id: "trireme",
      name: "Trireme",
      description: "Advanced galley with three rows of oars.",
      icon: "\u{1F6A3}",
      era: "classical_age",
      stats: { attack: 30, defense: 15, health: 100 },
      cost: { food: 60, wood: 150, gold: 60 },
      trainTime: 35,
      requiredTech: "iron_casting"
    },
    {
      id: "longship",
      name: "Longship",
      description: "Fast raiding ship of the north.",
      icon: "\u{1F6F6}",
      era: "medieval_age",
      stats: { attack: 45, defense: 20, health: 120 },
      cost: { food: 80, wood: 200, gold: 100 },
      trainTime: 40,
      requiredTech: "feudalism"
    },
    {
      id: "caravel",
      name: "Caravel",
      description: "Exploration and combat ship.",
      icon: "\u26F5",
      era: "renaissance",
      stats: { attack: 60, defense: 35, health: 180 },
      cost: { food: 100, wood: 300, gold: 200 },
      trainTime: 50,
      requiredTech: "astronomy"
    },
    {
      id: "ship_of_the_line",
      name: "Ship of the Line",
      description: "Massive warship with multiple gun decks.",
      icon: "\u{1F6A2}",
      era: "renaissance",
      stats: { attack: 100, defense: 60, health: 300 },
      cost: { food: 150, wood: 500, gold: 400 },
      trainTime: 70,
      requiredTech: "military_science"
    },
    {
      id: "ironclad",
      name: "Ironclad",
      description: "Steam-powered armored warship.",
      icon: "\u{1F6A2}",
      era: "industrial_age",
      stats: { attack: 150, defense: 100, health: 500 },
      cost: { food: 200, wood: 300, gold: 700 },
      trainTime: 90,
      requiredTech: "steam_power"
    },
    {
      id: "battleship",
      name: "Battleship",
      description: "Heavily armored capital ship.",
      icon: "\u{1F6F3}\uFE0F",
      era: "modern_age",
      stats: { attack: 300, defense: 200, health: 1e3 },
      cost: { food: 300, wood: 400, gold: 1500 },
      trainTime: 120,
      requiredTech: "electricity"
    },
    {
      id: "carrier",
      name: "Aircraft Carrier",
      description: "Mobile airbase at sea.",
      icon: "\u{1F6F3}\uFE0F",
      era: "modern_age",
      stats: { attack: 400, defense: 150, health: 1200 },
      cost: { food: 400, wood: 500, gold: 2500 },
      trainTime: 150,
      requiredTech: "flight"
    },
    {
      id: "nuclear_submarine",
      name: "Nuclear Submarine",
      description: "Stealth underwater attack vessel.",
      icon: "\u{1F6A2}",
      era: "atomic_age",
      stats: { attack: 500, defense: 250, health: 800 },
      cost: { food: 500, wood: 300, gold: 3500 },
      trainTime: 180,
      requiredTech: "nuclear_power"
    },
    {
      id: "stealth_destroyer",
      name: "Stealth Destroyer",
      description: "Advanced radar-evading warship.",
      icon: "\u{1F6A2}",
      era: "information_age",
      stats: { attack: 700, defense: 400, health: 1500 },
      cost: { food: 600, wood: 400, gold: 5e3 },
      trainTime: 200,
      requiredTech: "internet"
    },
    {
      id: "space_cruiser",
      name: "Space Cruiser",
      description: "Interplanetary combat vessel.",
      icon: "\u{1F680}",
      era: "future_age",
      stats: { attack: 1200, defense: 800, health: 3e3 },
      cost: { food: 1e3, wood: 500, gold: 1e4 },
      trainTime: 300,
      requiredTech: "space_colonization"
    }
  ];
  function getNavalUnitById(id) {
    return NAVAL_UNITS.find((n) => n.id === id);
  }
  function calculateNavalPower(navy) {
    let totalAttack = 0;
    let totalDefense = 0;
    let totalHealth = 0;
    for (const ship of navy) {
      const unit = getNavalUnitById(ship.typeId);
      if (unit) {
        totalAttack += unit.stats.attack * ship.count;
        totalDefense += unit.stats.defense * ship.count;
        totalHealth += unit.stats.health * ship.count;
      }
    }
    return { attack: totalAttack, defense: totalDefense, health: totalHealth };
  }
  var SIEGE_WEAPONS = [
    {
      id: "battering_ram",
      name: "Battering Ram",
      description: "Simple ram for breaking gates.",
      icon: "\u{1FAB5}",
      era: "bronze_age",
      stats: { attack: 10, defense: 5, health: 50, siegeBonus: 50 },
      cost: { food: 20, wood: 80, stone: 0, gold: 10 },
      trainTime: 20,
      requiredTech: "bronze_working"
    },
    {
      id: "siege_tower",
      name: "Siege Tower",
      description: "Mobile tower for scaling walls.",
      icon: "\u{1F5FC}",
      era: "iron_age",
      stats: { attack: 5, defense: 20, health: 100, siegeBonus: 40 },
      cost: { food: 30, wood: 150, stone: 0, gold: 30 },
      trainTime: 40,
      requiredTech: "construction"
    },
    {
      id: "catapult",
      name: "Catapult",
      description: "Hurls stones at fortifications.",
      icon: "\u{1F3AF}",
      era: "classical_age",
      stats: { attack: 40, defense: 5, health: 60, siegeBonus: 100 },
      cost: { food: 40, wood: 120, stone: 50, gold: 50 },
      trainTime: 35,
      requiredTech: "engineering"
    },
    {
      id: "ballista",
      name: "Ballista",
      description: "Giant crossbow for anti-personnel and siege.",
      icon: "\u{1F3F9}",
      era: "classical_age",
      stats: { attack: 50, defense: 3, health: 40, siegeBonus: 60 },
      cost: { food: 30, wood: 100, stone: 20, gold: 40 },
      trainTime: 30,
      requiredTech: "engineering"
    },
    {
      id: "trebuchet",
      name: "Trebuchet",
      description: "Massive counterweight siege engine.",
      icon: "\u{1F3AA}",
      era: "medieval_age",
      stats: { attack: 80, defense: 5, health: 80, siegeBonus: 200 },
      cost: { food: 60, wood: 200, stone: 100, gold: 100 },
      trainTime: 60,
      requiredTech: "machinery"
    },
    {
      id: "bombard",
      name: "Bombard",
      description: "Early cannon for siege warfare.",
      icon: "\u{1F4A3}",
      era: "medieval_age",
      stats: { attack: 120, defense: 5, health: 60, siegeBonus: 300 },
      cost: { food: 80, wood: 100, stone: 50, gold: 200 },
      trainTime: 70,
      requiredTech: "gunpowder"
    },
    {
      id: "cannon",
      name: "Siege Cannon",
      description: "Powerful artillery for breaching walls.",
      icon: "\u{1F4A5}",
      era: "renaissance",
      stats: { attack: 180, defense: 10, health: 100, siegeBonus: 400 },
      cost: { food: 100, wood: 150, stone: 100, gold: 350 },
      trainTime: 80,
      requiredTech: "military_science"
    },
    {
      id: "howitzer",
      name: "Howitzer",
      description: "Long-range bombardment weapon.",
      icon: "\u{1F52B}",
      era: "industrial_age",
      stats: { attack: 300, defense: 15, health: 150, siegeBonus: 500 },
      cost: { food: 150, wood: 100, stone: 150, gold: 600 },
      trainTime: 100,
      requiredTech: "dynamite"
    },
    {
      id: "cruise_missile",
      name: "Cruise Missile",
      description: "Precision-guided munition.",
      icon: "\u{1F680}",
      era: "atomic_age",
      stats: { attack: 600, defense: 0, health: 50, siegeBonus: 1e3 },
      cost: { food: 200, wood: 50, stone: 100, gold: 1500 },
      trainTime: 60,
      requiredTech: "rocketry"
    },
    {
      id: "orbital_bombardment",
      name: "Orbital Strike Platform",
      description: "Space-based weapons system.",
      icon: "\uFFFD\uFFFD",
      era: "future_age",
      stats: { attack: 1500, defense: 100, health: 200, siegeBonus: 3e3 },
      cost: { food: 500, wood: 200, stone: 500, gold: 5e3 },
      trainTime: 150,
      requiredTech: "space_colonization"
    }
  ];
  function getSiegeWeaponById(id) {
    return SIEGE_WEAPONS.find((s) => s.id === id);
  }
  function calculateSiegePower(siegeWeapons) {
    let totalAttack = 0;
    let totalDefense = 0;
    let totalHealth = 0;
    let totalSiegeBonus = 0;
    for (const weapon of siegeWeapons) {
      const unit = getSiegeWeaponById(weapon.typeId);
      if (unit) {
        totalAttack += unit.stats.attack * weapon.count;
        totalDefense += unit.stats.defense * weapon.count;
        totalHealth += unit.stats.health * weapon.count;
        totalSiegeBonus += unit.stats.siegeBonus * weapon.count;
      }
    }
    return { attack: totalAttack, defense: totalDefense, health: totalHealth, siegeBonus: totalSiegeBonus };
  }
  var MILITARY_TRADITIONS = [
    {
      id: "warrior_spirit",
      name: "Warrior Spirit",
      description: "Your soldiers fight with fierce determination.",
      icon: "\u{1F525}",
      bonuses: { attackMultiplier: 1.05, special: "+5% attack" },
      requirement: { battlesWon: 5 }
    },
    {
      id: "iron_discipline",
      name: "Iron Discipline",
      description: "Strict training creates resilient soldiers.",
      icon: "\u2694\uFE0F",
      bonuses: { defenseMultiplier: 1.05, special: "+5% defense" },
      requirement: { battlesWon: 10 }
    },
    {
      id: "shock_tactics",
      name: "Shock Tactics",
      description: "Lightning-fast attacks overwhelm enemies.",
      icon: "\u26A1",
      bonuses: { attackMultiplier: 1.1, special: "+10% attack" },
      requirement: { battlesWon: 25 }
    },
    {
      id: "fortification_masters",
      name: "Fortification Masters",
      description: "Your engineers build superior defenses.",
      icon: "\u{1F3F0}",
      bonuses: { defenseMultiplier: 1.15, special: "+15% defense" },
      requirement: { territoriesConquered: 10 }
    },
    {
      id: "veteran_corps",
      name: "Veteran Corps",
      description: "Battle-hardened units form your army core.",
      icon: "\u{1F396}\uFE0F",
      bonuses: { healthMultiplier: 1.1, experienceGain: 1.25, special: "+10% health, +25% exp gain" },
      requirement: { veteranUnits: 5 }
    },
    {
      id: "heroic_legacy",
      name: "Heroic Legacy",
      description: "Tales of great heroes inspire your troops.",
      icon: "\u{1F451}",
      bonuses: { attackMultiplier: 1.1, defenseMultiplier: 1.1, special: "+10% attack and defense" },
      requirement: { heroesRecruited: 3 }
    },
    {
      id: "conquerors_pride",
      name: "Conqueror's Pride",
      description: "Your empire is built on victory.",
      icon: "\u{1F30D}",
      bonuses: { attackMultiplier: 1.15, casualtyReduction: 0.1, special: "+15% attack, -10% casualties" },
      requirement: { territoriesConquered: 20 }
    },
    {
      id: "elite_forces",
      name: "Elite Forces",
      description: "The finest military in the world.",
      icon: "\u2B50",
      bonuses: { attackMultiplier: 1.2, defenseMultiplier: 1.2, healthMultiplier: 1.2, special: "+20% all stats" },
      requirement: { battlesWon: 100 }
    }
  ];
  function getTraditionById(id) {
    return MILITARY_TRADITIONS.find((t) => t.id === id);
  }
  function checkTraditionUnlock(tradition, stats) {
    const req = tradition.requirement;
    if (req.battlesWon && stats.battlesWon < req.battlesWon)
      return false;
    if (req.territoriesConquered && stats.territoriesConquered < req.territoriesConquered)
      return false;
    if (req.heroesRecruited && stats.heroesRecruited < req.heroesRecruited)
      return false;
    if (req.veteranUnits && stats.veteranUnits < req.veteranUnits)
      return false;
    return true;
  }
  function calculateTraditionBonuses(unlockedTraditions) {
    let attackMultiplier = 1;
    let defenseMultiplier = 1;
    let healthMultiplier = 1;
    let casualtyReduction = 0;
    let experienceGain = 1;
    for (const traditionId of unlockedTraditions) {
      const tradition = getTraditionById(traditionId);
      if (tradition) {
        if (tradition.bonuses.attackMultiplier)
          attackMultiplier *= tradition.bonuses.attackMultiplier;
        if (tradition.bonuses.defenseMultiplier)
          defenseMultiplier *= tradition.bonuses.defenseMultiplier;
        if (tradition.bonuses.healthMultiplier)
          healthMultiplier *= tradition.bonuses.healthMultiplier;
        if (tradition.bonuses.casualtyReduction)
          casualtyReduction += tradition.bonuses.casualtyReduction;
        if (tradition.bonuses.experienceGain)
          experienceGain *= tradition.bonuses.experienceGain;
      }
    }
    return { attackMultiplier, defenseMultiplier, healthMultiplier, casualtyReduction, experienceGain };
  }
  var SPY_MISSIONS = [
    {
      id: "scout_enemy",
      name: "Scout Enemy",
      description: "Gather intelligence on enemy forces.",
      icon: "\u{1F50D}",
      duration: 30,
      successChance: 0.9,
      cost: { gold: 50 },
      effects: { type: "intel", intelGained: "enemy_strength" },
      requiredTech: "writing"
    },
    {
      id: "steal_gold",
      name: "Steal Gold",
      description: "Pilfer gold from enemy treasury.",
      icon: "\u{1F4B0}",
      duration: 60,
      successChance: 0.6,
      cost: { gold: 100 },
      effects: { type: "steal", resourceStolen: { resource: "gold", amount: 500 } },
      requiredTech: "currency"
    },
    {
      id: "sabotage_defenses",
      name: "Sabotage Defenses",
      description: "Weaken enemy fortifications.",
      icon: "\u{1F4A3}",
      duration: 90,
      successChance: 0.5,
      cost: { gold: 200 },
      effects: { type: "sabotage", enemyDebuff: { stat: "defense", amount: 20 } },
      requiredTech: "engineering"
    },
    {
      id: "steal_research",
      name: "Steal Research",
      description: "Acquire enemy scientific knowledge.",
      icon: "\u{1F4DC}",
      duration: 120,
      successChance: 0.4,
      cost: { gold: 500 },
      effects: { type: "steal", resourceStolen: { resource: "science", amount: 2e3 } },
      requiredTech: "printing_press"
    },
    {
      id: "assassinate",
      name: "Assassinate Commander",
      description: "Remove enemy leadership.",
      icon: "\u{1F5E1}\uFE0F",
      duration: 180,
      successChance: 0.3,
      cost: { gold: 1e3 },
      effects: { type: "sabotage", enemyDebuff: { stat: "attack", amount: 30 } },
      requiredTech: "military_science"
    },
    {
      id: "counterintelligence",
      name: "Counterintelligence",
      description: "Protect against enemy spies.",
      icon: "\u{1F6E1}\uFE0F",
      duration: 60,
      successChance: 0.8,
      cost: { gold: 300 },
      effects: { type: "counter", intelGained: "spy_protection" },
      requiredTech: "radio"
    },
    {
      id: "cyber_attack",
      name: "Cyber Attack",
      description: "Disrupt enemy communications.",
      icon: "\u{1F4BB}",
      duration: 60,
      successChance: 0.65,
      cost: { gold: 2e3 },
      effects: { type: "sabotage", enemyDebuff: { stat: "health", amount: 25 } },
      requiredTech: "internet"
    },
    {
      id: "grand_heist",
      name: "Grand Heist",
      description: "Massive coordinated theft operation.",
      icon: "\u{1F3AD}",
      duration: 240,
      successChance: 0.35,
      cost: { gold: 5e3 },
      effects: { type: "steal", resourceStolen: { resource: "gold", amount: 25e3 } },
      requiredTech: "artificial_intelligence"
    }
  ];
  function getSpyMissionById(id) {
    return SPY_MISSIONS.find((m) => m.id === id);
  }
  function getAvailableSpyMissions(researchedTechs) {
    return SPY_MISSIONS.filter((m) => researchedTechs.has(m.requiredTech));
  }
  function calculateSpySuccessChance(mission, spy) {
    const levelBonus = spy.level * 0.05;
    return Math.min(0.95, mission.successChance + levelBonus);
  }
  function createInitialMilitaryState() {
    return {
      selectedFormation: "standard",
      defenseBuildings: [],
      defenseConstructionQueue: [],
      recruitedHeroes: /* @__PURE__ */ new Set(),
      activeHero: null,
      unitExperience: /* @__PURE__ */ new Map(),
      navy: [],
      navalTrainingQueue: [],
      siegeWeapons: [],
      siegeTrainingQueue: [],
      unlockedTraditions: /* @__PURE__ */ new Set(),
      spies: [],
      activeSpyMissions: [],
      maxSpies: 3
    };
  }
  function calculateTotalMilitaryPower(army, militaryState, researchedTechs) {
    let totalAttack = 0;
    let totalDefense = 0;
    let totalHealth = 0;
    for (const troop of army) {
      const troopType = getTroopTypeById(troop.typeId);
      if (troopType) {
        totalAttack += troopType.stats.attack * troop.count;
        totalDefense += troopType.stats.defense * troop.count;
        totalHealth += troopType.stats.health * troop.count;
      }
    }
    const navalPower = calculateNavalPower(militaryState.navy);
    totalAttack += navalPower.attack;
    totalDefense += navalPower.defense;
    totalHealth += navalPower.health;
    const siegePower = calculateSiegePower(militaryState.siegeWeapons);
    totalAttack += siegePower.attack;
    totalDefense += siegePower.defense;
    totalHealth += siegePower.health;
    const defenseBonuses = calculateDefenseBonuses(militaryState.defenseBuildings);
    totalDefense += defenseBonuses.defense;
    totalHealth += defenseBonuses.health;
    const formation = getFormationById(militaryState.selectedFormation);
    if (formation) {
      totalAttack *= formation.attackModifier;
      totalDefense *= formation.defenseModifier;
      totalHealth *= formation.healthModifier;
    }
    if (militaryState.activeHero) {
      const hero = getHeroById(militaryState.activeHero);
      if (hero) {
        totalAttack += hero.bonuses.attackBonus;
        totalDefense += hero.bonuses.defenseBonus;
        totalHealth += hero.bonuses.healthBonus;
      }
    }
    const traditionBonuses = calculateTraditionBonuses(militaryState.unlockedTraditions);
    totalAttack *= traditionBonuses.attackMultiplier;
    totalDefense *= traditionBonuses.defenseMultiplier;
    totalHealth *= traditionBonuses.healthMultiplier;
    return {
      attack: Math.floor(totalAttack),
      defense: Math.floor(totalDefense),
      health: Math.floor(totalHealth)
    };
  }

  // dist/game.js
  var Game = class {
    constructor() {
      this.updateInterval = null;
      this.onStateChange = null;
      this.onAchievementUnlocked = null;
      this.offlineProgress = null;
      this.state = this.createInitialState();
    }
    createInitialState() {
      return {
        currentEra: "stone_age",
        resources: {
          food: 0,
          wood: 0,
          stone: 0,
          gold: 0,
          science: 0
        },
        resourceMultipliers: {
          food: 1,
          wood: 1,
          stone: 1,
          gold: 1,
          science: 1
        },
        researchedTechs: /* @__PURE__ */ new Set(),
        currentResearch: null,
        researchProgress: 0,
        unlockedTroops: /* @__PURE__ */ new Set(),
        army: [],
        trainingQueue: [],
        lastUpdate: Date.now(),
        totalPlayTime: 0,
        // Combat system
        missions: generateMissions(),
        completedMissions: /* @__PURE__ */ new Set(),
        activeBattle: null,
        battleAnimationSpeed: 800,
        // 800ms per round
        // Achievements and statistics
        statistics: createInitialStatistics(),
        achievements: createInitialAchievementProgress(),
        pendingAchievementNotifications: [],
        // Buildings system
        buildings: [],
        constructionQueue: [],
        unlockedBuildings: /* @__PURE__ */ new Set(["hut"]),
        // Hut is available from start
        // Conquest mode
        territories: generateTerritories(),
        conqueredTerritories: /* @__PURE__ */ new Set(),
        activeConquestBattle: null,
        conquestMode: false,
        // Skill tree and legacy system
        skillTree: createInitialSkillTreeState(),
        // World and Lore system
        lore: createInitialLoreState(),
        // Military enhancements
        military: createInitialMilitaryState()
      };
    }
    setOnAchievementUnlocked(callback) {
      this.onAchievementUnlocked = callback;
    }
    setOnStateChange(callback) {
      this.onStateChange = callback;
    }
    notifyStateChange() {
      if (this.onStateChange) {
        this.onStateChange();
      }
    }
    start() {
      this.state.lastUpdate = Date.now();
      this.updateInterval = window.setInterval(() => this.update(), 100);
    }
    stop() {
      if (this.updateInterval !== null) {
        clearInterval(this.updateInterval);
        this.updateInterval = null;
      }
    }
    update() {
      const now = Date.now();
      const delta = (now - this.state.lastUpdate) / 1e3;
      this.state.lastUpdate = now;
      this.state.totalPlayTime += delta;
      const era = getEraById(this.state.currentEra);
      if (!era)
        return;
      const buildingProduction = calculateBuildingProduction(this.state.buildings);
      const conquestBonuses = this.getConquestBonuses();
      const conquestMultipliers = this.getConquestMultipliers();
      const loreBonuses = this.getLoreBonuses();
      const totalFoodMultiplier = this.state.resourceMultipliers.food * conquestMultipliers.food * loreBonuses.multipliers.food;
      const totalWoodMultiplier = this.state.resourceMultipliers.wood * conquestMultipliers.wood * loreBonuses.multipliers.wood;
      const totalStoneMultiplier = this.state.resourceMultipliers.stone * conquestMultipliers.stone * loreBonuses.multipliers.stone;
      const totalGoldMultiplier = this.state.resourceMultipliers.gold * conquestMultipliers.gold * loreBonuses.multipliers.gold;
      const totalScienceMultiplier = this.state.resourceMultipliers.science * conquestMultipliers.science * loreBonuses.multipliers.science;
      const foodGain = (era.resources.food.baseRate + buildingProduction.food + conquestBonuses.food + loreBonuses.flatBonuses.food) * totalFoodMultiplier * delta;
      const woodGain = (era.resources.wood.baseRate + buildingProduction.wood + conquestBonuses.wood + loreBonuses.flatBonuses.wood) * totalWoodMultiplier * delta;
      const stoneGain = (era.resources.stone.baseRate + buildingProduction.stone + conquestBonuses.stone + loreBonuses.flatBonuses.stone) * totalStoneMultiplier * delta;
      const goldGain = (era.resources.gold.baseRate + buildingProduction.gold + conquestBonuses.gold + loreBonuses.flatBonuses.gold) * totalGoldMultiplier * delta;
      const scienceGain = (era.resources.science.baseRate + buildingProduction.science + conquestBonuses.science + loreBonuses.flatBonuses.science) * totalScienceMultiplier * delta;
      this.state.resources.food += foodGain;
      this.state.resources.wood += woodGain;
      this.state.resources.stone += stoneGain;
      this.state.resources.gold += goldGain;
      this.state.resources.science += scienceGain;
      this.state.statistics.totalFoodGathered += foodGain;
      this.state.statistics.totalWoodGathered += woodGain;
      this.state.statistics.totalStoneGathered += stoneGain;
      this.state.statistics.totalGoldEarned += goldGain;
      this.state.statistics.totalScienceGenerated += scienceGain;
      const cultureGain = calculateCultureGain(delta * 0.1, this.state.lore.adoptedPolicies, this.state.lore.discoveredWonders.size);
      this.state.lore.culturePoints += cultureGain;
      if (this.state.currentResearch) {
        const tech = getTechById(this.state.currentResearch);
        if (tech) {
          this.state.researchProgress += (era.resources.science.baseRate + buildingProduction.science + conquestBonuses.science + loreBonuses.flatBonuses.science) * totalScienceMultiplier * delta;
          if (this.state.researchProgress >= tech.cost.science) {
            this.completeResearch();
          }
        }
      }
      this.updateTrainingQueue(now);
      this.updateConstructionQueue(now);
      this.updateMilitaryQueues(now);
      this.checkMilitaryTraditions();
      this.checkAchievements();
      this.notifyStateChange();
    }
    updateTrainingQueue(now) {
      const completed = [];
      for (let i = 0; i < this.state.trainingQueue.length; i++) {
        const training = this.state.trainingQueue[i];
        if (now >= training.endTime) {
          this.addTroopToArmy(training.troopId);
          this.state.statistics.totalTroopsTrained++;
          completed.push(i);
        }
      }
      for (let i = completed.length - 1; i >= 0; i--) {
        this.state.trainingQueue.splice(completed[i], 1);
      }
    }
    addTroopToArmy(troopId) {
      const existing = this.state.army.find((t) => t.typeId === troopId);
      if (existing) {
        existing.count++;
      } else {
        this.state.army.push({ typeId: troopId, count: 1 });
      }
    }
    updateConstructionQueue(now) {
      const completed = [];
      for (let i = 0; i < this.state.constructionQueue.length; i++) {
        const construction = this.state.constructionQueue[i];
        if (now >= construction.endTime) {
          this.addBuilding(construction.buildingId);
          this.state.statistics.totalBuildingsConstructed = (this.state.statistics.totalBuildingsConstructed || 0) + 1;
          completed.push(i);
        }
      }
      for (let i = completed.length - 1; i >= 0; i--) {
        this.state.constructionQueue.splice(completed[i], 1);
      }
    }
    addBuilding(buildingId) {
      const existing = this.state.buildings.find((b) => b.typeId === buildingId);
      if (existing) {
        existing.count++;
      } else {
        this.state.buildings.push({ typeId: buildingId, count: 1 });
      }
    }
    // Resource gathering actions (manual clicking)
    gatherFood() {
      const amount = 1 * this.state.resourceMultipliers.food;
      this.state.resources.food += amount;
      this.state.statistics.totalFoodGathered += amount;
      this.state.statistics.clickCount++;
      this.checkAchievements();
      this.notifyStateChange();
    }
    gatherWood() {
      const amount = 1 * this.state.resourceMultipliers.wood;
      this.state.resources.wood += amount;
      this.state.statistics.totalWoodGathered += amount;
      this.state.statistics.clickCount++;
      this.checkAchievements();
      this.notifyStateChange();
    }
    gatherStone() {
      const amount = 1 * this.state.resourceMultipliers.stone;
      this.state.resources.stone += amount;
      this.state.statistics.totalStoneGathered += amount;
      this.state.statistics.clickCount++;
      this.checkAchievements();
      this.notifyStateChange();
    }
    // Research system
    startResearch(techId) {
      const tech = getTechById(techId);
      if (!tech)
        return false;
      if (!canResearch(techId, this.state.researchedTechs, this.state.resources.science)) {
        return false;
      }
      this.state.resources.science -= tech.cost.science;
      this.state.currentResearch = techId;
      this.state.researchProgress = 0;
      this.notifyStateChange();
      return true;
    }
    completeResearch() {
      if (!this.state.currentResearch)
        return;
      const tech = getTechById(this.state.currentResearch);
      if (!tech)
        return;
      this.state.researchedTechs.add(this.state.currentResearch);
      if (tech.effects.resourceBonus) {
        const resource = tech.effects.resourceBonus.resource;
        this.state.resourceMultipliers[resource] *= tech.effects.resourceBonus.multiplier;
      }
      if (tech.effects.unitUnlock) {
        this.state.unlockedTroops.add(tech.effects.unitUnlock);
      }
      if (tech.effects.unlocks) {
        const nextEra = getNextEra(this.state.currentEra);
        if (nextEra && tech.effects.unlocks.includes(nextEra.id)) {
          this.state.currentEra = nextEra.id;
        }
      }
      this.checkBuildingUnlocks(this.state.currentResearch);
      this.state.currentResearch = null;
      this.state.researchProgress = 0;
      this.notifyStateChange();
    }
    checkBuildingUnlocks(techId) {
      for (const building of BUILDING_TYPES) {
        if (building.unlockTech === techId) {
          this.state.unlockedBuildings.add(building.id);
        }
      }
    }
    // Building system
    constructBuilding(buildingId) {
      const buildingType = getBuildingTypeById(buildingId);
      if (!buildingType)
        return false;
      if (!canBuildBuilding(buildingId, this.state.unlockedBuildings, this.state.buildings, this.state.resources)) {
        return false;
      }
      this.state.resources.food -= buildingType.cost.food;
      this.state.resources.wood -= buildingType.cost.wood;
      this.state.resources.stone -= buildingType.cost.stone;
      this.state.resources.gold -= buildingType.cost.gold;
      const now = Date.now();
      this.state.constructionQueue.push({
        buildingId,
        startTime: now,
        endTime: now + buildingType.buildTime * 1e3
      });
      this.notifyStateChange();
      return true;
    }
    getBuildingCount(buildingId) {
      const building = this.state.buildings.find((b) => b.typeId === buildingId);
      return building ? building.count : 0;
    }
    getBuildingProduction() {
      return calculateBuildingProduction(this.state.buildings);
    }
    getAvailableBuildings() {
      return BUILDING_TYPES.filter((building) => {
        if (building.unlockTech === null)
          return true;
        return this.state.unlockedBuildings.has(building.id);
      });
    }
    getTotalBuildingCount() {
      return getTotalBuildingCount(this.state.buildings);
    }
    // Barracks system
    trainTroop(troopId) {
      const troopType = getTroopTypeById(troopId);
      if (!troopType)
        return false;
      if (!canTrainTroop(troopId, this.state.unlockedTroops, this.state.resources)) {
        return false;
      }
      this.state.resources.food -= troopType.cost.food;
      this.state.resources.gold -= troopType.cost.gold;
      if (troopType.cost.wood)
        this.state.resources.wood -= troopType.cost.wood;
      if (troopType.cost.stone)
        this.state.resources.stone -= troopType.cost.stone;
      const now = Date.now();
      this.state.trainingQueue.push({
        troopId,
        startTime: now,
        endTime: now + troopType.trainTime * 1e3
      });
      this.notifyStateChange();
      return true;
    }
    getArmyPower() {
      return calculateArmyPower(this.state.army);
    }
    // Combat system methods
    getAvailableMissions() {
      return this.state.missions.filter((m) => isMissionAvailable(m, this.state.currentEra));
    }
    getMissionsByCurrentEra() {
      return getMissionsByEra(this.state.missions, this.state.currentEra);
    }
    canStartMission() {
      return canStartMission(this.state.army) && !this.state.activeBattle;
    }
    startMission(missionId) {
      const mission = getMissionById(this.state.missions, missionId);
      if (!mission)
        return false;
      if (!isMissionAvailable(mission, this.state.currentEra))
        return false;
      if (!canStartMission(this.state.army))
        return false;
      if (this.state.activeBattle)
        return false;
      const result = simulateCombat(this.state.army, mission);
      const playerPower = calculateArmyPower(this.state.army);
      this.state.activeBattle = {
        missionId,
        logs: result.logs,
        currentRound: 0,
        isComplete: false,
        result,
        playerStartHealth: playerPower.health,
        enemyStartHealth: mission.enemyArmy.health
      };
      this.notifyStateChange();
      return true;
    }
    // Advance battle animation by one round
    advanceBattleRound() {
      if (!this.state.activeBattle)
        return false;
      if (this.state.activeBattle.isComplete)
        return false;
      this.state.activeBattle.currentRound++;
      if (this.state.activeBattle.currentRound >= this.state.activeBattle.logs.length) {
        this.completeBattle();
      }
      this.notifyStateChange();
      return true;
    }
    completeBattle() {
      if (!this.state.activeBattle || !this.state.activeBattle.result)
        return;
      this.state.activeBattle.isComplete = true;
      const result = this.state.activeBattle.result;
      if (result.victory && result.rewards) {
        this.state.resources.food += result.rewards.food;
        this.state.resources.wood += result.rewards.wood;
        this.state.resources.stone += result.rewards.stone;
        this.state.resources.gold += result.rewards.gold;
        this.state.resources.science += result.rewards.science;
        this.state.statistics.totalFoodGathered += result.rewards.food;
        this.state.statistics.totalWoodGathered += result.rewards.wood;
        this.state.statistics.totalStoneGathered += result.rewards.stone;
        this.state.statistics.totalGoldEarned += result.rewards.gold;
        this.state.statistics.totalScienceGenerated += result.rewards.science;
        this.state.completedMissions.add(this.state.activeBattle.missionId);
        this.state.statistics.battlesWon++;
      } else {
        this.state.statistics.battlesLost++;
      }
      if (result.casualtyPercent > 0) {
        this.applyCasualties(result.casualtyPercent);
      }
      this.checkAchievements();
    }
    applyCasualties(casualtyPercent) {
      for (const troop of this.state.army) {
        const casualtyFactor = casualtyPercent / 100;
        const troopsLost = Math.floor(troop.count * casualtyFactor * 0.5);
        troop.count = Math.max(0, troop.count - troopsLost);
      }
      this.state.army = this.state.army.filter((t) => t.count > 0);
    }
    dismissBattle() {
      this.state.activeBattle = null;
      this.notifyStateChange();
    }
    setBattleSpeed(speed) {
      this.state.battleAnimationSpeed = Math.max(100, Math.min(2e3, speed));
      this.notifyStateChange();
    }
    isMissionCompleted(missionId) {
      return this.state.completedMissions.has(missionId);
    }
    // Conquest mode methods
    toggleConquestMode() {
      this.state.conquestMode = !this.state.conquestMode;
      this.notifyStateChange();
    }
    getAvailableTerritories() {
      return this.state.territories.filter((t) => isTerritoryAvailable(t, this.state.currentEra));
    }
    getTerritoriesByCurrentEra() {
      return getTerritoriesByEra(this.state.territories, this.state.currentEra);
    }
    canStartConquest() {
      return canStartMission(this.state.army) && !this.state.activeConquestBattle && !this.state.activeBattle;
    }
    startConquest(territoryId) {
      const territory = getTerritoryById(this.state.territories, territoryId);
      if (!territory)
        return false;
      if (!isTerritoryAvailable(territory, this.state.currentEra))
        return false;
      if (!canStartMission(this.state.army))
        return false;
      if (this.state.activeConquestBattle)
        return false;
      if (this.state.activeBattle)
        return false;
      const result = simulateTerritoryConquest(this.state.army, territory);
      const playerPower = calculateArmyPower(this.state.army);
      this.state.activeConquestBattle = {
        missionId: territoryId,
        // Using missionId to store territoryId
        logs: result.logs,
        currentRound: 0,
        isComplete: false,
        result,
        playerStartHealth: playerPower.health,
        enemyStartHealth: territory.enemyArmy.health
      };
      this.notifyStateChange();
      return true;
    }
    advanceConquestRound() {
      if (!this.state.activeConquestBattle)
        return false;
      if (this.state.activeConquestBattle.isComplete)
        return false;
      this.state.activeConquestBattle.currentRound++;
      if (this.state.activeConquestBattle.currentRound >= this.state.activeConquestBattle.logs.length) {
        this.completeConquest();
      }
      this.notifyStateChange();
      return true;
    }
    completeConquest() {
      if (!this.state.activeConquestBattle || !this.state.activeConquestBattle.result)
        return;
      this.state.activeConquestBattle.isComplete = true;
      const result = this.state.activeConquestBattle.result;
      const territoryId = this.state.activeConquestBattle.missionId;
      if (result.victory && result.rewards) {
        this.state.resources.food += result.rewards.food;
        this.state.resources.wood += result.rewards.wood;
        this.state.resources.stone += result.rewards.stone;
        this.state.resources.gold += result.rewards.gold;
        this.state.resources.science += result.rewards.science;
        this.state.statistics.totalFoodGathered += result.rewards.food;
        this.state.statistics.totalWoodGathered += result.rewards.wood;
        this.state.statistics.totalStoneGathered += result.rewards.stone;
        this.state.statistics.totalGoldEarned += result.rewards.gold;
        this.state.statistics.totalScienceGenerated += result.rewards.science;
        this.state.conqueredTerritories.add(territoryId);
        const territory = getTerritoryById(this.state.territories, territoryId);
        if (territory) {
          territory.conquered = true;
        }
        this.state.statistics.territoriesConquered = (this.state.statistics.territoriesConquered || 0) + 1;
        this.state.statistics.battlesWon++;
      } else {
        this.state.statistics.battlesLost++;
      }
      if (result.casualtyPercent > 0) {
        this.applyCasualties(result.casualtyPercent);
      }
      this.checkAchievements();
    }
    dismissConquestBattle() {
      this.state.activeConquestBattle = null;
      this.notifyStateChange();
    }
    isTerritoryConquered(territoryId) {
      return this.state.conqueredTerritories.has(territoryId);
    }
    getConquestBonuses() {
      return calculateConquestBonuses(this.state.territories);
    }
    getConquestMultipliers() {
      return calculateConquestMultipliers(this.state.territories);
    }
    getConqueredTerritoryCount() {
      return this.state.conqueredTerritories.size;
    }
    getTotalTerritoryCount() {
      return this.state.territories.length;
    }
    // Get available technologies
    getAvailableTechs() {
      return TECHNOLOGIES.filter((tech) => {
        if (this.state.researchedTechs.has(tech.id))
          return false;
        for (const prereq of tech.prerequisites) {
          if (!this.state.researchedTechs.has(prereq))
            return false;
        }
        return true;
      });
    }
    // Get available troops
    getAvailableTroops() {
      return TROOP_TYPES.filter((troop) => this.state.unlockedTroops.has(troop.id));
    }
    // Skill Tree system
    upgradeSkill(skillId) {
      const skill = getSkillById(skillId);
      if (!skill)
        return false;
      const currentLevel = getSkillLevel(skillId, this.state.skillTree.skillLevels);
      if (currentLevel >= skill.maxLevel)
        return false;
      const cost = getSkillCost(skill, currentLevel);
      if (this.state.skillTree.legacyPoints < cost)
        return false;
      if (!canUnlockSkill(skill, this.state.skillTree.skillLevels))
        return false;
      this.state.skillTree.legacyPoints -= cost;
      this.state.skillTree.skillLevels.set(skillId, currentLevel + 1);
      this.notifyStateChange();
      return true;
    }
    addLegacyPoints(points) {
      const bonuses = calculateSkillBonuses(this.state.skillTree.skillLevels);
      const adjustedPoints = Math.floor(points * bonuses.legacyPointsMultiplier);
      this.state.skillTree.legacyPoints += adjustedPoints;
      this.state.skillTree.totalLegacyPointsEarned += adjustedPoints;
      this.notifyStateChange();
    }
    getSkillBonuses() {
      return calculateSkillBonuses(this.state.skillTree.skillLevels);
    }
    // Achievement system
    checkAchievements() {
      for (const achievement of ACHIEVEMENTS) {
        const progress = this.state.achievements.get(achievement.id);
        if (!progress || progress.unlocked)
          continue;
        if (this.isAchievementConditionMet(achievement)) {
          this.unlockAchievement(achievement.id);
        }
      }
    }
    isAchievementConditionMet(achievement) {
      const condition = achievement.condition;
      switch (condition.type) {
        case "resource_total":
          return this.getStatisticForResource(condition.target) >= condition.amount;
        case "resource_current":
          return this.state.resources[condition.target] >= condition.amount;
        case "tech_count":
          return this.state.researchedTechs.size >= condition.amount;
        case "troop_count":
          return this.getTotalTroopCount() >= condition.amount;
        case "era_reached":
          return this.hasReachedEra(condition.target);
        case "battles_won":
          return this.state.statistics.battlesWon >= condition.amount;
        case "missions_completed":
          return this.state.completedMissions.size >= condition.amount;
        case "building_count":
          return this.getTotalBuildingCount() >= condition.amount;
        default:
          return false;
      }
    }
    getStatisticForResource(resource) {
      switch (resource) {
        case "food":
          return this.state.statistics.totalFoodGathered;
        case "wood":
          return this.state.statistics.totalWoodGathered;
        case "stone":
          return this.state.statistics.totalStoneGathered;
        case "gold":
          return this.state.statistics.totalGoldEarned;
        case "science":
          return this.state.statistics.totalScienceGenerated;
        default:
          return 0;
      }
    }
    getTotalTroopCount() {
      return this.state.army.reduce((sum, troop) => sum + troop.count, 0);
    }
    hasReachedEra(eraId) {
      const currentIndex = ERAS.findIndex((e) => e.id === this.state.currentEra);
      const targetIndex = ERAS.findIndex((e) => e.id === eraId);
      return currentIndex >= targetIndex;
    }
    unlockAchievement(achievementId) {
      const progress = this.state.achievements.get(achievementId);
      if (!progress || progress.unlocked)
        return;
      const achievement = getAchievementById(achievementId);
      if (!achievement)
        return;
      progress.unlocked = true;
      progress.unlockedAt = Date.now();
      progress.notified = false;
      this.state.pendingAchievementNotifications.push(achievementId);
      if (achievement.reward) {
        if (achievement.reward.type === "multiplier" && achievement.reward.resource) {
          const resource = achievement.reward.resource;
          this.state.resourceMultipliers[resource] *= achievement.reward.amount;
        }
      }
      if (this.onAchievementUnlocked) {
        this.onAchievementUnlocked(achievement);
      }
    }
    getUnlockedAchievements() {
      return ACHIEVEMENTS.filter((a) => {
        const progress = this.state.achievements.get(a.id);
        return progress && progress.unlocked;
      });
    }
    getLockedAchievements() {
      return ACHIEVEMENTS.filter((a) => {
        const progress = this.state.achievements.get(a.id);
        return !progress || !progress.unlocked;
      });
    }
    getAchievementProgress(achievementId) {
      return this.state.achievements.get(achievementId);
    }
    popPendingAchievementNotification() {
      return this.state.pendingAchievementNotifications.shift();
    }
    // Offline progress
    calculateOfflineProgress(lastSaveTime) {
      if (!this.state.researchedTechs.has(TECH_IDS.CLOUD_COMPUTING)) {
        this.offlineProgress = null;
        return;
      }
      const now = Date.now();
      const offlineDuration = (now - lastSaveTime) / 1e3;
      const maxOfflineTime = 8 * 60 * 60;
      const cappedDuration = Math.min(offlineDuration, maxOfflineTime);
      if (cappedDuration < 60) {
        this.offlineProgress = null;
        return;
      }
      const era = getEraById(this.state.currentEra);
      if (!era) {
        this.offlineProgress = null;
        return;
      }
      const offlineEfficiency = 0.5;
      const buildingProduction = calculateBuildingProduction(this.state.buildings);
      const food = (era.resources.food.baseRate + buildingProduction.food) * this.state.resourceMultipliers.food * cappedDuration * offlineEfficiency;
      const wood = (era.resources.wood.baseRate + buildingProduction.wood) * this.state.resourceMultipliers.wood * cappedDuration * offlineEfficiency;
      const stone = (era.resources.stone.baseRate + buildingProduction.stone) * this.state.resourceMultipliers.stone * cappedDuration * offlineEfficiency;
      const gold = (era.resources.gold.baseRate + buildingProduction.gold) * this.state.resourceMultipliers.gold * cappedDuration * offlineEfficiency;
      const science = (era.resources.science.baseRate + buildingProduction.science) * this.state.resourceMultipliers.science * cappedDuration * offlineEfficiency;
      this.state.resources.food += food;
      this.state.resources.wood += wood;
      this.state.resources.stone += stone;
      this.state.resources.gold += gold;
      this.state.resources.science += science;
      this.state.statistics.totalFoodGathered += food;
      this.state.statistics.totalWoodGathered += wood;
      this.state.statistics.totalStoneGathered += stone;
      this.state.statistics.totalGoldEarned += gold;
      this.state.statistics.totalScienceGenerated += science;
      this.state.statistics.offlineEarnings += food + wood + stone + gold + science;
      this.offlineProgress = {
        earned: true,
        resources: { food, wood, stone, gold, science },
        duration: cappedDuration
      };
    }
    dismissOfflineProgress() {
      this.offlineProgress = null;
    }
    // Save/Load
    saveGame() {
      const achievementsArray = Array.from(this.state.achievements.entries());
      const skillTreeSave = {
        legacyPoints: this.state.skillTree.legacyPoints,
        totalLegacyPointsEarned: this.state.skillTree.totalLegacyPointsEarned,
        skillLevels: Array.from(this.state.skillTree.skillLevels.entries()),
        completedMilestones: Array.from(this.state.skillTree.completedMilestones),
        milestoneCompletionCounts: Array.from(this.state.skillTree.milestoneCompletionCounts.entries()),
        prestigeCount: this.state.skillTree.prestigeCount
      };
      const loreSave = {
        selectedCivilization: this.state.lore.selectedCivilization,
        selectedLeader: this.state.lore.selectedLeader,
        discoveredWonders: Array.from(this.state.lore.discoveredWonders),
        foundedReligion: this.state.lore.foundedReligion,
        culturePoints: this.state.lore.culturePoints,
        cultureLevel: this.state.lore.cultureLevel,
        adoptedPolicies: Array.from(this.state.lore.adoptedPolicies)
      };
      const militarySave = {
        selectedFormation: this.state.military.selectedFormation,
        defenseBuildings: this.state.military.defenseBuildings,
        defenseConstructionQueue: this.state.military.defenseConstructionQueue,
        recruitedHeroes: Array.from(this.state.military.recruitedHeroes),
        activeHero: this.state.military.activeHero,
        unitExperience: Array.from(this.state.military.unitExperience.entries()),
        navy: this.state.military.navy,
        navalTrainingQueue: this.state.military.navalTrainingQueue,
        siegeWeapons: this.state.military.siegeWeapons,
        siegeTrainingQueue: this.state.military.siegeTrainingQueue,
        unlockedTraditions: Array.from(this.state.military.unlockedTraditions),
        spies: this.state.military.spies,
        activeSpyMissions: this.state.military.activeSpyMissions,
        maxSpies: this.state.military.maxSpies
      };
      const saveData = {
        ...this.state,
        researchedTechs: Array.from(this.state.researchedTechs),
        unlockedTroops: Array.from(this.state.unlockedTroops),
        completedMissions: Array.from(this.state.completedMissions),
        unlockedBuildings: Array.from(this.state.unlockedBuildings),
        conqueredTerritories: Array.from(this.state.conqueredTerritories),
        achievements: achievementsArray,
        skillTree: skillTreeSave,
        lore: loreSave,
        military: militarySave,
        activeBattle: null,
        // Don't save active battles
        activeConquestBattle: null,
        // Don't save active conquest battles
        saveTime: Date.now()
        // Save timestamp for offline progress
      };
      return JSON.stringify(saveData);
    }
    loadGame(saveString) {
      try {
        const saveData = JSON.parse(saveString);
        let achievementsMap;
        if (saveData.achievements && Array.isArray(saveData.achievements)) {
          achievementsMap = new Map(saveData.achievements);
        } else {
          achievementsMap = createInitialAchievementProgress();
        }
        for (const achievement of ACHIEVEMENTS) {
          if (!achievementsMap.has(achievement.id)) {
            achievementsMap.set(achievement.id, {
              id: achievement.id,
              unlocked: false,
              notified: false
            });
          }
        }
        let unlockedBuildingsSet;
        if (saveData.unlockedBuildings && Array.isArray(saveData.unlockedBuildings)) {
          unlockedBuildingsSet = new Set(saveData.unlockedBuildings);
        } else {
          unlockedBuildingsSet = /* @__PURE__ */ new Set(["hut"]);
          const researchedTechs = new Set(saveData.researchedTechs || []);
          for (const building of BUILDING_TYPES) {
            if (building.unlockTech && researchedTechs.has(building.unlockTech)) {
              unlockedBuildingsSet.add(building.id);
            }
          }
        }
        let conqueredTerritoriesSet;
        if (saveData.conqueredTerritories && Array.isArray(saveData.conqueredTerritories)) {
          conqueredTerritoriesSet = new Set(saveData.conqueredTerritories);
        } else {
          conqueredTerritoriesSet = /* @__PURE__ */ new Set();
        }
        const territories = generateTerritories();
        for (const territory of territories) {
          if (conqueredTerritoriesSet.has(territory.id)) {
            territory.conquered = true;
          }
        }
        let skillTreeState = createInitialSkillTreeState();
        if (saveData.skillTree) {
          skillTreeState = {
            legacyPoints: saveData.skillTree.legacyPoints || 0,
            totalLegacyPointsEarned: saveData.skillTree.totalLegacyPointsEarned || 0,
            skillLevels: new Map(saveData.skillTree.skillLevels || []),
            completedMilestones: new Set(saveData.skillTree.completedMilestones || []),
            milestoneCompletionCounts: new Map(saveData.skillTree.milestoneCompletionCounts || []),
            prestigeCount: saveData.skillTree.prestigeCount || 0
          };
        }
        let loreState = createInitialLoreState();
        if (saveData.lore) {
          loreState = {
            selectedCivilization: saveData.lore.selectedCivilization || "default",
            selectedLeader: saveData.lore.selectedLeader || null,
            discoveredWonders: new Set(saveData.lore.discoveredWonders || []),
            foundedReligion: saveData.lore.foundedReligion || null,
            culturePoints: saveData.lore.culturePoints || 0,
            cultureLevel: saveData.lore.cultureLevel || 0,
            adoptedPolicies: new Set(saveData.lore.adoptedPolicies || [])
          };
        }
        let militaryState = createInitialMilitaryState();
        if (saveData.military) {
          militaryState = {
            selectedFormation: saveData.military.selectedFormation || "standard",
            defenseBuildings: saveData.military.defenseBuildings || [],
            defenseConstructionQueue: saveData.military.defenseConstructionQueue || [],
            recruitedHeroes: new Set(saveData.military.recruitedHeroes || []),
            activeHero: saveData.military.activeHero || null,
            unitExperience: new Map(saveData.military.unitExperience || []),
            navy: saveData.military.navy || [],
            navalTrainingQueue: saveData.military.navalTrainingQueue || [],
            siegeWeapons: saveData.military.siegeWeapons || [],
            siegeTrainingQueue: saveData.military.siegeTrainingQueue || [],
            unlockedTraditions: new Set(saveData.military.unlockedTraditions || []),
            spies: saveData.military.spies || [],
            activeSpyMissions: saveData.military.activeSpyMissions || [],
            maxSpies: saveData.military.maxSpies || 3
          };
        }
        this.state = {
          ...saveData,
          researchedTechs: new Set(saveData.researchedTechs),
          unlockedTroops: new Set(saveData.unlockedTroops),
          completedMissions: new Set(saveData.completedMissions || []),
          missions: generateMissions(),
          // Always regenerate missions
          activeBattle: null,
          battleAnimationSpeed: saveData.battleAnimationSpeed || 800,
          statistics: saveData.statistics || createInitialStatistics(),
          achievements: achievementsMap,
          pendingAchievementNotifications: [],
          // Buildings system
          buildings: saveData.buildings || [],
          constructionQueue: saveData.constructionQueue || [],
          unlockedBuildings: unlockedBuildingsSet,
          // Conquest mode
          territories,
          conqueredTerritories: conqueredTerritoriesSet,
          activeConquestBattle: null,
          conquestMode: saveData.conquestMode || false,
          // Skill tree
          skillTree: skillTreeState,
          // World and Lore
          lore: loreState,
          // Military enhancements
          military: militaryState
        };
        if (saveData.saveTime) {
          this.calculateOfflineProgress(saveData.saveTime);
        }
        return true;
      } catch {
        return false;
      }
    }
    resetGame() {
      this.state = this.createInitialState();
      this.offlineProgress = null;
      this.notifyStateChange();
    }
    // ===== Lore System Methods =====
    getLoreBonuses() {
      const flatBonuses = { food: 0, wood: 0, stone: 0, gold: 0, science: 0 };
      const multipliers = { food: 1, wood: 1, stone: 1, gold: 1, science: 1 };
      const militaryBonuses = { attack: 1, defense: 1, health: 1 };
      const civilization = getCivilizationById(this.state.lore.selectedCivilization);
      const leader = this.state.lore.selectedLeader ? getLeaderById(this.state.lore.selectedLeader) : null;
      if (civilization) {
        const civBonuses = calculateCivilizationBonuses(civilization, leader);
        multipliers.food *= civBonuses.resourceMultipliers.food;
        multipliers.wood *= civBonuses.resourceMultipliers.wood;
        multipliers.stone *= civBonuses.resourceMultipliers.stone;
        multipliers.gold *= civBonuses.resourceMultipliers.gold;
        multipliers.science *= civBonuses.resourceMultipliers.science;
        militaryBonuses.attack *= civBonuses.militaryBonuses.attack;
        militaryBonuses.defense *= civBonuses.militaryBonuses.defense;
        militaryBonuses.health *= civBonuses.militaryBonuses.health;
      }
      const religionBonuses = calculateReligionBonuses(this.state.lore.foundedReligion);
      multipliers.food *= religionBonuses.resourceMultipliers.food;
      multipliers.wood *= religionBonuses.resourceMultipliers.wood;
      multipliers.stone *= religionBonuses.resourceMultipliers.stone;
      multipliers.gold *= religionBonuses.resourceMultipliers.gold;
      multipliers.science *= religionBonuses.resourceMultipliers.science;
      const wonderBonuses = calculateNaturalWonderBonuses(Array.from(this.state.lore.discoveredWonders));
      flatBonuses.food += wonderBonuses.flatBonuses.food;
      flatBonuses.wood += wonderBonuses.flatBonuses.wood;
      flatBonuses.stone += wonderBonuses.flatBonuses.stone;
      flatBonuses.gold += wonderBonuses.flatBonuses.gold;
      flatBonuses.science += wonderBonuses.flatBonuses.science;
      multipliers.food *= wonderBonuses.multipliers.food;
      multipliers.wood *= wonderBonuses.multipliers.wood;
      multipliers.stone *= wonderBonuses.multipliers.stone;
      multipliers.gold *= wonderBonuses.multipliers.gold;
      multipliers.science *= wonderBonuses.multipliers.science;
      const policyBonuses = calculatePolicyBonuses(Array.from(this.state.lore.adoptedPolicies));
      flatBonuses.food += policyBonuses.flatBonuses.food;
      flatBonuses.wood += policyBonuses.flatBonuses.wood;
      flatBonuses.stone += policyBonuses.flatBonuses.stone;
      flatBonuses.gold += policyBonuses.flatBonuses.gold;
      flatBonuses.science += policyBonuses.flatBonuses.science;
      const PERCENTAGE_TO_DECIMAL = 100;
      militaryBonuses.attack += policyBonuses.militaryBonuses.attack / PERCENTAGE_TO_DECIMAL;
      militaryBonuses.defense += policyBonuses.militaryBonuses.defense / PERCENTAGE_TO_DECIMAL;
      return { flatBonuses, multipliers, militaryBonuses };
    }
    selectCivilization(civilizationId) {
      const civilization = getCivilizationById(civilizationId);
      if (!civilization)
        return false;
      this.state.lore.selectedCivilization = civilizationId;
      this.state.lore.selectedLeader = null;
      if (civilization.startingResources) {
        this.state.resources.food += civilization.startingResources.food || 0;
        this.state.resources.wood += civilization.startingResources.wood || 0;
        this.state.resources.stone += civilization.startingResources.stone || 0;
        this.state.resources.gold += civilization.startingResources.gold || 0;
        this.state.resources.science += civilization.startingResources.science || 0;
      }
      this.notifyStateChange();
      return true;
    }
    selectLeader(leaderId) {
      const leader = getLeaderById(leaderId);
      if (!leader)
        return false;
      const availableLeaders = getAvailableLeaders(this.state.lore.selectedCivilization, this.state.currentEra, ERAS);
      if (!availableLeaders.find((l) => l.id === leaderId)) {
        return false;
      }
      this.state.lore.selectedLeader = leaderId;
      this.notifyStateChange();
      return true;
    }
    getAvailableLeaders() {
      return getAvailableLeaders(this.state.lore.selectedCivilization, this.state.currentEra, ERAS);
    }
    discoverNaturalWonder() {
      const wonder = tryDiscoverWonder(this.state.currentEra, this.state.lore.discoveredWonders, ERAS);
      if (wonder) {
        this.state.lore.discoveredWonders.add(wonder.id);
        if (wonder.id === "el_dorado") {
          this.state.resources.gold += 5e3;
        }
        this.notifyStateChange();
      }
      return wonder;
    }
    getDiscoveredWonders() {
      return Array.from(this.state.lore.discoveredWonders).map((id) => getNaturalWonderById(id)).filter((w) => w !== void 0);
    }
    foundNewReligion(templateId) {
      if (this.state.lore.foundedReligion) {
        return false;
      }
      const religion = foundReligion(templateId);
      if (!religion)
        return false;
      this.state.lore.foundedReligion = religion;
      this.notifyStateChange();
      return true;
    }
    getReligionTemplates() {
      return RELIGION_TEMPLATES;
    }
    adoptCulturalPolicy(policyId) {
      if (!canAdoptPolicy(policyId, this.state.lore.culturePoints, this.state.lore.adoptedPolicies)) {
        return false;
      }
      const policy = getPolicyById(policyId);
      if (!policy)
        return false;
      this.state.lore.culturePoints -= policy.cost;
      this.state.lore.adoptedPolicies.add(policyId);
      this.state.lore.cultureLevel = Math.floor(this.state.lore.adoptedPolicies.size / 2);
      this.notifyStateChange();
      return true;
    }
    getAvailablePolicies() {
      return CULTURAL_POLICIES.filter((policy) => !this.state.lore.adoptedPolicies.has(policy.id));
    }
    getAdoptedPolicies() {
      return Array.from(this.state.lore.adoptedPolicies).map((id) => getPolicyById(id)).filter((p) => p !== void 0);
    }
    getCivilization() {
      return getCivilizationById(this.state.lore.selectedCivilization);
    }
    getLeader() {
      return this.state.lore.selectedLeader ? getLeaderById(this.state.lore.selectedLeader) : void 0;
    }
    // ===== Military Enhancement Methods =====
    // Unit Upgrades
    getAvailableUnitUpgrades() {
      return UNIT_UPGRADES.filter((upgrade) => canUpgradeUnit(upgrade, this.state.army, this.state.resources, this.state.researchedTechs));
    }
    upgradeUnit(upgradeId) {
      const upgrade = getUpgradeById(upgradeId);
      if (!upgrade)
        return false;
      if (!canUpgradeUnit(upgrade, this.state.army, this.state.resources, this.state.researchedTechs)) {
        return false;
      }
      this.state.resources.food -= upgrade.cost.food;
      this.state.resources.gold -= upgrade.cost.gold;
      this.state.resources.science -= upgrade.cost.science;
      const fromTroop = this.state.army.find((t) => t.typeId === upgrade.fromUnit);
      if (!fromTroop || fromTroop.count <= 0)
        return false;
      fromTroop.count--;
      if (fromTroop.count <= 0) {
        this.state.army = this.state.army.filter((t) => t.count > 0);
      }
      const toTroop = this.state.army.find((t) => t.typeId === upgrade.toUnit);
      if (toTroop) {
        toTroop.count++;
      } else {
        this.state.army.push({ typeId: upgrade.toUnit, count: 1 });
        this.state.unlockedTroops.add(upgrade.toUnit);
      }
      this.notifyStateChange();
      return true;
    }
    // Formations
    getAvailableFormations() {
      return getAvailableFormations(this.state.researchedTechs);
    }
    setFormation(formationId) {
      const formation = getFormationById(formationId);
      if (!formation)
        return false;
      if (formation.requiredTech && !this.state.researchedTechs.has(formation.requiredTech)) {
        return false;
      }
      this.state.military.selectedFormation = formationId;
      this.notifyStateChange();
      return true;
    }
    getCurrentFormation() {
      return getFormationById(this.state.military.selectedFormation);
    }
    // Defense System
    getAvailableDefenseStructures() {
      return DEFENSE_STRUCTURES.filter((structure) => this.state.researchedTechs.has(structure.requiredTech));
    }
    buildDefenseStructure(structureId) {
      const structure = getDefenseStructureById(structureId);
      if (!structure)
        return false;
      if (!this.state.researchedTechs.has(structure.requiredTech))
        return false;
      const currentCount = this.state.military.defenseBuildings.find((b) => b.typeId === structureId)?.count || 0;
      if (currentCount >= structure.maxCount)
        return false;
      if (this.state.resources.food < structure.cost.food)
        return false;
      if (this.state.resources.wood < structure.cost.wood)
        return false;
      if (this.state.resources.stone < structure.cost.stone)
        return false;
      if (this.state.resources.gold < structure.cost.gold)
        return false;
      this.state.resources.food -= structure.cost.food;
      this.state.resources.wood -= structure.cost.wood;
      this.state.resources.stone -= structure.cost.stone;
      this.state.resources.gold -= structure.cost.gold;
      const now = Date.now();
      this.state.military.defenseConstructionQueue.push({
        typeId: structureId,
        endTime: now + structure.buildTime * 1e3
      });
      this.notifyStateChange();
      return true;
    }
    getDefenseBonuses() {
      return calculateDefenseBonuses(this.state.military.defenseBuildings);
    }
    // Heroes
    getAvailableHeroes() {
      return getAvailableHeroes(this.state.researchedTechs, this.state.military.recruitedHeroes);
    }
    recruitHero(heroId) {
      const hero = getHeroById(heroId);
      if (!hero)
        return false;
      if (this.state.military.recruitedHeroes.has(heroId))
        return false;
      if (!this.state.researchedTechs.has(hero.requiredTech))
        return false;
      if (this.state.resources.gold < hero.cost.gold)
        return false;
      if (this.state.resources.science < hero.cost.science)
        return false;
      this.state.resources.gold -= hero.cost.gold;
      this.state.resources.science -= hero.cost.science;
      this.state.military.recruitedHeroes.add(heroId);
      if (!this.state.military.activeHero) {
        this.state.military.activeHero = heroId;
      }
      this.state.statistics.heroesRecruited = (this.state.statistics.heroesRecruited || 0) + 1;
      this.checkMilitaryTraditions();
      this.notifyStateChange();
      return true;
    }
    setActiveHero(heroId) {
      if (heroId && !this.state.military.recruitedHeroes.has(heroId)) {
        return false;
      }
      this.state.military.activeHero = heroId;
      this.notifyStateChange();
      return true;
    }
    getActiveHero() {
      return this.state.military.activeHero ? getHeroById(this.state.military.activeHero) : void 0;
    }
    getRecruitedHeroes() {
      return Array.from(this.state.military.recruitedHeroes).map((id) => getHeroById(id)).filter((h) => h !== void 0);
    }
    // Naval Forces
    getAvailableNavalUnits() {
      return NAVAL_UNITS.filter((unit) => this.state.researchedTechs.has(unit.requiredTech));
    }
    trainNavalUnit(unitId) {
      const unit = getNavalUnitById(unitId);
      if (!unit)
        return false;
      if (!this.state.researchedTechs.has(unit.requiredTech))
        return false;
      if (this.state.resources.food < unit.cost.food)
        return false;
      if (this.state.resources.wood < unit.cost.wood)
        return false;
      if (this.state.resources.gold < unit.cost.gold)
        return false;
      this.state.resources.food -= unit.cost.food;
      this.state.resources.wood -= unit.cost.wood;
      this.state.resources.gold -= unit.cost.gold;
      const now = Date.now();
      this.state.military.navalTrainingQueue.push({
        typeId: unitId,
        endTime: now + unit.trainTime * 1e3
      });
      this.notifyStateChange();
      return true;
    }
    getNavalPower() {
      return calculateNavalPower(this.state.military.navy);
    }
    // Siege Weapons
    getAvailableSiegeWeapons() {
      return SIEGE_WEAPONS.filter((weapon) => this.state.researchedTechs.has(weapon.requiredTech));
    }
    trainSiegeWeapon(weaponId) {
      const weapon = getSiegeWeaponById(weaponId);
      if (!weapon)
        return false;
      if (!this.state.researchedTechs.has(weapon.requiredTech))
        return false;
      if (this.state.resources.food < weapon.cost.food)
        return false;
      if (this.state.resources.wood < weapon.cost.wood)
        return false;
      if (this.state.resources.stone < weapon.cost.stone)
        return false;
      if (this.state.resources.gold < weapon.cost.gold)
        return false;
      this.state.resources.food -= weapon.cost.food;
      this.state.resources.wood -= weapon.cost.wood;
      this.state.resources.stone -= weapon.cost.stone;
      this.state.resources.gold -= weapon.cost.gold;
      const now = Date.now();
      this.state.military.siegeTrainingQueue.push({
        typeId: weaponId,
        endTime: now + weapon.trainTime * 1e3
      });
      this.notifyStateChange();
      return true;
    }
    getSiegePower() {
      return calculateSiegePower(this.state.military.siegeWeapons);
    }
    // Military Traditions
    checkMilitaryTraditions() {
      const stats = {
        battlesWon: this.state.statistics.battlesWon,
        territoriesConquered: this.state.statistics.territoriesConquered || 0,
        heroesRecruited: this.state.statistics.heroesRecruited || 0,
        veteranUnits: this.getVeteranUnitCount()
      };
      for (const tradition of MILITARY_TRADITIONS) {
        if (!this.state.military.unlockedTraditions.has(tradition.id)) {
          if (checkTraditionUnlock(tradition, stats)) {
            this.state.military.unlockedTraditions.add(tradition.id);
          }
        }
      }
    }
    getVeteranUnitCount() {
      let count = 0;
      for (const [, expData] of this.state.military.unitExperience) {
        if (expData.level >= 2) {
          count++;
        }
      }
      return count;
    }
    getUnlockedTraditions() {
      return Array.from(this.state.military.unlockedTraditions).map((id) => getTraditionById(id)).filter((t) => t !== void 0);
    }
    getTraditionBonuses() {
      return calculateTraditionBonuses(this.state.military.unlockedTraditions);
    }
    // Espionage
    getAvailableSpyMissions() {
      return getAvailableSpyMissions(this.state.researchedTechs);
    }
    recruitSpy() {
      if (this.state.military.spies.length >= this.state.military.maxSpies)
        return false;
      const spyCost = 500 * (this.state.military.spies.length + 1);
      if (this.state.resources.gold < spyCost)
        return false;
      this.state.resources.gold -= spyCost;
      const spy = {
        id: `spy_${Date.now()}_${Math.random().toString(36).substring(2, 11)}`,
        name: this.generateSpyName(),
        level: 1,
        experience: 0,
        currentMission: null,
        missionEndTime: null
      };
      this.state.military.spies.push(spy);
      this.notifyStateChange();
      return true;
    }
    generateSpyName() {
      const firstNames = ["Alex", "Jordan", "Taylor", "Morgan", "Casey", "Riley", "Quinn", "Avery", "Reese", "Dakota"];
      const lastNames = ["Shadow", "Steele", "Fox", "Wolf", "Storm", "Raven", "Black", "Gray", "Stone", "Cross"];
      return `${firstNames[Math.floor(Math.random() * firstNames.length)]} ${lastNames[Math.floor(Math.random() * lastNames.length)]}`;
    }
    startSpyMission(spyId, missionId) {
      const spy = this.state.military.spies.find((s) => s.id === spyId);
      if (!spy)
        return false;
      if (spy.currentMission)
        return false;
      const mission = getSpyMissionById(missionId);
      if (!mission)
        return false;
      if (!this.state.researchedTechs.has(mission.requiredTech))
        return false;
      if (this.state.resources.gold < mission.cost.gold)
        return false;
      this.state.resources.gold -= mission.cost.gold;
      const now = Date.now();
      spy.currentMission = missionId;
      spy.missionEndTime = now + mission.duration * 1e3;
      this.state.military.activeSpyMissions.push({
        spyId,
        missionId,
        startTime: now,
        endTime: now + mission.duration * 1e3
      });
      this.notifyStateChange();
      return true;
    }
    // Get total military power including all systems
    getTotalMilitaryPower() {
      return calculateTotalMilitaryPower(this.state.army, this.state.military, this.state.researchedTechs);
    }
    // Update military training queues (called from main update loop)
    updateMilitaryQueues(now) {
      const completedDefense = [];
      for (let i = 0; i < this.state.military.defenseConstructionQueue.length; i++) {
        const construction = this.state.military.defenseConstructionQueue[i];
        if (now >= construction.endTime) {
          const existing = this.state.military.defenseBuildings.find((b) => b.typeId === construction.typeId);
          if (existing) {
            existing.count++;
          } else {
            this.state.military.defenseBuildings.push({ typeId: construction.typeId, count: 1 });
          }
          completedDefense.push(i);
        }
      }
      for (let i = completedDefense.length - 1; i >= 0; i--) {
        this.state.military.defenseConstructionQueue.splice(completedDefense[i], 1);
      }
      const completedNaval = [];
      for (let i = 0; i < this.state.military.navalTrainingQueue.length; i++) {
        const training = this.state.military.navalTrainingQueue[i];
        if (now >= training.endTime) {
          const existing = this.state.military.navy.find((n) => n.typeId === training.typeId);
          if (existing) {
            existing.count++;
          } else {
            this.state.military.navy.push({ typeId: training.typeId, count: 1 });
          }
          completedNaval.push(i);
        }
      }
      for (let i = completedNaval.length - 1; i >= 0; i--) {
        this.state.military.navalTrainingQueue.splice(completedNaval[i], 1);
      }
      const completedSiege = [];
      for (let i = 0; i < this.state.military.siegeTrainingQueue.length; i++) {
        const training = this.state.military.siegeTrainingQueue[i];
        if (now >= training.endTime) {
          const existing = this.state.military.siegeWeapons.find((s) => s.typeId === training.typeId);
          if (existing) {
            existing.count++;
          } else {
            this.state.military.siegeWeapons.push({ typeId: training.typeId, count: 1 });
          }
          completedSiege.push(i);
        }
      }
      for (let i = completedSiege.length - 1; i >= 0; i--) {
        this.state.military.siegeTrainingQueue.splice(completedSiege[i], 1);
      }
      const completedSpyMissions = [];
      for (let i = 0; i < this.state.military.activeSpyMissions.length; i++) {
        const activeMission = this.state.military.activeSpyMissions[i];
        if (now >= activeMission.endTime) {
          this.completeSpyMission(activeMission);
          completedSpyMissions.push(i);
        }
      }
      for (let i = completedSpyMissions.length - 1; i >= 0; i--) {
        this.state.military.activeSpyMissions.splice(completedSpyMissions[i], 1);
      }
    }
    completeSpyMission(activeMission) {
      const spy = this.state.military.spies.find((s) => s.id === activeMission.spyId);
      const mission = getSpyMissionById(activeMission.missionId);
      if (!spy || !mission)
        return;
      const successChance = calculateSpySuccessChance(mission, spy);
      const success = Math.random() < successChance;
      if (success) {
        if (mission.effects.type === "steal" && mission.effects.resourceStolen) {
          const resource = mission.effects.resourceStolen.resource;
          this.state.resources[resource] += mission.effects.resourceStolen.amount;
        }
        spy.experience += 50;
        if (spy.experience >= 100 * spy.level) {
          spy.level++;
        }
      }
      spy.currentMission = null;
      spy.missionEndTime = null;
    }
  };

  // dist/ui.js
  var RENDER_DEBOUNCE_MS = 100;
  var INTERACTION_PAUSE_MS = 300;
  var GameUI = class {
    constructor(game) {
      this.currentTab = "resources";
      this.battleAnimationInterval = null;
      this.conquestAnimationInterval = null;
      this.achievementNotificationQueue = [];
      this.isShowingAchievement = false;
      this.renderTimeout = null;
      this.isUserInteracting = false;
      this.lastRenderedTab = "";
      this.tabContentVersions = /* @__PURE__ */ new Map();
      this.battleResultRendered = false;
      this.conquestResultRendered = false;
      this.previousResources = null;
      this.game = game;
      this.game.setOnStateChange(() => this.scheduleRender());
      this.game.setOnAchievementUnlocked((achievement) => this.queueAchievementNotification(achievement));
      this.setupEventListeners();
      this.initThemeToggle();
      this.addTooltips();
    }
    // Debounced render to prevent rapid re-renders from interfering with clicks
    scheduleRender() {
      if (this.isUserInteracting) {
        return;
      }
      if (this.renderTimeout !== null) {
        return;
      }
      this.renderTimeout = window.setTimeout(() => {
        this.renderTimeout = null;
        this.render();
      }, RENDER_DEBOUNCE_MS);
    }
    // Mark interaction start - prevents re-renders during click processing
    startInteraction() {
      this.isUserInteracting = true;
      window.setTimeout(() => {
        this.isUserInteracting = false;
        this.scheduleRender();
      }, INTERACTION_PAUSE_MS);
    }
    setupEventListeners() {
      document.querySelectorAll(".tab-btn").forEach((btn) => {
        btn.addEventListener("click", (e) => {
          const target = e.target;
          const tab = target.dataset.tab;
          if (tab) {
            this.switchTab(tab);
          }
        });
      });
      document.getElementById("gather-food")?.addEventListener("click", () => {
        this.startInteraction();
        this.game.gatherFood();
      });
      document.getElementById("gather-wood")?.addEventListener("click", () => {
        this.startInteraction();
        this.game.gatherWood();
      });
      document.getElementById("gather-stone")?.addEventListener("click", () => {
        this.startInteraction();
        this.game.gatherStone();
      });
      document.getElementById("save-game")?.addEventListener("click", () => this.saveGame());
      document.getElementById("load-game")?.addEventListener("click", () => this.loadGame());
      document.getElementById("reset-game")?.addEventListener("click", () => this.resetGame());
      document.getElementById("buildings-content")?.addEventListener("click", (e) => {
        const target = e.target;
        if (target.classList.contains("build-btn") && !target.hasAttribute("disabled")) {
          const buildingId = target.dataset.building;
          if (buildingId) {
            this.startInteraction();
            this.game.constructBuilding(buildingId);
          }
        }
      });
      document.getElementById("research-tree")?.addEventListener("click", (e) => {
        const target = e.target;
        if (target.classList.contains("research-btn") && !target.hasAttribute("disabled")) {
          const techId = target.dataset.tech;
          if (techId) {
            this.startInteraction();
            this.game.startResearch(techId);
          }
        }
      });
      document.getElementById("barracks-content")?.addEventListener("click", (e) => {
        const target = e.target;
        if (target.classList.contains("train-btn") && !target.hasAttribute("disabled")) {
          const troopId = target.dataset.troop;
          if (troopId) {
            this.startInteraction();
            this.game.trainTroop(troopId);
          }
        }
      });
      document.getElementById("combat-content")?.addEventListener("click", (e) => {
        const target = e.target;
        if (target.classList.contains("mission-btn") && !target.hasAttribute("disabled")) {
          const missionId = target.dataset.mission;
          if (missionId) {
            this.startInteraction();
            this.startMission(missionId);
          }
        }
        if (target.classList.contains("territory-btn") && !target.hasAttribute("disabled")) {
          const territoryId = target.dataset.territory;
          if (territoryId) {
            this.startInteraction();
            this.startConquest(territoryId);
          }
        }
        if (target.id === "toggle-conquest-mode" || target.id === "toggle-missions-mode") {
          this.startInteraction();
          this.game.toggleConquestMode();
        }
        if (target.id === "dismiss-battle") {
          this.startInteraction();
          this.battleResultRendered = false;
          this.game.dismissBattle();
        }
        if (target.id === "dismiss-conquest-battle") {
          this.startInteraction();
          this.conquestResultRendered = false;
          this.game.dismissConquestBattle();
        }
      });
      document.getElementById("combat-content")?.addEventListener("input", (e) => {
        const target = e.target;
        if (target.id === "battle-speed") {
          const speed = parseInt(target.value);
          this.game.setBattleSpeed(speed);
          const speedDisplay = document.getElementById("speed-display");
          if (speedDisplay)
            speedDisplay.textContent = `${speed}ms`;
          if (!this.game.state.activeBattle?.isComplete) {
            this.startBattleAnimation();
          }
          if (!this.game.state.activeConquestBattle?.isComplete) {
            this.startConquestAnimation();
          }
        }
      });
      document.getElementById("skills-content")?.addEventListener("click", (e) => {
        const target = e.target;
        if (target.classList.contains("skill-btn") && !target.hasAttribute("disabled")) {
          const skillId = target.dataset.skill;
          if (skillId) {
            this.startInteraction();
            this.game.upgradeSkill(skillId);
          }
        }
      });
      document.getElementById("world-content")?.addEventListener("click", (e) => {
        const target = e.target;
        if (target.classList.contains("civ-btn") && !target.hasAttribute("disabled")) {
          const civId = target.dataset.civilization;
          if (civId) {
            this.startInteraction();
            this.game.selectCivilization(civId);
          }
        }
        if (target.classList.contains("leader-btn") && !target.hasAttribute("disabled")) {
          const leaderId = target.dataset.leader;
          if (leaderId) {
            this.startInteraction();
            this.game.selectLeader(leaderId);
          }
        }
        if (target.classList.contains("religion-btn") && !target.hasAttribute("disabled")) {
          const religionId = target.dataset.religion;
          if (religionId) {
            this.startInteraction();
            this.game.foundNewReligion(religionId);
          }
        }
        if (target.classList.contains("policy-btn") && !target.hasAttribute("disabled")) {
          const policyId = target.dataset.policy;
          if (policyId) {
            this.startInteraction();
            this.game.adoptCulturalPolicy(policyId);
          }
        }
        if (target.id === "explore-wonder-btn") {
          this.startInteraction();
          const wonder = this.game.discoverNaturalWonder();
          if (wonder) {
            this.showNotification(`Discovered ${wonder.name}!`);
          } else {
            this.showNotification("Nothing discovered this time...");
          }
        }
      });
      document.getElementById("military-content")?.addEventListener("click", (e) => {
        const target = e.target;
        if (target.classList.contains("formation-card") && !target.classList.contains("locked")) {
          const formationId = target.dataset.formation;
          if (formationId) {
            this.startInteraction();
            this.game.setFormation(formationId);
          }
        }
        if (target.classList.contains("hero-btn") && !target.hasAttribute("disabled")) {
          const heroId = target.dataset.hero;
          if (heroId) {
            this.startInteraction();
            if (target.classList.contains("recruit")) {
              this.game.recruitHero(heroId);
            } else if (target.classList.contains("set-active")) {
              this.game.setActiveHero(heroId);
            }
          }
        }
        if (target.classList.contains("build-defense-btn") && !target.hasAttribute("disabled")) {
          const structureId = target.dataset.defense;
          if (structureId) {
            this.startInteraction();
            this.game.buildDefenseStructure(structureId);
          }
        }
        if (target.classList.contains("train-naval-btn") && !target.hasAttribute("disabled")) {
          const unitId = target.dataset.naval;
          if (unitId) {
            this.startInteraction();
            this.game.trainNavalUnit(unitId);
          }
        }
        if (target.classList.contains("train-siege-btn") && !target.hasAttribute("disabled")) {
          const weaponId = target.dataset.siege;
          if (weaponId) {
            this.startInteraction();
            this.game.trainSiegeWeapon(weaponId);
          }
        }
        if (target.classList.contains("upgrade-btn") && !target.hasAttribute("disabled")) {
          const upgradeId = target.dataset.upgrade;
          if (upgradeId) {
            this.startInteraction();
            this.game.upgradeUnit(upgradeId);
          }
        }
        if (target.id === "recruit-spy-btn" && !target.hasAttribute("disabled")) {
          this.startInteraction();
          if (this.game.recruitSpy()) {
            this.showNotification("New spy recruited!");
          }
        }
        if (target.classList.contains("spy-mission-btn") && !target.hasAttribute("disabled")) {
          const spyId = target.dataset.spy;
          const missionId = target.dataset.mission;
          if (spyId && missionId) {
            this.startInteraction();
            if (this.game.startSpyMission(spyId, missionId)) {
              this.showNotification("Spy mission started!");
            }
          }
        }
      });
    }
    // Initialize the theme toggle button
    initThemeToggle() {
      const savedTheme = localStorage.getItem("civGameTheme");
      const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
      const theme = savedTheme || (prefersDark ? "dark" : "light");
      if (theme === "light") {
        document.documentElement.setAttribute("data-theme", "light");
      }
      const toggleContainer = document.createElement("div");
      toggleContainer.className = "theme-toggle-container";
      toggleContainer.innerHTML = `
      <button class="theme-toggle-btn" id="theme-toggle" data-tooltip="Toggle Light/Dark Theme">
        ${theme === "dark" ? "\u2600\uFE0F" : "\u{1F319}"}
      </button>
    `;
      document.body.appendChild(toggleContainer);
      document.getElementById("theme-toggle")?.addEventListener("click", () => {
        this.toggleTheme();
      });
    }
    // Toggle between light and dark themes
    toggleTheme() {
      const currentTheme = document.documentElement.getAttribute("data-theme");
      const newTheme = currentTheme === "light" ? "dark" : "light";
      if (newTheme === "light") {
        document.documentElement.setAttribute("data-theme", "light");
      } else {
        document.documentElement.removeAttribute("data-theme");
      }
      const toggleBtn = document.getElementById("theme-toggle");
      if (toggleBtn) {
        toggleBtn.textContent = newTheme === "dark" ? "\u2600\uFE0F" : "\u{1F319}";
      }
      localStorage.setItem("civGameTheme", newTheme);
      this.showNotification(`${newTheme === "light" ? "\u2600\uFE0F Light" : "\u{1F319} Dark"} theme activated`);
    }
    // Add tooltips to various UI elements
    addTooltips() {
      const resourceTooltips = {
        "food": "Food is used to train troops and sustain your population. Gather food or build farms.",
        "wood": "Wood is essential for construction. Gather wood or build lumber mills.",
        "stone": "Stone is used for advanced buildings and defenses. Mine stone from quarries.",
        "gold": "Gold is the universal currency. Earn gold through trade and mining.",
        "science": "Science points are used to research new technologies. Build libraries and universities."
      };
      document.querySelectorAll(".resource").forEach((resource) => {
        const name = resource.querySelector(".resource-name")?.textContent?.toLowerCase().trim();
        if (name && resourceTooltips[name]) {
          resource.setAttribute("data-tooltip", resourceTooltips[name]);
        }
      });
      const tabTooltips = {
        "resources": "Manually gather resources to boost your civilization",
        "buildings": "Construct buildings that passively generate resources",
        "research": "Research technologies to unlock new abilities and advance eras",
        "barracks": "Train troops to build your army",
        "army": "View your current military strength",
        "combat": "Engage in battles and conquer territories",
        "world": "Choose civilization, leaders, and cultural policies",
        "skills": "Upgrade permanent skills using legacy points",
        "military": "Manage formations, heroes, naval forces, and espionage",
        "achievements": "View your accomplishments and statistics"
      };
      document.querySelectorAll(".tab-btn").forEach((btn) => {
        const tab = btn.dataset.tab;
        if (tab && tabTooltips[tab]) {
          btn.setAttribute("data-tooltip", tabTooltips[tab]);
        }
      });
      document.getElementById("save-game")?.setAttribute("data-tooltip", "Save your game progress to local storage");
      document.getElementById("load-game")?.setAttribute("data-tooltip", "Load a previously saved game");
      document.getElementById("reset-game")?.setAttribute("data-tooltip", "Reset all progress and start fresh (cannot be undone!)");
    }
    switchTab(tab) {
      this.currentTab = tab;
      if (tab !== "combat" && this.battleAnimationInterval) {
        clearInterval(this.battleAnimationInterval);
        this.battleAnimationInterval = null;
      }
      if (tab !== "combat" && this.conquestAnimationInterval) {
        clearInterval(this.conquestAnimationInterval);
        this.conquestAnimationInterval = null;
      }
      document.querySelectorAll(".tab-btn").forEach((btn) => {
        btn.classList.remove("active");
        if (btn.dataset.tab === tab) {
          btn.classList.add("active");
        }
      });
      document.querySelectorAll(".tab-content").forEach((content) => {
        content.classList.remove("active");
      });
      document.getElementById(`${tab}-tab`)?.classList.add("active");
      this.render();
    }
    render() {
      this.renderHeader();
      this.renderResources();
      const tabChanged = this.lastRenderedTab !== this.currentTab;
      this.lastRenderedTab = this.currentTab;
      switch (this.currentTab) {
        case "resources":
          this.renderResourcesTab();
          break;
        case "buildings":
          if (tabChanged) {
            this.renderBuildingsTab();
          } else {
            this.updateBuildingsTab();
          }
          break;
        case "research":
          if (tabChanged) {
            this.renderResearchTab();
          } else {
            this.updateResearchTab();
          }
          break;
        case "barracks":
          if (tabChanged) {
            this.renderBarracksTab();
          } else {
            this.updateBarracksTab();
          }
          break;
        case "army":
          this.renderArmyTab();
          break;
        case "combat":
          if (tabChanged) {
            this.renderCombatTab();
          } else {
            this.updateCombatTab();
          }
          break;
        case "achievements":
          this.renderAchievementsTab();
          break;
        case "skills":
          if (tabChanged) {
            this.renderSkillsTab();
          } else {
            this.updateSkillsTab();
          }
          break;
        case "world":
          if (tabChanged) {
            this.renderWorldTab();
          } else {
            this.updateWorldTab();
          }
          break;
        case "military":
          if (tabChanged) {
            this.renderMilitaryTab();
          } else {
            this.updateMilitaryTab();
          }
          break;
      }
      this.checkOfflineProgress();
      this.processAchievementNotifications();
    }
    renderHeader() {
      const era = getEraById(this.game.state.currentEra);
      const headerEl = document.getElementById("current-era");
      if (headerEl && era) {
        headerEl.textContent = era.name;
      }
      const descEl = document.getElementById("era-description");
      if (descEl && era) {
        descEl.textContent = era.description;
      }
      const eraIndex = ERAS.findIndex((e) => e.id === this.game.state.currentEra);
      const progressEl = document.getElementById("era-progress");
      if (progressEl) {
        progressEl.textContent = `Era ${eraIndex + 1} of ${ERAS.length}`;
      }
    }
    renderResources() {
      const { resources } = this.game.state;
      if (this.previousResources) {
        this.animateResourceGain("food", this.previousResources.food, resources.food);
        this.animateResourceGain("wood", this.previousResources.wood, resources.wood);
        this.animateResourceGain("stone", this.previousResources.stone, resources.stone);
        this.animateResourceGain("gold", this.previousResources.gold, resources.gold);
        this.animateResourceGain("science", this.previousResources.science, resources.science);
      }
      this.previousResources = { ...resources };
      document.getElementById("food-amount").textContent = Math.floor(resources.food).toString();
      document.getElementById("wood-amount").textContent = Math.floor(resources.wood).toString();
      document.getElementById("stone-amount").textContent = Math.floor(resources.stone).toString();
      document.getElementById("gold-amount").textContent = Math.floor(resources.gold).toString();
      document.getElementById("science-amount").textContent = Math.floor(resources.science).toString();
      const era = getEraById(this.game.state.currentEra);
      if (era) {
        const { resourceMultipliers } = this.game.state;
        document.getElementById("food-rate").textContent = `+${(era.resources.food.baseRate * resourceMultipliers.food).toFixed(1)}/s`;
        document.getElementById("wood-rate").textContent = `+${(era.resources.wood.baseRate * resourceMultipliers.wood).toFixed(1)}/s`;
        document.getElementById("stone-rate").textContent = `+${(era.resources.stone.baseRate * resourceMultipliers.stone).toFixed(1)}/s`;
        document.getElementById("gold-rate").textContent = `+${(era.resources.gold.baseRate * resourceMultipliers.gold).toFixed(1)}/s`;
        document.getElementById("science-rate").textContent = `+${(era.resources.science.baseRate * resourceMultipliers.science).toFixed(1)}/s`;
      }
    }
    // Animate resource gain with visual feedback
    animateResourceGain(resourceType, oldValue, newValue) {
      const gain = Math.floor(newValue) - Math.floor(oldValue);
      if (gain >= 1) {
        const amountEl = document.getElementById(`${resourceType}-amount`);
        const resourceEl = amountEl?.closest(".resource");
        if (resourceEl && amountEl) {
          resourceEl.classList.add("gain-animation");
          amountEl.classList.add("gain-animation");
          setTimeout(() => {
            resourceEl.classList.remove("gain-animation");
            amountEl.classList.remove("gain-animation");
          }, 500);
          this.showResourceGainPopup(resourceEl, gain);
        }
      }
    }
    // Show floating resource gain popup
    showResourceGainPopup(resourceEl, gain) {
      const popup = document.createElement("span");
      popup.className = "resource-gain-popup";
      popup.textContent = `+${gain}`;
      resourceEl.style.position = "relative";
      resourceEl.appendChild(popup);
      setTimeout(() => {
        popup.remove();
      }, 1e3);
    }
    renderResourcesTab() {
      const { resourceMultipliers } = this.game.state;
      const foodBtn = document.getElementById("gather-food");
      const woodBtn = document.getElementById("gather-wood");
      const stoneBtn = document.getElementById("gather-stone");
      if (foodBtn) {
        foodBtn.textContent = `\u{1F356} Gather Food (+${resourceMultipliers.food.toFixed(1)})`;
      }
      if (woodBtn) {
        woodBtn.textContent = `\u{1FAB5} Gather Wood (+${resourceMultipliers.wood.toFixed(1)})`;
      }
      if (stoneBtn) {
        stoneBtn.textContent = `\u{1FAA8} Gather Stone (+${resourceMultipliers.stone.toFixed(1)})`;
      }
    }
    renderBuildingsTab() {
      const container = document.getElementById("buildings-content");
      if (!container)
        return;
      let html = "";
      html += "<h3>\u{1F528} Construction Queue</h3>";
      if (this.game.state.constructionQueue.length > 0) {
        html += '<div class="construction-queue">';
        const now = Date.now();
        for (const construction of this.game.state.constructionQueue) {
          const buildingType = getBuildingTypeById(construction.buildingId);
          if (buildingType) {
            const remaining = Math.max(0, (construction.endTime - now) / 1e3);
            const progress = (buildingType.buildTime - remaining) / buildingType.buildTime * 100;
            html += `
            <div class="construction-item">
              <span>${buildingType.name}</span>
              <div class="progress-bar small">
                <div class="progress-fill" style="width: ${progress}%"></div>
              </div>
              <span>${remaining.toFixed(1)}s</span>
            </div>
          `;
          }
        }
        html += "</div>";
      } else {
        html += '<p class="empty-message">No buildings under construction</p>';
      }
      const buildingProduction = this.game.getBuildingProduction();
      const totalBuildings = this.game.getTotalBuildingCount();
      html += `
      <div class="building-overview">
        <h3>\u{1F4CA} Building Production (${totalBuildings} buildings)</h3>
        <div class="production-stats">
          ${buildingProduction.food > 0 ? `<span class="production-stat">\u{1F356} +${buildingProduction.food.toFixed(1)}/s</span>` : ""}
          ${buildingProduction.wood > 0 ? `<span class="production-stat">\u{1FAB5} +${buildingProduction.wood.toFixed(1)}/s</span>` : ""}
          ${buildingProduction.stone > 0 ? `<span class="production-stat">\u{1FAA8} +${buildingProduction.stone.toFixed(1)}/s</span>` : ""}
          ${buildingProduction.gold > 0 ? `<span class="production-stat">\u{1F4B0} +${buildingProduction.gold.toFixed(1)}/s</span>` : ""}
          ${buildingProduction.science > 0 ? `<span class="production-stat">\u{1F52C} +${buildingProduction.science.toFixed(1)}/s</span>` : ""}
          ${totalBuildings === 0 ? '<span class="empty-message">Build your first building to start producing resources!</span>' : ""}
        </div>
      </div>
    `;
      const buildingsByEra = /* @__PURE__ */ new Map();
      for (const era of ERAS) {
        buildingsByEra.set(era.id, []);
      }
      for (const building of BUILDING_TYPES) {
        buildingsByEra.get(building.era)?.push(building);
      }
      html += "<h3>\u{1F3D7}\uFE0F Available Buildings</h3>";
      for (const era of ERAS) {
        const buildings = buildingsByEra.get(era.id) || [];
        if (buildings.length === 0)
          continue;
        const hasUnlockedBuildings = buildings.some((b) => b.unlockTech === null || this.game.state.unlockedBuildings.has(b.id));
        if (!hasUnlockedBuildings)
          continue;
        html += `<div class="era-section">
        <h4>${era.name} Buildings</h4>
        <div class="building-grid">`;
        for (const building of buildings) {
          const isUnlocked = building.unlockTech === null || this.game.state.unlockedBuildings.has(building.id);
          if (!isUnlocked)
            continue;
          const currentCount = this.game.getBuildingCount(building.id);
          const canBuild = this.canBuildBuilding(building);
          const atMax = currentCount >= building.maxCount;
          let statusClass = "locked";
          if (atMax)
            statusClass = "maxed";
          else if (canBuild)
            statusClass = "available";
          html += `
          <div class="building-card ${statusClass}">
            <div class="building-header">
              <h5>${building.name}</h5>
              <span class="building-count">${currentCount}/${building.maxCount}</span>
            </div>
            <p class="building-desc">${building.description}</p>
            <div class="building-production">
              <span class="label">Production:</span>
              ${building.production.food ? `<span>\u{1F356} +${building.production.food}/s</span>` : ""}
              ${building.production.wood ? `<span>\u{1FAB5} +${building.production.wood}/s</span>` : ""}
              ${building.production.stone ? `<span>\u{1FAA8} +${building.production.stone}/s</span>` : ""}
              ${building.production.gold ? `<span>\u{1F4B0} +${building.production.gold}/s</span>` : ""}
              ${building.production.science ? `<span>\u{1F52C} +${building.production.science}/s</span>` : ""}
            </div>
            <div class="building-cost">
              <span class="label">Cost:</span>
              ${building.cost.food > 0 ? `<span>\u{1F356} ${building.cost.food}</span>` : ""}
              ${building.cost.wood > 0 ? `<span>\u{1FAB5} ${building.cost.wood}</span>` : ""}
              ${building.cost.stone > 0 ? `<span>\u{1FAA8} ${building.cost.stone}</span>` : ""}
              ${building.cost.gold > 0 ? `<span>\u{1F4B0} ${building.cost.gold}</span>` : ""}
            </div>
            <p class="build-time">\u23F1\uFE0F ${building.buildTime}s</p>
            <button class="build-btn" data-building="${building.id}" ${!canBuild || atMax ? "disabled" : ""}>
              ${atMax ? "Max Built" : "Build"}
            </button>
          </div>
        `;
        }
        html += "</div></div>";
      }
      container.innerHTML = html;
    }
    canBuildBuilding(building) {
      const { resources } = this.game.state;
      const currentCount = this.game.getBuildingCount(building.id);
      if (currentCount >= building.maxCount)
        return false;
      if (resources.food < building.cost.food)
        return false;
      if (resources.wood < building.cost.wood)
        return false;
      if (resources.stone < building.cost.stone)
        return false;
      if (resources.gold < building.cost.gold)
        return false;
      return true;
    }
    // Update buildings tab without full re-render - only updates dynamic elements
    updateBuildingsTab() {
      const container = document.getElementById("buildings-content");
      if (!container) {
        this.renderBuildingsTab();
        return;
      }
      const currentUnlockedCount = this.game.state.unlockedBuildings.size;
      const currentBuildingCount = this.game.getTotalBuildingCount();
      const currentQueueLength = this.game.state.constructionQueue.length;
      const versionKey = `${currentUnlockedCount}-${currentBuildingCount}-${currentQueueLength}`;
      const lastVersion = this.tabContentVersions.get("buildings");
      if (lastVersion === void 0 || lastVersion.toString() !== versionKey) {
        this.tabContentVersions.set("buildings", versionKey);
        this.renderBuildingsTab();
        return;
      }
      const now = Date.now();
      const constructionItems = container.querySelectorAll(".construction-item");
      constructionItems.forEach((item, index) => {
        const construction = this.game.state.constructionQueue[index];
        if (construction) {
          const buildingType = getBuildingTypeById(construction.buildingId);
          if (buildingType) {
            const remaining = Math.max(0, (construction.endTime - now) / 1e3);
            const progress = (buildingType.buildTime - remaining) / buildingType.buildTime * 100;
            const progressFill = item.querySelector(".progress-fill");
            const timeSpan = item.querySelector("span:last-child");
            if (progressFill)
              progressFill.style.width = `${progress}%`;
            if (timeSpan)
              timeSpan.textContent = `${remaining.toFixed(1)}s`;
          }
        }
      });
      const buildButtons = container.querySelectorAll(".build-btn");
      buildButtons.forEach((btn) => {
        const buildingId = btn.dataset.building;
        if (buildingId) {
          const buildingType = getBuildingTypeById(buildingId);
          if (buildingType) {
            const canBuild = this.canBuildBuilding(buildingType);
            const currentCount = this.game.getBuildingCount(buildingId);
            const atMax = currentCount >= buildingType.maxCount;
            btn.disabled = !canBuild || atMax;
          }
        }
      });
    }
    renderResearchTab() {
      const container = document.getElementById("research-tree");
      if (!container)
        return;
      let html = "";
      if (this.game.state.currentResearch) {
        const tech = getTechById(this.game.state.currentResearch);
        if (tech) {
          const progress = this.game.state.researchProgress / tech.cost.science * 100;
          html += `
          <div class="current-research">
            <h3>Currently Researching: ${tech.name}</h3>
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${Math.min(progress, 100)}%"></div>
            </div>
            <p>${Math.floor(this.game.state.researchProgress)} / ${tech.cost.science} science</p>
          </div>
        `;
        }
      }
      const techsByEra = /* @__PURE__ */ new Map();
      for (const era of ERAS) {
        techsByEra.set(era.id, []);
      }
      for (const tech of TECHNOLOGIES) {
        techsByEra.get(tech.era)?.push(tech);
      }
      for (const era of ERAS) {
        const techs = techsByEra.get(era.id) || [];
        if (techs.length === 0)
          continue;
        html += `<div class="era-section">
        <h3>${era.name} Technologies</h3>
        <div class="tech-grid">`;
        for (const tech of techs) {
          const isResearched = this.game.state.researchedTechs.has(tech.id);
          const hasPrereqs = this.hasPrerequisites(tech);
          const canAfford = this.game.state.resources.science >= tech.cost.science;
          const isAvailable = this.canResearchTech(tech);
          const isCurrent = this.game.state.currentResearch === tech.id;
          const isAnyResearchInProgress = this.game.state.currentResearch !== null;
          let statusClass = "locked";
          if (isResearched)
            statusClass = "researched";
          else if (isCurrent)
            statusClass = "current";
          else if (isAvailable)
            statusClass = "available";
          else if (hasPrereqs)
            statusClass = "unlocked";
          const showButton = hasPrereqs && !isResearched && !isCurrent;
          const buttonDisabled = !canAfford || isAnyResearchInProgress;
          html += `
          <div class="tech-card ${statusClass}" data-tech-id="${tech.id}">
            <h4>${tech.name}</h4>
            <p class="tech-desc">${tech.description}</p>
            <p class="tech-cost">Cost: ${tech.cost.science} science</p>
            ${isResearched ? '<span class="badge">\u2713 Researched</span>' : ""}
            ${showButton ? `<button class="research-btn" data-tech="${tech.id}" ${buttonDisabled ? "disabled" : ""}>Research</button>` : ""}
          </div>
        `;
        }
        html += "</div></div>";
      }
      container.innerHTML = html;
    }
    canResearchTech(tech) {
      if (this.game.state.researchedTechs.has(tech.id))
        return false;
      if (this.game.state.currentResearch)
        return false;
      for (const prereq of tech.prerequisites) {
        if (!this.game.state.researchedTechs.has(prereq))
          return false;
      }
      return this.game.state.resources.science >= tech.cost.science;
    }
    // Check if prerequisites are met (regardless of science or current research)
    hasPrerequisites(tech) {
      for (const prereq of tech.prerequisites) {
        if (!this.game.state.researchedTechs.has(prereq))
          return false;
      }
      return true;
    }
    // Update research tab without full re-render
    updateResearchTab() {
      const container = document.getElementById("research-tree");
      if (!container) {
        this.renderResearchTab();
        return;
      }
      const researchedCount = this.game.state.researchedTechs.size;
      const currentResearch = this.game.state.currentResearch || "";
      const versionKey = `${researchedCount}-${currentResearch}`;
      const lastVersion = this.tabContentVersions.get("research");
      if (lastVersion === void 0 || lastVersion.toString() !== versionKey) {
        this.tabContentVersions.set("research", versionKey);
        this.renderResearchTab();
        return;
      }
      if (this.game.state.currentResearch) {
        const tech = getTechById(this.game.state.currentResearch);
        if (tech) {
          const progress = this.game.state.researchProgress / tech.cost.science * 100;
          const progressFill = container.querySelector(".current-research .progress-fill");
          const progressText = container.querySelector(".current-research p:last-child");
          if (progressFill)
            progressFill.style.width = `${Math.min(progress, 100)}%`;
          if (progressText)
            progressText.textContent = `${Math.floor(this.game.state.researchProgress)} / ${tech.cost.science} science`;
        }
      }
      const researchButtons = container.querySelectorAll(".research-btn");
      researchButtons.forEach((btn) => {
        const techId = btn.dataset.tech;
        if (techId) {
          const tech = getTechById(techId);
          if (tech) {
            const canAfford = this.game.state.resources.science >= tech.cost.science;
            const isAnyResearchInProgress = this.game.state.currentResearch !== null;
            btn.disabled = !canAfford || isAnyResearchInProgress;
          }
        }
      });
    }
    renderBarracksTab() {
      const container = document.getElementById("barracks-content");
      if (!container)
        return;
      let html = "<h3>Training Queue</h3>";
      if (this.game.state.trainingQueue.length > 0) {
        html += '<div class="training-queue">';
        const now = Date.now();
        for (const training of this.game.state.trainingQueue) {
          const troopType = getTroopTypeById(training.troopId);
          if (troopType) {
            const remaining = Math.max(0, (training.endTime - now) / 1e3);
            const progress = (troopType.trainTime - remaining) / troopType.trainTime * 100;
            html += `
            <div class="training-item">
              <span>${troopType.name}</span>
              <div class="progress-bar small">
                <div class="progress-fill" style="width: ${progress}%"></div>
              </div>
              <span>${remaining.toFixed(1)}s</span>
            </div>
          `;
          }
        }
        html += "</div>";
      } else {
        html += '<p class="empty-message">No troops in training</p>';
      }
      html += "<h3>Available Units</h3>";
      const availableTroops = this.game.getAvailableTroops();
      if (availableTroops.length === 0) {
        html += '<p class="empty-message">Research technologies to unlock troops!</p>';
      } else {
        html += '<div class="troop-grid">';
        for (const troop of availableTroops) {
          const canTrain = this.canTrainTroop(troop);
          html += `
          <div class="troop-card ${canTrain ? "available" : "unavailable"}">
            <h4>${troop.name}</h4>
            <p class="troop-desc">${troop.description}</p>
            <div class="troop-stats">
              <span>\u2694\uFE0F ${troop.stats.attack}</span>
              <span>\u{1F6E1}\uFE0F ${troop.stats.defense}</span>
              <span>\u2764\uFE0F ${troop.stats.health}</span>
            </div>
            <div class="troop-cost">
              <span>\u{1F356} ${troop.cost.food}</span>
              <span>\u{1F4B0} ${troop.cost.gold}</span>
              ${troop.cost.wood ? `<span>\u{1FAB5} ${troop.cost.wood}</span>` : ""}
              ${troop.cost.stone ? `<span>\u{1FAA8} ${troop.cost.stone}</span>` : ""}
            </div>
            <p class="train-time">\u23F1\uFE0F ${troop.trainTime}s</p>
            <button class="train-btn" data-troop="${troop.id}" ${!canTrain ? "disabled" : ""}>
              Train
            </button>
          </div>
        `;
        }
        html += "</div>";
      }
      container.innerHTML = html;
    }
    canTrainTroop(troop) {
      const { resources } = this.game.state;
      if (resources.food < troop.cost.food)
        return false;
      if (resources.gold < troop.cost.gold)
        return false;
      if (troop.cost.wood && resources.wood < troop.cost.wood)
        return false;
      if (troop.cost.stone && resources.stone < troop.cost.stone)
        return false;
      return true;
    }
    // Update barracks tab without full re-render
    updateBarracksTab() {
      const container = document.getElementById("barracks-content");
      if (!container) {
        this.renderBarracksTab();
        return;
      }
      const unlockedCount = this.game.state.unlockedTroops.size;
      const queueLength = this.game.state.trainingQueue.length;
      const armyCount = this.game.state.army.reduce((sum, t) => sum + t.count, 0);
      const versionKey = `${unlockedCount}-${queueLength}-${armyCount}`;
      const lastVersion = this.tabContentVersions.get("barracks");
      if (lastVersion === void 0 || lastVersion.toString() !== versionKey) {
        this.tabContentVersions.set("barracks", versionKey);
        this.renderBarracksTab();
        return;
      }
      const now = Date.now();
      const trainingItems = container.querySelectorAll(".training-item");
      trainingItems.forEach((item, index) => {
        const training = this.game.state.trainingQueue[index];
        if (training) {
          const troopType = getTroopTypeById(training.troopId);
          if (troopType) {
            const remaining = Math.max(0, (training.endTime - now) / 1e3);
            const progress = (troopType.trainTime - remaining) / troopType.trainTime * 100;
            const progressFill = item.querySelector(".progress-fill");
            const timeSpan = item.querySelector("span:last-child");
            if (progressFill)
              progressFill.style.width = `${progress}%`;
            if (timeSpan)
              timeSpan.textContent = `${remaining.toFixed(1)}s`;
          }
        }
      });
      const trainButtons = container.querySelectorAll(".train-btn");
      trainButtons.forEach((btn) => {
        const troopId = btn.dataset.troop;
        if (troopId) {
          const troopType = getTroopTypeById(troopId);
          if (troopType) {
            const canTrain = this.canTrainTroop(troopType);
            btn.disabled = !canTrain;
          }
        }
      });
    }
    renderArmyTab() {
      const container = document.getElementById("army-content");
      if (!container)
        return;
      const { army } = this.game.state;
      const power = this.game.getArmyPower();
      let html = `
      <div class="army-overview">
        <h3>Army Power</h3>
        <div class="power-stats">
          <div class="power-stat">
            <span class="power-icon">\u2694\uFE0F</span>
            <span class="power-value">${power.attack}</span>
            <span class="power-label">Attack</span>
          </div>
          <div class="power-stat">
            <span class="power-icon">\u{1F6E1}\uFE0F</span>
            <span class="power-value">${power.defense}</span>
            <span class="power-label">Defense</span>
          </div>
          <div class="power-stat">
            <span class="power-icon">\u2764\uFE0F</span>
            <span class="power-value">${power.health}</span>
            <span class="power-label">Health</span>
          </div>
        </div>
      </div>
    `;
      html += "<h3>Your Troops</h3>";
      if (army.length === 0) {
        html += '<p class="empty-message">No troops recruited yet. Visit the Barracks to train troops!</p>';
      } else {
        html += '<div class="army-grid">';
        for (const troop of army) {
          const troopType = getTroopTypeById(troop.typeId);
          if (troopType) {
            html += `
            <div class="army-unit">
              <h4>${troopType.name}</h4>
              <span class="unit-count">x${troop.count}</span>
              <div class="unit-stats">
                <span>\u2694\uFE0F ${troopType.stats.attack * troop.count}</span>
                <span>\u{1F6E1}\uFE0F ${troopType.stats.defense * troop.count}</span>
                <span>\u2764\uFE0F ${troopType.stats.health * troop.count}</span>
              </div>
            </div>
          `;
          }
        }
        html += "</div>";
      }
      container.innerHTML = html;
    }
    renderCombatTab() {
      const container = document.getElementById("combat-content");
      if (!container)
        return;
      if (this.game.state.activeBattle) {
        this.renderActiveBattle(container);
        return;
      }
      if (this.game.state.activeConquestBattle) {
        this.renderActiveConquestBattle(container);
        return;
      }
      const isConquestMode = this.game.state.conquestMode;
      const playerPower = this.game.getArmyPower();
      let html = `
      <div class="combat-mode-toggle">
        <button class="mode-toggle-btn ${!isConquestMode ? "active" : ""}" id="toggle-missions-mode">
          \u2694\uFE0F Missions
        </button>
        <button class="mode-toggle-btn ${isConquestMode ? "active" : ""}" id="toggle-conquest-mode">
          \u{1F3F0} Conquest
        </button>
      </div>
    `;
      html += `
      <div class="army-power-summary">
        <span>Your Army: \u2694\uFE0F ${playerPower.attack} | \u{1F6E1}\uFE0F ${playerPower.defense} | \u2764\uFE0F ${playerPower.health}</span>
      </div>
    `;
      if (playerPower.health === 0) {
        html += '<div class="warning-message">\u26A0\uFE0F You need troops to start battles! Train some in the Barracks first.</div>';
      }
      if (isConquestMode) {
        html += this.renderConquestMode(playerPower);
      } else {
        html += this.renderMissionsMode(playerPower);
      }
      container.innerHTML = html;
    }
    renderMissionsMode(playerPower) {
      let html = "<h3>\u2694\uFE0F Combat Missions</h3>";
      html += '<p class="combat-intro">Choose a mission to test your army against enemy forces. Missions are organized by era - higher eras have tougher enemies but better rewards! Missions feature armies of varying sizes: Small \u{1F539}, Medium \u{1F538}, Large \u{1F48E}, and Boss \u{1F451}.</p>';
      for (const era of ERAS) {
        const eraMissions = getMissionsByEra(this.game.state.missions, era.id);
        if (eraMissions.length === 0)
          continue;
        const isEraAvailable = isMissionAvailable(eraMissions[0], this.game.state.currentEra);
        html += `
        <div class="mission-era-section ${!isEraAvailable ? "locked" : ""}">
          <h4 class="mission-era-title">${era.name} Missions ${!isEraAvailable ? "\u{1F512}" : ""}</h4>
          <div class="mission-grid">
      `;
        for (const mission of eraMissions) {
          const isAvailable = isMissionAvailable(mission, this.game.state.currentEra);
          const isCompleted = this.game.isMissionCompleted(mission.id);
          const canStart = isAvailable && playerPower.health > 0;
          const difficultyRating = this.getDifficultyRating(playerPower, mission);
          const sizeIndicator = this.getArmySizeIndicator(mission.enemyArmy.size);
          html += `
          <div class="mission-card ${isCompleted ? "completed" : ""} ${!isAvailable ? "locked" : ""}">
            <div class="mission-header">
              <h5>${sizeIndicator} ${mission.name}</h5>
              ${isCompleted ? '<span class="completed-badge">\u2713 Completed</span>' : ""}
            </div>
            <p class="mission-desc">${mission.description}</p>
            <div class="enemy-stats">
              <span class="enemy-label">Enemy: ${mission.enemyArmy.name}</span>
              <div class="enemy-power">
                <span>\u2694\uFE0F ${mission.enemyArmy.attack}</span>
                <span>\u{1F6E1}\uFE0F ${mission.enemyArmy.defense}</span>
                <span>\u2764\uFE0F ${mission.enemyArmy.health}</span>
              </div>
            </div>
            <div class="difficulty-indicator ${difficultyRating.class}">
              Difficulty: ${difficultyRating.label}
            </div>
            <div class="mission-rewards">
              <span class="rewards-label">Rewards:</span>
              <div class="rewards-list">
                ${mission.rewards.food > 0 ? `<span>\u{1F356} ${mission.rewards.food}</span>` : ""}
                ${mission.rewards.wood > 0 ? `<span>\u{1FAB5} ${mission.rewards.wood}</span>` : ""}
                ${mission.rewards.stone > 0 ? `<span>\u{1FAA8} ${mission.rewards.stone}</span>` : ""}
                ${mission.rewards.gold > 0 ? `<span>\u{1F4B0} ${mission.rewards.gold}</span>` : ""}
                ${mission.rewards.science > 0 ? `<span>\u{1F52C} ${mission.rewards.science}</span>` : ""}
              </div>
            </div>
            <button class="mission-btn ${!canStart ? "disabled" : ""}" 
                    data-mission="${mission.id}" 
                    ${!canStart ? "disabled" : ""}>
              ${!isAvailable ? "\u{1F512} Locked" : isCompleted ? "\u2694\uFE0F Replay" : "\u2694\uFE0F Start Mission"}
            </button>
          </div>
        `;
        }
        html += "</div></div>";
      }
      return html;
    }
    renderConquestMode(playerPower) {
      let html = "<h3>\u{1F3F0} Conquest Mode</h3>";
      html += '<p class="combat-intro">Conquer territories to gain permanent bonuses! Each territory provides ongoing resource bonuses once conquered. Territories are organized by era - higher eras have stronger defenders but better rewards!</p>';
      const conquestBonuses = this.game.getConquestBonuses();
      const conquestMultipliers = this.game.getConquestMultipliers();
      const conqueredCount = this.game.getConqueredTerritoryCount();
      const totalCount = this.game.getTotalTerritoryCount();
      html += `
      <div class="conquest-overview">
        <div class="conquest-progress">
          <span>Territories Conquered: ${conqueredCount} / ${totalCount}</span>
          <div class="progress-bar">
            <div class="progress-fill" style="width: ${conqueredCount / totalCount * 100}%"></div>
          </div>
        </div>
        <div class="conquest-bonuses">
          <h4>Active Bonuses:</h4>
          <div class="bonuses-list">
            ${conquestBonuses.food > 0 ? `<span class="bonus-item">\u{1F356} +${conquestBonuses.food.toFixed(1)}/s</span>` : ""}
            ${conquestBonuses.wood > 0 ? `<span class="bonus-item">\u{1FAB5} +${conquestBonuses.wood.toFixed(1)}/s</span>` : ""}
            ${conquestBonuses.stone > 0 ? `<span class="bonus-item">\u{1FAA8} +${conquestBonuses.stone.toFixed(1)}/s</span>` : ""}
            ${conquestBonuses.gold > 0 ? `<span class="bonus-item">\u{1F4B0} +${conquestBonuses.gold.toFixed(1)}/s</span>` : ""}
            ${conquestBonuses.science > 0 ? `<span class="bonus-item">\u{1F52C} +${conquestBonuses.science.toFixed(1)}/s</span>` : ""}
            ${conquestMultipliers.food > 1 ? `<span class="bonus-item multiplier">\u{1F356} \xD7${conquestMultipliers.food.toFixed(2)}</span>` : ""}
            ${conquestMultipliers.wood > 1 ? `<span class="bonus-item multiplier">\u{1FAB5} \xD7${conquestMultipliers.wood.toFixed(2)}</span>` : ""}
            ${conquestMultipliers.stone > 1 ? `<span class="bonus-item multiplier">\u{1FAA8} \xD7${conquestMultipliers.stone.toFixed(2)}</span>` : ""}
            ${conquestMultipliers.gold > 1 ? `<span class="bonus-item multiplier">\u{1F4B0} \xD7${conquestMultipliers.gold.toFixed(2)}</span>` : ""}
            ${conquestMultipliers.science > 1 ? `<span class="bonus-item multiplier">\u{1F52C} \xD7${conquestMultipliers.science.toFixed(2)}</span>` : ""}
            ${conqueredCount === 0 ? '<span class="no-bonuses">No territories conquered yet!</span>' : ""}
          </div>
        </div>
      </div>
    `;
      for (const era of ERAS) {
        const eraTerritories = getTerritoriesByEra(this.game.state.territories, era.id);
        if (eraTerritories.length === 0)
          continue;
        const isEraAvailable = isTerritoryAvailable(eraTerritories[0], this.game.state.currentEra);
        html += `
        <div class="territory-era-section ${!isEraAvailable ? "locked" : ""}">
          <h4 class="territory-era-title">${era.name} Territories ${!isEraAvailable ? "\u{1F512}" : ""}</h4>
          <div class="territory-grid">
      `;
        for (const territory of eraTerritories) {
          const isAvailable = isTerritoryAvailable(territory, this.game.state.currentEra);
          const isConquered = this.game.isTerritoryConquered(territory.id);
          const canStart = isAvailable && playerPower.health > 0 && !isConquered;
          const territoryAsMission = { enemyArmy: territory.enemyArmy };
          const difficultyRating = this.getDifficultyRating(playerPower, territoryAsMission);
          const sizeIndicator = this.getArmySizeIndicator(territory.enemyArmy.size);
          let bonusText = "";
          if (territory.bonuses.flatBonus) {
            bonusText = `+${territory.bonuses.flatBonus.amount} ${this.getResourceEmoji(territory.bonuses.flatBonus.resource)}/s`;
          } else if (territory.bonuses.resourceMultiplier) {
            bonusText = `\xD7${territory.bonuses.resourceMultiplier.multiplier.toFixed(2)} ${this.getResourceEmoji(territory.bonuses.resourceMultiplier.resource)}`;
          }
          html += `
          <div class="territory-card ${isConquered ? "conquered" : ""} ${!isAvailable ? "locked" : ""}">
            <div class="territory-header">
              <h5>${sizeIndicator} ${territory.name}</h5>
              ${isConquered ? '<span class="conquered-badge">\u{1F3F4} Conquered</span>' : ""}
            </div>
            <p class="territory-desc">${territory.description}</p>
            <div class="territory-bonus">
              <span class="bonus-label">Permanent Bonus:</span>
              <span class="bonus-value">${bonusText}</span>
            </div>
            <div class="enemy-stats">
              <span class="enemy-label">Defenders: ${territory.enemyArmy.name}</span>
              <div class="enemy-power">
                <span>\u2694\uFE0F ${territory.enemyArmy.attack}</span>
                <span>\u{1F6E1}\uFE0F ${territory.enemyArmy.defense}</span>
                <span>\u2764\uFE0F ${territory.enemyArmy.health}</span>
              </div>
            </div>
            <div class="difficulty-indicator ${difficultyRating.class}">
              Difficulty: ${difficultyRating.label}
            </div>
            <div class="territory-rewards">
              <span class="rewards-label">One-time Rewards:</span>
              <div class="rewards-list">
                ${territory.rewards.food > 0 ? `<span>\u{1F356} ${territory.rewards.food}</span>` : ""}
                ${territory.rewards.wood > 0 ? `<span>\u{1FAB5} ${territory.rewards.wood}</span>` : ""}
                ${territory.rewards.stone > 0 ? `<span>\u{1FAA8} ${territory.rewards.stone}</span>` : ""}
                ${territory.rewards.gold > 0 ? `<span>\u{1F4B0} ${territory.rewards.gold}</span>` : ""}
                ${territory.rewards.science > 0 ? `<span>\u{1F52C} ${territory.rewards.science}</span>` : ""}
              </div>
            </div>
            <button class="territory-btn ${!canStart ? "disabled" : ""}" 
                    data-territory="${territory.id}" 
                    ${!canStart ? "disabled" : ""}>
              ${!isAvailable ? "\u{1F512} Locked" : isConquered ? "\u{1F3F4} Conquered" : "\u2694\uFE0F Attack Territory"}
            </button>
          </div>
        `;
        }
        html += "</div></div>";
      }
      return html;
    }
    getArmySizeIndicator(size) {
      switch (size) {
        case "small":
          return "\u{1F539}";
        case "medium":
          return "\u{1F538}";
        case "large":
          return "\u{1F48E}";
        case "boss":
          return "\u{1F451}";
        default:
          return "\u{1F538}";
      }
    }
    getResourceEmoji(resource) {
      switch (resource) {
        case "food":
          return "\u{1F356}";
        case "wood":
          return "\u{1FAB5}";
        case "stone":
          return "\u{1FAA8}";
        case "gold":
          return "\u{1F4B0}";
        case "science":
          return "\u{1F52C}";
        default:
          return "\u{1F4E6}";
      }
    }
    renderActiveConquestBattle(container) {
      const battle = this.game.state.activeConquestBattle;
      if (!battle)
        return;
      if (battle.isComplete && this.conquestResultRendered) {
        return;
      }
      const territory = getTerritoryById(this.game.state.territories, battle.missionId);
      if (!territory)
        return;
      const currentLog = battle.logs[battle.currentRound - 1];
      const playerHealth = currentLog ? currentLog.playerHealth : battle.playerStartHealth;
      const enemyHealth = currentLog ? currentLog.enemyHealth : battle.enemyStartHealth;
      const playerHealthPercent = playerHealth / battle.playerStartHealth * 100;
      const enemyHealthPercent = enemyHealth / battle.enemyStartHealth * 100;
      const playerTroops = this.game.state.army;
      const playerTroopDisplay = this.generateBattlefieldTroops(playerTroops, "player", playerHealthPercent);
      const enemyTroopDisplay = this.generateEnemyTroops(territory.enemyArmy.size, enemyHealthPercent);
      let html = `
      <div class="battle-arena conquest-battle">
        <h3 class="battle-title">\u{1F3F0} Conquest: ${territory.name}</h3>
        <p class="battle-vs">Your Army vs ${territory.enemyArmy.name}</p>
        
        <!-- Animated Battlefield -->
        <div class="battlefield-container" id="battlefield">
          <div class="battlefield-center-line"></div>
          
          <!-- Labels -->
          <div class="battlefield-label player-label">Your Army</div>
          <div class="battlefield-label enemy-label">${territory.enemyArmy.name}</div>
          
          <!-- Round indicator -->
          <div class="battlefield-round">
            Round ${battle.currentRound} / ${battle.logs.length}
          </div>
          
          <!-- Troops -->
          <div class="battlefield-troops" id="battlefield-troops">
            ${playerTroopDisplay}
            ${enemyTroopDisplay}
          </div>
          
          <!-- Health bars on battlefield -->
          <div class="battlefield-health player-health-bar">
            <div class="battlefield-health-fill player" style="width: ${playerHealthPercent}%"></div>
            <span class="battlefield-health-text">${Math.max(0, Math.floor(playerHealth))} / ${battle.playerStartHealth}</span>
          </div>
          <div class="battlefield-health enemy-health-bar">
            <div class="battlefield-health-fill enemy" style="width: ${enemyHealthPercent}%"></div>
            <span class="battlefield-health-text">${Math.max(0, Math.floor(enemyHealth))} / ${battle.enemyStartHealth}</span>
          </div>
          
          ${battle.isComplete && battle.result ? `
            <div class="battlefield-result-overlay ${battle.result.victory ? "victory" : "defeat"}">
              <div class="battlefield-result-text">${battle.result.victory ? "\u{1F3F0} CONQUERED!" : "\u{1F480} DEFEAT!"}</div>
            </div>
          ` : ""}
        </div>
        
        <!-- Compact Battle Log -->
        <div class="battle-log-container">
          <h4>\u{1F4DC} Battle Log</h4>
          <div class="battle-log-compact" id="conquest-battle-log">
    `;
      for (let i = 0; i < battle.currentRound; i++) {
        const log = battle.logs[i];
        html += `
        <span class="log-chip player-attack">R${log.round}: \u2694\uFE0F ${log.playerDamage}</span>
        <span class="log-chip enemy-attack">R${log.round}: \u{1F4A5} ${log.enemyDamage}</span>
      `;
      }
      html += `
          </div>
        </div>
    `;
      if (battle.isComplete && battle.result) {
        const result = battle.result;
        let bonusText = "";
        if (territory.bonuses.flatBonus) {
          bonusText = `+${territory.bonuses.flatBonus.amount} ${this.getResourceEmoji(territory.bonuses.flatBonus.resource)}/s`;
        } else if (territory.bonuses.resourceMultiplier) {
          bonusText = `\xD7${territory.bonuses.resourceMultiplier.multiplier.toFixed(2)} ${this.getResourceEmoji(territory.bonuses.resourceMultiplier.resource)}`;
        }
        html += `
        <div class="battle-result ${result.victory ? "victory" : "defeat"}">
          <h3>${result.victory ? "\u{1F389} Territory Conquered!" : "\u{1F480} Conquest Failed!"}</h3>
          <p class="casualty-report">Casualties: ${result.casualtyPercent}% of your army</p>
          ${result.victory ? `
            <div class="conquest-reward">
              <h4>Territory Bonus Unlocked:</h4>
              <span class="bonus-unlocked">${bonusText}</span>
            </div>
            <div class="battle-rewards">
              <h4>Rewards Earned:</h4>
              <div class="rewards-list">
                ${result.rewards && result.rewards.food > 0 ? `<span>\u{1F356} +${result.rewards.food}</span>` : ""}
                ${result.rewards && result.rewards.wood > 0 ? `<span>\u{1FAB5} +${result.rewards.wood}</span>` : ""}
                ${result.rewards && result.rewards.stone > 0 ? `<span>\u{1FAA8} +${result.rewards.stone}</span>` : ""}
                ${result.rewards && result.rewards.gold > 0 ? `<span>\u{1F4B0} +${result.rewards.gold}</span>` : ""}
                ${result.rewards && result.rewards.science > 0 ? `<span>\u{1F52C} +${result.rewards.science}</span>` : ""}
              </div>
            </div>
          ` : ""}
          <button class="dismiss-battle-btn" id="dismiss-conquest-battle">Return to Conquest</button>
        </div>
      `;
      }
      html += `
      <div class="battle-controls">
        <label>Battle Speed:</label>
        <input type="range" id="battle-speed" min="100" max="2000" step="100" 
               value="${this.game.state.battleAnimationSpeed}">
        <span id="speed-display">${this.game.state.battleAnimationSpeed}ms</span>
      </div>
    `;
      html += "</div>";
      container.innerHTML = html;
      const battleLog = document.getElementById("conquest-battle-log");
      if (battleLog) {
        battleLog.scrollTop = battleLog.scrollHeight;
      }
      if (!battle.isComplete && currentLog) {
        this.triggerBattleAnimations(currentLog.playerDamage, currentLog.enemyDamage);
      }
      if (battle.isComplete) {
        this.conquestResultRendered = true;
      }
    }
    getDifficultyRating(playerPower, mission) {
      const playerTotal = playerPower.attack + playerPower.defense + playerPower.health;
      const enemyTotal = mission.enemyArmy.attack + mission.enemyArmy.defense + mission.enemyArmy.health;
      if (playerTotal === 0)
        return { label: "Impossible", class: "difficulty-impossible" };
      const ratio = playerTotal / enemyTotal;
      if (ratio >= 2)
        return { label: "Very Easy", class: "difficulty-very-easy" };
      if (ratio >= 1.5)
        return { label: "Easy", class: "difficulty-easy" };
      if (ratio >= 1)
        return { label: "Medium", class: "difficulty-medium" };
      if (ratio >= 0.7)
        return { label: "Hard", class: "difficulty-hard" };
      if (ratio >= 0.4)
        return { label: "Very Hard", class: "difficulty-very-hard" };
      return { label: "Extreme", class: "difficulty-extreme" };
    }
    // Update combat tab without full re-render
    updateCombatTab() {
      const container = document.getElementById("combat-content");
      if (!container) {
        this.renderCombatTab();
        return;
      }
      if (this.game.state.activeBattle) {
        this.renderActiveBattle(container);
        return;
      }
      if (this.game.state.activeConquestBattle) {
        this.renderActiveConquestBattle(container);
        return;
      }
      const completedCount = this.game.state.completedMissions.size;
      const conqueredCount = this.game.state.conqueredTerritories.size;
      const armyHealth = this.game.getArmyPower().health;
      const isConquestMode = this.game.state.conquestMode;
      const versionKey = `${completedCount}-${conqueredCount}-${armyHealth}-${isConquestMode}`;
      const lastVersion = this.tabContentVersions.get("combat");
      if (lastVersion === void 0 || lastVersion.toString() !== versionKey) {
        this.tabContentVersions.set("combat", versionKey);
        this.renderCombatTab();
        return;
      }
      const playerPower = this.game.getArmyPower();
      const missionButtons = container.querySelectorAll(".mission-btn");
      missionButtons.forEach((btn) => {
        const missionId = btn.dataset.mission;
        if (missionId) {
          const mission = getMissionById(this.game.state.missions, missionId);
          if (mission) {
            const isAvailable = isMissionAvailable(mission, this.game.state.currentEra);
            const canStart = isAvailable && playerPower.health > 0;
            btn.disabled = !canStart;
          }
        }
      });
      const territoryButtons = container.querySelectorAll(".territory-btn");
      territoryButtons.forEach((btn) => {
        const territoryId = btn.dataset.territory;
        if (territoryId) {
          const territory = getTerritoryById(this.game.state.territories, territoryId);
          if (territory) {
            const isAvailable = isTerritoryAvailable(territory, this.game.state.currentEra);
            const isConquered = this.game.isTerritoryConquered(territory.id);
            const canStart = isAvailable && playerPower.health > 0 && !isConquered;
            btn.disabled = !canStart;
          }
        }
      });
    }
    startMission(missionId) {
      if (this.game.startMission(missionId)) {
        this.battleResultRendered = false;
        this.startBattleAnimation();
      }
    }
    startConquest(territoryId) {
      if (this.game.startConquest(territoryId)) {
        this.conquestResultRendered = false;
        this.startConquestAnimation();
      }
    }
    startConquestAnimation() {
      if (this.conquestAnimationInterval) {
        clearInterval(this.conquestAnimationInterval);
      }
      this.conquestAnimationInterval = window.setInterval(() => {
        if (!this.game.state.activeConquestBattle || this.game.state.activeConquestBattle.isComplete) {
          if (this.conquestAnimationInterval) {
            clearInterval(this.conquestAnimationInterval);
            this.conquestAnimationInterval = null;
          }
          return;
        }
        this.game.advanceConquestRound();
      }, this.game.state.battleAnimationSpeed);
    }
    startBattleAnimation() {
      if (this.battleAnimationInterval) {
        clearInterval(this.battleAnimationInterval);
      }
      this.battleAnimationInterval = window.setInterval(() => {
        if (!this.game.state.activeBattle || this.game.state.activeBattle.isComplete) {
          if (this.battleAnimationInterval) {
            clearInterval(this.battleAnimationInterval);
            this.battleAnimationInterval = null;
          }
          return;
        }
        this.game.advanceBattleRound();
      }, this.game.state.battleAnimationSpeed);
    }
    renderActiveBattle(container) {
      const battle = this.game.state.activeBattle;
      if (!battle)
        return;
      if (battle.isComplete && this.battleResultRendered) {
        return;
      }
      const mission = getMissionById(this.game.state.missions, battle.missionId);
      if (!mission)
        return;
      const currentLog = battle.logs[battle.currentRound - 1];
      const playerHealth = currentLog ? currentLog.playerHealth : battle.playerStartHealth;
      const enemyHealth = currentLog ? currentLog.enemyHealth : battle.enemyStartHealth;
      const playerHealthPercent = playerHealth / battle.playerStartHealth * 100;
      const enemyHealthPercent = enemyHealth / battle.enemyStartHealth * 100;
      const playerTroops = this.game.state.army;
      const playerTroopDisplay = this.generateBattlefieldTroops(playerTroops, "player", playerHealthPercent);
      const enemyTroopDisplay = this.generateEnemyTroops(mission.enemyArmy.size, enemyHealthPercent);
      let html = `
      <div class="battle-arena">
        <h3 class="battle-title">\u2694\uFE0F Battle: ${mission.name}</h3>
        <p class="battle-vs">Your Army vs ${mission.enemyArmy.name}</p>
        
        <!-- Animated Battlefield -->
        <div class="battlefield-container" id="battlefield">
          <div class="battlefield-center-line"></div>
          
          <!-- Labels -->
          <div class="battlefield-label player-label">Your Army</div>
          <div class="battlefield-label enemy-label">${mission.enemyArmy.name}</div>
          
          <!-- Round indicator -->
          <div class="battlefield-round">
            Round ${battle.currentRound} / ${battle.logs.length}
          </div>
          
          <!-- Troops -->
          <div class="battlefield-troops" id="battlefield-troops">
            ${playerTroopDisplay}
            ${enemyTroopDisplay}
          </div>
          
          <!-- Health bars on battlefield -->
          <div class="battlefield-health player-health-bar">
            <div class="battlefield-health-fill player" style="width: ${playerHealthPercent}%"></div>
            <span class="battlefield-health-text">${Math.max(0, Math.floor(playerHealth))} / ${battle.playerStartHealth}</span>
          </div>
          <div class="battlefield-health enemy-health-bar">
            <div class="battlefield-health-fill enemy" style="width: ${enemyHealthPercent}%"></div>
            <span class="battlefield-health-text">${Math.max(0, Math.floor(enemyHealth))} / ${battle.enemyStartHealth}</span>
          </div>
          
          ${battle.isComplete && battle.result ? `
            <div class="battlefield-result-overlay ${battle.result.victory ? "victory" : "defeat"}">
              <div class="battlefield-result-text">${battle.result.victory ? "\u{1F389} VICTORY!" : "\u{1F480} DEFEAT!"}</div>
            </div>
          ` : ""}
        </div>
        
        <!-- Compact Battle Log -->
        <div class="battle-log-container">
          <h4>\u{1F4DC} Battle Log</h4>
          <div class="battle-log-compact" id="battle-log">
    `;
      for (let i = 0; i < battle.currentRound; i++) {
        const log = battle.logs[i];
        html += `
        <span class="log-chip player-attack">R${log.round}: \u2694\uFE0F ${log.playerDamage}</span>
        <span class="log-chip enemy-attack">R${log.round}: \u{1F4A5} ${log.enemyDamage}</span>
      `;
      }
      html += `
          </div>
        </div>
    `;
      if (battle.isComplete && battle.result) {
        const result = battle.result;
        html += `
        <div class="battle-result ${result.victory ? "victory" : "defeat"}">
          <h3>${result.victory ? "\u{1F389} Victory!" : "\u{1F480} Defeat!"}</h3>
          <p class="casualty-report">Casualties: ${result.casualtyPercent}% of your army</p>
          ${result.victory && result.rewards ? `
            <div class="battle-rewards">
              <h4>Rewards Earned:</h4>
              <div class="rewards-list">
                ${result.rewards.food > 0 ? `<span>\u{1F356} +${result.rewards.food}</span>` : ""}
                ${result.rewards.wood > 0 ? `<span>\u{1FAB5} +${result.rewards.wood}</span>` : ""}
                ${result.rewards.stone > 0 ? `<span>\u{1FAA8} +${result.rewards.stone}</span>` : ""}
                ${result.rewards.gold > 0 ? `<span>\u{1F4B0} +${result.rewards.gold}</span>` : ""}
                ${result.rewards.science > 0 ? `<span>\u{1F52C} +${result.rewards.science}</span>` : ""}
              </div>
            </div>
          ` : ""}
          <button class="dismiss-battle-btn" id="dismiss-battle">Return to Missions</button>
        </div>
      `;
      }
      html += `
      <div class="battle-controls">
        <label>Battle Speed:</label>
        <input type="range" id="battle-speed" min="100" max="2000" step="100" 
               value="${this.game.state.battleAnimationSpeed}">
        <span id="speed-display">${this.game.state.battleAnimationSpeed}ms</span>
      </div>
    `;
      html += "</div>";
      container.innerHTML = html;
      const battleLog = document.getElementById("battle-log");
      if (battleLog) {
        battleLog.scrollTop = battleLog.scrollHeight;
      }
      if (!battle.isComplete && currentLog) {
        this.triggerBattleAnimations(currentLog.playerDamage, currentLog.enemyDamage);
      }
      if (battle.isComplete) {
        this.battleResultRendered = true;
      }
    }
    // Generate troop icons for battlefield visualization
    generateBattlefieldTroops(troops, side, healthPercent) {
      let html = "";
      const maxTroopsToShow = 8;
      let troopIndex = 0;
      const troopDisplay = [];
      for (const troop of troops) {
        const troopType = getTroopTypeById(troop.typeId);
        if (troopType && troop.count > 0) {
          troopDisplay.push({
            icon: troopType.icon || "\u2694\uFE0F",
            count: troop.count,
            troopClass: troopType.troopClass || "infantry"
          });
        }
      }
      const troopsToShow = troopDisplay.slice(0, maxTroopsToShow);
      const rows = 3;
      const cols = Math.ceil(troopsToShow.length / rows);
      troopsToShow.forEach((troop, idx) => {
        const row = Math.floor(idx / cols);
        const col = idx % cols;
        const baseX = side === "player" ? 5 : 55;
        const xOffset = col * 12;
        const yPos = 20 + row * 25;
        const xPos = side === "player" ? baseX + xOffset : baseX + (cols - col - 1) * 12;
        const opacity = healthPercent > 30 ? 1 : healthPercent / 30;
        html += `
        <div class="troop-unit ${side}-troop ${troop.troopClass}" 
             style="left: ${xPos}%; top: ${yPos}%; opacity: ${opacity}"
             data-troop-index="${idx}"
             data-side="${side}">
          <span class="troop-icon">${troop.icon}</span>
          <span class="troop-count">\xD7${troop.count}</span>
        </div>
      `;
      });
      if (troopsToShow.length === 0 && side === "player") {
        html += `
        <div class="troop-unit ${side}-troop infantry" style="left: 15%; top: 40%;">
          <span class="troop-icon">\u{1F3F0}</span>
          <span class="troop-count">\xD70</span>
        </div>
      `;
      }
      return html;
    }
    // Generate enemy troop icons based on army size
    generateEnemyTroops(size, healthPercent) {
      const enemyConfigs = {
        "small": [
          { icon: "\u{1F479}", count: 5, troopClass: "infantry" },
          { icon: "\u{1F3F9}", count: 3, troopClass: "ranged" }
        ],
        "medium": [
          { icon: "\u{1F479}", count: 10, troopClass: "infantry" },
          { icon: "\u{1F3F9}", count: 5, troopClass: "ranged" },
          { icon: "\u{1F40E}", count: 3, troopClass: "cavalry" }
        ],
        "large": [
          { icon: "\u{1F479}", count: 20, troopClass: "infantry" },
          { icon: "\u{1F3F9}", count: 10, troopClass: "ranged" },
          { icon: "\u{1F40E}", count: 8, troopClass: "cavalry" },
          { icon: "\u{1F4A3}", count: 5, troopClass: "siege" }
        ],
        "boss": [
          { icon: "\u{1F451}", count: 1, troopClass: "special" },
          { icon: "\u{1F480}", count: 15, troopClass: "infantry" },
          { icon: "\u{1F3F9}", count: 10, troopClass: "ranged" },
          { icon: "\u{1F409}", count: 3, troopClass: "cavalry" },
          { icon: "\u26A1", count: 5, troopClass: "siege" }
        ]
      };
      const config = enemyConfigs[size || "medium"] || enemyConfigs["medium"];
      let html = "";
      const rows = 3;
      const cols = Math.ceil(config.length / rows);
      config.forEach((troop, idx) => {
        const row = Math.floor(idx / cols);
        const col = idx % cols;
        const baseX = 55;
        const xOffset = (cols - col - 1) * 12;
        const yPos = 20 + row * 25;
        const xPos = baseX + xOffset;
        const opacity = healthPercent > 30 ? 1 : healthPercent / 30;
        html += `
        <div class="troop-unit enemy-troop ${troop.troopClass}" 
             style="left: ${xPos}%; top: ${yPos}%; opacity: ${opacity}"
             data-troop-index="${idx}"
             data-side="enemy">
          <span class="troop-icon">${troop.icon}</span>
          <span class="troop-count">\xD7${troop.count}</span>
        </div>
      `;
      });
      return html;
    }
    // Trigger attack animations and damage popups
    triggerBattleAnimations(playerDamage, enemyDamage) {
      const battlefield = document.getElementById("battlefield-troops");
      if (!battlefield)
        return;
      const playerTroops = battlefield.querySelectorAll(".player-troop");
      const enemyTroops = battlefield.querySelectorAll(".enemy-troop");
      if (playerTroops.length > 0) {
        const randomPlayer = playerTroops[Math.floor(Math.random() * playerTroops.length)];
        randomPlayer.classList.add("attacking");
        setTimeout(() => randomPlayer.classList.remove("attacking"), 400);
        if (enemyTroops.length > 0) {
          const targetEnemy = enemyTroops[Math.floor(Math.random() * enemyTroops.length)];
          targetEnemy.classList.add("hit");
          setTimeout(() => targetEnemy.classList.remove("hit"), 300);
          this.showDamagePopup(targetEnemy, playerDamage, "player-damage");
        }
      }
      setTimeout(() => {
        if (enemyTroops.length > 0) {
          const randomEnemy = enemyTroops[Math.floor(Math.random() * enemyTroops.length)];
          randomEnemy.classList.add("attacking");
          setTimeout(() => randomEnemy.classList.remove("attacking"), 400);
          if (playerTroops.length > 0) {
            const targetPlayer = playerTroops[Math.floor(Math.random() * playerTroops.length)];
            targetPlayer.classList.add("hit");
            setTimeout(() => targetPlayer.classList.remove("hit"), 300);
            this.showDamagePopup(targetPlayer, enemyDamage, "enemy-damage");
          }
        }
      }, 200);
    }
    // Show floating damage popup
    showDamagePopup(element, damage, className) {
      const popup = document.createElement("div");
      popup.className = `damage-popup ${className}`;
      popup.textContent = `-${damage}`;
      const rect = element.getBoundingClientRect();
      const battlefield = document.getElementById("battlefield");
      if (battlefield) {
        const battlefieldRect = battlefield.getBoundingClientRect();
        popup.style.left = `${rect.left - battlefieldRect.left + rect.width / 2}px`;
        popup.style.top = `${rect.top - battlefieldRect.top}px`;
        battlefield.appendChild(popup);
        setTimeout(() => popup.remove(), 1e3);
      }
    }
    saveGame() {
      const saveString = this.game.saveGame();
      localStorage.setItem("civGameSave", saveString);
      this.showNotification("Game saved!");
    }
    loadGame() {
      const saveString = localStorage.getItem("civGameSave");
      if (saveString && this.game.loadGame(saveString)) {
        this.showNotification("Game loaded!");
      } else {
        this.showNotification("No save found!");
      }
    }
    resetGame() {
      if (confirm("Are you sure you want to reset? All progress will be lost!")) {
        this.game.resetGame();
        localStorage.removeItem("civGameSave");
        this.showNotification("Game reset!");
      }
    }
    showNotification(message) {
      const notification = document.createElement("div");
      notification.className = "notification";
      notification.textContent = message;
      document.body.appendChild(notification);
      setTimeout(() => {
        notification.classList.add("fade-out");
        setTimeout(() => notification.remove(), 500);
      }, 2e3);
    }
    // Achievements tab
    renderAchievementsTab() {
      const container = document.getElementById("achievements-content");
      if (!container)
        return;
      let html = "";
      html += this.renderStatisticsSection();
      const categories = [
        { id: "progress", name: "Era Progress", icon: "\u{1F3DB}\uFE0F" },
        { id: "resources", name: "Resource Gathering", icon: "\u{1F4E6}" },
        { id: "buildings", name: "Buildings", icon: "\u{1F3D7}\uFE0F" },
        { id: "research", name: "Research", icon: "\u{1F52C}" },
        { id: "military", name: "Military", icon: "\u2694\uFE0F" },
        { id: "combat", name: "Combat", icon: "\u{1F3AF}" }
      ];
      html += "<h3>\u{1F3C6} Achievements</h3>";
      const unlockedCount = this.game.getUnlockedAchievements().length;
      const totalCount = ACHIEVEMENTS.length;
      html += `<div class="achievement-progress-bar">
      <div class="achievement-progress-fill" style="width: ${unlockedCount / totalCount * 100}%"></div>
      <span class="achievement-progress-text">${unlockedCount} / ${totalCount} Unlocked</span>
    </div>`;
      for (const category of categories) {
        const categoryAchievements = getAchievementsByCategory(category.id);
        const unlockedInCategory = categoryAchievements.filter((a) => {
          const progress = this.game.getAchievementProgress(a.id);
          return progress && progress.unlocked;
        }).length;
        html += `
        <div class="achievement-category">
          <h4>${category.icon} ${category.name} (${unlockedInCategory}/${categoryAchievements.length})</h4>
          <div class="achievement-grid">
      `;
        for (const achievement of categoryAchievements) {
          const progress = this.game.getAchievementProgress(achievement.id);
          const isUnlocked = progress && progress.unlocked;
          html += `
          <div class="achievement-card ${isUnlocked ? "unlocked" : "locked"}">
            <div class="achievement-icon">${achievement.icon}</div>
            <div class="achievement-info">
              <h5>${achievement.name}</h5>
              <p>${achievement.description}</p>
              ${achievement.reward ? `<span class="achievement-reward">Reward: ${achievement.reward.resource ? achievement.reward.resource + " " : ""}\xD7${achievement.reward.amount}</span>` : ""}
            </div>
            ${isUnlocked ? '<span class="achievement-badge">\u2713</span>' : ""}
          </div>
        `;
        }
        html += "</div></div>";
      }
      container.innerHTML = html;
    }
    renderStatisticsSection() {
      const stats = this.game.state.statistics;
      const formatNumber = (n) => Math.floor(n).toLocaleString();
      const formatTime = (seconds) => {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor(seconds % 3600 / 60);
        const secs = Math.floor(seconds % 60);
        if (hours > 0)
          return `${hours}h ${minutes}m ${secs}s`;
        if (minutes > 0)
          return `${minutes}m ${secs}s`;
        return `${secs}s`;
      };
      return `
      <div class="statistics-section">
        <h3>\u{1F4CA} Statistics</h3>
        <div class="stats-grid">
          <div class="stat-card">
            <span class="stat-icon">\u{1F356}</span>
            <span class="stat-value">${formatNumber(stats.totalFoodGathered)}</span>
            <span class="stat-label">Total Food</span>
          </div>
          <div class="stat-card">
            <span class="stat-icon">\u{1FAB5}</span>
            <span class="stat-value">${formatNumber(stats.totalWoodGathered)}</span>
            <span class="stat-label">Total Wood</span>
          </div>
          <div class="stat-card">
            <span class="stat-icon">\u{1FAA8}</span>
            <span class="stat-value">${formatNumber(stats.totalStoneGathered)}</span>
            <span class="stat-label">Total Stone</span>
          </div>
          <div class="stat-card">
            <span class="stat-icon">\u{1F4B0}</span>
            <span class="stat-value">${formatNumber(stats.totalGoldEarned)}</span>
            <span class="stat-label">Total Gold</span>
          </div>
          <div class="stat-card">
            <span class="stat-icon">\u{1F52C}</span>
            <span class="stat-value">${formatNumber(stats.totalScienceGenerated)}</span>
            <span class="stat-label">Total Science</span>
          </div>
          <div class="stat-card">
            <span class="stat-icon">\u{1F446}</span>
            <span class="stat-value">${formatNumber(stats.clickCount)}</span>
            <span class="stat-label">Clicks</span>
          </div>
          <div class="stat-card">
            <span class="stat-icon">\u{1F3D7}\uFE0F</span>
            <span class="stat-value">${this.game.getTotalBuildingCount()}</span>
            <span class="stat-label">Buildings</span>
          </div>
          <div class="stat-card">
            <span class="stat-icon">\u2694\uFE0F</span>
            <span class="stat-value">${formatNumber(stats.totalTroopsTrained)}</span>
            <span class="stat-label">Troops Trained</span>
          </div>
          <div class="stat-card">
            <span class="stat-icon">\u{1F3C6}</span>
            <span class="stat-value">${stats.battlesWon}</span>
            <span class="stat-label">Battles Won</span>
          </div>
          <div class="stat-card">
            <span class="stat-icon">\u{1F480}</span>
            <span class="stat-value">${stats.battlesLost}</span>
            <span class="stat-label">Battles Lost</span>
          </div>
          <div class="stat-card">
            <span class="stat-icon">\u23F1\uFE0F</span>
            <span class="stat-value">${formatTime(this.game.state.totalPlayTime)}</span>
            <span class="stat-label">Play Time</span>
          </div>
          <div class="stat-card">
            <span class="stat-icon">\u{1F4A4}</span>
            <span class="stat-value">${formatNumber(stats.offlineEarnings)}</span>
            <span class="stat-label">Offline Earnings</span>
          </div>
          <div class="stat-card">
            <span class="stat-icon">\u{1F4DA}</span>
            <span class="stat-value">${this.game.state.researchedTechs.size}</span>
            <span class="stat-label">Technologies</span>
          </div>
        </div>
      </div>
    `;
    }
    // Achievement notifications
    queueAchievementNotification(achievement) {
      this.achievementNotificationQueue.push(achievement);
    }
    processAchievementNotifications() {
      if (this.isShowingAchievement || this.achievementNotificationQueue.length === 0)
        return;
      const achievement = this.achievementNotificationQueue.shift();
      if (!achievement)
        return;
      this.isShowingAchievement = true;
      this.showAchievementPopup(achievement);
    }
    showAchievementPopup(achievement) {
      const popup = document.createElement("div");
      popup.className = "achievement-popup";
      popup.innerHTML = `
      <div class="achievement-popup-content">
        <div class="achievement-popup-icon">${achievement.icon}</div>
        <div class="achievement-popup-info">
          <h4>Achievement Unlocked!</h4>
          <h5>${achievement.name}</h5>
          <p>${achievement.description}</p>
        </div>
      </div>
    `;
      document.body.appendChild(popup);
      setTimeout(() => popup.classList.add("show"), 10);
      setTimeout(() => {
        popup.classList.remove("show");
        setTimeout(() => {
          popup.remove();
          this.isShowingAchievement = false;
          this.processAchievementNotifications();
        }, 500);
      }, 3e3);
    }
    // Offline progress popup
    checkOfflineProgress() {
      const offlineProgress = this.game.offlineProgress;
      if (!offlineProgress || !offlineProgress.earned)
        return;
      this.game.dismissOfflineProgress();
      this.showOfflineProgressPopup(offlineProgress);
    }
    showOfflineProgressPopup(progress) {
      const formatNumber = (n) => Math.floor(n).toLocaleString();
      const formatTime = (seconds) => {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor(seconds % 3600 / 60);
        if (hours > 0)
          return `${hours}h ${minutes}m`;
        return `${minutes}m`;
      };
      const popup = document.createElement("div");
      popup.className = "offline-popup-overlay";
      popup.innerHTML = `
      <div class="offline-popup">
        <h3>\u{1F4A4} Welcome Back!</h3>
        <p>You were away for ${formatTime(progress.duration)}</p>
        <p class="offline-subtitle">Your civilization earned while you were gone:</p>
        <div class="offline-rewards">
          ${progress.resources.food > 0 ? `<span>\u{1F356} +${formatNumber(progress.resources.food)}</span>` : ""}
          ${progress.resources.wood > 0 ? `<span>\u{1FAB5} +${formatNumber(progress.resources.wood)}</span>` : ""}
          ${progress.resources.stone > 0 ? `<span>\u{1FAA8} +${formatNumber(progress.resources.stone)}</span>` : ""}
          ${progress.resources.gold > 0 ? `<span>\u{1F4B0} +${formatNumber(progress.resources.gold)}</span>` : ""}
          ${progress.resources.science > 0 ? `<span>\u{1F52C} +${formatNumber(progress.resources.science)}</span>` : ""}
        </div>
        <p class="offline-note">Offline earnings are 50% of normal rate (max 8 hours)</p>
        <button class="offline-dismiss-btn">Continue Playing</button>
      </div>
    `;
      document.body.appendChild(popup);
      popup.querySelector(".offline-dismiss-btn")?.addEventListener("click", () => {
        popup.classList.add("fade-out");
        setTimeout(() => popup.remove(), 300);
      });
      popup.addEventListener("click", (e) => {
        if (e.target === popup) {
          popup.classList.add("fade-out");
          setTimeout(() => popup.remove(), 300);
        }
      });
    }
    // Skill Tree Tab
    renderSkillsTab() {
      const container = document.getElementById("skills-content");
      if (!container)
        return;
      const { skillTree } = this.game.state;
      const bonuses = calculateSkillBonuses(skillTree.skillLevels);
      let html = "";
      html += `
      <div class="skill-overview">
        <div class="legacy-points-display">
          <span class="legacy-icon">\u2728</span>
          <span class="legacy-label">Legacy Points:</span>
          <span class="legacy-value">${skillTree.legacyPoints}</span>
        </div>
        <div class="legacy-stats">
          <span>Total Earned: ${skillTree.totalLegacyPointsEarned}</span>
          <span>Prestige Count: ${skillTree.prestigeCount}</span>
        </div>
      </div>
    `;
      html += this.renderSkillBonusesSummary(bonuses);
      const categories = [
        { id: "production", name: "Production", icon: "\u{1F4E6}" },
        { id: "military", name: "Military", icon: "\u2694\uFE0F" },
        { id: "research", name: "Research", icon: "\u{1F52C}" },
        { id: "economy", name: "Economy", icon: "\u{1F4B0}" },
        { id: "special", name: "Special", icon: "\u{1F31F}" }
      ];
      html += "<h3>\u{1F3AF} Skill Trees</h3>";
      for (const category of categories) {
        const categorySkills = getSkillsByCategory(category.id);
        if (categorySkills.length === 0)
          continue;
        html += `
        <div class="skill-category">
          <h4>${category.icon} ${category.name}</h4>
          <div class="skill-grid">
      `;
        for (const skill of categorySkills) {
          html += this.renderSkillCard(skill, skillTree.skillLevels);
        }
        html += "</div></div>";
      }
      html += this.renderLegacyMilestones();
      container.innerHTML = html;
    }
    renderSkillBonusesSummary(bonuses) {
      const hasResourceBonuses = bonuses.resourceMultipliers.food > 1 || bonuses.resourceMultipliers.wood > 1 || bonuses.resourceMultipliers.stone > 1 || bonuses.resourceMultipliers.gold > 1 || bonuses.resourceMultipliers.science > 1;
      const hasFlatBonuses = bonuses.flatBonuses.food > 0 || bonuses.flatBonuses.wood > 0 || bonuses.flatBonuses.stone > 0 || bonuses.flatBonuses.gold > 0 || bonuses.flatBonuses.science > 0;
      const hasMilitaryBonuses = bonuses.militaryMultipliers.attack > 1 || bonuses.militaryMultipliers.defense > 1 || bonuses.militaryMultipliers.health > 1 || bonuses.militaryMultipliers.casualtyReduction > 0;
      const hasOtherBonuses = bonuses.researchSpeedMultiplier > 1 || bonuses.startingResources > 0 || bonuses.techRetention > 0 || bonuses.legacyPointsMultiplier > 1;
      if (!hasResourceBonuses && !hasFlatBonuses && !hasMilitaryBonuses && !hasOtherBonuses) {
        return `
        <div class="skill-bonuses-summary">
          <h4>Active Skill Bonuses</h4>
          <p class="no-bonuses">No skills unlocked yet. Spend legacy points to unlock permanent bonuses!</p>
        </div>
      `;
      }
      let html = `
      <div class="skill-bonuses-summary">
        <h4>Active Skill Bonuses</h4>
        <div class="bonuses-grid">
    `;
      if (hasResourceBonuses) {
        html += '<div class="bonus-group"><span class="bonus-group-label">Resource Multipliers:</span>';
        if (bonuses.resourceMultipliers.food > 1)
          html += `<span class="bonus-value">\u{1F356} \xD7${bonuses.resourceMultipliers.food.toFixed(2)}</span>`;
        if (bonuses.resourceMultipliers.wood > 1)
          html += `<span class="bonus-value">\u{1FAB5} \xD7${bonuses.resourceMultipliers.wood.toFixed(2)}</span>`;
        if (bonuses.resourceMultipliers.stone > 1)
          html += `<span class="bonus-value">\u{1FAA8} \xD7${bonuses.resourceMultipliers.stone.toFixed(2)}</span>`;
        if (bonuses.resourceMultipliers.gold > 1)
          html += `<span class="bonus-value">\u{1F4B0} \xD7${bonuses.resourceMultipliers.gold.toFixed(2)}</span>`;
        if (bonuses.resourceMultipliers.science > 1)
          html += `<span class="bonus-value">\u{1F52C} \xD7${bonuses.resourceMultipliers.science.toFixed(2)}</span>`;
        html += "</div>";
      }
      if (hasFlatBonuses) {
        html += '<div class="bonus-group"><span class="bonus-group-label">Flat Bonuses:</span>';
        if (bonuses.flatBonuses.food > 0)
          html += `<span class="bonus-value">\u{1F356} +${bonuses.flatBonuses.food.toFixed(1)}/s</span>`;
        if (bonuses.flatBonuses.wood > 0)
          html += `<span class="bonus-value">\u{1FAB5} +${bonuses.flatBonuses.wood.toFixed(1)}/s</span>`;
        if (bonuses.flatBonuses.stone > 0)
          html += `<span class="bonus-value">\u{1FAA8} +${bonuses.flatBonuses.stone.toFixed(1)}/s</span>`;
        if (bonuses.flatBonuses.gold > 0)
          html += `<span class="bonus-value">\u{1F4B0} +${bonuses.flatBonuses.gold.toFixed(1)}/s</span>`;
        if (bonuses.flatBonuses.science > 0)
          html += `<span class="bonus-value">\u{1F52C} +${bonuses.flatBonuses.science.toFixed(1)}/s</span>`;
        html += "</div>";
      }
      if (hasMilitaryBonuses) {
        html += '<div class="bonus-group"><span class="bonus-group-label">Military Bonuses:</span>';
        if (bonuses.militaryMultipliers.attack > 1)
          html += `<span class="bonus-value">\u2694\uFE0F \xD7${bonuses.militaryMultipliers.attack.toFixed(2)}</span>`;
        if (bonuses.militaryMultipliers.defense > 1)
          html += `<span class="bonus-value">\u{1F6E1}\uFE0F \xD7${bonuses.militaryMultipliers.defense.toFixed(2)}</span>`;
        if (bonuses.militaryMultipliers.health > 1)
          html += `<span class="bonus-value">\u2764\uFE0F \xD7${bonuses.militaryMultipliers.health.toFixed(2)}</span>`;
        if (bonuses.militaryMultipliers.casualtyReduction > 0)
          html += `<span class="bonus-value">\u{1F396}\uFE0F -${(bonuses.militaryMultipliers.casualtyReduction * 100).toFixed(0)}% casualties</span>`;
        html += "</div>";
      }
      if (hasOtherBonuses) {
        html += '<div class="bonus-group"><span class="bonus-group-label">Other Bonuses:</span>';
        if (bonuses.researchSpeedMultiplier > 1)
          html += `<span class="bonus-value">\u23F1\uFE0F \xD7${bonuses.researchSpeedMultiplier.toFixed(2)} research</span>`;
        if (bonuses.startingResources > 0)
          html += `<span class="bonus-value">\u{1F4E6} +${bonuses.startingResources} starting</span>`;
        if (bonuses.techRetention > 0)
          html += `<span class="bonus-value">\u{1F9EC} ${(bonuses.techRetention * 100).toFixed(0)}% tech kept</span>`;
        if (bonuses.legacyPointsMultiplier > 1)
          html += `<span class="bonus-value">\u2728 \xD7${bonuses.legacyPointsMultiplier.toFixed(2)} legacy</span>`;
        html += "</div>";
      }
      html += "</div></div>";
      return html;
    }
    renderSkillCard(skill, skillLevels) {
      const currentLevel = getSkillLevel(skill.id, skillLevels);
      const isMaxed = currentLevel >= skill.maxLevel;
      const cost = getSkillCost(skill, currentLevel);
      const canUnlock = canUnlockSkill(skill, skillLevels);
      const hasPoints = this.game.state.skillTree.legacyPoints >= cost;
      const canUpgrade = canUnlock && hasPoints && !isMaxed;
      let effectDisplay = "";
      const currentEffect = getSkillEffect(skill, currentLevel);
      const nextEffect = getSkillEffect(skill, currentLevel + 1);
      if (skill.effects.type === "multiplier") {
        if (currentLevel > 0) {
          effectDisplay = `\xD7${currentEffect.toFixed(2)}`;
          if (!isMaxed)
            effectDisplay += ` \u2192 \xD7${nextEffect.toFixed(2)}`;
        } else {
          effectDisplay = `\u2192 \xD7${nextEffect.toFixed(2)}`;
        }
      } else {
        if (currentLevel > 0) {
          effectDisplay = `+${currentEffect.toFixed(1)}`;
          if (!isMaxed)
            effectDisplay += ` \u2192 +${nextEffect.toFixed(1)}`;
        } else {
          effectDisplay = `\u2192 +${nextEffect.toFixed(1)}`;
        }
      }
      let prereqDisplay = "";
      if (skill.prerequisites.length > 0 && !canUnlock) {
        const prereqNames = skill.prerequisites.map((id) => {
          const prereqSkill = getSkillById(id);
          return prereqSkill ? prereqSkill.name : id;
        }).join(", ");
        prereqDisplay = `<span class="skill-prereq">Requires: ${prereqNames}</span>`;
      }
      let statusClass = "locked";
      if (isMaxed)
        statusClass = "maxed";
      else if (canUpgrade)
        statusClass = "available";
      else if (canUnlock)
        statusClass = "affordable";
      return `
      <div class="skill-card ${statusClass}">
        <div class="skill-header">
          <span class="skill-icon">${skill.icon}</span>
          <h5>${skill.name}</h5>
          <span class="skill-level">${currentLevel}/${skill.maxLevel}</span>
        </div>
        <p class="skill-desc">${skill.description}</p>
        <div class="skill-effect">
          <span class="effect-label">Effect:</span>
          <span class="effect-value">${effectDisplay}</span>
        </div>
        ${prereqDisplay}
        ${!isMaxed ? `
          <div class="skill-cost">
            <span>Cost: \u2728 ${cost}</span>
          </div>
          <button class="skill-btn" data-skill="${skill.id}" ${!canUpgrade ? "disabled" : ""}>
            ${canUnlock ? hasPoints ? "Upgrade" : "Need Points" : "Locked"}
          </button>
        ` : `
          <div class="skill-maxed">
            <span>\u2713 Maxed</span>
          </div>
        `}
      </div>
    `;
    }
    renderLegacyMilestones() {
      const { skillTree } = this.game.state;
      let html = `
      <div class="legacy-milestones">
        <h3>\u{1F3C6} Legacy Milestones</h3>
        <p>Complete milestones to earn legacy points!</p>
        <div class="milestone-grid">
    `;
      for (const milestone of LEGACY_MILESTONES) {
        const isCompleted = skillTree.completedMilestones.has(milestone.id);
        const completionCount = skillTree.milestoneCompletionCounts.get(milestone.id) || 0;
        const canComplete = this.checkMilestoneCondition(milestone);
        html += `
        <div class="milestone-card ${isCompleted ? "completed" : ""} ${canComplete && !isCompleted ? "available" : ""}">
          <div class="milestone-header">
            <span class="milestone-icon">${milestone.icon}</span>
            <h5>${milestone.name}</h5>
          </div>
          <p class="milestone-desc">${milestone.description}</p>
          <div class="milestone-reward">
            <span>Reward: \u2728 ${milestone.legacyPoints} Legacy Points</span>
          </div>
          ${milestone.repeatable ? `<span class="milestone-repeatable">Repeatable (Completed: ${completionCount}\xD7)</span>` : ""}
          ${isCompleted && !milestone.repeatable ? '<span class="milestone-complete-badge">\u2713 Completed</span>' : ""}
        </div>
      `;
      }
      html += "</div></div>";
      return html;
    }
    checkMilestoneCondition(milestone) {
      const condition = milestone.condition;
      const stats = this.game.state.statistics;
      switch (condition.type) {
        case "era_reached":
          return this.game.hasReachedEra(condition.target);
        case "battles_won":
          return stats.battlesWon >= condition.amount;
        case "territories_conquered":
          return (stats.territoriesConquered || 0) >= condition.amount;
        case "techs_researched":
          return this.game.state.researchedTechs.size >= condition.amount;
        case "buildings_built":
          return (stats.totalBuildingsConstructed || 0) >= condition.amount;
        default:
          return false;
      }
    }
    updateSkillsTab() {
      const container = document.getElementById("skills-content");
      if (!container) {
        this.renderSkillsTab();
        return;
      }
      const { skillTree } = this.game.state;
      let totalLevels = 0;
      skillTree.skillLevels.forEach((level) => {
        totalLevels += level;
      });
      const versionKey = `${skillTree.legacyPoints}-${totalLevels}-${skillTree.completedMilestones.size}`;
      const lastVersion = this.tabContentVersions.get("skills");
      if (lastVersion === void 0 || lastVersion !== versionKey) {
        this.tabContentVersions.set("skills", versionKey);
        this.renderSkillsTab();
        return;
      }
      const legacyValue = container.querySelector(".legacy-value");
      if (legacyValue) {
        legacyValue.textContent = skillTree.legacyPoints.toString();
      }
      const skillButtons = container.querySelectorAll(".skill-btn");
      skillButtons.forEach((btn) => {
        const skillId = btn.dataset.skill;
        if (skillId) {
          const skill = getSkillById(skillId);
          if (skill) {
            const currentLevel = getSkillLevel(skill.id, skillTree.skillLevels);
            const isMaxed = currentLevel >= skill.maxLevel;
            const cost = getSkillCost(skill, currentLevel);
            const canUnlock = canUnlockSkill(skill, skillTree.skillLevels);
            const hasPoints = skillTree.legacyPoints >= cost;
            const canUpgrade = canUnlock && hasPoints && !isMaxed;
            btn.disabled = !canUpgrade;
          }
        }
      });
    }
    // ===== World & Lore Tab =====
    renderWorldTab() {
      const container = document.getElementById("world-content");
      if (!container)
        return;
      const { lore } = this.game.state;
      const currentCiv = getCivilizationById(lore.selectedCivilization);
      const currentLeader = lore.selectedLeader ? getLeaderById(lore.selectedLeader) : null;
      let html = "";
      html += this.renderCivilizationSection(currentCiv, currentLeader, lore);
      html += this.renderLeadersSection(currentLeader, lore);
      html += this.renderReligionSection(lore);
      html += this.renderNaturalWondersSection(lore);
      html += this.renderCulturalPoliciesSection(lore);
      container.innerHTML = html;
    }
    renderCivilizationSection(currentCiv, currentLeader, lore) {
      let html = `
      <div class="world-section civilization-section">
        <h3>\u{1F3DB}\uFE0F Your Civilization</h3>
        ${currentCiv ? `
          <div class="current-civ-display">
            <span class="civ-icon">${currentCiv.icon}</span>
            <div class="civ-details">
              <h4>${currentCiv.name}</h4>
              <p>${currentCiv.description}</p>
              ${currentCiv.bonuses.specialAbility ? `<span class="special-ability">\u2728 ${currentCiv.bonuses.specialAbility}</span>` : ""}
            </div>
          </div>
          ${currentLeader ? `
            <div class="current-leader-display">
              <span class="leader-icon">${currentLeader.icon}</span>
              <div class="leader-details">
                <h5>${currentLeader.name} - ${currentLeader.title}</h5>
                <p>${currentLeader.description}</p>
                <span class="special-ability">\u2728 ${currentLeader.bonuses.specialAbility}</span>
              </div>
            </div>
          ` : '<p class="no-leader">No leader selected. Choose a leader below!</p>'}
        ` : ""}
        
        <h4>Choose Your Civilization</h4>
        <div class="civ-grid">
    `;
      for (const civ of CIVILIZATIONS) {
        const isSelected = civ.id === lore.selectedCivilization;
        const bonusText = this.getCivBonusText(civ);
        html += `
        <div class="civ-card ${isSelected ? "selected" : ""}">
          <div class="civ-header">
            <span class="civ-icon">${civ.icon}</span>
            <h5>${civ.name}</h5>
          </div>
          <p class="civ-desc">${civ.description}</p>
          <div class="civ-bonuses">${bonusText}</div>
          ${civ.bonuses.specialAbility ? `<span class="civ-special">\u2728 ${civ.bonuses.specialAbility}</span>` : ""}
          <button class="civ-btn ${isSelected ? "selected" : ""}" 
                  data-civilization="${civ.id}"
                  ${isSelected ? "disabled" : ""}>
            ${isSelected ? "\u2713 Selected" : "Select"}
          </button>
        </div>
      `;
      }
      html += "</div></div>";
      return html;
    }
    getCivBonusText(civ) {
      const bonuses = [];
      if (civ.bonuses.resourceMultipliers) {
        if (civ.bonuses.resourceMultipliers.food && civ.bonuses.resourceMultipliers.food > 1) {
          bonuses.push(`\u{1F356} \xD7${civ.bonuses.resourceMultipliers.food.toFixed(2)}`);
        }
        if (civ.bonuses.resourceMultipliers.wood && civ.bonuses.resourceMultipliers.wood > 1) {
          bonuses.push(`\u{1FAB5} \xD7${civ.bonuses.resourceMultipliers.wood.toFixed(2)}`);
        }
        if (civ.bonuses.resourceMultipliers.stone && civ.bonuses.resourceMultipliers.stone > 1) {
          bonuses.push(`\u{1FAA8} \xD7${civ.bonuses.resourceMultipliers.stone.toFixed(2)}`);
        }
        if (civ.bonuses.resourceMultipliers.gold && civ.bonuses.resourceMultipliers.gold > 1) {
          bonuses.push(`\u{1F4B0} \xD7${civ.bonuses.resourceMultipliers.gold.toFixed(2)}`);
        }
        if (civ.bonuses.resourceMultipliers.science && civ.bonuses.resourceMultipliers.science > 1) {
          bonuses.push(`\u{1F52C} \xD7${civ.bonuses.resourceMultipliers.science.toFixed(2)}`);
        }
      }
      if (civ.bonuses.militaryBonuses) {
        if (civ.bonuses.militaryBonuses.attack && civ.bonuses.militaryBonuses.attack > 1) {
          bonuses.push(`\u2694\uFE0F \xD7${civ.bonuses.militaryBonuses.attack.toFixed(2)}`);
        }
        if (civ.bonuses.militaryBonuses.defense && civ.bonuses.militaryBonuses.defense > 1) {
          bonuses.push(`\u{1F6E1}\uFE0F \xD7${civ.bonuses.militaryBonuses.defense.toFixed(2)}`);
        }
      }
      return bonuses.length > 0 ? bonuses.join(" ") : "No special bonuses";
    }
    renderLeadersSection(currentLeader, lore) {
      const availableLeaders = this.game.getAvailableLeaders();
      let html = `
      <div class="world-section leaders-section">
        <h3>\u{1F451} Historical Leaders</h3>
        <p>Choose a leader to guide your civilization. More leaders unlock as you advance through eras.</p>
        <div class="leader-grid">
    `;
      if (availableLeaders.length === 0) {
        html += '<p class="empty-message">No leaders available yet. Keep progressing!</p>';
      } else {
        for (const leader of availableLeaders) {
          const isSelected = leader.id === lore.selectedLeader;
          html += `
          <div class="leader-card ${isSelected ? "selected" : ""}">
            <div class="leader-header">
              <span class="leader-icon">${leader.icon}</span>
              <div>
                <h5>${leader.name}</h5>
                <span class="leader-title">${leader.title}</span>
              </div>
            </div>
            <p class="leader-desc">${leader.description}</p>
            <span class="leader-ability">\u2728 ${leader.bonuses.specialAbility}</span>
            <button class="leader-btn ${isSelected ? "selected" : ""}"
                    data-leader="${leader.id}"
                    ${isSelected ? "disabled" : ""}>
              ${isSelected ? "\u2713 Selected" : "Select Leader"}
            </button>
          </div>
        `;
        }
      }
      html += "</div></div>";
      return html;
    }
    renderReligionSection(lore) {
      let html = `
      <div class="world-section religion-section">
        <h3>\u{1F64F} Religion</h3>
    `;
      if (lore.foundedReligion) {
        const religion = lore.foundedReligion;
        html += `
        <div class="founded-religion">
          <div class="religion-header">
            <span class="religion-icon">${religion.icon}</span>
            <div>
              <h4>${religion.name}</h4>
              <span class="follower-count">${religion.followers} followers</span>
            </div>
          </div>
          <p class="religion-desc">${religion.description}</p>
          <span class="religion-ability">\u2728 ${religion.bonuses.specialAbility}</span>
        </div>
      `;
      } else {
        html += `
        <p>Found a religion to gain permanent bonuses for your civilization.</p>
        <div class="religion-grid">
      `;
        for (const template of RELIGION_TEMPLATES) {
          html += `
          <div class="religion-card">
            <div class="religion-header">
              <span class="religion-icon">${template.icon}</span>
              <h5>${template.name}</h5>
            </div>
            <p class="religion-desc">${template.description}</p>
            <span class="religion-ability">\u2728 ${template.bonuses.specialAbility}</span>
            <button class="religion-btn" data-religion="${template.id}">
              Found Religion
            </button>
          </div>
        `;
        }
        html += "</div>";
      }
      html += "</div>";
      return html;
    }
    renderNaturalWondersSection(lore) {
      const discoveredWonders = this.game.getDiscoveredWonders();
      let html = `
      <div class="world-section wonders-section">
        <h3>\u{1F30D} Natural Wonders</h3>
        <p>Explore the world to discover natural wonders that provide permanent bonuses.</p>
        <button id="explore-wonder-btn" class="explore-btn">\u{1F50D} Explore for Wonders</button>
        
        <h4>Discovered Wonders (${discoveredWonders.length}/${NATURAL_WONDERS.length})</h4>
        <div class="wonder-grid">
    `;
      if (discoveredWonders.length === 0) {
        html += '<p class="empty-message">No wonders discovered yet. Keep exploring!</p>';
      } else {
        for (const wonder of discoveredWonders) {
          const bonusText = this.getWonderBonusText(wonder);
          html += `
          <div class="wonder-card discovered">
            <div class="wonder-header">
              <span class="wonder-icon">${wonder.icon}</span>
              <h5>${wonder.name}</h5>
            </div>
            <p class="wonder-desc">${wonder.description}</p>
            <div class="wonder-bonuses">${bonusText}</div>
            ${wonder.bonuses.specialEffect ? `<span class="wonder-effect">\u2728 ${wonder.bonuses.specialEffect}</span>` : ""}
          </div>
        `;
        }
      }
      html += "</div></div>";
      return html;
    }
    getWonderBonusText(wonder) {
      const bonuses = [];
      if (wonder.bonuses.flatBonuses) {
        for (const bonus of wonder.bonuses.flatBonuses) {
          const emoji = this.getResourceEmoji(bonus.resource);
          bonuses.push(`${emoji} +${bonus.amount}/s`);
        }
      }
      if (wonder.bonuses.resourceMultiplier) {
        const emoji = this.getResourceEmoji(wonder.bonuses.resourceMultiplier.resource);
        bonuses.push(`${emoji} \xD7${wonder.bonuses.resourceMultiplier.multiplier.toFixed(2)}`);
      }
      return bonuses.length > 0 ? bonuses.join(" ") : "Special effects only";
    }
    renderCulturalPoliciesSection(lore) {
      const adoptedPolicies = this.game.getAdoptedPolicies();
      const availablePolicies = this.game.getAvailablePolicies();
      let html = `
      <div class="world-section culture-section">
        <h3>\u{1F3AD} Cultural Policies</h3>
        <div class="culture-overview">
          <div class="culture-points">
            <span class="culture-icon">\u{1F3A8}</span>
            <span class="culture-label">Culture Points:</span>
            <span class="culture-value">${Math.floor(lore.culturePoints)}</span>
          </div>
          <div class="culture-level">
            <span>Culture Level: ${lore.cultureLevel}</span>
          </div>
        </div>
        
        <h4>Adopted Policies (${adoptedPolicies.length}/${CULTURAL_POLICIES.length})</h4>
        <div class="adopted-policies">
    `;
      if (adoptedPolicies.length === 0) {
        html += '<p class="empty-message">No policies adopted yet.</p>';
      } else {
        for (const policy of adoptedPolicies) {
          html += `
          <div class="policy-card adopted">
            <span class="policy-icon">${policy.icon}</span>
            <div class="policy-info">
              <h5>${policy.name}</h5>
              <p>${policy.description}</p>
              ${policy.effects.special ? `<span class="policy-effect">\u2728 ${policy.effects.special}</span>` : ""}
            </div>
          </div>
        `;
        }
      }
      html += `
        </div>
        
        <h4>Available Policies</h4>
        <div class="policy-grid">
    `;
      if (availablePolicies.length === 0) {
        html += '<p class="empty-message">All policies adopted!</p>';
      } else {
        for (const policy of availablePolicies) {
          const canAdopt = canAdoptPolicy(policy.id, lore.culturePoints, lore.adoptedPolicies);
          html += `
          <div class="policy-card ${canAdopt ? "available" : "locked"}">
            <div class="policy-header">
              <span class="policy-icon">${policy.icon}</span>
              <h5>${policy.name}</h5>
            </div>
            <p class="policy-desc">${policy.description}</p>
            ${policy.effects.special ? `<span class="policy-effect">\u2728 ${policy.effects.special}</span>` : ""}
            <div class="policy-cost">Cost: \u{1F3A8} ${policy.cost}</div>
            <button class="policy-btn ${canAdopt ? "" : "disabled"}"
                    data-policy="${policy.id}"
                    ${canAdopt ? "" : "disabled"}>
              ${canAdopt ? "Adopt Policy" : "Need More Culture"}
            </button>
          </div>
        `;
        }
      }
      html += "</div></div>";
      return html;
    }
    updateWorldTab() {
      const container = document.getElementById("world-content");
      if (!container) {
        this.renderWorldTab();
        return;
      }
      const { lore } = this.game.state;
      const discoveredCount = lore.discoveredWonders.size;
      const policiesCount = lore.adoptedPolicies.size;
      const hasReligion = lore.foundedReligion ? 1 : 0;
      const versionKey = `${lore.selectedCivilization}-${lore.selectedLeader}-${discoveredCount}-${policiesCount}-${hasReligion}`;
      const lastVersion = this.tabContentVersions.get("world");
      if (lastVersion === void 0 || lastVersion !== versionKey) {
        this.tabContentVersions.set("world", versionKey);
        this.renderWorldTab();
        return;
      }
      const cultureValue = container.querySelector(".culture-value");
      if (cultureValue) {
        cultureValue.textContent = Math.floor(lore.culturePoints).toString();
      }
      const policyButtons = container.querySelectorAll(".policy-btn");
      policyButtons.forEach((btn) => {
        const policyId = btn.dataset.policy;
        if (policyId) {
          const canAdopt = canAdoptPolicy(policyId, lore.culturePoints, lore.adoptedPolicies);
          btn.disabled = !canAdopt;
        }
      });
    }
    // ===== Military Tab =====
    renderMilitaryTab() {
      const container = document.getElementById("military-content");
      if (!container)
        return;
      let html = "";
      html += this.renderMilitaryOverview();
      html += this.renderFormationsSection();
      html += this.renderUnitUpgradesSection();
      html += this.renderHeroesSection();
      html += this.renderDefenseSection();
      html += this.renderNavalSection();
      html += this.renderSiegeSection();
      html += this.renderTraditionsSection();
      html += this.renderEspionageSection();
      container.innerHTML = html;
    }
    renderMilitaryOverview() {
      const totalPower = this.game.getTotalMilitaryPower();
      const formation = this.game.getCurrentFormation();
      const activeHero = this.game.getActiveHero();
      const traditionBonuses = this.game.getTraditionBonuses();
      const defenseBonuses = this.game.getDefenseBonuses();
      const navalPower = this.game.getNavalPower();
      const siegePower = this.game.getSiegePower();
      return `
      <div class="military-section">
        <h3>\u{1F4CA} Military Overview</h3>
        <div class="military-overview">
          <div class="military-stat">
            <span class="military-stat-icon">\u2694\uFE0F</span>
            <span class="military-stat-value">${totalPower.attack}</span>
            <span class="military-stat-label">Total Attack</span>
          </div>
          <div class="military-stat">
            <span class="military-stat-icon">\u{1F6E1}\uFE0F</span>
            <span class="military-stat-value">${totalPower.defense}</span>
            <span class="military-stat-label">Total Defense</span>
          </div>
          <div class="military-stat">
            <span class="military-stat-icon">\u2764\uFE0F</span>
            <span class="military-stat-value">${totalPower.health}</span>
            <span class="military-stat-label">Total Health</span>
          </div>
          <div class="military-stat">
            <span class="military-stat-icon">${formation?.icon || "\u2694\uFE0F"}</span>
            <span class="military-stat-value">${formation?.name || "Standard"}</span>
            <span class="military-stat-label">Formation</span>
          </div>
          <div class="military-stat">
            <span class="military-stat-icon">${activeHero?.icon || "\u274C"}</span>
            <span class="military-stat-value">${activeHero?.name || "None"}</span>
            <span class="military-stat-label">Active Hero</span>
          </div>
          <div class="military-stat">
            <span class="military-stat-icon">\u{1F3F0}</span>
            <span class="military-stat-value">+${defenseBonuses.defense}</span>
            <span class="military-stat-label">Defense Bonus</span>
          </div>
          <div class="military-stat">
            <span class="military-stat-icon">\u2693</span>
            <span class="military-stat-value">${navalPower.attack}</span>
            <span class="military-stat-label">Naval Power</span>
          </div>
          <div class="military-stat">
            <span class="military-stat-icon">\u{1F4A3}</span>
            <span class="military-stat-value">${siegePower.siegeBonus}</span>
            <span class="military-stat-label">Siege Bonus</span>
          </div>
        </div>
        ${traditionBonuses.attackMultiplier > 1 || traditionBonuses.defenseMultiplier > 1 ? `
          <div class="tradition-bonuses-summary">
            <h4>Tradition Bonuses Active:</h4>
            <span>
              ${traditionBonuses.attackMultiplier > 1 ? `\u2694\uFE0F \xD7${traditionBonuses.attackMultiplier.toFixed(2)}` : ""}
              ${traditionBonuses.defenseMultiplier > 1 ? `\u{1F6E1}\uFE0F \xD7${traditionBonuses.defenseMultiplier.toFixed(2)}` : ""}
              ${traditionBonuses.healthMultiplier > 1 ? `\u2764\uFE0F \xD7${traditionBonuses.healthMultiplier.toFixed(2)}` : ""}
              ${traditionBonuses.casualtyReduction > 0 ? `\u{1F396}\uFE0F -${(traditionBonuses.casualtyReduction * 100).toFixed(0)}% casualties` : ""}
            </span>
          </div>
        ` : ""}
      </div>
    `;
    }
    renderFormationsSection() {
      const availableFormations = this.game.getAvailableFormations();
      const currentFormation = this.game.state.military.selectedFormation;
      let html = `
      <div class="military-section">
        <h3>\u2694\uFE0F Combat Formations</h3>
        <p>Choose a formation to modify your army's combat effectiveness.</p>
        <div class="formation-grid">
    `;
      for (const formation of availableFormations) {
        const isActive = formation.id === currentFormation;
        html += `
        <div class="formation-card ${isActive ? "active" : ""}" data-formation="${formation.id}">
          <div class="formation-header">
            <span class="formation-icon">${formation.icon}</span>
            <span class="formation-name">${formation.name}</span>
          </div>
          <p class="formation-desc">${formation.description}</p>
          <div class="formation-stats">
            <span class="formation-stat ${formation.attackModifier >= 1 ? "positive" : "negative"}">
              \u2694\uFE0F ${formation.attackModifier >= 1 ? "+" : ""}${((formation.attackModifier - 1) * 100).toFixed(0)}%
            </span>
            <span class="formation-stat ${formation.defenseModifier >= 1 ? "positive" : "negative"}">
              \u{1F6E1}\uFE0F ${formation.defenseModifier >= 1 ? "+" : ""}${((formation.defenseModifier - 1) * 100).toFixed(0)}%
            </span>
            <span class="formation-stat ${formation.healthModifier >= 1 ? "positive" : "negative"}">
              \u2764\uFE0F ${formation.healthModifier >= 1 ? "+" : ""}${((formation.healthModifier - 1) * 100).toFixed(0)}%
            </span>
          </div>
          ${formation.specialEffect ? `<span class="formation-special">\u2728 ${formation.specialEffect}</span>` : ""}
          ${isActive ? '<span class="badge">\u2713 Active</span>' : ""}
        </div>
      `;
      }
      html += "</div></div>";
      return html;
    }
    renderUnitUpgradesSection() {
      const availableUpgrades = this.game.getAvailableUnitUpgrades();
      let html = `
      <div class="military-section">
        <h3>\u2B06\uFE0F Unit Upgrades</h3>
        <p>Upgrade your existing units to more powerful versions.</p>
    `;
      if (availableUpgrades.length === 0) {
        html += '<p class="empty-message">No unit upgrades available. Train units and research technologies to unlock upgrades.</p>';
      } else {
        html += '<div class="upgrade-grid">';
        for (const upgrade of availableUpgrades) {
          html += `
          <div class="upgrade-card available">
            <h5>${upgrade.name}</h5>
            <p class="upgrade-desc">${upgrade.description}</p>
            <div class="upgrade-arrow">
              <span class="upgrade-from">${this.getTroopName(upgrade.fromUnit)}</span>
              <span>\u2192</span>
              <span class="upgrade-to">${this.getTroopName(upgrade.toUnit)}</span>
            </div>
            <div class="upgrade-cost">
              <span>\u{1F356} ${upgrade.cost.food}</span>
              <span>\u{1F4B0} ${upgrade.cost.gold}</span>
              <span>\u{1F52C} ${upgrade.cost.science}</span>
            </div>
            <button class="upgrade-btn" data-upgrade="${upgrade.id}">Upgrade</button>
          </div>
        `;
        }
        html += "</div>";
      }
      html += "</div>";
      return html;
    }
    getTroopName(troopId) {
      const troop = getTroopTypeById(troopId);
      return troop ? troop.name : troopId;
    }
    renderHeroesSection() {
      const availableHeroes = this.game.getAvailableHeroes();
      const recruitedHeroes = this.game.getRecruitedHeroes();
      const activeHeroId = this.game.state.military.activeHero;
      let html = `
      <div class="military-section">
        <h3>\u{1F451} Heroes & Generals</h3>
        <p>Recruit legendary commanders to lead your armies.</p>
    `;
      if (recruitedHeroes.length > 0) {
        html += '<h4>Your Heroes</h4><div class="hero-grid">';
        for (const hero of recruitedHeroes) {
          const isActive = hero.id === activeHeroId;
          html += `
          <div class="hero-card recruited ${isActive ? "active" : ""}">
            <div class="hero-header">
              <span class="hero-icon">${hero.icon}</span>
              <div class="hero-info">
                <h5>${hero.name}</h5>
                <span class="hero-title">${hero.title}</span>
              </div>
            </div>
            <p class="hero-desc">${hero.description}</p>
            <div class="hero-bonuses">
              <span class="hero-bonus">\u2694\uFE0F +${hero.bonuses.attackBonus}</span>
              <span class="hero-bonus">\u{1F6E1}\uFE0F +${hero.bonuses.defenseBonus}</span>
              <span class="hero-bonus">\u2764\uFE0F +${hero.bonuses.healthBonus}</span>
            </div>
            <span class="hero-ability">\u2728 ${hero.bonuses.specialAbility}</span>
            <button class="hero-btn set-active" data-hero="${hero.id}" ${isActive ? "disabled" : ""}>
              ${isActive ? "\u2713 Active" : "Set Active"}
            </button>
          </div>
        `;
        }
        html += "</div>";
      }
      if (availableHeroes.length > 0) {
        html += '<h4>Available Heroes</h4><div class="hero-grid">';
        for (const hero of availableHeroes) {
          const canAfford = this.game.state.resources.gold >= hero.cost.gold && this.game.state.resources.science >= hero.cost.science;
          html += `
          <div class="hero-card ${canAfford ? "available" : ""}">
            <div class="hero-header">
              <span class="hero-icon">${hero.icon}</span>
              <div class="hero-info">
                <h5>${hero.name}</h5>
                <span class="hero-title">${hero.title}</span>
              </div>
            </div>
            <p class="hero-desc">${hero.description}</p>
            <div class="hero-bonuses">
              <span class="hero-bonus">\u2694\uFE0F +${hero.bonuses.attackBonus}</span>
              <span class="hero-bonus">\u{1F6E1}\uFE0F +${hero.bonuses.defenseBonus}</span>
              <span class="hero-bonus">\u2764\uFE0F +${hero.bonuses.healthBonus}</span>
            </div>
            <span class="hero-ability">\u2728 ${hero.bonuses.specialAbility}</span>
            <div class="hero-cost">
              <span>\u{1F4B0} ${hero.cost.gold}</span>
              <span>\u{1F52C} ${hero.cost.science}</span>
            </div>
            <button class="hero-btn recruit" data-hero="${hero.id}" ${!canAfford ? "disabled" : ""}>
              Recruit
            </button>
          </div>
        `;
        }
        html += "</div>";
      }
      if (availableHeroes.length === 0 && recruitedHeroes.length === 0) {
        html += '<p class="empty-message">No heroes available. Research technologies to unlock heroes.</p>';
      }
      html += "</div>";
      return html;
    }
    renderDefenseSection() {
      const availableStructures = this.game.getAvailableDefenseStructures();
      const defenseBuildings = this.game.state.military.defenseBuildings;
      const constructionQueue = this.game.state.military.defenseConstructionQueue;
      let html = `
      <div class="military-section">
        <h3>\u{1F3F0} Defense Structures</h3>
        <p>Build fortifications to protect your civilization.</p>
    `;
      if (constructionQueue.length > 0) {
        html += '<h4>Under Construction</h4><div class="military-queue">';
        const now = Date.now();
        for (const construction of constructionQueue) {
          const structure = getDefenseStructureById(construction.typeId);
          if (structure) {
            const remaining = Math.max(0, (construction.endTime - now) / 1e3);
            html += `
            <div class="military-queue-item">
              <span>${structure.icon} ${structure.name}</span>
              <span>${remaining.toFixed(1)}s</span>
            </div>
          `;
          }
        }
        html += "</div>";
      }
      if (availableStructures.length > 0) {
        html += '<div class="defense-grid">';
        for (const structure of availableStructures) {
          const currentCount = defenseBuildings.find((b) => b.typeId === structure.id)?.count || 0;
          const atMax = currentCount >= structure.maxCount;
          const canBuild = !atMax && this.game.state.resources.food >= structure.cost.food && this.game.state.resources.wood >= structure.cost.wood && this.game.state.resources.stone >= structure.cost.stone && this.game.state.resources.gold >= structure.cost.gold;
          html += `
          <div class="defense-card ${canBuild ? "available" : ""} ${atMax ? "maxed" : ""}">
            <div class="defense-header">
              <h5>${structure.icon} ${structure.name}</h5>
              <span class="defense-count">${currentCount}/${structure.maxCount}</span>
            </div>
            <p class="defense-desc">${structure.description}</p>
            <div class="defense-bonuses">
              <span>\u{1F6E1}\uFE0F +${structure.defenseBonus}</span>
              <span>\u2764\uFE0F +${structure.healthBonus}</span>
            </div>
            <div class="defense-cost">
              ${structure.cost.food > 0 ? `<span>\u{1F356} ${structure.cost.food}</span>` : ""}
              ${structure.cost.wood > 0 ? `<span>\u{1FAB5} ${structure.cost.wood}</span>` : ""}
              ${structure.cost.stone > 0 ? `<span>\u{1FAA8} ${structure.cost.stone}</span>` : ""}
              ${structure.cost.gold > 0 ? `<span>\u{1F4B0} ${structure.cost.gold}</span>` : ""}
            </div>
            <p class="build-time">\u23F1\uFE0F ${structure.buildTime}s</p>
            <button class="build-defense-btn" data-defense="${structure.id}" ${!canBuild || atMax ? "disabled" : ""}>
              ${atMax ? "Max Built" : "Build"}
            </button>
          </div>
        `;
        }
        html += "</div>";
      } else {
        html += '<p class="empty-message">No defense structures available. Research technologies to unlock.</p>';
      }
      html += "</div>";
      return html;
    }
    renderNavalSection() {
      const availableNaval = this.game.getAvailableNavalUnits();
      const navy = this.game.state.military.navy;
      const trainingQueue = this.game.state.military.navalTrainingQueue;
      let html = `
      <div class="military-section">
        <h3>\u2693 Naval Forces</h3>
        <p>Build a fleet to dominate the seas.</p>
    `;
      const navalPower = this.game.getNavalPower();
      if (navy.length > 0) {
        html += `
        <div class="naval-summary">
          <span>Fleet Power: \u2694\uFE0F ${navalPower.attack} | \u{1F6E1}\uFE0F ${navalPower.defense} | \u2764\uFE0F ${navalPower.health}</span>
        </div>
      `;
      }
      if (trainingQueue.length > 0) {
        html += '<h4>Shipyard Queue</h4><div class="military-queue">';
        const now = Date.now();
        for (const training of trainingQueue) {
          const unit = getNavalUnitById(training.typeId);
          if (unit) {
            const remaining = Math.max(0, (training.endTime - now) / 1e3);
            html += `
            <div class="military-queue-item">
              <span>${unit.icon} ${unit.name}</span>
              <span>${remaining.toFixed(1)}s</span>
            </div>
          `;
          }
        }
        html += "</div>";
      }
      if (navy.length > 0) {
        html += '<h4>Your Fleet</h4><div class="naval-grid">';
        for (const ship of navy) {
          const unit = getNavalUnitById(ship.typeId);
          if (unit) {
            html += `
            <div class="naval-card">
              <div class="naval-header">
                <span class="naval-icon">${unit.icon}</span>
                <h5>${unit.name} (\xD7${ship.count})</h5>
              </div>
              <div class="naval-stats">
                <span>\u2694\uFE0F ${unit.stats.attack * ship.count}</span>
                <span>\u{1F6E1}\uFE0F ${unit.stats.defense * ship.count}</span>
                <span>\u2764\uFE0F ${unit.stats.health * ship.count}</span>
              </div>
            </div>
          `;
          }
        }
        html += "</div>";
      }
      if (availableNaval.length > 0) {
        html += '<h4>Build Ships</h4><div class="naval-grid">';
        for (const unit of availableNaval) {
          const canTrain = this.game.state.resources.food >= unit.cost.food && this.game.state.resources.wood >= unit.cost.wood && this.game.state.resources.gold >= unit.cost.gold;
          html += `
          <div class="naval-card ${canTrain ? "available" : ""}">
            <div class="naval-header">
              <span class="naval-icon">${unit.icon}</span>
              <h5>${unit.name}</h5>
            </div>
            <p class="naval-desc">${unit.description}</p>
            <div class="naval-stats">
              <span>\u2694\uFE0F ${unit.stats.attack}</span>
              <span>\u{1F6E1}\uFE0F ${unit.stats.defense}</span>
              <span>\u2764\uFE0F ${unit.stats.health}</span>
            </div>
            <div class="naval-cost">
              <span>\u{1F356} ${unit.cost.food}</span>
              <span>\u{1FAB5} ${unit.cost.wood}</span>
              <span>\u{1F4B0} ${unit.cost.gold}</span>
            </div>
            <p class="train-time">\u23F1\uFE0F ${unit.trainTime}s</p>
            <button class="train-naval-btn" data-naval="${unit.id}" ${!canTrain ? "disabled" : ""}>
              Build
            </button>
          </div>
        `;
        }
        html += "</div>";
      } else {
        html += '<p class="empty-message">No naval units available. Research technologies to unlock.</p>';
      }
      html += "</div>";
      return html;
    }
    renderSiegeSection() {
      const availableSiege = this.game.getAvailableSiegeWeapons();
      const siegeWeapons = this.game.state.military.siegeWeapons;
      const trainingQueue = this.game.state.military.siegeTrainingQueue;
      let html = `
      <div class="military-section">
        <h3>\u{1F4A3} Siege Weapons</h3>
        <p>Build siege equipment to breach enemy fortifications.</p>
    `;
      const siegePower = this.game.getSiegePower();
      if (siegeWeapons.length > 0) {
        html += `
        <div class="siege-summary">
          <span>Siege Power: \u2694\uFE0F ${siegePower.attack} | \u{1F4A5} +${siegePower.siegeBonus} siege bonus</span>
        </div>
      `;
      }
      if (trainingQueue.length > 0) {
        html += '<h4>Workshop Queue</h4><div class="military-queue">';
        const now = Date.now();
        for (const training of trainingQueue) {
          const weapon = getSiegeWeaponById(training.typeId);
          if (weapon) {
            const remaining = Math.max(0, (training.endTime - now) / 1e3);
            html += `
            <div class="military-queue-item">
              <span>${weapon.icon} ${weapon.name}</span>
              <span>${remaining.toFixed(1)}s</span>
            </div>
          `;
          }
        }
        html += "</div>";
      }
      if (siegeWeapons.length > 0) {
        html += '<h4>Your Arsenal</h4><div class="siege-grid">';
        for (const weapon of siegeWeapons) {
          const unit = getSiegeWeaponById(weapon.typeId);
          if (unit) {
            html += `
            <div class="siege-card">
              <div class="siege-header">
                <span class="siege-icon">${unit.icon}</span>
                <h5>${unit.name} (\xD7${weapon.count})</h5>
              </div>
              <div class="siege-stats">
                <span>\u2694\uFE0F ${unit.stats.attack * weapon.count}</span>
                <span>\u{1F4A5} +${unit.stats.siegeBonus * weapon.count}</span>
              </div>
            </div>
          `;
          }
        }
        html += "</div>";
      }
      if (availableSiege.length > 0) {
        html += '<h4>Build Siege Weapons</h4><div class="siege-grid">';
        for (const weapon of availableSiege) {
          const canTrain = this.game.state.resources.food >= weapon.cost.food && this.game.state.resources.wood >= weapon.cost.wood && this.game.state.resources.stone >= weapon.cost.stone && this.game.state.resources.gold >= weapon.cost.gold;
          html += `
          <div class="siege-card ${canTrain ? "available" : ""}">
            <div class="siege-header">
              <span class="siege-icon">${weapon.icon}</span>
              <h5>${weapon.name}</h5>
            </div>
            <p class="siege-desc">${weapon.description}</p>
            <div class="siege-stats">
              <span>\u2694\uFE0F ${weapon.stats.attack}</span>
              <span>\u{1F4A5} +${weapon.stats.siegeBonus}</span>
            </div>
            <div class="siege-cost">
              ${weapon.cost.food > 0 ? `<span>\u{1F356} ${weapon.cost.food}</span>` : ""}
              ${weapon.cost.wood > 0 ? `<span>\u{1FAB5} ${weapon.cost.wood}</span>` : ""}
              ${weapon.cost.stone > 0 ? `<span>\u{1FAA8} ${weapon.cost.stone}</span>` : ""}
              ${weapon.cost.gold > 0 ? `<span>\u{1F4B0} ${weapon.cost.gold}</span>` : ""}
            </div>
            <p class="train-time">\u23F1\uFE0F ${weapon.trainTime}s</p>
            <button class="train-siege-btn" data-siege="${weapon.id}" ${!canTrain ? "disabled" : ""}>
              Build
            </button>
          </div>
        `;
        }
        html += "</div>";
      } else {
        html += '<p class="empty-message">No siege weapons available. Research technologies to unlock.</p>';
      }
      html += "</div>";
      return html;
    }
    renderTraditionsSection() {
      const unlockedTraditions = this.game.getUnlockedTraditions();
      const stats = {
        battlesWon: this.game.state.statistics.battlesWon,
        territoriesConquered: this.game.state.statistics.territoriesConquered || 0,
        heroesRecruited: this.game.state.statistics.heroesRecruited || 0,
        veteranUnits: 0
        // Would need to track this
      };
      let html = `
      <div class="military-section">
        <h3>\u{1F396}\uFE0F Military Traditions</h3>
        <p>Earn permanent combat bonuses through military achievements.</p>
        <div class="traditions-grid">
    `;
      for (const tradition of MILITARY_TRADITIONS) {
        const isUnlocked = unlockedTraditions.some((t) => t.id === tradition.id);
        const canUnlock = checkTraditionUnlock(tradition, stats);
        let reqText = "";
        if (tradition.requirement.battlesWon)
          reqText = `Win ${tradition.requirement.battlesWon} battles (${stats.battlesWon}/${tradition.requirement.battlesWon})`;
        if (tradition.requirement.territoriesConquered)
          reqText = `Conquer ${tradition.requirement.territoriesConquered} territories (${stats.territoriesConquered}/${tradition.requirement.territoriesConquered})`;
        if (tradition.requirement.heroesRecruited)
          reqText = `Recruit ${tradition.requirement.heroesRecruited} heroes (${stats.heroesRecruited}/${tradition.requirement.heroesRecruited})`;
        if (tradition.requirement.veteranUnits)
          reqText = `Have ${tradition.requirement.veteranUnits} veteran units`;
        html += `
        <div class="tradition-card ${isUnlocked ? "unlocked" : ""}">
          <div class="tradition-header">
            <span class="tradition-icon">${tradition.icon}</span>
            <h5>${tradition.name}</h5>
          </div>
          <p class="tradition-desc">${tradition.description}</p>
          <span class="tradition-bonus">${tradition.bonuses.special}</span>
          <span class="tradition-requirement ${canUnlock ? "met" : ""}">${reqText}</span>
          ${isUnlocked ? '<span class="badge">\u2713 Unlocked</span>' : ""}
        </div>
      `;
      }
      html += "</div></div>";
      return html;
    }
    renderEspionageSection() {
      const spies = this.game.state.military.spies;
      const maxSpies = this.game.state.military.maxSpies;
      const availableMissions = this.game.getAvailableSpyMissions();
      const spyCost = 500 * (spies.length + 1);
      const canRecruit = spies.length < maxSpies && this.game.state.resources.gold >= spyCost;
      let html = `
      <div class="military-section">
        <h3>\u{1F575}\uFE0F Espionage</h3>
        <p>Recruit spies for sabotage, theft, and intelligence gathering.</p>
        
        <div class="spy-overview">
          <span>Spies: ${spies.length}/${maxSpies}</span>
          <button class="recruit-spy-btn" id="recruit-spy-btn" ${!canRecruit ? "disabled" : ""}>
            Recruit Spy (\u{1F4B0} ${spyCost})
          </button>
        </div>
    `;
      if (spies.length > 0) {
        html += '<h4>Your Agents</h4><div class="spy-grid">';
        for (const spy of spies) {
          const isBusy = spy.currentMission !== null;
          html += `
          <div class="spy-card ${isBusy ? "busy" : ""}">
            <div class="spy-header">
              <span class="spy-name">\u{1F575}\uFE0F ${spy.name}</span>
              <span class="spy-level">Lvl ${spy.level}</span>
            </div>
            <span class="spy-status ${isBusy ? "on-mission" : ""}">
              ${isBusy ? "\u{1F504} On Mission" : "\u2713 Available"}
            </span>
          </div>
        `;
        }
        html += "</div>";
      }
      if (availableMissions.length > 0 && spies.some((s) => !s.currentMission)) {
        html += '<h4>Available Missions</h4><div class="spy-mission-grid">';
        const availableSpy = spies.find((s) => !s.currentMission);
        for (const mission of availableMissions) {
          const canAfford = this.game.state.resources.gold >= mission.cost.gold;
          html += `
          <div class="spy-mission-card ${canAfford ? "available" : ""}">
            <div class="mission-header">
              <span class="mission-icon">${mission.icon}</span>
              <h5>${mission.name}</h5>
            </div>
            <p class="mission-desc">${mission.description}</p>
            <div class="mission-stats">
              <span>\u23F1\uFE0F ${mission.duration}s</span>
              <span>\u{1F3AF} ${Math.floor(mission.successChance * 100)}%</span>
              <span>\u{1F4B0} ${mission.cost.gold}</span>
            </div>
            <button class="spy-mission-btn" 
                    data-spy="${availableSpy?.id || ""}" 
                    data-mission="${mission.id}"
                    ${!canAfford || !availableSpy ? "disabled" : ""}>
              Start Mission
            </button>
          </div>
        `;
        }
        html += "</div>";
      } else if (spies.length === 0) {
        html += '<p class="empty-message">Recruit spies to start espionage missions.</p>';
      } else if (!spies.some((s) => !s.currentMission)) {
        html += '<p class="empty-message">All spies are currently on missions.</p>';
      } else if (availableMissions.length === 0) {
        html += '<p class="empty-message">No spy missions available. Research technologies to unlock.</p>';
      }
      html += "</div>";
      return html;
    }
    updateMilitaryTab() {
      const container = document.getElementById("military-content");
      if (!container) {
        this.renderMilitaryTab();
        return;
      }
      const { military } = this.game.state;
      const heroCount = military.recruitedHeroes.size;
      const defenseCount = military.defenseBuildings.reduce((sum, b) => sum + b.count, 0);
      const navalCount = military.navy.reduce((sum, n) => sum + n.count, 0);
      const siegeCount = military.siegeWeapons.reduce((sum, s) => sum + s.count, 0);
      const traditionCount = military.unlockedTraditions.size;
      const spyCount = military.spies.length;
      const queueLength = military.defenseConstructionQueue.length + military.navalTrainingQueue.length + military.siegeTrainingQueue.length;
      const versionKey = `${military.selectedFormation}-${heroCount}-${defenseCount}-${navalCount}-${siegeCount}-${traditionCount}-${spyCount}-${queueLength}`;
      const lastVersion = this.tabContentVersions.get("military");
      if (lastVersion === void 0 || lastVersion !== versionKey) {
        this.tabContentVersions.set("military", versionKey);
        this.renderMilitaryTab();
        return;
      }
    }
  };

  // dist/main.js
  function initGame() {
    const game = new Game();
    const ui = new GameUI(game);
    const saveString = localStorage.getItem("civGameSave");
    if (saveString) {
      game.loadGame(saveString);
    }
    game.start();
    ui.render();
    setInterval(() => {
      const saveData = game.saveGame();
      localStorage.setItem("civGameSave", saveData);
    }, 3e4);
    window.game = game;
  }
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initGame);
  } else {
    initGame();
  }
})();

</script>
</body>
</html>
